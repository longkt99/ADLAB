[{"filePath":"E:\\Content Machine\\app\\(dashboard)\\calendar\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchCalendarData'. Either include it or remove the dependency array.","line":259,"column":6,"nodeType":"ArrayExpression","endLine":259,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [year, month, platformFilter, statusFilter, fetchCalendarData]","fix":{"range":[8935,8978],"text":"[year, month, platformFilter, statusFilter, fetchCalendarData]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchCalendarData'. Either include it or remove the dependency array.","line":274,"column":6,"nodeType":"ArrayExpression","endLine":274,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [year, month, platformFilter, statusFilter, fetchCalendarData]","fix":{"range":[9419,9462],"text":"[year, month, platformFilter, statusFilter, fetchCalendarData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport Link from 'next/link';\r\nimport { useRouter } from 'next/navigation';\r\nimport { PLATFORMS, PLATFORM_DISPLAY_NAMES, type Platform } from '@/lib/platforms';\r\nimport { useTranslation, formatDate } from '@/lib/i18n';\r\n\r\n// ============================================\r\n// Types\r\n// ============================================\r\ninterface CalendarEvent {\r\n  id: string;\r\n  post_id: string;\r\n  post_title: string;\r\n  platform: Platform;\r\n  status: 'scheduled' | 'published';\r\n  content: string;\r\n  date: string;\r\n  scheduled_at: string | null;\r\n  published_at: string | null;\r\n}\r\n\r\ninterface CalendarData {\r\n  success: boolean;\r\n  year: number;\r\n  month: number;\r\n  total_events: number;\r\n  events: CalendarEvent[];\r\n  events_by_day: { [key: string]: CalendarEvent[] };\r\n  filters: {\r\n    platform: string;\r\n    status: string;\r\n  };\r\n}\r\n\r\n// ============================================\r\n// Platform Badge Component - Warm Professional: subtle pills\r\n// ============================================\r\nfunction PlatformBadge({ platform }: { platform: Platform }) {\r\n  const displayName = PLATFORM_DISPLAY_NAMES[platform] || platform;\r\n\r\n  return (\r\n    <span className=\"inline-block px-2 py-0.5 text-xs bg-secondary text-secondary-foreground rounded\">\r\n      {displayName}\r\n    </span>\r\n  );\r\n}\r\n\r\n// ============================================\r\n// Platform Emoji Helper\r\n// ============================================\r\nfunction getPlatformEmoji(platform: Platform): string {\r\n  const emojis: { [key: string]: string } = {\r\n    twitter_x: 'ð•',\r\n    instagram_post: 'ðŸ“·',\r\n    threads: 'ðŸ§µ',\r\n    bluesky: 'â˜ï¸',\r\n    linkedin: 'ðŸ’¼',\r\n    google: 'ðŸ”',\r\n    pinterest: 'ðŸ“Œ',\r\n    youtube_community: 'â–¶ï¸',\r\n  };\r\n  return emojis[platform] || 'ðŸ“„';\r\n}\r\n\r\n// ============================================\r\n// Platform Color Helper - Warm Professional: cream/warm tones\r\n// ============================================\r\nfunction getPlatformColors(platform: Platform): { bg: string; border: string } {\r\n  // Using warm, subtle colors\r\n  const colors: { [key: string]: { bg: string; border: string } } = {\r\n    twitter_x: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    instagram_post: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    threads: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    bluesky: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    linkedin: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    google: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    pinterest: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n    youtube_community: { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' },\r\n  };\r\n  return colors[platform] || { bg: 'hsl(40 14% 95%)', border: 'hsl(40 10% 85%)' };\r\n}\r\n\r\n// ============================================\r\n// Date Range Helpers\r\n// ============================================\r\nfunction getThisWeek(): { start: Date; end: Date } {\r\n  const now = new Date();\r\n  const dayOfWeek = now.getDay(); // 0 (Sunday) to 6 (Saturday)\r\n\r\n  // Calculate days to Monday (start of week)\r\n  const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\r\n\r\n  const monday = new Date(now);\r\n  monday.setDate(now.getDate() - daysToMonday);\r\n  monday.setHours(0, 0, 0, 0);\r\n\r\n  const sunday = new Date(monday);\r\n  sunday.setDate(monday.getDate() + 6);\r\n  sunday.setHours(23, 59, 59, 999);\r\n\r\n  return { start: monday, end: sunday };\r\n}\r\n\r\nfunction formatDateRange(start: Date, end: Date): string {\r\n  const formatOptions: Intl.DateTimeFormatOptions = { month: 'short', day: 'numeric', year: 'numeric' };\r\n  const startStr = start.toLocaleDateString('en-US', formatOptions);\r\n  const endStr = end.toLocaleDateString('en-US', formatOptions);\r\n  return `${startStr} â€“ ${endStr}`;\r\n}\r\n\r\nfunction shiftDateRange(range: { start: Date; end: Date }, direction: 'prev' | 'next'): { start: Date; end: Date } {\r\n  const durationMs = range.end.getTime() - range.start.getTime();\r\n  const shift = direction === 'next' ? durationMs + 1 : -(durationMs + 1);\r\n\r\n  const newStart = new Date(range.start.getTime() + shift);\r\n  const newEnd = new Date(range.end.getTime() + shift);\r\n\r\n  return { start: newStart, end: newEnd };\r\n}\r\n\r\n// ============================================\r\n// Status Badge Component - Warm Professional: subtle pills\r\n// ============================================\r\nfunction StatusBadge({ status, t }: { status: string; t: (key: string) => string }) {\r\n  // Use translation for status label\r\n  const statusLabel = t(`status.${status}`) || status;\r\n\r\n  return (\r\n    <span className=\"inline-block px-2 py-0.5 text-xs bg-secondary text-foreground rounded\">\r\n      {statusLabel}\r\n    </span>\r\n  );\r\n}\r\n\r\n// ============================================\r\n// Calendar Page Component\r\n// ============================================\r\nexport default function CalendarPage() {\r\n  const router = useRouter();\r\n  const { t, language } = useTranslation();\r\n  const [currentDate, setCurrentDate] = useState(new Date());\r\n  const [calendarData, setCalendarData] = useState<CalendarData | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [selectedEvent, setSelectedEvent] = useState<CalendarEvent | null>(null);\r\n\r\n  // View Mode (month, week, agenda)\r\n  const [viewMode, setViewMode] = useState<'month' | 'week' | 'agenda'>('month');\r\n\r\n  // Filters\r\n  const [platformFilter, setPlatformFilter] = useState<string>('all');\r\n  const [statusFilter, setStatusFilter] = useState<string>('all');\r\n  const [searchQuery, setSearchQuery] = useState<string>('');\r\n  const [weekFilterActive, setWeekFilterActive] = useState(false);\r\n  const [customDateRange, setCustomDateRange] = useState<{ start: Date; end: Date } | null>(null);\r\n\r\n  // Day Events Modal State\r\n  const [dayEventsModal, setDayEventsModal] = useState<{ day: number; events: CalendarEvent[] } | null>(null);\r\n  const [dayEventsPage, setDayEventsPage] = useState(1);\r\n  const eventsPerPage = 6;\r\n\r\n  const year = currentDate.getFullYear();\r\n  const month = currentDate.getMonth() + 1; // JavaScript months are 0-indexed\r\n\r\n  // ============================================\r\n  // Filter Event Handlers\r\n  // ============================================\r\n  const handleThisWeekToggle = () => {\r\n    if (weekFilterActive) {\r\n      // Deactivate week filter\r\n      setWeekFilterActive(false);\r\n      setCustomDateRange(null);\r\n    } else {\r\n      // Activate week filter\r\n      setWeekFilterActive(true);\r\n      setCustomDateRange(getThisWeek());\r\n    }\r\n  };\r\n\r\n  const handleDateRangeShift = (direction: 'prev' | 'next') => {\r\n    if (customDateRange) {\r\n      const newRange = shiftDateRange(customDateRange, direction);\r\n      setCustomDateRange(newRange);\r\n      // Keep weekFilterActive false when manually navigating\r\n      setWeekFilterActive(false);\r\n    }\r\n  };\r\n\r\n  const handleClearDateRange = () => {\r\n    setWeekFilterActive(false);\r\n    setCustomDateRange(null);\r\n  };\r\n\r\n  // ============================================\r\n  // Client-Side Event Filtering\r\n  // ============================================\r\n  const applyClientSideFilters = (events: CalendarEvent[]): CalendarEvent[] => {\r\n    let filtered = [...events];\r\n\r\n    // 1. Apply search filter\r\n    if (searchQuery.trim()) {\r\n      const query = searchQuery.toLowerCase();\r\n      filtered = filtered.filter((event) =>\r\n        event.post_title.toLowerCase().includes(query) ||\r\n        event.content.toLowerCase().includes(query)\r\n      );\r\n    }\r\n\r\n    // 2. Apply date range filter (week or custom)\r\n    if (customDateRange) {\r\n      filtered = filtered.filter((event) => {\r\n        const eventDate = new Date(event.date);\r\n        return eventDate >= customDateRange.start && eventDate <= customDateRange.end;\r\n      });\r\n    }\r\n\r\n    return filtered;\r\n  };\r\n\r\n  // ============================================\r\n  // Fetch Calendar Data\r\n  // ============================================\r\n  const fetchCalendarData = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const params = new URLSearchParams({\r\n        year: year.toString(),\r\n        month: month.toString(),\r\n      });\r\n\r\n      if (platformFilter !== 'all') {\r\n        params.append('platform', platformFilter);\r\n      }\r\n\r\n      if (statusFilter !== 'all') {\r\n        params.append('status', statusFilter);\r\n      }\r\n\r\n      const response = await fetch(`/api/calendar/events?${params.toString()}`);\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to fetch calendar data');\r\n      }\r\n\r\n      const data: CalendarData = await response.json();\r\n      setCalendarData(data);\r\n    } catch (error) {\r\n      console.error('Error fetching calendar data:', error);\r\n      alert('Failed to load calendar data');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Fetch calendar data when dependencies change\r\n  useEffect(() => {\r\n    fetchCalendarData();\r\n  }, [year, month, platformFilter, statusFilter]);\r\n\r\n  // Refetch calendar data when page becomes visible (user navigates back)\r\n  useEffect(() => {\r\n    const handleVisibilityChange = () => {\r\n      if (document.visibilityState === 'visible') {\r\n        fetchCalendarData();\r\n      }\r\n    };\r\n\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n\r\n    return () => {\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n    };\r\n  }, [year, month, platformFilter, statusFilter]);\r\n\r\n  // ============================================\r\n  // Calendar Navigation\r\n  // ============================================\r\n  const goToPreviousMonth = () => {\r\n    setCurrentDate(new Date(year, month - 2, 1)); // month - 2 because we add 1 for display\r\n  };\r\n\r\n  const goToNextMonth = () => {\r\n    setCurrentDate(new Date(year, month, 1));\r\n  };\r\n\r\n  const goToToday = () => {\r\n    setCurrentDate(new Date());\r\n  };\r\n\r\n  // ============================================\r\n  // Calendar Day Cells\r\n  // ============================================\r\n  const getDaysInMonth = (year: number, month: number) => {\r\n    return new Date(year, month, 0).getDate();\r\n  };\r\n\r\n  const getFirstDayOfMonth = (year: number, month: number) => {\r\n    // Returns 0 (Sunday) to 6 (Saturday)\r\n    return new Date(year, month - 1, 1).getDay();\r\n  };\r\n\r\n  const _monthNames = [\r\n    'January', 'February', 'March', 'April', 'May', 'June',\r\n    'July', 'August', 'September', 'October', 'November', 'December'\r\n  ];\r\n\r\n  const daysInMonth = getDaysInMonth(year, month);\r\n  const firstDayOfWeek = getFirstDayOfMonth(year, month);\r\n\r\n  // Build calendar grid (6 rows x 7 columns = 42 cells)\r\n  const calendarCells: (number | null)[] = [];\r\n\r\n  // Add empty cells for days before the 1st\r\n  for (let i = 0; i < firstDayOfWeek; i++) {\r\n    calendarCells.push(null);\r\n  }\r\n\r\n  // Add cells for each day of the month\r\n  for (let day = 1; day <= daysInMonth; day++) {\r\n    calendarCells.push(day);\r\n  }\r\n\r\n  // Pad to fill 6 rows (42 cells total)\r\n  while (calendarCells.length < 42) {\r\n    calendarCells.push(null);\r\n  }\r\n\r\n  // ============================================\r\n  // Get Events for a Specific Day\r\n  // ============================================\r\n  const getEventsForDay = (day: number | null): CalendarEvent[] => {\r\n    if (!day || !calendarData) return [];\r\n\r\n    const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\r\n    const dayEvents = calendarData.events_by_day[dateKey] || [];\r\n\r\n    // Apply client-side filters (search, date range)\r\n    return applyClientSideFilters(dayEvents);\r\n  };\r\n\r\n  // ============================================\r\n  // Check if Day is Today\r\n  // ============================================\r\n  const isToday = (day: number | null): boolean => {\r\n    if (!day) return false;\r\n    const today = new Date();\r\n    return (\r\n      day === today.getDate() &&\r\n      month === today.getMonth() + 1 &&\r\n      year === today.getFullYear()\r\n    );\r\n  };\r\n\r\n  // ============================================\r\n  // Day Events Modal (for \"+X more\")\r\n  // ============================================\r\n  const DayEventsModal = ({ day, events }: { day: number; events: CalendarEvent[] }) => {\r\n    const totalPages = Math.ceil(events.length / eventsPerPage);\r\n    const startIndex = (dayEventsPage - 1) * eventsPerPage;\r\n    const endIndex = startIndex + eventsPerPage;\r\n    const paginatedEvents = events.slice(startIndex, endIndex);\r\n\r\n    const handleEventClick = (postId: string) => {\r\n      router.push(`/posts/${postId}`);\r\n    };\r\n\r\n    const handleClose = () => {\r\n      setDayEventsModal(null);\r\n      setDayEventsPage(1);\r\n    };\r\n\r\n    return (\r\n      <div\r\n        className=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4\"\r\n        onClick={handleClose}\r\n      >\r\n        <div\r\n          className=\"bg-white dark:bg-gray-900 rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto\"\r\n          onClick={(e) => e.stopPropagation()}\r\n        >\r\n          {/* Header */}\r\n          <div className=\"border-b border-gray-200 dark:border-gray-800 p-6 bg-gradient-to-r from-gray-50 dark:from-gray-900 to-white dark:to-gray-900\">\r\n            <div className=\"flex items-start justify-between\">\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold text-gray-900 dark:text-gray-100\">\r\n                  {formatDate(new Date(year, month - 1, day), 'dateFull', language)}\r\n                </h2>\r\n                <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1 font-medium\">\r\n                  {events.length} {t('calendar.dayEventsModal.events')}\r\n                </p>\r\n              </div>\r\n              <button\r\n                onClick={handleClose}\r\n                className=\"p-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-all\"\r\n              >\r\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                </svg>\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Events List */}\r\n          <div className=\"p-6 space-y-3\">\r\n            {paginatedEvents.map((event) => {\r\n              const platformColors = getPlatformColors(event.platform);\r\n              return (\r\n                <button\r\n                  key={event.id}\r\n                  onClick={() => handleEventClick(event.post_id)}\r\n                  className=\"w-full text-left p-4 rounded-xl border-l-4 hover:shadow-lg transition-all\"\r\n                  style={{\r\n                    backgroundColor: platformColors.bg,\r\n                    borderColor: platformColors.border,\r\n                  }}\r\n                >\r\n                  <div className=\"flex items-start justify-between gap-3\">\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        <span className=\"text-lg\">{getPlatformEmoji(event.platform)}</span>\r\n                        <PlatformBadge platform={event.platform} />\r\n                        <StatusBadge status={event.status} t={t} />\r\n                      </div>\r\n                      <h3 className=\"font-bold text-gray-900 mb-1 truncate\">\r\n                        {event.post_title}\r\n                      </h3>\r\n                      <p className=\"text-sm text-gray-700 line-clamp-2\">\r\n                        {event.content}\r\n                      </p>\r\n                      {event.scheduled_at && (\r\n                        <p className=\"text-xs text-gray-600 mt-2 flex items-center gap-1.5\">\r\n                          <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                          </svg>\r\n                          {formatDate(event.scheduled_at, 'timeOnly', language)}\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                    <svg className=\"w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                    </svg>\r\n                  </div>\r\n                </button>\r\n              );\r\n            })}\r\n          </div>\r\n\r\n          {/* Pagination */}\r\n          {totalPages > 1 && (\r\n            <div className=\"border-t border-gray-200 dark:border-gray-800 p-6 bg-gray-50 dark:bg-gray-900\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <button\r\n                  onClick={() => setDayEventsPage(Math.max(1, dayEventsPage - 1))}\r\n                  disabled={dayEventsPage === 1}\r\n                  className=\"px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-600 transition-all font-semibold text-sm shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {t('calendar.dayEventsModal.previous')}\r\n                </button>\r\n                <span className=\"text-sm text-gray-600 dark:text-gray-400 font-semibold\">\r\n                  {t('calendar.dayEventsModal.page')} {dayEventsPage} {t('calendar.dayEventsModal.of')} {totalPages}\r\n                </span>\r\n                <button\r\n                  onClick={() => setDayEventsPage(Math.min(totalPages, dayEventsPage + 1))}\r\n                  disabled={dayEventsPage === totalPages}\r\n                  className=\"px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-600 transition-all font-semibold text-sm shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {t('calendar.dayEventsModal.next')}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Footer */}\r\n          <div className=\"border-t border-gray-200 dark:border-gray-800 p-6 bg-gray-50 dark:bg-gray-900\">\r\n            <button\r\n              onClick={handleClose}\r\n              className=\"w-full px-4 py-2.5 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors font-semibold\"\r\n            >\r\n              {t('calendar.dayEventsModal.close')}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // ============================================\r\n  // Event Details Modal\r\n  // ============================================\r\n  const EventModal = ({ event }: { event: CalendarEvent }) => {\r\n    const eventDate = new Date(event.date);\r\n    // Format: \"Monday, December 10, 2025, 2:30 PM\" (en) or \"Thá»© Hai, 10/12/2025, 14:30\" (vi)\r\n    const formattedDate = formatDate(eventDate, 'dateTimeShort', language);\r\n\r\n    return (\r\n      <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\r\n        <div className=\"bg-white dark:bg-gray-900 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n          {/* Header */}\r\n          <div className=\"border-b border-gray-200 dark:border-gray-800 p-6 bg-gradient-to-r from-gray-50 dark:from-gray-900 to-white dark:to-gray-900\">\r\n            <div className=\"flex items-start justify-between\">\r\n              <div className=\"flex-1\">\r\n                <h2 className=\"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3\">{t('calendar.eventModal.title')}</h2>\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  <PlatformBadge platform={event.platform} />\r\n                  <StatusBadge status={event.status} t={t} />\r\n                </div>\r\n                <p className=\"text-sm text-gray-600 dark:text-gray-400 font-medium\">{formattedDate}</p>\r\n              </div>\r\n              <button\r\n                onClick={() => setSelectedEvent(null)}\r\n                className=\"p-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-all\"\r\n              >\r\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                </svg>\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Content */}\r\n          <div className=\"p-6 space-y-5\">\r\n            <div>\r\n              <h3 className=\"text-sm font-bold text-gray-900 dark:text-gray-100 mb-2\">{t('calendar.eventModal.postTitle')}</h3>\r\n              <p className=\"text-gray-700 dark:text-gray-300 font-medium\">{event.post_title}</p>\r\n            </div>\r\n\r\n            <div>\r\n              <h3 className=\"text-sm font-bold text-gray-900 dark:text-gray-100 mb-2\">{t('calendar.eventModal.content')}</h3>\r\n              <div className=\"bg-gray-50 dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700\">\r\n                <p className=\"text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed\">{event.content}</p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-5\">\r\n              {event.scheduled_at && (\r\n                <div>\r\n                  <h3 className=\"text-sm font-bold text-gray-900 dark:text-gray-100 mb-2\">{t('calendar.eventModal.scheduledFor')}</h3>\r\n                  <div className=\"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300\">\r\n                    <svg className=\"w-4 h-4 text-gray-500 dark:text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                    </svg>\r\n                    {formatDate(event.scheduled_at, 'dateTimeShort', language)}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {event.published_at && (\r\n                <div>\r\n                  <h3 className=\"text-sm font-bold text-gray-900 dark:text-gray-100 mb-2\">{t('calendar.eventModal.publishedAt')}</h3>\r\n                  <div className=\"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300\">\r\n                    <svg className=\"w-4 h-4 text-gray-500 dark:text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                    </svg>\r\n                    {formatDate(event.published_at, 'dateTimeShort', language)}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Footer */}\r\n          <div className=\"border-t border-gray-200 dark:border-gray-800 p-6 bg-gray-50 dark:bg-gray-900\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <Link\r\n                href={`/posts/${event.post_id}`}\r\n                className=\"inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-semibold text-sm\"\r\n              >\r\n                {t('calendar.eventModal.viewFullPost')}\r\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 7l5 5m0 0l-5 5m5-5H6\" />\r\n                </svg>\r\n              </Link>\r\n              <button\r\n                onClick={() => setSelectedEvent(null)}\r\n                className=\"px-4 py-2.5 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors font-semibold\"\r\n              >\r\n                {t('calendar.eventModal.close')}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // ============================================\r\n  // Render\r\n  // ============================================\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Page Header */}\r\n      <div>\r\n        <h1 className=\"text-xl font-semibold text-foreground tracking-tight\">{t('calendar.title')}</h1>\r\n        <p className=\"text-sm text-muted-foreground mt-1\">{t('calendar.subtitle')}</p>\r\n      </div>\r\n\r\n      {/* Enhanced Filter Bar */}\r\n      <div className=\"bg-card rounded-lg border border-border p-4\">\r\n        <div className=\"flex flex-col sm:flex-row sm:items-center gap-3\">\r\n          {/* Search Input */}\r\n          <div className=\"flex-1 min-w-0\">\r\n            <div className=\"relative\">\r\n              <input\r\n                type=\"text\"\r\n                placeholder={t('calendar.search.placeholder')}\r\n                value={searchQuery}\r\n                onChange={(e) => setSearchQuery(e.target.value)}\r\n                className=\"w-full px-3 py-2.5 pl-9 border border-border bg-card text-foreground placeholder:text-muted-foreground rounded-lg text-sm focus:ring-2 focus:ring-ring/20 focus:border-border transition-all dark:bg-secondary\"\r\n              />\r\n              <svg\r\n                className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\"\r\n                fill=\"none\"\r\n                stroke=\"currentColor\"\r\n                viewBox=\"0 0 24 24\"\r\n              >\r\n                <path\r\n                  strokeLinecap=\"round\"\r\n                  strokeLinejoin=\"round\"\r\n                  strokeWidth={1.5}\r\n                  d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\"\r\n                />\r\n              </svg>\r\n            </div>\r\n          </div>\r\n\r\n          {/* This Week Button */}\r\n          <button\r\n            onClick={handleThisWeekToggle}\r\n            className={`w-full sm:w-auto px-4 py-2.5 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${\r\n              weekFilterActive\r\n                ? 'bg-primary text-primary-foreground'\r\n                : 'bg-card text-foreground hover:bg-secondary border border-border'\r\n            }`}\r\n          >\r\n            {t('calendar.toolbar.thisWeek')}\r\n          </button>\r\n\r\n          {/* Date Range Selector */}\r\n          {customDateRange && (\r\n            <div className=\"flex items-center gap-1 overflow-x-auto\">\r\n              <button\r\n                onClick={() => handleDateRangeShift('prev')}\r\n                className=\"p-1.5 hover:bg-accent rounded transition-colors\"\r\n                aria-label={t('calendar.toolbar.previousPeriod')}\r\n              >\r\n                <svg className=\"w-3.5 h-3.5 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15 19l-7-7 7-7\" />\r\n                </svg>\r\n              </button>\r\n\r\n              <div className=\"px-3 py-1.5 bg-muted border border-border rounded text-xs text-foreground min-w-[200px] text-center\">\r\n                {formatDateRange(customDateRange.start, customDateRange.end)}\r\n              </div>\r\n\r\n              <button\r\n                onClick={() => handleDateRangeShift('next')}\r\n                className=\"p-1.5 hover:bg-accent rounded transition-colors\"\r\n                aria-label={t('calendar.toolbar.nextPeriod')}\r\n              >\r\n                <svg className=\"w-3.5 h-3.5 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 5l7 7-7 7\" />\r\n                </svg>\r\n              </button>\r\n\r\n              <button\r\n                onClick={handleClearDateRange}\r\n                className=\"p-1.5 hover:bg-accent rounded transition-colors text-muted-foreground hover:text-destructive\"\r\n                aria-label={t('calendar.toolbar.clearDateRange')}\r\n              >\r\n                <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M6 18L18 6M6 6l12 12\" />\r\n                </svg>\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* View Mode Toggle + Navigation & Filters */}\r\n      <div className=\"bg-card rounded-lg border border-border p-4\">\r\n          {/* View Toggle Buttons */}\r\n          <div className=\"flex flex-wrap items-center gap-2 pb-3 mb-3 border-b border-border\">\r\n            <span className=\"text-xs text-muted-foreground mr-2 whitespace-nowrap\">{t('calendar.viewMode.label')}</span>\r\n            <button\r\n              onClick={() => setViewMode('month')}\r\n              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${\r\n                viewMode === 'month'\r\n                  ? 'bg-secondary text-foreground'\r\n                  : 'text-muted-foreground hover:bg-secondary hover:text-foreground'\r\n              }`}\r\n            >\r\n              {t('calendar.viewMode.month')}\r\n            </button>\r\n            <button\r\n              onClick={() => setViewMode('week')}\r\n              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${\r\n                viewMode === 'week'\r\n                  ? 'bg-secondary text-foreground'\r\n                  : 'text-muted-foreground hover:bg-secondary hover:text-foreground'\r\n              }`}\r\n            >\r\n              {t('calendar.viewMode.week')}\r\n            </button>\r\n            <button\r\n              onClick={() => setViewMode('agenda')}\r\n              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${\r\n                viewMode === 'agenda'\r\n                  ? 'bg-secondary text-foreground'\r\n                  : 'text-muted-foreground hover:bg-secondary hover:text-foreground'\r\n              }`}\r\n            >\r\n              {t('calendar.viewMode.agenda')}\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3\">\r\n            {/* Date Navigation */}\r\n            <div className=\"flex items-center justify-center lg:justify-start gap-2\">\r\n              <button\r\n                onClick={goToPreviousMonth}\r\n                className=\"p-1.5 hover:bg-secondary rounded-lg transition-colors\"\r\n                aria-label={t('calendar.toolbar.previousMonth')}\r\n              >\r\n                <svg className=\"w-4 h-4 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15 19l-7-7 7-7\" />\r\n                </svg>\r\n              </button>\r\n\r\n              <h2 className=\"text-sm font-medium text-foreground min-w-[140px] text-center\">\r\n                {formatDate(new Date(year, month - 1, 1), 'monthYear', language)}\r\n              </h2>\r\n\r\n              <button\r\n                onClick={goToNextMonth}\r\n                className=\"p-1.5 hover:bg-secondary rounded-lg transition-colors\"\r\n                aria-label={t('calendar.toolbar.nextMonth')}\r\n              >\r\n                <svg className=\"w-4 h-4 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 5l7 7-7 7\" />\r\n                </svg>\r\n              </button>\r\n\r\n              <button\r\n                onClick={goToToday}\r\n                className=\"ml-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-all text-sm font-medium\"\r\n              >\r\n                {t('calendar.toolbar.today')}\r\n              </button>\r\n            </div>\r\n\r\n            {/* Filters */}\r\n            <div className=\"flex flex-col sm:flex-row sm:flex-wrap items-stretch sm:items-center gap-3\">\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-1.5\">\r\n                <label htmlFor=\"platform-filter\" className=\"text-xs text-muted-foreground whitespace-nowrap\">\r\n                  {t('calendar.filters.platformLabel')}\r\n                </label>\r\n                <select\r\n                  id=\"platform-filter\"\r\n                  value={platformFilter}\r\n                  onChange={(e) => setPlatformFilter(e.target.value)}\r\n                  className=\"w-full sm:w-auto px-3 py-2 border border-border bg-card text-foreground rounded-lg text-sm focus:ring-2 focus:ring-ring/20 focus:border-border transition-all dark:bg-secondary\"\r\n                >\r\n                  <option value=\"all\">{t('calendar.filters.allPlatforms')}</option>\r\n                  {PLATFORMS.map((platform) => (\r\n                    <option key={platform} value={platform}>\r\n                      {PLATFORM_DISPLAY_NAMES[platform]}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-1.5\">\r\n                <label htmlFor=\"status-filter\" className=\"text-xs text-muted-foreground whitespace-nowrap\">\r\n                  {t('calendar.filters.statusLabel')}\r\n                </label>\r\n                <select\r\n                  id=\"status-filter\"\r\n                  value={statusFilter}\r\n                  onChange={(e) => setStatusFilter(e.target.value)}\r\n                  className=\"w-full sm:w-auto px-3 py-2 border border-border bg-card text-foreground rounded-lg text-sm focus:ring-2 focus:ring-ring/20 focus:border-border transition-all dark:bg-secondary\"\r\n                >\r\n                  <option value=\"all\">{t('calendar.filters.allStatuses')}</option>\r\n                  <option value=\"scheduled\">{t('status.scheduled')}</option>\r\n                  <option value=\"published\">{t('status.published')}</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Stats */}\r\n          {calendarData && (\r\n            <div className=\"mt-3 pt-3 border-t border-border\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {t('calendar.stats.showing')} <span className=\"text-foreground\">{applyClientSideFilters(calendarData.events).length}</span> {applyClientSideFilters(calendarData.events).length === 1 ? t('calendar.stats.eventSingular') : t('calendar.stats.eventPlural')} {t('calendar.stats.in')} {formatDate(new Date(year, month - 1, 1), 'monthYear', language)}\r\n                  {(searchQuery || customDateRange) && (\r\n                    <span className=\"text-muted-foreground\"> {t('calendar.stats.filteredFrom')} {calendarData.total_events} {t('calendar.stats.total')}</span>\r\n                  )}\r\n                </p>\r\n                {(searchQuery || customDateRange) && (\r\n                  <button\r\n                    onClick={() => {\r\n                      setSearchQuery('');\r\n                      setWeekFilterActive(false);\r\n                      setCustomDateRange(null);\r\n                    }}\r\n                    className=\"text-xs text-muted-foreground hover:text-foreground\"\r\n                  >\r\n                    {t('calendar.stats.clearAllFilters')}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n      {/* Calendar Grid */}\r\n      {loading ? (\r\n        <div className=\"bg-card rounded-xl border border-border p-16 text-center\">\r\n          <div className=\"inline-flex items-center gap-2\">\r\n            <svg className=\"animate-spin w-4 h-4 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n              <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\r\n              <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n            </svg>\r\n            <p className=\"text-sm text-muted-foreground\">{t('calendar.loading.message')}</p>\r\n          </div>\r\n        </div>\r\n      ) : viewMode === 'month' ? (\r\n        <div className=\"min-h-[500px] sm:h-[calc(100vh-320px)]\">\r\n          <div className=\"bg-card rounded-xl border border-border overflow-x-auto h-full flex flex-col\">\r\n            {/* Day Headers */}\r\n            <div className=\"grid grid-cols-7 bg-secondary/50 border-b border-border min-w-[640px]\">\r\n              {[\r\n                t('calendar.weekdays.sun'),\r\n                t('calendar.weekdays.mon'),\r\n                t('calendar.weekdays.tue'),\r\n                t('calendar.weekdays.wed'),\r\n                t('calendar.weekdays.thu'),\r\n                t('calendar.weekdays.fri'),\r\n                t('calendar.weekdays.sat')\r\n              ].map((day, index) => (\r\n                <div key={index} className=\"p-2 text-center text-[11px] font-medium text-muted-foreground uppercase tracking-wide border-r border-border last:border-r-0\">\r\n                  {day}\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n          {/* Calendar Days */}\r\n          <div className=\"grid grid-cols-7 flex-1 min-w-[640px]\">\r\n            {calendarCells.map((day, index) => {\r\n              const events = getEventsForDay(day);\r\n              const isTodayCell = isToday(day);\r\n\r\n              return (\r\n                <div\r\n                  key={index}\r\n                  className={`min-h-[80px] p-1.5 border-r border-b border-border last:border-r-0 flex flex-col ${\r\n                    day ? 'bg-card hover:bg-accent/30 transition-colors' : 'bg-muted/30'\r\n                  } ${isTodayCell ? 'ring-1 ring-inset ring-primary bg-primary/5' : ''}`}\r\n                >\r\n                  {day && (\r\n                    <>\r\n                      <div className={`text-xs mb-1 ${isTodayCell ? 'text-primary font-medium' : 'text-muted-foreground'}`}>\r\n                        {day}\r\n                      </div>\r\n\r\n                      <div className=\"space-y-0.5 overflow-y-auto flex-1\">\r\n                        {events.slice(0, 3).map((event) => {\r\n                          return (\r\n                            <button\r\n                              key={event.id}\r\n                              onClick={() => router.push(`/posts/${event.post_id}`)}\r\n                              className=\"w-full text-left px-1.5 py-1 rounded text-[10px] bg-accent hover:bg-accent/80 transition-colors border-l-2 border-border\"\r\n                            >\r\n                              <div className=\"truncate text-foreground\">\r\n                                {getPlatformEmoji(event.platform)}\r\n                                {' '}\r\n                                {event.post_title}\r\n                              </div>\r\n                            </button>\r\n                          );\r\n                        })}\r\n\r\n                        {events.length > 3 && (\r\n                          <button\r\n                            onClick={() => setDayEventsModal({ day: day, events })}\r\n                            className=\"text-[10px] text-muted-foreground hover:text-foreground pl-1.5\"\r\n                          >\r\n                            +{events.length - 3} {t('calendar.dayCell.more')}\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n          </div>\r\n        </div>\r\n      ) : viewMode === 'week' ? (\r\n        <div className=\"bg-card rounded-xl border border-border overflow-hidden\">\r\n          {/* Week View - Warm Professional */}\r\n          <div className=\"p-5\">\r\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">{t('calendar.weekView.title')}</h3>\r\n            <div className=\"grid grid-cols-7 gap-1.5\">\r\n              {(() => {\r\n                const startOfWeek = new Date(year, month - 1, 1);\r\n                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());\r\n                return Array.from({ length: 7 }).map((_, i) => {\r\n                  const dayDate = new Date(startOfWeek);\r\n                  dayDate.setDate(dayDate.getDate() + i);\r\n                  const dayNum = dayDate.getDate();\r\n                  const events = calendarData ? applyClientSideFilters(calendarData.events).filter(e => {\r\n                    const eventDate = new Date(e.date);\r\n                    return eventDate.getDate() === dayNum &&\r\n                           eventDate.getMonth() === dayDate.getMonth() &&\r\n                           eventDate.getFullYear() === dayDate.getFullYear();\r\n                  }) : [];\r\n                  const isTodayCell = new Date().toDateString() === dayDate.toDateString();\r\n\r\n                  return (\r\n                    <div key={i} className={`p-2 rounded border ${isTodayCell ? 'border-primary bg-primary/5' : 'border-border'}`}>\r\n                      <div className={`text-[10px] mb-1 ${isTodayCell ? 'text-primary' : 'text-muted-foreground'}`}>\r\n                        {formatDate(dayDate, 'dateShort', language)}\r\n                      </div>\r\n                      <div className={`text-lg font-medium mb-2 ${isTodayCell ? 'text-primary' : 'text-foreground'}`}>\r\n                        {dayNum}\r\n                      </div>\r\n                      <div className=\"space-y-1\">\r\n                        {events.slice(0, 5).map((event) => {\r\n                          return (\r\n                            <button\r\n                              key={event.id}\r\n                              onClick={() => router.push(`/posts/${event.post_id}`)}\r\n                              className=\"w-full text-left px-1.5 py-1 rounded text-[10px] bg-accent hover:bg-accent/80 transition-colors border-l-2 border-border\"\r\n                            >\r\n                              <div className=\"truncate text-foreground\">\r\n                                {getPlatformEmoji(event.platform)} {event.post_title}\r\n                              </div>\r\n                            </button>\r\n                          );\r\n                        })}\r\n                        {events.length > 5 && (\r\n                          <p className=\"text-[10px] text-muted-foreground pl-1.5\">+{events.length - 5} {t('calendar.dayCell.more')}</p>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                });\r\n              })()}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"bg-card rounded-xl border border-border overflow-hidden\">\r\n          {/* Agenda View - Warm Professional */}\r\n          <div className=\"p-5\">\r\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">{t('calendar.agendaView.title')}</h3>\r\n            <div className=\"space-y-3\">\r\n              {(() => {\r\n                const allEvents = calendarData ? applyClientSideFilters(calendarData.events) : [];\r\n                const eventsByDate = allEvents.reduce((acc, event) => {\r\n                  const dateKey = new Date(event.date).toDateString();\r\n                  if (!acc[dateKey]) acc[dateKey] = [];\r\n                  acc[dateKey].push(event);\r\n                  return acc;\r\n                }, {} as { [key: string]: CalendarEvent[] });\r\n\r\n                return Object.entries(eventsByDate).sort((a, b) => new Date(a[0]).getTime() - new Date(b[0]).getTime()).map(([dateStr, events]) => {\r\n                  const date = new Date(dateStr);\r\n                  return (\r\n                    <div key={dateStr} className=\"border-l-2 border-border pl-3\">\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        <div className=\"text-xs font-medium text-foreground\">\r\n                          {formatDate(date, 'dateFull', language)}\r\n                        </div>\r\n                        <span className=\"px-1.5 py-0.5 bg-muted text-muted-foreground text-[10px] rounded\">\r\n                          {events.length} {events.length === 1 ? t('common.event') : t('common.events')}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"space-y-1.5\">\r\n                        {events.map((event) => (\r\n                          <div key={event.id} className=\"flex items-start gap-2 p-2 bg-accent/50 rounded hover:bg-accent transition-colors\">\r\n                            <div className=\"flex-1\">\r\n                              <div className=\"flex items-center gap-1.5 mb-1\">\r\n                                <PlatformBadge platform={event.platform} />\r\n                                <StatusBadge status={event.status} t={t} />\r\n                              </div>\r\n                              <button\r\n                                onClick={() => router.push(`/posts/${event.post_id}`)}\r\n                                className=\"text-sm text-foreground hover:text-primary text-left\"\r\n                              >\r\n                                {event.post_title}\r\n                              </button>\r\n                              <p className=\"text-xs text-muted-foreground mt-0.5 line-clamp-2\">\r\n                                {event.content}\r\n                              </p>\r\n                            </div>\r\n                            <div className=\"text-[10px] text-muted-foreground\">\r\n                              {event.scheduled_at ? formatDate(event.scheduled_at, 'timeOnly', language) :\r\n                               event.published_at ? formatDate(event.published_at, 'timeOnly', language) : '-'}\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                });\r\n              })()}\r\n              {calendarData && applyClientSideFilters(calendarData.events).length === 0 && (\r\n                <div className=\"text-center py-12 text-muted-foreground\">\r\n                  <p className=\"text-sm\">{t('calendar.agendaView.noEvents')}</p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Legend - Warm Professional: minimal */}\r\n      <div className=\"bg-card rounded-xl border border-border p-4\">\r\n        <h3 className=\"text-xs font-medium text-foreground mb-3\">{t('calendar.legend.title')}</h3>\r\n        <div className=\"flex flex-wrap gap-4\">\r\n          <div className=\"flex items-center gap-1.5\">\r\n            <div className=\"w-3 h-3 rounded bg-accent border border-border\"></div>\r\n            <span className=\"text-xs text-muted-foreground\">{t('calendar.legend.scheduled')}</span>\r\n          </div>\r\n          <div className=\"flex items-center gap-1.5\">\r\n            <div className=\"w-3 h-3 rounded bg-accent border border-border\"></div>\r\n            <span className=\"text-xs text-muted-foreground\">{t('calendar.legend.published')}</span>\r\n          </div>\r\n          <div className=\"flex items-center gap-1.5\">\r\n            <div className=\"w-3 h-3 rounded ring-1 ring-primary bg-primary/10\"></div>\r\n            <span className=\"text-xs text-muted-foreground\">{t('calendar.legend.today')}</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Event Details Modal */}\r\n      {selectedEvent && <EventModal event={selectedEvent} />}\r\n\r\n      {/* Day Events Modal */}\r\n      {dayEventsModal && <DayEventsModal day={dayEventsModal.day} events={dayEventsModal.events} />}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\app\\(dashboard)\\posts\\[id]\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchVariants' and 'router'. Either include them or remove the dependency array.","line":92,"column":6,"nodeType":"ArrayExpression","endLine":92,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [fetchVariants, id, router]","fix":{"range":[2857,2861],"text":"[fetchVariants, id, router]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":181,"column":17,"nodeType":"JSXOpeningElement","endLine":185,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n// 1. ThÃªm import 'use'\r\nimport { useEffect, useState, use } from 'react';\r\nimport Link from 'next/link';\r\nimport { useRouter } from 'next/navigation';\r\nimport { getPlatformDisplayName } from '@/lib/platforms';\r\nimport { useTranslation, formatDate } from '@/lib/i18n';\r\nimport { StatusBadge } from '../posts-ui';\r\nimport VariantList from '@/components/posts/VariantList';\r\nimport DeletePostButton from '@/components/posts/DeletePostButton';\r\nimport GenerateVariantsButton from '@/components/posts/GenerateVariantsButton';\r\nimport type { Post, Variant } from '@/lib/types';\r\nimport { buttonGroups } from '@/lib/ui/responsive';\r\n\r\ninterface PostDetailPageProps {\r\n  // 2. Cáº­p nháº­t kiá»ƒu dá»¯ liá»‡u params thÃ nh Promise\r\n  params: Promise<{\r\n    id: string;\r\n  }>;\r\n}\r\n\r\nexport default function PostDetailPage({ params }: PostDetailPageProps) {\r\n  // 3. Unwrap params báº±ng React.use()\r\n  const { id } = use(params);\r\n\r\n  const router = useRouter();\r\n  const { t, language } = useTranslation();\r\n  const [post, setPost] = useState<Post | null>(null);\r\n  const [variants, setVariants] = useState<Variant[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Separate function to fetch variants - can be called independently\r\n  const fetchVariants = async () => {\r\n    try {\r\n      const variantsRes = await fetch(`/api/posts/${id}/variants`);\r\n\r\n      if (variantsRes.ok) {\r\n        const variantsData = await variantsRes.json();\r\n        setVariants(variantsData.variants || []);\r\n      } else {\r\n        console.warn('Failed to fetch variants, continuing with empty list');\r\n        setVariants([]);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to refetch variants:', error);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    async function fetchData() {\r\n      try {\r\n        setLoading(true);\r\n        setError(null);\r\n\r\n        // Fetch post data\r\n        // 4. DÃ¹ng biáº¿n 'id' thay cho 'params.id'\r\n        const postRes = await fetch(`/api/posts/${id}`);\r\n\r\n        if (!postRes.ok) {\r\n          if (postRes.status === 404) {\r\n            setError('Post not found');\r\n            router.push('/posts');\r\n            return;\r\n          }\r\n          throw new Error(`Failed to fetch post: ${postRes.statusText}`);\r\n        }\r\n\r\n        const postData = await postRes.json();\r\n\r\n        if (!postData.post) {\r\n          setError('Post not found');\r\n          router.push('/posts');\r\n          return;\r\n        }\r\n\r\n        setPost(postData.post);\r\n\r\n        // Fetch variants data\r\n        await fetchVariants();\r\n\r\n      } catch (error) {\r\n        console.error('Failed to fetch post:', error);\r\n        setError(error instanceof Error ? error.message : 'Failed to load post');\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n\r\n    fetchData();\r\n  }, [id]);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center py-12\">\r\n        <div className=\"inline-flex items-center gap-3\">\r\n          <svg className=\"animate-spin w-5 h-5 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n            <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\r\n            <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n          </svg>\r\n          <span className=\"text-muted-foreground\">{t('common.loading')}</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error || !post) {\r\n    return (\r\n      <div className=\"flex flex-col items-center justify-center py-12\">\r\n        <div className=\"text-center\">\r\n          <h2 className=\"text-xl font-semibold text-foreground mb-2\">\r\n            {error || 'Post not found'}\r\n          </h2>\r\n          <p className=\"text-sm text-muted-foreground mb-6\">\r\n            The post you&apos;re looking for doesn&apos;t exist or has been deleted.\r\n          </p>\r\n          <Link\r\n            href=\"/posts\"\r\n            className=\"inline-flex items-center gap-2 px-4 py-2.5 bg-primary text-primary-foreground text-sm font-medium rounded-lg hover:opacity-90 transition-all\"\r\n          >\r\n            â† Back to Posts\r\n          </Link>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Calculate variant stats (client-side only, no API calls)\r\n  const variantStats = {\r\n    total: variants.length,\r\n    draft: variants.filter(v => v.status === 'draft').length,\r\n    approved: variants.filter(v => v.status === 'approved').length,\r\n    scheduled: variants.filter(v => v.status === 'scheduled').length,\r\n    published: variants.filter(v => v.status === 'published').length,\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto\">\r\n      {/* Navigation - lighter touch */}\r\n      <div className=\"mb-8\">\r\n        <Link\r\n          href=\"/posts\"\r\n          className=\"inline-flex items-center gap-2 px-3.5 py-2 text-[13px] font-medium text-muted-foreground hover:text-foreground bg-transparent hover:bg-secondary/60 rounded-lg transition-colors\"\r\n        >\r\n          <span className=\"text-muted-foreground\">â†</span>\r\n          {t('postDetail.backToPosts')}\r\n        </Link>\r\n      </div>\r\n\r\n      {/* 2-Column Layout: Main Content + Stats Sidebar */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n        {/* Main Content Column */}\r\n        <div className=\"lg:col-span-2 space-y-8\">\r\n          {/* Post Details Card */}\r\n          <div className=\"bg-card rounded-xl border border-border\">\r\n            {/* Title & Meta Header - more breathing room */}\r\n            <div className=\"px-6 py-6 border-b border-border\">\r\n              <h1 className=\"text-[22px] font-semibold text-foreground leading-tight tracking-tight\">\r\n                {post.title}\r\n              </h1>\r\n              <div className=\"flex flex-wrap items-center gap-3 mt-4 text-[13px]\">\r\n                <StatusBadge status={post.status} />\r\n                <span className=\"text-muted-foreground\">\r\n                  {t('postDetail.createdAt')} {formatDate(post.created_at, 'dateFull', language)}\r\n                </span>\r\n                {post.scheduled_time && (\r\n                  <>\r\n                    <span className=\"text-muted-foreground/50\">Â·</span>\r\n                    <span className=\"text-muted-foreground\">\r\n                      {t('postDetail.scheduledFor')} {formatDate(post.scheduled_time, 'dateTimeShort', language)}\r\n                    </span>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Cover Image - cleaner presentation */}\r\n            {post.cover_image_url && (\r\n              <div className=\"px-6 py-5 border-b border-border\">\r\n                <img\r\n                  src={post.cover_image_url}\r\n                  alt={post.title}\r\n                  className=\"w-full max-h-[400px] object-cover rounded-lg\"\r\n                />\r\n              </div>\r\n            )}\r\n\r\n            {/* Content Section - improved readability */}\r\n            <div className=\"px-6 py-6 border-b border-border\">\r\n              <h2 className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide mb-4\">\r\n                {t('postDetail.content')}\r\n              </h2>\r\n              <div className=\"bg-secondary/30 dark:bg-secondary/50 rounded-lg px-5 py-4 whitespace-pre-wrap text-[15px] text-foreground leading-[1.7]\">\r\n                {post.content}\r\n              </div>\r\n              <div className=\"mt-4 text-xs text-muted-foreground\">\r\n                {t('postDetail.characterCount')} {post.content.length.toLocaleString()}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Target Platforms - softer visual weight */}\r\n            {post.platforms && post.platforms.length > 0 && (\r\n              <div className=\"px-6 py-5 border-b border-border\">\r\n                <h2 className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide mb-3\">\r\n                  {t('postDetail.targetPlatforms')}\r\n                </h2>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {post.platforms.map((platform) => (\r\n                    <span\r\n                      key={platform}\r\n                      className=\"px-2.5 py-1 bg-secondary/60 dark:bg-secondary/80 text-foreground/80 text-xs font-medium rounded-md\"\r\n                    >\r\n                      {getPlatformDisplayName(platform)}\r\n                    </span>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Action Buttons - subtle background */}\r\n            <div className=\"px-6 py-5 bg-secondary/20 dark:bg-secondary/30 rounded-b-xl\">\r\n              <div className={`${buttonGroups.stack} ${buttonGroups.gap}`}>\r\n                <Link\r\n                  href={`/posts/${post.id}/edit`}\r\n                  className=\"w-full sm:flex-1 sm:min-w-[180px] px-5 py-2.5 bg-primary text-primary-foreground text-sm font-medium rounded-lg hover:opacity-90 transition-all text-center\"\r\n                >\r\n                  {t('postDetail.editPost')}\r\n                </Link>\r\n                <GenerateVariantsButton postId={post.id} onVariantsCreated={fetchVariants} />\r\n                <DeletePostButton postId={post.id} />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Variants Section */}\r\n          <div className=\"bg-card rounded-xl border border-border\">\r\n            <div className=\"px-6 py-5 border-b border-border\">\r\n              <h2 className=\"text-base font-semibold text-foreground\">\r\n                {t('postDetail.generatedVariants')}\r\n              </h2>\r\n              <p className=\"text-[13px] text-muted-foreground mt-1\">\r\n                {variants.length} {variants.length === 1 ? 'variant' : 'variants'} generated\r\n              </p>\r\n            </div>\r\n            <div className=\"p-6\">\r\n              <VariantList variants={variants} onVariantsUpdated={fetchVariants} />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Stats Sidebar Column - refined rhythm */}\r\n        <div className=\"lg:col-span-1\">\r\n          {/* Quick Stats Card */}\r\n          <div className=\"bg-card rounded-xl border border-border p-6 sticky top-4\">\r\n            <h3 className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide mb-5\">\r\n              Variant Statistics\r\n            </h3>\r\n\r\n            {/* Total Variants - prominent number */}\r\n            <div className=\"mb-6 pb-5 border-b border-border/60\">\r\n              <div className=\"flex items-baseline justify-between\">\r\n                <span className=\"text-[13px] text-muted-foreground\">\r\n                  Total\r\n                </span>\r\n                <span className=\"text-3xl font-semibold text-foreground tracking-tight\">\r\n                  {variantStats.total}\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Status Breakdown - calmer, less boxy */}\r\n            <div className=\"space-y-3\">\r\n              <div className=\"flex items-center justify-between py-2\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"w-2 h-2 rounded-full bg-muted-foreground/50\"></div>\r\n                  <span className=\"text-[13px] text-foreground/80\">Draft</span>\r\n                </div>\r\n                <span className=\"text-[15px] font-medium text-foreground tabular-nums\">\r\n                  {variantStats.draft}\r\n                </span>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between py-2\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"w-2 h-2 rounded-full bg-foreground/50\"></div>\r\n                  <span className=\"text-[13px] text-foreground/80\">Approved</span>\r\n                </div>\r\n                <span className=\"text-[15px] font-medium text-foreground tabular-nums\">\r\n                  {variantStats.approved}\r\n                </span>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between py-2\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"w-2 h-2 rounded-full\" style={{ background: 'hsl(var(--warm-accent))' }}></div>\r\n                  <span className=\"text-[13px] text-foreground/80\">Scheduled</span>\r\n                </div>\r\n                <span className=\"text-[15px] font-medium text-foreground tabular-nums\">\r\n                  {variantStats.scheduled}\r\n                </span>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between py-2\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"w-2 h-2 rounded-full bg-foreground\"></div>\r\n                  <span className=\"text-[13px] text-foreground/80\">Published</span>\r\n                </div>\r\n                <span className=\"text-[15px] font-medium text-foreground tabular-nums\">\r\n                  {variantStats.published}\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Progress Indicator - refined */}\r\n            {variantStats.total > 0 && (\r\n              <div className=\"mt-6 pt-5 border-t border-border/60\">\r\n                <div className=\"flex items-baseline justify-between mb-3\">\r\n                  <span className=\"text-[13px] text-muted-foreground\">\r\n                    Completion\r\n                  </span>\r\n                  <span className=\"text-lg font-semibold text-foreground tabular-nums\">\r\n                    {Math.round((variantStats.published / variantStats.total) * 100)}%\r\n                  </span>\r\n                </div>\r\n                <div className=\"w-full bg-secondary/60 dark:bg-secondary rounded-full h-1\">\r\n                  <div\r\n                    className=\"bg-foreground/70 h-1 rounded-full transition-all\"\r\n                    style={{\r\n                      width: `${Math.round((variantStats.published / variantStats.total) * 100)}%`,\r\n                    }}\r\n                  />\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground mt-3\">\r\n                  {variantStats.published} of {variantStats.total} published\r\n                </p>\r\n              </div>\r\n            )}\r\n\r\n            {/* Quick Actions - lighter */}\r\n            <div className={`mt-6 pt-5 border-t border-border/60 ${buttonGroups.stack} ${buttonGroups.gap}`}>\r\n              <Link\r\n                href=\"/posts\"\r\n                className=\"w-full px-4 py-2 text-center text-[13px] font-medium text-muted-foreground hover:text-foreground bg-transparent border border-border/60 rounded-lg hover:bg-secondary/50 transition-colors\"\r\n              >\r\n                â† All Posts\r\n              </Link>\r\n              <Link\r\n                href={`/posts/${post.id}/edit`}\r\n                className=\"w-full px-4 py-2 text-center text-[13px] font-medium bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-all\"\r\n              >\r\n                Edit Post\r\n              </Link>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\app\\(dashboard)\\studio\\components\\FallingLEffect.tsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":43,"column":5,"severity":1,"nodeType":null,"fix":{"range":[1481,1592],"text":" "}}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\FallingLEffect.tsx:42:5\n  40 |\n  41 |     // eslint-disable-next-line react-hooks/set-state-in-effect -- Animation trigger requires immediate state setup\n> 42 |     setParticles(newParticles);\n     |     ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  43 |     // eslint-disable-next-line react-hooks/set-state-in-effect -- Animation trigger requires immediate state setup\n  44 |     setIsAnimating(true);\n  45 |","line":42,"column":5,"nodeType":null,"endLine":42,"endColumn":17,"suppressions":[{"kind":"directive","justification":"Animation trigger requires immediate state setup"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"'use client';\r\n\r\n// ============================================\r\n// Falling L Effect Component\r\n// ============================================\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport type { LParticle } from '@/types/studio';\r\n\r\ninterface FallingLEffectProps {\r\n  trigger: number; // Increment this to trigger animation\r\n  duration?: number; // Total duration in ms\r\n  particleCount?: number; // Number of L particles\r\n}\r\n\r\nexport default function FallingLEffect({\r\n  trigger,\r\n  duration = 3000,\r\n  particleCount = 25,\r\n}: FallingLEffectProps) {\r\n  const [particles, setParticles] = useState<LParticle[]>([]);\r\n  const [isAnimating, setIsAnimating] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (trigger === 0) return; // Don't animate on initial mount\r\n\r\n    // Generate particles\r\n    const newParticles: LParticle[] = Array.from(\r\n      { length: particleCount },\r\n      (_, i) => ({\r\n        id: `l-${trigger}-${i}`,\r\n        x: Math.random() * 100, // 0-100%\r\n        delay: Math.random() * 1000, // 0-1000ms\r\n        size: 12 + Math.random() * 20, // 12-32px (smaller)\r\n        duration: 2500 + Math.random() * 2000, // 2500-4500ms (slower fall)\r\n        opacity: 0.3 + Math.random() * 0.3, // 0.3-0.6 (subtler)\r\n        rotation: -15 + Math.random() * 30, // -15 to 15 degrees\r\n      })\r\n    );\r\n\r\n    // eslint-disable-next-line react-hooks/set-state-in-effect -- Animation trigger requires immediate state setup\r\n    setParticles(newParticles);\r\n    // eslint-disable-next-line react-hooks/set-state-in-effect -- Animation trigger requires immediate state setup\r\n    setIsAnimating(true);\r\n\r\n    // Cleanup after animation completes\r\n    const timer = setTimeout(() => {\r\n      setIsAnimating(false);\r\n      setParticles([]);\r\n    }, duration);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [trigger, duration, particleCount]);\r\n\r\n  if (!isAnimating) return null;\r\n\r\n  return (\r\n    <div\r\n      className=\"fixed inset-0 pointer-events-none z-[9999] overflow-hidden\"\r\n      aria-hidden=\"true\"\r\n    >\r\n      {particles.map((particle) => (\r\n        <div\r\n          key={particle.id}\r\n          className=\"absolute animate-fall-and-fade\"\r\n          style={{\r\n            left: `${particle.x}%`,\r\n            top: '-50px',\r\n            fontSize: `${particle.size}px`,\r\n            animationDelay: `${particle.delay}ms`,\r\n            animationDuration: `${particle.duration}ms`,\r\n            opacity: particle.opacity,\r\n            ['--rotate-end' as string]: `${particle.rotation}deg`,\r\n          }}\r\n        >\r\n          <span\r\n            className=\"font-bold bg-gradient-to-br from-blue-500 to-blue-700 bg-clip-text text-transparent\"\r\n            style={{\r\n              textShadow: '0 2px 8px rgba(59, 130, 246, 0.3)',\r\n              filter: 'drop-shadow(0 2px 8px rgba(59, 130, 246, 0.3))',\r\n            }}\r\n          >\r\n            L\r\n          </span>\r\n        </div>\r\n      ))}\r\n\r\n      {/* Inline styles for animation */}\r\n      <style jsx>{`\r\n        @keyframes fall-and-fade {\r\n          0% {\r\n            transform: translateY(0) rotate(0deg);\r\n            opacity: 1;\r\n          }\r\n          100% {\r\n            transform: translateY(calc(100vh + 50px)) rotate(var(--rotate-end));\r\n            opacity: 0;\r\n          }\r\n        }\r\n\r\n        .animate-fall-and-fade {\r\n          animation: fall-and-fade forwards;\r\n          animation-timing-function: ease-in;\r\n        }\r\n      `}</style>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\app\\(dashboard)\\studio\\components\\PromptExplorer.tsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":118,"column":7,"severity":1,"nodeType":null,"fix":{"range":[3744,3837],"text":" "}},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":120,"column":7,"severity":1,"nodeType":null,"fix":{"range":[3880,3973],"text":" "}}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\PromptExplorer.tsx:117:7\n  115 |     if (isOpen) {\n  116 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset filters when modal opens\n> 117 |       setSearchQuery('');\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  118 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset filters when modal opens\n  119 |       setSelectedCategory('all');\n  120 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset filters when modal opens","line":117,"column":7,"nodeType":null,"endLine":117,"endColumn":21,"suppressions":[{"kind":"directive","justification":"Reset filters when modal opens"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\PromptExplorer.tsx:144:5\n  142 |   useEffect(() => {\n  143 |     // eslint-disable-next-line react-hooks/set-state-in-effect -- Derived state reset when category changes\n> 144 |     setSelectedUseCase('all');\n      |     ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  145 |   }, [selectedCategory]);\n  146 |\n  147 |   // Filter cards","line":144,"column":5,"nodeType":null,"endLine":144,"endColumn":23,"suppressions":[{"kind":"directive","justification":"Derived state reset when category changes"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":2,"source":"'use client';\r\n\r\n// ============================================\r\n// PromptExplorer - Browse All Prompts Modal\r\n// ============================================\r\n// Modal for discovering and filtering the full prompt library.\r\n// Opens via \"KhÃ¡m phÃ¡ prompt\" link from PromptGrid.\r\n//\r\n// UX PHILOSOPHY:\r\n// - Intent-driven: \"What do you want to do?\" not \"Filter database\"\r\n// - Beginner-friendly: guidance text, simple language\r\n// - Calm, editorial feel - suggestions, not configuration\r\n//\r\n// FLOW:\r\n// User clicks card in Explorer â†’ closes Explorer â†’ opens PromptSheet\r\n// ============================================\r\n\r\nimport { useState, useEffect, useRef, useMemo } from 'react';\r\nimport {\r\n  PROMPT_CARDS,\r\n  type PromptCardData,\r\n  type PromptCategory,\r\n} from '@/lib/studio/promptLibrary';\r\nimport PromptCard from './PromptCard';\r\nimport { Icon } from '@/components/ui/Icon';\r\n\r\ninterface PromptExplorerProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onSelectCard: (card: PromptCardData) => void;\r\n}\r\n\r\n// ============================================\r\n// Intent-driven Category Labels (user language, not technical)\r\n// ============================================\r\nconst INTENT_LABELS: Record<PromptCategory, string> = {\r\n  social: 'Viáº¿t cho máº¡ng xÃ£ há»™i',\r\n  sales: 'BÃ¡n hÃ ng',\r\n  email: 'Viáº¿t email',\r\n  seo: 'Viáº¿t Ä‘á»ƒ lÃªn Google',\r\n  video: 'Viáº¿t cho video',\r\n  brand: 'XÃ¢y thÆ°Æ¡ng hiá»‡u',\r\n  strategy: 'Láº­p káº¿ hoáº¡ch',\r\n};\r\n\r\n// Order categories by common usage\r\nconst CATEGORY_ORDER: PromptCategory[] = [\r\n  'social',\r\n  'sales',\r\n  'video',\r\n  'seo',\r\n  'email',\r\n  'brand',\r\n  'strategy',\r\n];\r\n\r\n// ============================================\r\n// Use Cases - Limited to 5 most common per category\r\n// ============================================\r\nconst USE_CASES_BY_CATEGORY: Record<PromptCategory, { id: string; label: string }[]> = {\r\n  social: [\r\n    { id: 'caption', label: 'Caption' },\r\n    { id: 'hook', label: 'Hook má»Ÿ Ä‘áº§u' },\r\n    { id: 'cta', label: 'KÃªu gá»i hÃ nh Ä‘á»™ng' },\r\n    { id: 'engagement', label: 'Táº¡o tÆ°Æ¡ng tÃ¡c' },\r\n    { id: 'story', label: 'Ká»ƒ chuyá»‡n' },\r\n  ],\r\n  sales: [\r\n    { id: 'product', label: 'MÃ´ táº£ sáº£n pháº©m' },\r\n    { id: 'cta', label: 'KÃªu gá»i mua' },\r\n    { id: 'benefit', label: 'Lá»£i Ã­ch' },\r\n    { id: 'urgency', label: 'Táº¡o khan hiáº¿m' },\r\n  ],\r\n  email: [\r\n    { id: 'promo', label: 'Khuyáº¿n mÃ£i' },\r\n    { id: 'newsletter', label: 'Báº£n tin' },\r\n    { id: 'outreach', label: 'Tiáº¿p cáº­n má»›i' },\r\n    { id: 'followup', label: 'Nháº¯c nhá»Ÿ' },\r\n  ],\r\n  seo: [\r\n    { id: 'blog', label: 'BÃ i blog' },\r\n    { id: 'meta', label: 'Meta & Title' },\r\n    { id: 'product', label: 'MÃ´ táº£ sáº£n pháº©m' },\r\n    { id: 'local', label: 'Äá»‹a phÆ°Æ¡ng' },\r\n  ],\r\n  video: [\r\n    { id: 'script', label: 'Ká»‹ch báº£n' },\r\n    { id: 'hook', label: 'Hook 3 giÃ¢y' },\r\n    { id: 'cta', label: 'Káº¿t video' },\r\n  ],\r\n  brand: [\r\n    { id: 'tagline', label: 'Slogan' },\r\n    { id: 'story', label: 'CÃ¢u chuyá»‡n' },\r\n    { id: 'about', label: 'Giá»›i thiá»‡u' },\r\n  ],\r\n  strategy: [\r\n    { id: 'calendar', label: 'Lá»‹ch ná»™i dung' },\r\n    { id: 'analysis', label: 'PhÃ¢n tÃ­ch' },\r\n    { id: 'planning', label: 'LÃªn Ã½ tÆ°á»Ÿng' },\r\n  ],\r\n};\r\n\r\nexport default function PromptExplorer({\r\n  isOpen,\r\n  onClose,\r\n  onSelectCard,\r\n}: PromptExplorerProps) {\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n  const [selectedCategory, setSelectedCategory] = useState<PromptCategory | 'all'>('all');\r\n  const [selectedUseCase, setSelectedUseCase] = useState<string>('all');\r\n  const searchInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Reset filters when opening\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset filters when modal opens\r\n      setSearchQuery('');\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset filters when modal opens\r\n      setSelectedCategory('all');\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset filters when modal opens\r\n      setSelectedUseCase('all');\r\n      // Focus search input after animation\r\n      const timer = setTimeout(() => {\r\n        searchInputRef.current?.focus();\r\n      }, 150);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [isOpen]);\r\n\r\n  // Handle escape key\r\n  useEffect(() => {\r\n    const handleEscape = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape' && isOpen) {\r\n        onClose();\r\n      }\r\n    };\r\n    window.addEventListener('keydown', handleEscape);\r\n    return () => window.removeEventListener('keydown', handleEscape);\r\n  }, [isOpen, onClose]);\r\n\r\n  // Reset use case when category changes\r\n  useEffect(() => {\r\n    // eslint-disable-next-line react-hooks/set-state-in-effect -- Derived state reset when category changes\r\n    setSelectedUseCase('all');\r\n  }, [selectedCategory]);\r\n\r\n  // Filter cards\r\n  const filteredCards = useMemo(() => {\r\n    let result = PROMPT_CARDS;\r\n\r\n    // Category filter\r\n    if (selectedCategory !== 'all') {\r\n      result = result.filter(card => card.category === selectedCategory);\r\n    }\r\n\r\n    // Use case filter (simple keyword matching in title/description)\r\n    if (selectedUseCase !== 'all' && selectedCategory !== 'all') {\r\n      const useCaseKeywords: Record<string, string[]> = {\r\n        // Social\r\n        caption: ['caption', 'bÃ i Ä‘Äƒng', 'post'],\r\n        hook: ['hook', 'thu hÃºt'],\r\n        cta: ['cta', 'kÃªu gá»i'],\r\n        story: ['story', 'ká»ƒ chuyá»‡n'],\r\n        engagement: ['tÆ°Æ¡ng tÃ¡c', 'comment', 'cÃ¢u há»i'],\r\n        // Sales\r\n        product: ['sáº£n pháº©m', 'product', 'mÃ´ táº£'],\r\n        urgency: ['khan hiáº¿m', 'urgency', 'flash'],\r\n        benefit: ['lá»£i Ã­ch', 'benefit'],\r\n        // Email\r\n        promo: ['khuyáº¿n mÃ£i', 'promo'],\r\n        newsletter: ['newsletter', 'báº£n tin'],\r\n        outreach: ['cold', 'outreach', 'tiáº¿p cáº­n'],\r\n        followup: ['follow', 'nháº¯c'],\r\n        // SEO\r\n        blog: ['blog', 'bÃ i viáº¿t', 'má»Ÿ bÃ i'],\r\n        meta: ['meta', 'description'],\r\n        local: ['local', 'Ä‘á»‹a phÆ°Æ¡ng'],\r\n        // Video\r\n        script: ['script', 'ká»‹ch báº£n'],\r\n        // Brand\r\n        tagline: ['tagline', 'slogan'],\r\n        about: ['about', 'giá»›i thiá»‡u'],\r\n        // Strategy\r\n        calendar: ['calendar', 'lá»‹ch'],\r\n        analysis: ['phÃ¢n tÃ­ch', 'analysis', 'competitor'],\r\n        planning: ['káº¿ hoáº¡ch', 'plan', 'pillar'],\r\n      };\r\n\r\n      const keywords = useCaseKeywords[selectedUseCase] || [];\r\n      if (keywords.length > 0) {\r\n        result = result.filter(card => {\r\n          const text = `${card.title} ${card.description}`.toLowerCase();\r\n          return keywords.some(kw => text.includes(kw.toLowerCase()));\r\n        });\r\n      }\r\n    }\r\n\r\n    // Search filter\r\n    if (searchQuery.trim()) {\r\n      const query = searchQuery.toLowerCase().trim();\r\n      result = result.filter(card => {\r\n        const text = `${card.title} ${card.description} ${card.platform || ''}`.toLowerCase();\r\n        return text.includes(query);\r\n      });\r\n    }\r\n\r\n    return result;\r\n  }, [selectedCategory, selectedUseCase, searchQuery]);\r\n\r\n  // Get available use cases for current category\r\n  const availableUseCases = selectedCategory !== 'all'\r\n    ? USE_CASES_BY_CATEGORY[selectedCategory]\r\n    : [];\r\n\r\n  // Handle card selection\r\n  const handleCardClick = (card: PromptCardData) => {\r\n    onClose();\r\n    // Small delay to allow close animation\r\n    setTimeout(() => {\r\n      onSelectCard(card);\r\n    }, 100);\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop */}\r\n      <div\r\n        className=\"fixed inset-0 z-40 bg-black/20 dark:bg-black/40 backdrop-blur-[2px] animate-[fadeIn_0.2s_ease-out]\"\r\n        onClick={onClose}\r\n        aria-hidden=\"true\"\r\n      />\r\n\r\n      {/* Modal Container */}\r\n      <div className=\"fixed inset-x-0 bottom-0 sm:inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 animate-[slideUp_0.3s_cubic-bezier(0.16,1,0.3,1)] sm:animate-[fadeIn_0.2s_ease-out]\">\r\n        <div\r\n          className=\"w-full sm:max-w-2xl bg-white dark:bg-zinc-900 rounded-t-[20px] sm:rounded-[16px] shadow-2xl max-h-[90vh] sm:max-h-[80vh] overflow-hidden flex flex-col\"\r\n          role=\"dialog\"\r\n          aria-modal=\"true\"\r\n          aria-labelledby=\"explorer-title\"\r\n        >\r\n          {/* Header */}\r\n          <div className=\"flex-shrink-0 px-5 sm:px-6 pt-4 pb-4 border-b border-zinc-100 dark:border-zinc-800\">\r\n            {/* Drag handle - mobile only */}\r\n            <div className=\"flex justify-center mb-3 sm:hidden\">\r\n              <div className=\"w-10 h-1 rounded-full bg-zinc-200 dark:bg-zinc-700\" />\r\n            </div>\r\n\r\n            {/* Close button - top right */}\r\n            <div className=\"flex justify-end mb-2\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={onClose}\r\n                className=\"p-1.5 -mr-1.5 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors\"\r\n                aria-label=\"ÄÃ³ng\"\r\n              >\r\n                <Icon name=\"close\" size={18} />\r\n              </button>\r\n            </div>\r\n\r\n            {/* Guidance layer - conversational, intent-driven */}\r\n            <div className=\"mb-4\">\r\n              <h2\r\n                id=\"explorer-title\"\r\n                className=\"text-[17px] font-medium text-zinc-900 dark:text-zinc-100 mb-1\"\r\n              >\r\n                Báº¡n muá»‘n viáº¿t gÃ¬ hÃ´m nay?\r\n              </h2>\r\n              <p className=\"text-[13px] text-zinc-500 dark:text-zinc-400\">\r\n                Chá»n má»¥c Ä‘Ã­ch, mÃ¬nh sáº½ gá»£i Ã½ cÃ¡ch viáº¿t phÃ¹ há»£p.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Category Filter - intent-driven labels */}\r\n            <div className=\"flex flex-wrap gap-2 mb-3\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setSelectedCategory('all')}\r\n                className={`px-3 py-1.5 text-[12px] rounded-lg border transition-all duration-150 ${\r\n                  selectedCategory === 'all'\r\n                    ? 'bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 border-transparent'\r\n                    : 'bg-transparent border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 hover:border-zinc-300 dark:hover:border-zinc-600'\r\n                }`}\r\n              >\r\n                Táº¥t cáº£\r\n              </button>\r\n              {CATEGORY_ORDER.map(cat => (\r\n                <button\r\n                  key={cat}\r\n                  type=\"button\"\r\n                  onClick={() => setSelectedCategory(cat)}\r\n                  className={`px-3 py-1.5 text-[12px] rounded-lg border transition-all duration-150 ${\r\n                    selectedCategory === cat\r\n                      ? 'bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 border-transparent'\r\n                      : 'bg-transparent border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 hover:border-zinc-300 dark:hover:border-zinc-600'\r\n                  }`}\r\n                >\r\n                  {INTENT_LABELS[cat]}\r\n                </button>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Use Case Filter - contextual, only when category selected */}\r\n            {selectedCategory !== 'all' && availableUseCases.length > 0 && (\r\n              <div className=\"flex flex-wrap gap-1.5 mb-3\">\r\n                <span className=\"text-[11px] text-zinc-400 dark:text-zinc-500 mr-1 py-1\">\r\n                  Cá»¥ thá»ƒ hÆ¡n:\r\n                </span>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setSelectedUseCase('all')}\r\n                  className={`px-2.5 py-1 text-[11px] rounded-md transition-colors ${\r\n                    selectedUseCase === 'all'\r\n                      ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-200'\r\n                      : 'text-zinc-500 dark:text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'\r\n                  }`}\r\n                >\r\n                  Táº¥t cáº£\r\n                </button>\r\n                {availableUseCases.map(uc => (\r\n                  <button\r\n                    key={uc.id}\r\n                    type=\"button\"\r\n                    onClick={() => setSelectedUseCase(uc.id)}\r\n                    className={`px-2.5 py-1 text-[11px] rounded-md transition-colors ${\r\n                      selectedUseCase === uc.id\r\n                        ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-200'\r\n                        : 'text-zinc-500 dark:text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'\r\n                    }`}\r\n                  >\r\n                    {uc.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Search - tertiary, subtle, clearly optional */}\r\n            <div className=\"relative\">\r\n              <Icon\r\n                name=\"search\"\r\n                size={14}\r\n                className=\"absolute left-3 top-1/2 -translate-y-1/2 text-zinc-300 dark:text-zinc-600\"\r\n              />\r\n              <input\r\n                ref={searchInputRef}\r\n                type=\"text\"\r\n                value={searchQuery}\r\n                onChange={(e) => setSearchQuery(e.target.value)}\r\n                placeholder=\"Hoáº·c gÃµ tá»« khÃ³a báº¥t ká»³...\"\r\n                className=\"w-full pl-8 pr-4 py-2 text-[13px] text-zinc-900 dark:text-zinc-100 placeholder:text-zinc-300 dark:placeholder:text-zinc-600 bg-zinc-50/50 dark:bg-zinc-800/30 border border-zinc-200/40 dark:border-zinc-700/30 rounded-lg focus:outline-none focus:ring-1 focus:ring-zinc-300 dark:focus:ring-zinc-600 focus:border-transparent focus:bg-zinc-50 dark:focus:bg-zinc-800/40 transition-all duration-150\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Cards Grid - scrollable */}\r\n          <div className=\"flex-1 overflow-y-auto px-5 sm:px-6 py-4\">\r\n            {filteredCards.length === 0 ? (\r\n              <div className=\"text-center py-12\">\r\n                <p className=\"text-[13px] text-zinc-500 dark:text-zinc-400 mb-2\">\r\n                  ChÆ°a cÃ³ gá»£i Ã½ nÃ o khá»›p\r\n                </p>\r\n                <p className=\"text-[12px] text-zinc-400 dark:text-zinc-500 mb-3\">\r\n                  Thá»­ chá»n má»¥c Ä‘Ã­ch khÃ¡c hoáº·c xÃ³a bá»™ lá»c\r\n                </p>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    setSelectedCategory('all');\r\n                    setSelectedUseCase('all');\r\n                    setSearchQuery('');\r\n                  }}\r\n                  className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-[12px] text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300 border border-zinc-200 dark:border-zinc-700 rounded-lg hover:border-zinc-300 dark:hover:border-zinc-600 transition-colors\"\r\n                >\r\n                  Xem táº¥t cáº£ gá»£i Ã½\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <>\r\n                {/* Result count - subtle */}\r\n                <div className=\"flex items-center justify-between mb-3\">\r\n                  <p className=\"text-[11px] text-zinc-400 dark:text-zinc-500\">\r\n                    {filteredCards.length} gá»£i Ã½\r\n                  </p>\r\n                  {selectedCategory !== 'all' && (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        setSelectedCategory('all');\r\n                        setSelectedUseCase('all');\r\n                      }}\r\n                      className=\"text-[11px] text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-400\"\r\n                    >\r\n                      Xem táº¥t cáº£\r\n                    </button>\r\n                  )}\r\n                </div>\r\n                <div className=\"grid gap-2.5 grid-cols-1 sm:grid-cols-2\">\r\n                  {filteredCards.map((card) => (\r\n                    <PromptCard\r\n                      key={card.id}\r\n                      card={card}\r\n                      onSelect={handleCardClick}\r\n                    />\r\n                  ))}\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\app\\(dashboard)\\studio\\components\\PromptGrid.tsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":84,"column":7,"severity":1,"nodeType":null,"fix":{"range":[3430,3524],"text":" "}}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\PromptGrid.tsx:58:7\n  56 |     if (editorValue.trim().length > 0 || assistantCount > 0) {\n  57 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- One-way state transition based on external data\n> 58 |       setHasInteracted(true);\n     |       ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  59 |     }\n  60 |   }, [editorValue, assistantCount]);\n  61 |","line":58,"column":7,"nodeType":null,"endLine":58,"endColumn":23,"suppressions":[{"kind":"directive","justification":"One-way state transition based on external data"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\PromptGrid.tsx:83:7\n  81 |     if (assistantCount > prevAssistantCountRef.current) {\n  82 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Auto-collapse on new AI response\n> 83 |       setIsCollapsed(true);\n     |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  84 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Track that we've auto-collapsed\n  85 |       setHasAutoCollapsed(true);\n  86 |     }","line":83,"column":7,"nodeType":null,"endLine":83,"endColumn":21,"suppressions":[{"kind":"directive","justification":"Auto-collapse on new AI response"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"'use client';\r\n\r\n// ============================================\r\n// PromptGrid - 1-Click Prompts Grid (v1)\r\n// ============================================\r\n// Displays 6-8 featured prompt cards above editor.\r\n// Secondary layer that helps users start quickly.\r\n//\r\n// VISIBILITY RULES:\r\n// 1. Empty editor â†’ opacity 100%\r\n// 2. User typing (>20 chars) â†’ fade to 40%\r\n// 3. After first AI result â†’ auto-collapse (user can expand)\r\n// 4. ALWAYS visible by default for new users (beginner-friendly)\r\n//\r\n// STEP 4.5: Adaptive Silence\r\n// - Hide top guidance text after any user interaction\r\n// - Grid becomes silent option set, not suggestion panel\r\n// ============================================\r\n\r\nimport { useState, useEffect, useRef, useMemo } from 'react';\r\nimport { getFeaturedCards, type PromptCardData } from '@/lib/studio/promptLibrary';\r\nimport PromptCard from './PromptCard';\r\nimport { Icon } from '@/components/ui/Icon';\r\n// STEP 5: Soft preference memory for category affinity\r\nimport { getCategoryAffinity } from '@/lib/studio/preferenceMemory';\r\n\r\ninterface PromptGridProps {\r\n  editorValue: string;\r\n  assistantCount: number; // Monotonic count of assistant messages\r\n  onSelectCard: (card: PromptCardData) => void;\r\n  onOpenExplorer: () => void;\r\n}\r\n\r\nconst FADE_THRESHOLD = 20;\r\n\r\nexport default function PromptGrid({\r\n  editorValue,\r\n  assistantCount,\r\n  onSelectCard,\r\n  onOpenExplorer,\r\n}: PromptGridProps) {\r\n  // Collapsed state - ALWAYS start expanded for beginner-friendly UX\r\n  // Only collapse after user manually collapses OR after first NEW AI result\r\n  const [isCollapsed, setIsCollapsed] = useState(false);\r\n  const [hasAutoCollapsed, setHasAutoCollapsed] = useState(false);\r\n  // STEP 4.5: Track if user has interacted (hide guidance permanently)\r\n  const [hasInteracted, setHasInteracted] = useState(false);\r\n\r\n  // Track previous assistant count to detect NEW responses (increments)\r\n  // Using count instead of boolean allows detecting new messages even when history exists\r\n  const prevAssistantCountRef = useRef(assistantCount);\r\n  const isFirstRenderRef = useRef(true);\r\n\r\n  // STEP 4.5: Mark as interacted when user types or has AI results\r\n  useEffect(() => {\r\n    if (editorValue.trim().length > 0 || assistantCount > 0) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- One-way state transition based on external data\r\n      setHasInteracted(true);\r\n    }\r\n  }, [editorValue, assistantCount]);\r\n\r\n  // Auto-collapse when assistant count INCREASES after first render\r\n  // IMPORTANT: Ignore persisted assistant messages on mount; collapse only when\r\n  // a NEW assistant message arrives during this session.\r\n  useEffect(() => {\r\n    // Skip first render - we never auto-collapse on mount (regardless of persisted history)\r\n    if (isFirstRenderRef.current) {\r\n      isFirstRenderRef.current = false;\r\n      prevAssistantCountRef.current = assistantCount;\r\n      return;\r\n    }\r\n\r\n    // Skip if already collapsed or already auto-collapsed\r\n    if (isCollapsed || hasAutoCollapsed) {\r\n      // Still update ref to track count\r\n      prevAssistantCountRef.current = assistantCount;\r\n      return;\r\n    }\r\n\r\n    // Collapse when count increases (new AI response arrived)\r\n    if (assistantCount > prevAssistantCountRef.current) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Auto-collapse on new AI response\r\n      setIsCollapsed(true);\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Track that we've auto-collapsed\r\n      setHasAutoCollapsed(true);\r\n    }\r\n\r\n    // Always update ref for next comparison\r\n    prevAssistantCountRef.current = assistantCount;\r\n  }, [assistantCount, isCollapsed, hasAutoCollapsed]);\r\n\r\n  // Toggle collapse state (no localStorage - fresh each session for better UX)\r\n  const handleToggleCollapse = () => {\r\n    setIsCollapsed(!isCollapsed);\r\n  };\r\n\r\n  // Visibility logic: fade to 40% when >20 chars\r\n  const charCount = editorValue.trim().length;\r\n  const shouldFade = charCount > FADE_THRESHOLD;\r\n\r\n  // Get featured cards (6-8 cards only in v1)\r\n  const baseFeaturedCards = getFeaturedCards();\r\n\r\n  // STEP 5: Apply subtle category affinity - move preferred categories up by 1 position\r\n  // This creates a \"slightly more familiar\" feel without dramatic reordering\r\n  const featuredCards = useMemo(() => {\r\n    const affinity = getCategoryAffinity();\r\n    if (affinity.length === 0) return baseFeaturedCards;\r\n\r\n    // Get the top preferred category\r\n    const preferredCategory = affinity[0];\r\n\r\n    // Find cards in preferred category\r\n    const preferred: PromptCardData[] = [];\r\n    const others: PromptCardData[] = [];\r\n\r\n    for (const card of baseFeaturedCards) {\r\n      if (card.category === preferredCategory) {\r\n        preferred.push(card);\r\n      } else {\r\n        others.push(card);\r\n      }\r\n    }\r\n\r\n    // Subtle reorder: move ONE preferred card to position 1 (after first card)\r\n    // This keeps the grid feeling natural, not optimized\r\n    if (preferred.length > 0 && others.length > 1) {\r\n      const [first, ...rest] = others;\r\n      return [first, preferred[0], ...rest, ...preferred.slice(1)];\r\n    }\r\n\r\n    return baseFeaturedCards;\r\n  }, [baseFeaturedCards]);\r\n\r\n  // If collapsed, show minimal expand hint\r\n  if (isCollapsed) {\r\n    return (\r\n      <div className=\"mb-3\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleToggleCollapse}\r\n          className=\"flex items-center gap-1.5 text-[12px] text-muted-foreground hover:text-foreground transition-colors duration-150\"\r\n        >\r\n          <span>Gá»£i Ã½</span>\r\n          <Icon name=\"chevronDown\" size={12} />\r\n        </button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className=\"mb-5 transition-opacity duration-200 ease-out\"\r\n      style={{ opacity: shouldFade ? 0.4 : 1 }}\r\n    >\r\n      {/* STEP 4.5: Only show guidance for brand new users, hide after any interaction */}\r\n      {!hasInteracted && (\r\n        <div className=\"mb-4 text-center\">\r\n          <p className=\"text-[13px] text-zinc-500 dark:text-zinc-400\">\r\n            MÃ´ táº£ Ã½ tÆ°á»Ÿng cá»§a báº¡n.\r\n          </p>\r\n        </div>\r\n      )}\r\n\r\n      {/* STEP 4.5: Header - minimal, reduced spacing after interaction */}\r\n      <div className={`flex items-center justify-between ${hasInteracted ? 'mb-3' : 'mb-4'}`}>\r\n        <span className=\"text-[10px] font-medium text-zinc-400 dark:text-zinc-500 uppercase tracking-wide\">\r\n          Gá»£i Ã½\r\n        </span>\r\n        <div className=\"flex items-center gap-2.5\">\r\n          {/* Máº«u prompt - quieter styling */}\r\n          <button\r\n            type=\"button\"\r\n            onClick={onOpenExplorer}\r\n            className=\"text-[12px] text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring/30 rounded-sm\"\r\n            aria-label=\"Xem táº¥t cáº£ máº«u prompt\"\r\n          >\r\n            Xem thÃªm\r\n          </button>\r\n          {/* Collapse toggle */}\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleToggleCollapse}\r\n            className=\"p-1 -mr-1 text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors duration-150\"\r\n            aria-label=\"Thu gá»n\"\r\n          >\r\n            <Icon name=\"chevronUp\" size={14} />\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* STEP 4.5: Card Grid - tighter spacing after interaction */}\r\n      <div className={`grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 ${hasInteracted ? 'gap-2.5' : 'gap-3'}`}>\r\n        {featuredCards.map((card) => (\r\n          <PromptCard\r\n            key={card.id}\r\n            card={card}\r\n            onSelect={onSelectCard}\r\n          />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'activeCanon', 'language', 'refreshEditorialMode', 'rewriteConfirmedForDraftId', 'setAiError', 'setEditPatchMeta', and 'setOutputContract'. Either include them or remove the dependency array.","line":2212,"column":6,"nodeType":"ArrayExpression","endLine":2229,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [canSubmit, chatInput, activeSourceId, messages, language, isEditing, generateConfirmationHash, lastConfirmationHash, lastIntentChoice, continuityState, cancelAcceptTimer, recordOutcomeSignal, setAiError, rewriteConfirmedForDraftId, refreshEditorialMode, activeCanon, setEditPatchMeta, setOutputContract, createIntentOutcome, setActiveSource, handleSend]","fix":{"range":[82976,83369],"text":"[canSubmit, chatInput, activeSourceId, messages, language, isEditing, generateConfirmationHash, lastConfirmationHash, lastIntentChoice, continuityState, cancelAcceptTimer, recordOutcomeSignal, setAiError, rewriteConfirmedForDraftId, refreshEditorialMode, activeCanon, setEditPatchMeta, setOutputContract, createIntentOutcome, setActiveSource, handleSend]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:532:9\n  530 |       if (activated) {\n  531 |         // eslint-disable-next-line react-hooks/set-state-in-effect -- Sync editorial mode after draft activation\n> 532 |         refreshEditorialMode();\n      |         ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  533 |         if (process.env.NODE_ENV === 'development') {\n  534 |           console.log('[StudioEditor:STEP14A] Auto-activated draft:', lastAssistantMsg.id);\n  535 |         }","line":532,"column":9,"nodeType":null,"endLine":532,"endColumn":29,"suppressions":[{"kind":"directive","justification":"Sync editorial mode after draft activation"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:545:7\n  543 |       unlockEdit();\n  544 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Sync editorial mode after unlock\n> 545 |       refreshEditorialMode();\n      |       ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  546 |       if (process.env.NODE_ENV === 'development') {\n  547 |         console.log('[StudioEditor:STEP14A] Edit unlocked after AI response');\n  548 |       }","line":545,"column":7,"nodeType":null,"endLine":545,"endColumn":27,"suppressions":[{"kind":"directive","justification":"Sync editorial mode after unlock"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:558:7\n  556 |     if (rewriteConfirmedForDraftId && rewriteConfirmedForDraftId !== currentDraftId) {\n  557 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset confirmation on draft change\n> 558 |       setRewriteConfirmedForDraftId(null);\n      |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  559 |       if (process.env.NODE_ENV === 'development') {\n  560 |         console.log('[StudioEditor:STEP27] Reset rewrite confirmation - draft changed', {\n  561 |           was: rewriteConfirmedForDraftId,","line":558,"column":7,"nodeType":null,"endLine":558,"endColumn":36,"suppressions":[{"kind":"directive","justification":"Reset confirmation on draft change"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:572:7\n  570 |     if (messages.length === 0 && rewriteConfirmedForDraftId) {\n  571 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset confirmation on clear\n> 572 |       setRewriteConfirmedForDraftId(null);\n      |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  573 |       if (process.env.NODE_ENV === 'development') {\n  574 |         console.log('[StudioEditor:STEP27] Reset rewrite confirmation - messages cleared');\n  575 |       }","line":572,"column":7,"nodeType":null,"endLine":572,"endColumn":36,"suppressions":[{"kind":"directive","justification":"Reset confirmation on clear"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:641:7\n  639 |     if (!hasActiveDraft()) {\n  640 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset canon when draft deactivated\n> 641 |       setActiveCanon(null);\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  642 |       return;\n  643 |     }\n  644 |","line":641,"column":7,"nodeType":null,"endLine":641,"endColumn":21,"suppressions":[{"kind":"directive","justification":"Reset canon when draft deactivated"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:681:7\n  679 |     if (!hasActiveDraft()) {\n  680 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset intent canon when draft deactivated\n> 681 |       setActiveIntentCanon(null);\n      |       ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  682 |       return;\n  683 |     }\n  684 |","line":681,"column":7,"nodeType":null,"endLine":681,"endColumn":27,"suppressions":[{"kind":"directive","justification":"Reset intent canon when draft deactivated"}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:864:7\n  862 |     if (timeRemaining <= 0) {\n  863 |       // eslint-disable-next-line react-hooks/set-state-in-effect -- Dismiss expired toast immediately\n> 864 |       setLocalEditToast(null);\n      |       ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  865 |       return;\n  866 |     }\n  867 |","line":864,"column":7,"nodeType":null,"endLine":864,"endColumn":24,"suppressions":[{"kind":"directive","justification":"Dismiss expired toast immediately"}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `language`, but the source dependencies were [canSubmit_0, chatInput, activeSourceId, messages, isEditing, editedMessageId, handleSend, setActiveSource, lastIntentChoice, lastConfirmationHash, generateConfirmationHash, createIntentOutcome, cancelAcceptTimer, recordOutcomeSignal, continuityState]. Inferred different dependency than source.\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:1623:35\n  1621 |   // ============================================\n  1622 |   // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\n> 1623 |   const attemptSend = useCallback(() => {\n       |                                   ^^^^^^^\n> 1624 |     if (!canSubmit) return;\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 1625 |\n       â€¦\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2211 |     });\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2212 |   }, [\n       | ^^^^ Could not preserve existing manual memoization\n  2213 |     canSubmit,\n  2214 |     chatInput,\n  2215 |     activeSourceId,","line":1623,"column":35,"nodeType":null,"endLine":2212,"endColumn":4,"suppressions":[{"kind":"directive","justification":"Complex callback with intentional partial deps"}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `setAiError`, but the source dependencies were [canSubmit_0, chatInput, activeSourceId, messages, isEditing, editedMessageId, handleSend, setActiveSource, lastIntentChoice, lastConfirmationHash, generateConfirmationHash, createIntentOutcome, cancelAcceptTimer, recordOutcomeSignal, continuityState]. Inferred different dependency than source.\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:1623:35\n  1621 |   // ============================================\n  1622 |   // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\n> 1623 |   const attemptSend = useCallback(() => {\n       |                                   ^^^^^^^\n> 1624 |     if (!canSubmit) return;\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 1625 |\n       â€¦\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2211 |     });\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2212 |   }, [\n       | ^^^^ Could not preserve existing manual memoization\n  2213 |     canSubmit,\n  2214 |     chatInput,\n  2215 |     activeSourceId,","line":1623,"column":35,"nodeType":null,"endLine":2212,"endColumn":4,"suppressions":[{"kind":"directive","justification":"Complex callback with intentional partial deps"}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `rewriteConfirmedForDraftId`, but the source dependencies were [canSubmit_0, chatInput, activeSourceId, messages, isEditing, editedMessageId, handleSend, setActiveSource, lastIntentChoice, lastConfirmationHash, generateConfirmationHash, createIntentOutcome, cancelAcceptTimer, recordOutcomeSignal, continuityState]. Inferred different dependency than source.\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:1623:35\n  1621 |   // ============================================\n  1622 |   // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\n> 1623 |   const attemptSend = useCallback(() => {\n       |                                   ^^^^^^^\n> 1624 |     if (!canSubmit) return;\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 1625 |\n       â€¦\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2211 |     });\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2212 |   }, [\n       | ^^^^ Could not preserve existing manual memoization\n  2213 |     canSubmit,\n  2214 |     chatInput,\n  2215 |     activeSourceId,","line":1623,"column":35,"nodeType":null,"endLine":2212,"endColumn":4,"suppressions":[{"kind":"directive","justification":"Complex callback with intentional partial deps"}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `activeCanon`, but the source dependencies were [canSubmit_0, chatInput, activeSourceId, messages, isEditing, editedMessageId, handleSend, setActiveSource, lastIntentChoice, lastConfirmationHash, generateConfirmationHash, createIntentOutcome, cancelAcceptTimer, recordOutcomeSignal, continuityState]. Inferred different dependency than source.\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:1623:35\n  1621 |   // ============================================\n  1622 |   // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\n> 1623 |   const attemptSend = useCallback(() => {\n       |                                   ^^^^^^^\n> 1624 |     if (!canSubmit) return;\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 1625 |\n       â€¦\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2211 |     });\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2212 |   }, [\n       | ^^^^ Could not preserve existing manual memoization\n  2213 |     canSubmit,\n  2214 |     chatInput,\n  2215 |     activeSourceId,","line":1623,"column":35,"nodeType":null,"endLine":2212,"endColumn":4,"suppressions":[{"kind":"directive","justification":"Complex callback with intentional partial deps"}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `setEditPatchMeta`, but the source dependencies were [canSubmit_0, chatInput, activeSourceId, messages, isEditing, editedMessageId, handleSend, setActiveSource, lastIntentChoice, lastConfirmationHash, generateConfirmationHash, createIntentOutcome, cancelAcceptTimer, recordOutcomeSignal, continuityState]. Inferred different dependency than source.\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:1623:35\n  1621 |   // ============================================\n  1622 |   // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\n> 1623 |   const attemptSend = useCallback(() => {\n       |                                   ^^^^^^^\n> 1624 |     if (!canSubmit) return;\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 1625 |\n       â€¦\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2211 |     });\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2212 |   }, [\n       | ^^^^ Could not preserve existing manual memoization\n  2213 |     canSubmit,\n  2214 |     chatInput,\n  2215 |     activeSourceId,","line":1623,"column":35,"nodeType":null,"endLine":2212,"endColumn":4,"suppressions":[{"kind":"directive","justification":"Complex callback with intentional partial deps"}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `setOutputContract`, but the source dependencies were [canSubmit_0, chatInput, activeSourceId, messages, isEditing, editedMessageId, handleSend, setActiveSource, lastIntentChoice, lastConfirmationHash, generateConfirmationHash, createIntentOutcome, cancelAcceptTimer, recordOutcomeSignal, continuityState]. Inferred different dependency than source.\n\nE:\\Content Machine\\app\\(dashboard)\\studio\\components\\StudioEditor.tsx:1623:35\n  1621 |   // ============================================\n  1622 |   // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\n> 1623 |   const attemptSend = useCallback(() => {\n       |                                   ^^^^^^^\n> 1624 |     if (!canSubmit) return;\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 1625 |\n       â€¦\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2211 |     });\n       | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 2212 |   }, [\n       | ^^^^ Could not preserve existing manual memoization\n  2213 |     canSubmit,\n  2214 |     chatInput,\n  2215 |     activeSourceId,","line":1623,"column":35,"nodeType":null,"endLine":2212,"endColumn":4,"suppressions":[{"kind":"directive","justification":"Complex callback with intentional partial deps"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n// ============================================\r\n// StudioEditor - Calm Writing Surface\r\n// ============================================\r\n// DESIGN PHILOSOPHY: A writing surface, not a tool\r\n// - User starts typing immediately\r\n// - AI is a quiet background presence\r\n// - Options feel optional, not required\r\n//\r\n// LAYOUT: ChatGPT-like viewport-based\r\n// - Messages in scrollable container (flex-1)\r\n// - Input fixed at bottom (flex-shrink-0)\r\n// - PromptGrid shows in messages area when empty\r\n//\r\n// 3 STATES ONLY:\r\n// 1. Empty / short input â†’ invitation\r\n// 2. Typing â†’ acknowledgment\r\n// 3. Has results â†’ refinement offer\r\n//\r\n// VISUAL RULES:\r\n// - No icons in hints (too playful)\r\n// - No decorative dividers (too heavy)\r\n// - Send button is the ONLY strong action\r\n// - Everything else is secondary and quiet\r\n//\r\n// ============================================\r\n// STEP 6.5: UX Intent Confirmation\r\n// ============================================\r\n// When ambiguity is high (user editing + short transform instruction),\r\n// show confirmation UI to clarify intent before sending.\r\n// This prevents \"AI misunderstood\" situations.\r\n// ============================================\r\n\r\nimport React, { useState, useRef, useEffect, useCallback, useMemo } from 'react';\r\nimport { useStudio } from '@/lib/studio/studioContext';\r\nimport { useTranslation } from '@/lib/i18n';\r\nimport { Icon } from '@/components/ui/Icon';\r\nimport { GOLDEN_INTENTS } from '@/lib/studio/golden/intentsRegistry';\r\nimport QualityLockPanel from './QualityLockPanel';\r\nimport DiffPreviewModal from './DiffPreviewModal';\r\nimport MessageActionBar from './MessageActionBar';\r\nimport DiffApplyPanel from './DiffApplyPanel';\r\nimport SourceIndicator from './SourceIndicator';\r\nimport RewriteConfirmationDialog from './RewriteConfirmationDialog';\r\nimport { ERROR_BOX } from '@/lib/studio/messageStyles';\r\nimport type { ActionType } from '@/types/orchestrator';\r\n\r\n// âœ… Validation-display consistency check (SINGLE SOURCE OF TRUTH)\r\nimport {\r\n  isValidationStale,\r\n  getDisplayedText,\r\n  computeContentHash,\r\n  traceValidation,\r\n} from '@/lib/quality/validateDisplayedContent';\r\nimport { runQualityLock } from '@/lib/quality/runQualityLock';\r\nimport { isValidIntentId, type IntentId } from '@/lib/quality/intentQualityRules';\r\nimport type { QualityLockMeta } from '@/types/studio';\r\n\r\n// âœ… User message display (SINGLE SOURCE OF TRUTH)\r\nimport { getDisplayedUserMessageText } from '@/lib/studio/messageDisplay';\r\n\r\n// âœ… STEP 6.6: Local Apply (NO LLM call)\r\nimport { localApply } from '@/lib/studio/localApply';\r\n\r\n// âœ… STEP 7: Intent Confidence & Learning Loop\r\nimport { computeRouteConfidence, type ConfidenceInput } from '@/lib/studio/intentConfidence';\r\nimport {\r\n  computePatternHash,\r\n  getAutoApplyChoice,\r\n  recordChoice,\r\n  recordNegativeSignal,\r\n  getLearnedChoice,\r\n} from '@/lib/studio/intentLearning';\r\n\r\n// âœ… STEP 8: Intent Transparency & Debug Overlay\r\nimport {\r\n  isIntentDebugEnabled,\r\n  createDebugDecision,\r\n  logIntentDecision,\r\n  type DebugDecision,\r\n  type DecisionPath,\r\n} from '@/lib/studio/intentDebug';\r\nimport { IntentDebugBadge } from './IntentDebugBadge';\r\nimport { IntentConfirmExplain } from './IntentConfirmExplain';\r\n\r\n// âœ… STEP 9: Intent Outcome Tracking\r\nimport {\r\n  createOutcome,\r\n  appendSignal,\r\n  shouldMarkUnreliable,\r\n  choiceToRoute,\r\n  type RouteUsed,\r\n} from '@/lib/studio/intentOutcome';\r\nimport * as outcomeStore from '@/lib/studio/intentOutcomeStore';\r\nimport { recordOutcome } from '@/lib/studio/intentLearning';\r\n\r\n// âœ… STEP 10: Intent Stability & Trust Signals\r\nimport {\r\n  computeStability,\r\n  getConfirmationGating,\r\n  type StabilityMetrics,\r\n} from '@/lib/studio/intentStability';\r\n\r\n// âœ… STEP 11: Intent Memory & Conversational Continuity\r\nimport {\r\n  createInitialContinuityState,\r\n  updateContinuityState,\r\n  shouldSkipConfirmationByContext,\r\n  type ContinuityState,\r\n} from '@/lib/studio/intentContinuity';\r\n\r\n// âœ… STEP 12: User Preference & Style Memory (Soft Bias)\r\nimport {\r\n  getPreferenceBias,\r\n  recordPreference,\r\n  detectChoiceSignals,\r\n  detectInstructionSignals,\r\n  type BiasResult,\r\n  type PreferenceContext,\r\n} from '@/lib/studio/userPreference';\r\n\r\n// âœ… STEP 13: Trust, Control & Recovery Layer\r\nimport {\r\n  arePreferencesEnabled,\r\n  isAutoApplyEnabled,\r\n  executeRecoveryAction,\r\n} from '@/lib/studio/intentControl';\r\nimport { TrustMicrocopy } from './TrustMicrocopy';\r\n\r\n// âœ… STEP 14: Team/Multi-User/Organization Intent Governance\r\nimport {\r\n  getGovernanceContext,\r\n  isGovernanceActive,\r\n  isLearningAllowed,\r\n  isAutoApplyAllowed as isAutoApplyAllowedByGovernance,\r\n  isExecutionAllowed,\r\n  isPreferenceBiasAllowed,\r\n  shouldForceConfirmation,\r\n  type GovernanceDecision,\r\n} from '@/lib/studio/intentGovernance';\r\n\r\n// âœ… STEP 3: Intent Debug Panel (DEV-ONLY observability)\r\nimport { IntentDebugPanel, isIntentDebugAvailable } from './IntentDebugPanel';\r\n\r\n// âœ… STEP 4: Intent Summary Badge (UX enhancement)\r\nimport { IntentSummaryBadge, isIntentSummaryEnabled } from './IntentSummaryBadge';\r\n\r\n// âœ… STEP 14A: Editorial Authority & Single Draft Enforcement\r\nimport {\r\n  hasActiveDraft,\r\n  isEditLocked,\r\n  getActiveDraftId,\r\n  getEditorialMode,\r\n  lockForEdit,\r\n  unlockEdit,\r\n  enterCreateMode,\r\n  checkIntentOverride,\r\n  handleCreateConfirmation,\r\n  maybeActivateDraft,\r\n  getCreateWarningCopy,\r\n  getEditorialBadgeCopy,\r\n  getEditorialDebugState,\r\n  type EditorialMode,\r\n  type CreateConfirmation,\r\n} from '@/lib/studio/editorialAuthority';\r\n\r\n// âœ… STEP 15: Editorial Canon & Structural Locking\r\nimport {\r\n  extractCanonFromDraft,\r\n  applyCanonLocks,\r\n  updateCanonFromText,\r\n  getCanonDebugSummary,\r\n  type EditorialCanon,\r\n  type CanonDiff,\r\n} from '@/lib/studio/editorialCanon';\r\n\r\n// âœ… STEP 16: Edit Guard Modal & Evaluation\r\nimport {\r\n  EditGuardModal,\r\n  type EditGuardResult,\r\n} from './EditGuardModal';\r\nimport {\r\n  type EditorialOp,\r\n} from '@/lib/studio/editorialOpPrompt';\r\n\r\n// âœ… STEP 17: Editorial Intent Canon & Meaning Preservation\r\nimport {\r\n  buildIntentCanonFromDraft,\r\n  getIntentCanonDebugSummary,\r\n  type EditorialIntentCanon,\r\n  type IntentCanonDiff,\r\n  type IntentGuardDecision,\r\n} from '@/lib/studio/editorialIntentCanon';\r\nimport { IntentCanonGuardModal } from './IntentCanonGuardModal';\r\n\r\n// âœ… STEP 19: Edit Scope Contract & Visible Edit Scope\r\nimport {\r\n  shouldGateForScopePick,\r\n  buildEditScopeContract,\r\n  type EditScopeContract,\r\n  type ScopeGate,\r\n} from '@/lib/studio/editScopeContract';\r\nimport { EditScopeBadge } from './EditScopeBadge';\r\nimport { EditScopePickModal } from './EditScopePickModal';\r\n\r\n// âœ… STEP 20: Edit Intent Normalizer\r\nimport {\r\n  normalizeEditIntent,\r\n} from '@/lib/studio/editIntentNormalizer';\r\n\r\n// âœ… STEP 21: Edit Patch Executor\r\n// âœ… STEP 22: Output Contract Builder\r\nimport {\r\n  buildEditPatchMeta,\r\n  shouldSkipStructureValidation,\r\n  allowsPartialOutput,\r\n  getEditPatchDebugSummary,\r\n  buildOutputContractFromMeta,\r\n  getOutputContractDebugSummary,\r\n} from '@/lib/studio/editPatchExecutor';\r\n\r\n// âœ… STEP 22: Answer Engine (for REWRITE_UPGRADE context guard)\r\nimport {\r\n  detectTaskType,\r\n  type TaskDetectionContext,\r\n} from '@/lib/studio/answerEngine';\r\nimport { REWRITE_NO_CONTEXT_ERROR } from '@/lib/orchestrator/llmExecutor';\r\n\r\n// âœ… STEP 29: Kill-Switch for production safety\r\nimport { isRewriteUpgradeEnabled } from '@/lib/studio/featureFlags';\r\n\r\n// ============================================\r\n// STEP 6.5: Intent Choice Types\r\n// ============================================\r\ntype IntentChoice = 'EDIT_IN_PLACE' | 'TRANSFORM_NEW_VERSION' | 'CREATE_NEW';\r\n\r\ninterface PendingIntentChoice {\r\n  inputText: string;\r\n  editedMessageId: string | null;\r\n  uiSourceMessageId: string | null;\r\n}\r\n\r\ninterface StudioEditorProps {\r\n  promptGrid?: React.ReactNode;\r\n}\r\n\r\n// ============================================\r\n// STEP 6.5: Pattern Detection Helpers\r\n// ============================================\r\n\r\n/**\r\n * Detect if input contains explicit \"create new\" signals.\r\n * If true, skip confirmation and go straight to CREATE path.\r\n */\r\nfunction isExplicitNewCreate(text: string): boolean {\r\n  const normalized = text.toLowerCase().normalize('NFC');\r\n  const patterns = [\r\n    /\\b(bÃ i\\s*má»›i|viáº¿t\\s*má»›i|táº¡o\\s*má»›i|ná»™i\\s*dung\\s*má»›i)\\b/,\r\n    /\\b(chá»§\\s*Ä‘á»\\s*(má»›i|khÃ¡c)|topic\\s*(má»›i|khÃ¡c))\\b/,\r\n    /\\b(báº¯t\\s*Ä‘áº§u\\s*láº¡i|start\\s*over|new\\s*content)\\b/,\r\n    /\\b(viáº¿t\\s*vá»\\s*chá»§\\s*Ä‘á»|viáº¿t\\s*cho)\\b/,\r\n    /\\b(create\\s*new|write\\s*new|draft\\s*new)\\b/i,\r\n  ];\r\n  return patterns.some((p) => p.test(normalized));\r\n}\r\n\r\n/**\r\n * Detect if input explicitly references the selected/current message.\r\n * If true, assume TRANSFORM intent.\r\n */\r\nfunction isExplicitTransformReference(text: string): boolean {\r\n  const normalized = text.toLowerCase().normalize('NFC');\r\n  const patterns = [\r\n    /\\b(Ä‘oáº¡n\\s*(trÃªn|nÃ y|vá»«a\\s*rá»“i|Ä‘ang\\s*chá»n))\\b/,\r\n    /\\b(ná»™i\\s*dung\\s*(trÃªn|nÃ y|vá»«a\\s*rá»“i))\\b/,\r\n    /\\b(bÃ i\\s*(trÃªn|nÃ y|vá»«a\\s*viáº¿t))\\b/,\r\n    /\\b(chá»‰nh\\s*(Ä‘oáº¡n|bÃ i)\\s*(nÃ y|trÃªn))\\b/,\r\n    /\\b(sá»­a\\s*(Ä‘oáº¡n|bÃ i)\\s*(nÃ y|trÃªn))\\b/,\r\n    /\\b(this\\s*(content|post|message))\\b/i,\r\n  ];\r\n  return patterns.some((p) => p.test(normalized));\r\n}\r\n\r\n/**\r\n * Detect if input is an ambiguous transform-like instruction.\r\n * Short instructions with transform verbs but no clear target.\r\n */\r\nfunction isAmbiguousInstruction(text: string): boolean {\r\n  const normalized = text.trim().toLowerCase().normalize('NFC');\r\n\r\n  // Long inputs (>120 chars) are considered intentional - no confirmation\r\n  if (text.length > 120) return false;\r\n\r\n  // Very short inputs without transform verbs are not ambiguous transform instructions\r\n  if (text.length < 3) return false;\r\n\r\n  // Transform verb patterns (Vietnamese + English)\r\n  const transformVerbs = [\r\n    /\\b(viáº¿t\\s*láº¡i|rewrite)\\b/i,\r\n    /\\b(ngáº¯n\\s*(hÆ¡n|láº¡i)|rÃºt\\s*gá»n|shorten|shorter)\\b/i,\r\n    /\\b(dÃ i\\s*hÆ¡n|má»Ÿ\\s*rá»™ng|expand|longer)\\b/i,\r\n    /\\b(tá»‘i\\s*Æ°u|optimize|cáº£i\\s*thiá»‡n|improve)\\b/i,\r\n    /\\b(Ä‘á»•i\\s*giá»ng|change\\s*tone|giá»ng\\s*(khÃ¡c|má»›i))\\b/i,\r\n    /\\b(chuyÃªn\\s*nghiá»‡p\\s*hÆ¡n|professional)\\b/i,\r\n    /\\b(thÃ¢n\\s*thiá»‡n\\s*hÆ¡n|friendly|casual)\\b/i,\r\n    /\\b(hay\\s*hÆ¡n|better|tá»‘t\\s*hÆ¡n)\\b/i,\r\n    /\\b(sá»­a|fix|chá»‰nh|edit)\\b/i,\r\n    /\\b(dá»‹ch|translate)\\b/i,\r\n    /\\b(format|Ä‘á»‹nh\\s*dáº¡ng)\\b/i,\r\n    /\\b(Ä‘Æ¡n\\s*giáº£n\\s*hÆ¡n|simpler|simplify)\\b/i,\r\n    /\\b(chi\\s*tiáº¿t\\s*hÆ¡n|more\\s*detail|elaborate)\\b/i,\r\n    /\\b(thÃªm\\s*(emoji|icon|hashtag|cta))\\b/i,\r\n    /\\b(bá»\\s*(emoji|icon|hashtag))\\b/i,\r\n  ];\r\n\r\n  const hasTransformVerb = transformVerbs.some((p) => p.test(normalized));\r\n\r\n  // If it has transform verbs and is short (<=80 chars), it's ambiguous\r\n  if (hasTransformVerb && text.length <= 80) {\r\n    return true;\r\n  }\r\n\r\n  // Short single-word or two-word commands are often ambiguous\r\n  const wordCount = normalized.split(/\\s+/).filter(Boolean).length;\r\n  if (wordCount <= 3 && hasTransformVerb) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Determine if we should show intent confirmation UI.\r\n * Only show when ambiguity is high.\r\n */\r\nfunction shouldConfirmIntent(params: {\r\n  isEditing: boolean;\r\n  editedMessageId: string | null;\r\n  uiSourceMessageId: string | null;\r\n  inputText: string;\r\n}): boolean {\r\n  const { isEditing, editedMessageId, uiSourceMessageId, inputText } = params;\r\n\r\n  // Escape hatch: explicit new create â†’ never show confirmation\r\n  if (isExplicitNewCreate(inputText)) {\r\n    return false;\r\n  }\r\n\r\n  // Escape hatch: explicit transform reference â†’ no confirmation needed\r\n  if (isExplicitTransformReference(inputText)) {\r\n    return false;\r\n  }\r\n\r\n  // Long inputs (>120 chars) â†’ user knows what they mean\r\n  if (inputText.length > 120) {\r\n    return false;\r\n  }\r\n\r\n  // Check if input is ambiguous\r\n  const isAmbiguous = isAmbiguousInstruction(inputText);\r\n  if (!isAmbiguous) {\r\n    return false;\r\n  }\r\n\r\n  // Case 1: Editing AND has UI source selected that's different from edited message\r\n  if (isEditing && editedMessageId && uiSourceMessageId && editedMessageId !== uiSourceMessageId) {\r\n    return true;\r\n  }\r\n\r\n  // Case 2: Editing with ambiguous transform instruction\r\n  if (isEditing && editedMessageId && isAmbiguous) {\r\n    return true;\r\n  }\r\n\r\n  // Case 3: UI source selected with ambiguous instruction (might mean create new)\r\n  if (uiSourceMessageId && isAmbiguous) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport default function StudioEditor({ promptGrid }: StudioEditorProps) {\r\n  const { t, language } = useTranslation();\r\n  const {\r\n    chatInput,\r\n    setChatInput,\r\n    handleSend,\r\n    aiLoading,\r\n    aiError,\r\n    setAiError, // âœ… STEP 22: For REWRITE_UPGRADE context guard\r\n    retryLastAction, // âœ… Error recovery\r\n    messages,\r\n    clearMessages,\r\n    approvedMessageId,\r\n    setApprovedMessage,\r\n    // Auto Fix\r\n    autoFixMessage,\r\n    autoFixLoading,\r\n    autoFixPreview,\r\n    applyAutoFix,\r\n    cancelAutoFix,\r\n    autoFixToast,\r\n    undoAutoFix,\r\n    dismissAutoFixToast,\r\n    // Orchestrator\r\n    activeSourceId,\r\n    setActiveSource,\r\n    handleTransformAction,\r\n    transformLoading,\r\n    // Diff & Apply\r\n    applyTransformResult,\r\n    undoApplyTransformResult,\r\n    // STEP 6.6: Local Edit\r\n    updateMessageContent,\r\n    // STEP 21: Edit Patch Meta\r\n    setEditPatchMeta,\r\n    // STEP 22: Output Contract\r\n    setOutputContract,\r\n    // FEATURE A: Primary Selection\r\n    primaryMessageId,\r\n    setPrimaryMessage,\r\n    // FEATURE B: Session Management\r\n    saveSessionSnapshot,\r\n    getRecentSnapshots,\r\n    restoreSnapshot,\r\n  } = useStudio();\r\n\r\n  const editorRef = useRef<HTMLTextAreaElement>(null);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\r\n  const [hoveredMessageId, setHoveredMessageId] = useState<string | null>(null);\r\n  const [isSourcePickerMode, setIsSourcePickerMode] = useState(false);\r\n  // FEATURE B: Session snapshots dropdown\r\n  const [showSnapshotsDropdown, setShowSnapshotsDropdown] = useState(false);\r\n\r\n  // ============================================\r\n  // STEP 6.5: Intent Confirmation State\r\n  // ============================================\r\n  // pendingIntentChoice: When set, shows confirmation UI instead of sending\r\n  // lastIntentChoice: Remembers last choice to avoid re-asking for same situation\r\n  const [pendingIntentChoice, setPendingIntentChoice] = useState<PendingIntentChoice | null>(null);\r\n  const [lastIntentChoice, setLastIntentChoice] = useState<IntentChoice | null>(null);\r\n  // Track the last input/context hash to detect if situation changed\r\n  const [lastConfirmationHash, setLastConfirmationHash] = useState<string | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 6.6 + STEP 7: Local Edit Undo State\r\n  // ============================================\r\n  const [localEditToast, setLocalEditToast] = useState<{\r\n    show: boolean;\r\n    message: string;\r\n    messageId: string;\r\n    previousContent: string;\r\n    expiresAt: number;\r\n    // âœ… STEP 7: Track pattern hash for negative signal recording\r\n    patternHash?: string;\r\n    // âœ… STEP 13: Track intent ID for recovery action\r\n    intentId?: string;\r\n  } | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 8: Debug Decision State\r\n  // ============================================\r\n  const [lastDebugDecision, setLastDebugDecision] = useState<DebugDecision | null>(null);\r\n  // Track pending debug context for confirmation flow\r\n  // Type for debug context used by both ref and state\r\n  type DebugContextType = {\r\n    patternHash: string;\r\n    confidenceInput: ConfidenceInput;\r\n    confidenceResult: { routeHint: 'CREATE' | 'TRANSFORM'; intentConfidence: number; reason: string };\r\n    uiSourceMessageId: string | null;\r\n    // âœ… STEP 10: Include stability metrics\r\n    stability?: StabilityMetrics;\r\n    // âœ… STEP 11: Include continuity state\r\n    continuity?: ContinuityState;\r\n    // âœ… STEP 12: Include preference bias\r\n    preferenceBias?: BiasResult;\r\n    // âœ… STEP 14: Include governance decision\r\n    governanceDecision?: GovernanceDecision;\r\n  };\r\n  const pendingDebugContextRef = useRef<DebugContextType | null>(null);\r\n  // State mirror for render-safe access (synced when ref is set)\r\n  const [debugContextForRender, setDebugContextForRender] = useState<DebugContextType | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 11: Intent Memory & Conversational Continuity State\r\n  // ============================================\r\n  // Track conversation flow patterns across turns (session-only, not persisted)\r\n  const [continuityState, setContinuityState] = useState<ContinuityState>(() =>\r\n    createInitialContinuityState()\r\n  );\r\n\r\n  // ============================================\r\n  // STEP 14A: Editorial Authority State\r\n  // ============================================\r\n  // Track editorial mode for single-draft enforcement\r\n  const [editorialMode, setEditorialModeState] = useState<EditorialMode>(() => getEditorialMode());\r\n  const [showCreateWarning, setShowCreateWarning] = useState(false);\r\n  const [pendingCreateIntent, setPendingCreateIntent] = useState<{\r\n    originalIntent: 'CREATE' | 'TRANSFORM';\r\n    inputText: string;\r\n  } | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 27: Rewrite Intent Confirmation State\r\n  // ============================================\r\n  // Track which draft ID has been confirmed for rewrite (UI state only)\r\n  // Reset when: draft changes, editor cleared, or user switches to CREATE\r\n  const [rewriteConfirmedForDraftId, setRewriteConfirmedForDraftId] = useState<string | null>(null);\r\n  // Show the confirmation dialog\r\n  const [showRewriteConfirmation, setShowRewriteConfirmation] = useState(false);\r\n  // Store pending input for after confirmation\r\n  const pendingRewriteInputRef = useRef<string | null>(null);\r\n\r\n  // Sync editorial mode state with module state\r\n  const refreshEditorialMode = useCallback(() => {\r\n    setEditorialModeState(getEditorialMode());\r\n  }, []);\r\n\r\n  // âœ… STEP 14A: Auto-activate draft when AI produces first output\r\n  useEffect(() => {\r\n    // Find the last assistant message\r\n    const lastAssistantMsg = [...messages].reverse().find(m => m.role === 'assistant');\r\n\r\n    if (lastAssistantMsg && !hasActiveDraft()) {\r\n      // Activate this message as the draft\r\n      const activated = maybeActivateDraft(lastAssistantMsg.id, true);\r\n      if (activated) {\r\n        // eslint-disable-next-line react-hooks/set-state-in-effect -- Sync editorial mode after draft activation\r\n        refreshEditorialMode();\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.log('[StudioEditor:STEP14A] Auto-activated draft:', lastAssistantMsg.id);\r\n        }\r\n      }\r\n    }\r\n  }, [messages, refreshEditorialMode]);\r\n\r\n  // âœ… STEP 14A: Unlock edit when AI loading finishes\r\n  useEffect(() => {\r\n    if (!aiLoading && isEditLocked()) {\r\n      unlockEdit();\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Sync editorial mode after unlock\r\n      refreshEditorialMode();\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP14A] Edit unlocked after AI response');\r\n      }\r\n    }\r\n  }, [aiLoading, refreshEditorialMode]);\r\n\r\n  // âœ… STEP 27: Reset rewrite confirmation when draft changes\r\n  useEffect(() => {\r\n    const currentDraftId = getActiveDraftId();\r\n    // Reset if draft changed or no longer active\r\n    if (rewriteConfirmedForDraftId && rewriteConfirmedForDraftId !== currentDraftId) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset confirmation on draft change\r\n      setRewriteConfirmedForDraftId(null);\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP27] Reset rewrite confirmation - draft changed', {\r\n          was: rewriteConfirmedForDraftId,\r\n          now: currentDraftId,\r\n        });\r\n      }\r\n    }\r\n  }, [rewriteConfirmedForDraftId, editorialMode]);\r\n\r\n  // âœ… STEP 27: Reset rewrite confirmation when messages cleared\r\n  useEffect(() => {\r\n    if (messages.length === 0 && rewriteConfirmedForDraftId) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset confirmation on clear\r\n      setRewriteConfirmedForDraftId(null);\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP27] Reset rewrite confirmation - messages cleared');\r\n      }\r\n    }\r\n  }, [messages.length, rewriteConfirmedForDraftId]);\r\n\r\n  // ============================================\r\n  // STEP 15: Editorial Canon State\r\n  // ============================================\r\n  // Canon tracks structural integrity of the active draft.\r\n  // Session-only state (not persisted to localStorage per privacy invariant).\r\n  const [activeCanon, setActiveCanon] = useState<EditorialCanon | null>(null);\r\n  // Pending canon approval state - when AI proposes changes to locked sections\r\n  const [_pendingCanonApproval, _setPendingCanonApproval] = useState<{\r\n    diff: CanonDiff;\r\n    newText: string;\r\n    messageId: string;\r\n  } | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 16: Edit Guard State\r\n  // ============================================\r\n  // Tracks pending edit guard approval when AI output violates expected scope.\r\n  // Session-only state (not persisted).\r\n  const [pendingEditGuard, setPendingEditGuard] = useState<{\r\n    guardResult: EditGuardResult;\r\n    requestedOp: EditorialOp;\r\n    originalText: string;\r\n    newText: string;\r\n    messageId: string;\r\n    applyMode: 'all' | 'hook' | 'body' | 'cta' | 'hashtags';\r\n  } | null>(null);\r\n  // Track the detected editorial op for the current instruction\r\n  const _detectedEditorialOpRef = useRef<EditorialOp | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 17: Editorial Intent Canon State\r\n  // ============================================\r\n  // Tracks the editorial intent (meaning/purpose) of the active draft.\r\n  // Session-only state (not persisted per privacy invariant).\r\n  const [activeIntentCanon, setActiveIntentCanon] = useState<EditorialIntentCanon | null>(null);\r\n  // Pending intent canon guard state - when AI output drifts from intent\r\n  const [pendingIntentCanonGuard, setPendingIntentCanonGuard] = useState<{\r\n    diff: IntentCanonDiff;\r\n    decision: IntentGuardDecision;\r\n    newText: string;\r\n    messageId: string;\r\n    applyMode: 'all' | 'hook' | 'body' | 'cta' | 'hashtags';\r\n  } | null>(null);\r\n\r\n  // ============================================\r\n  // STEP 19: Edit Scope Contract State\r\n  // ============================================\r\n  // Tracks the active edit scope (which section is being edited, which are locked).\r\n  // Session-only state (not persisted per privacy invariant).\r\n  const [activeScopeContract, setActiveScopeContract] = useState<EditScopeContract | null>(null);\r\n  // Pending scope gate state - when edit scope is ambiguous and requires user pick\r\n  const [pendingScopeGate, setPendingScopeGate] = useState<{\r\n    gate: ScopeGate;\r\n    inputText: string;\r\n  } | null>(null);\r\n  // Ref to store the selected scope contract for passing through handleSend\r\n  const selectedScopeContractRef = useRef<EditScopeContract | null>(null);\r\n\r\n  // âœ… STEP 15: Initialize canon when draft is activated\r\n  useEffect(() => {\r\n    if (!hasActiveDraft()) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset canon when draft deactivated\r\n      setActiveCanon(null);\r\n      return;\r\n    }\r\n\r\n    const activeDraftId = getActiveDraftId();\r\n    if (!activeDraftId) return;\r\n\r\n    // Find the active draft message\r\n    const draftMessage = messages.find(m => m.id === activeDraftId);\r\n    if (!draftMessage || draftMessage.role !== 'assistant') return;\r\n\r\n    // Extract canon from the draft if we don't have one yet\r\n    if (!activeCanon || activeCanon.meta.activeDraftId !== activeDraftId) {\r\n      const extractedCanon = extractCanonFromDraft(draftMessage.content, activeDraftId);\r\n      // Apply default lock policy: HOOK + CTA + TONE locked, BODY unlocked\r\n      const lockedCanon = applyCanonLocks(extractedCanon, 'default');\r\n      setActiveCanon(lockedCanon);\r\n\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP15] Canon initialized:', getCanonDebugSummary(lockedCanon));\r\n      }\r\n    }\r\n  }, [messages, activeCanon]);\r\n\r\n  // âœ… STEP 15: Update canon when draft content changes (after AI edit)\r\n  const _updateCanonAfterEdit = useCallback((newContent: string) => {\r\n    if (!activeCanon) return;\r\n\r\n    const updatedCanon = updateCanonFromText(activeCanon, newContent);\r\n    setActiveCanon(updatedCanon);\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP15] Canon updated after edit:', getCanonDebugSummary(updatedCanon));\r\n    }\r\n  }, [activeCanon]);\r\n\r\n  // âœ… STEP 17: Initialize intent canon when draft is activated\r\n  useEffect(() => {\r\n    if (!hasActiveDraft()) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Reset intent canon when draft deactivated\r\n      setActiveIntentCanon(null);\r\n      return;\r\n    }\r\n\r\n    const activeDraftId = getActiveDraftId();\r\n    if (!activeDraftId) return;\r\n\r\n    // Find the active draft message\r\n    const draftMessage = messages.find(m => m.id === activeDraftId);\r\n    if (!draftMessage || draftMessage.role !== 'assistant') return;\r\n\r\n    // Build intent canon from the draft if we don't have one yet\r\n    if (!activeIntentCanon || activeIntentCanon.meta.draftId !== activeDraftId) {\r\n      const intentCanon = buildIntentCanonFromDraft(draftMessage.content, {\r\n        language: 'vi',\r\n        platform: undefined,\r\n        existingTone: undefined,\r\n      });\r\n      // Update draftId to match\r\n      intentCanon.meta.draftId = activeDraftId;\r\n      setActiveIntentCanon(intentCanon);\r\n\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP17] Intent canon initialized:', getIntentCanonDebugSummary(intentCanon));\r\n      }\r\n    }\r\n  }, [messages, activeIntentCanon]);\r\n\r\n  // âœ… STEP 17: Update intent canon after accepting drift\r\n  const updateIntentCanonAfterDrift = useCallback((newContent: string) => {\r\n    if (!activeIntentCanon) return;\r\n\r\n    const updatedCanon = buildIntentCanonFromDraft(newContent, {\r\n      language: activeIntentCanon.meta.language,\r\n      platform: activeIntentCanon.meta.platform,\r\n    });\r\n    // Preserve the original draftId\r\n    updatedCanon.meta.draftId = activeIntentCanon.meta.draftId;\r\n    setActiveIntentCanon(updatedCanon);\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP17] Intent canon updated after drift:', getIntentCanonDebugSummary(updatedCanon));\r\n    }\r\n  }, [activeIntentCanon]);\r\n\r\n  // ============================================\r\n  // STEP 9: Intent Outcome Tracking State\r\n  // ============================================\r\n  // Track the current intent for outcome observation\r\n  const currentIntentRef = useRef<{\r\n    intentId: string;\r\n    patternHash?: string;\r\n    routeUsed: RouteUsed;\r\n    confidence?: number;\r\n    createdAt: number;\r\n  } | null>(null);\r\n  // Timer for ACCEPT_SILENTLY detection (20s after output)\r\n  const acceptTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  // Track last output timestamp for RESEND_IMMEDIATELY detection\r\n  const lastOutputAtRef = useRef<number>(0);\r\n  // Track last active source for RESEND detection\r\n  const lastActiveSourceRef = useRef<string | null>(null);\r\n\r\n  // Cleanup outcome timers on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      if (acceptTimerRef.current) {\r\n        clearTimeout(acceptTimerRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // ============================================\r\n  // STEP 9: Outcome Signal Recording Helpers\r\n  // ============================================\r\n\r\n  /**\r\n   * Record an outcome signal and update derived state\r\n   */\r\n  const recordOutcomeSignal = useCallback((\r\n    signalType: 'UNDO_WITHIN_WINDOW' | 'EDIT_AFTER' | 'RESEND_IMMEDIATELY' | 'ACCEPT_SILENTLY',\r\n    meta?: Record<string, string | number | boolean>\r\n  ) => {\r\n    const intent = currentIntentRef.current;\r\n    if (!intent) return;\r\n\r\n    try {\r\n      // Update outcome in store\r\n      const updated = outcomeStore.updateAndDerive(intent.intentId, (outcome) =>\r\n        appendSignal(outcome, { type: signalType, meta })\r\n      );\r\n\r\n      if (updated && updated.patternHash) {\r\n        // If this outcome indicates unreliability, record for learning\r\n        if (shouldMarkUnreliable(updated)) {\r\n          recordOutcome(\r\n            updated.intentId,\r\n            updated.patternHash,\r\n            updated.derived.severity,\r\n            updated.derived.negative\r\n          );\r\n        }\r\n      }\r\n\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP9] Recorded outcome signal:', {\r\n          intentId: intent.intentId,\r\n          signalType,\r\n          meta,\r\n        });\r\n      }\r\n    } catch {\r\n      // Fail silently - outcome tracking is non-blocking\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Cancel the accept timer (called when negative signal occurs)\r\n   */\r\n  const cancelAcceptTimer = useCallback(() => {\r\n    if (acceptTimerRef.current) {\r\n      clearTimeout(acceptTimerRef.current);\r\n      acceptTimerRef.current = null;\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Start the accept timer (called after output is produced)\r\n   */\r\n  const startAcceptTimer = useCallback(() => {\r\n    cancelAcceptTimer();\r\n\r\n    // Set timer for 20 seconds\r\n    acceptTimerRef.current = setTimeout(() => {\r\n      recordOutcomeSignal('ACCEPT_SILENTLY');\r\n      acceptTimerRef.current = null;\r\n    }, 20000);\r\n  }, [cancelAcceptTimer, recordOutcomeSignal]);\r\n\r\n  /**\r\n   * Create a new intent outcome record\r\n   */\r\n  const createIntentOutcome = useCallback((\r\n    routeUsed: RouteUsed,\r\n    patternHash?: string,\r\n    confidence?: number\r\n  ) => {\r\n    const outcome = createOutcome({\r\n      routeUsed,\r\n      patternHash,\r\n      confidence,\r\n    });\r\n\r\n    // Store in ref for signal recording\r\n    currentIntentRef.current = {\r\n      intentId: outcome.intentId,\r\n      patternHash,\r\n      routeUsed,\r\n      confidence,\r\n      createdAt: outcome.createdAt,\r\n    };\r\n\r\n    // Persist to store\r\n    outcomeStore.put(outcome);\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP9] Created outcome:', {\r\n        intentId: outcome.intentId,\r\n        routeUsed,\r\n        patternHash,\r\n      });\r\n    }\r\n\r\n    return outcome.intentId;\r\n  }, []);\r\n\r\n  // Auto-dismiss local edit toast after 5 seconds\r\n  useEffect(() => {\r\n    if (!localEditToast?.show) return;\r\n\r\n    const timeRemaining = localEditToast.expiresAt - Date.now();\r\n    if (timeRemaining <= 0) {\r\n      // eslint-disable-next-line react-hooks/set-state-in-effect -- Dismiss expired toast immediately\r\n      setLocalEditToast(null);\r\n      return;\r\n    }\r\n\r\n    const timer = setTimeout(() => {\r\n      setLocalEditToast(null);\r\n    }, timeRemaining);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [localEditToast]);\r\n\r\n  // Undo local edit\r\n  const undoLocalEdit = useCallback(() => {\r\n    if (!localEditToast) return;\r\n\r\n    const { messageId, previousContent, patternHash, intentId } = localEditToast;\r\n    updateMessageContent(messageId, previousContent);\r\n\r\n    // âœ… STEP 7: Record negative signal for learning loop\r\n    if (patternHash) {\r\n      recordNegativeSignal(patternHash, 'EDIT_IN_PLACE');\r\n    }\r\n\r\n    // âœ… STEP 9: Record UNDO_WITHIN_WINDOW outcome signal\r\n    cancelAcceptTimer(); // Cancel accept timer since user undid\r\n    recordOutcomeSignal('UNDO_WITHIN_WINDOW', { windowMs: 5000 });\r\n\r\n    // âœ… STEP 13: Execute recovery action for tracking\r\n    if (intentId && patternHash) {\r\n      executeRecoveryAction({\r\n        type: 'UNDO_LAST_INTENT',\r\n        intentId,\r\n        patternHash,\r\n      }, 'vi');\r\n    }\r\n\r\n    setLocalEditToast(null);\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP6.6] Undid local edit:', messageId, patternHash ? '(negative signal recorded)' : '');\r\n    }\r\n  }, [localEditToast, updateMessageContent, cancelAcceptTimer, recordOutcomeSignal]);\r\n\r\n  // Currently, StudioEditor doesn't have explicit \"edit mode\" for inline editing.\r\n  // For STEP 6.5, we consider \"editing\" as when there's a UI source selected.\r\n  // In future, if inline editing is added, this can be expanded.\r\n  const isEditing = false; // No inline edit mode currently\r\n  const editedMessageId: string | null = null; // No edited message currently\r\n\r\n  // ============================================\r\n  // VALIDATION-DISPLAY CONSISTENCY\r\n  // ============================================\r\n\r\n  const effectiveQualityLockMap = useMemo(() => {\r\n    const map = new Map<string, QualityLockMeta | undefined>();\r\n\r\n    for (const message of messages) {\r\n      if (message.role !== 'assistant' || !message.meta?.qualityLock) continue;\r\n\r\n      const stored = message.meta.qualityLock;\r\n      const displayedText = getDisplayedText(message.content);\r\n      const contentHash = computeContentHash(displayedText);\r\n      const cacheKey = `${message.id}-${contentHash}`;\r\n\r\n      const stale = isValidationStale(displayedText, stored);\r\n\r\n      if (stale) {\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.warn('[StudioEditor] Stale validation detected - re-evaluating:', {\r\n            messageId: message.id,\r\n            contentHash,\r\n            storedDecision: stored.decision,\r\n          });\r\n          traceValidation(message.id, displayedText, displayedText, stored);\r\n        }\r\n\r\n        const intent = message.meta?.intent || message.meta?.templateId;\r\n        if (isValidIntentId(intent)) {\r\n          const reEvalResult = runQualityLock({\r\n            intent: intent as IntentId,\r\n            output: displayedText,\r\n            meta: {\r\n              templateId: message.meta?.templateId,\r\n              language: 'vi',\r\n              testMode: message.meta?.testMode,\r\n            },\r\n          });\r\n\r\n          const newDecision =\r\n            reEvalResult.hardFails.length > 0\r\n              ? ('FAIL' as const)\r\n              : reEvalResult.softFails.length > 0\r\n              ? ('DRAFT' as const)\r\n              : ('PASS' as const);\r\n\r\n          if (process.env.NODE_ENV === 'development') {\r\n            console.log('[StudioEditor] Re-evaluation result:', {\r\n              messageId: message.id,\r\n              oldDecision: stored.decision,\r\n              newDecision,\r\n              hardFails: reEvalResult.hardFails.map((f) => f.id),\r\n            });\r\n          }\r\n\r\n          map.set(cacheKey, {\r\n            decision: newDecision,\r\n            softFails: reEvalResult.softFails,\r\n            hardFails: reEvalResult.hardFails,\r\n            autoFixAttempts: stored.autoFixAttempts || 0,\r\n          });\r\n        } else {\r\n          map.set(cacheKey, stored);\r\n        }\r\n      } else {\r\n        map.set(cacheKey, stored);\r\n      }\r\n    }\r\n\r\n    return map;\r\n  }, [messages]);\r\n\r\n  const getEffectiveQualityLock = useCallback(\r\n    (message: {\r\n      id: string;\r\n      content: string;\r\n      meta?: {\r\n        qualityLock?: QualityLockMeta;\r\n        templateId?: string;\r\n        intent?: string;\r\n        testMode?: boolean;\r\n      };\r\n    }): QualityLockMeta | undefined => {\r\n      if (!message.meta?.qualityLock) return undefined;\r\n\r\n      const displayedText = getDisplayedText(message.content);\r\n      const contentHash = computeContentHash(displayedText);\r\n      const cacheKey = `${message.id}-${contentHash}`;\r\n\r\n      return effectiveQualityLockMap.get(cacheKey) || message.meta.qualityLock;\r\n    },\r\n    [effectiveQualityLockMap]\r\n  );\r\n\r\n  // ============================================\r\n  // AUTO-SCROLL BEHAVIOR (ChatGPT-like)\r\n  // ============================================\r\n\r\n  const [isNearBottom, setIsNearBottom] = useState(true);\r\n  const isUserScrollingRef = useRef(false);\r\n  const prevMessagesLengthRef = useRef(messages.length);\r\n  const SCROLL_THRESHOLD = 100;\r\n\r\n  // Get enabled intents for content type chips\r\n  const _enabledIntents = GOLDEN_INTENTS.filter((intent) => intent.enabled !== false).sort(\r\n    (a, b) => a.order - b.order\r\n  );\r\n\r\n  // ============================================\r\n  // INTENT DETECTION - Signal-based approach\r\n  // (Used ONLY for hinting now; NOT for gating submit)\r\n  // ============================================\r\n\r\n  type InputState = 'empty' | 'noise' | 'short' | 'intent_weak' | 'intent_clear';\r\n\r\n  const normalizeInput = (raw: string): string => {\r\n    return raw\r\n      .normalize('NFC')\r\n      .replace(/\\u00A0/g, ' ')\r\n      .replace(/\\s+/g, ' ')\r\n      .trim()\r\n      .toLowerCase();\r\n  };\r\n\r\n  const NOISE_PATTERNS = [\r\n    /^(alo|hello|hi|hey|test|abc|123|asdf|xxx|yyy|zzz)$/i,\r\n    /^(.)\\1{2,}$/,\r\n    /^[a-z]{1,3}$/i,\r\n  ];\r\n\r\n  const ACTION_VERBS = /\\b(viáº¿t|táº¡o|lÃ m|soáº¡n|Ä‘áº·t|nghÄ©|lÃªn|draft|giÃºp|há»— trá»£)\\b/i;\r\n\r\n  const SPECIFIC_CONTENT_TYPES =\r\n    /caption|bÃ i Ä‘Äƒng|bÃ i viáº¿t|bÃ i quáº£ng cÃ¡o|bÃ i quang cao|bÃ i blog|bÃ i pr|quáº£ng cÃ¡o|quang cao|ads?|post|story|reel|reels|video|ká»‹ch báº£n|kich ban|script|banner|tiÃªu Ä‘á»|tieu de|headline|mÃ´ táº£ sáº£n pháº©m|mo ta san pham|description|email marketing|email|thÆ°|tin nháº¯n|tin nhan|message|slogan|tagline|hook|content calendar|lá»‹ch ná»™i dung/i;\r\n\r\n  const GENERIC_CONTENT_TYPES = /\\b(bÃ i|ná»™i dung|noi dung|content)\\b/i;\r\n\r\n  const PLATFORMS =\r\n    /\\b(facebook|fb|instagram|ig|insta|tiktok|tik tok|youtube|yt|linkedin|twitter|x\\.com|website|web|blog|fanpage|fan page|zalo|threads)\\b/i;\r\n\r\n  const TOPIC_INDICATORS =\r\n    /\\b(cho|vá»|ve|cá»§a|cua|bÃ¡n|ban|giá»›i thiá»‡u|gioi thieu|quáº£ng bÃ¡|quang ba|pr|marketing)\\s+\\S+/i;\r\n\r\n  const BUSINESS_TERMS =\r\n    /\\b(quÃ¡n|quan|shop|cá»­a hÃ ng|cua hang|thÆ°Æ¡ng hiá»‡u|thuong hieu|brand|sáº£n pháº©m|san pham|dá»‹ch vá»¥|dich vu|khÃ³a há»c|khoa hoc|event|sá»± kiá»‡n|su kien|dá»± Ã¡n|du an|project|cÃ´ng ty|cong ty|company|startup|spa|salon|gym|nhÃ  hÃ ng|nha hang|cafe|cÃ  phÃª|ca phe)\\b/i;\r\n\r\n  const META_INTENT_PATTERNS = [\r\n    /^(tÃ´i )?(muá»‘n |cáº§n )?(viáº¿t|táº¡o|lÃ m)( bÃ i| ná»™i dung| content)?$/i,\r\n    /^viáº¿t (bÃ i|ná»™i dung|content)$/i,\r\n    /^(viáº¿t|táº¡o|lÃ m) (gÃ¬ Ä‘Ã³|cÃ¡i gÃ¬|gÃ¬|gi do|cai gi|gi)$/i,\r\n    /^(giÃºp|há»— trá»£|ho tro)( tÃ´i| mÃ¬nh)?( viáº¿t| táº¡o| lÃ m)?$/i,\r\n  ];\r\n\r\n  interface IntentSignals {\r\n    normalized: string;\r\n    wordCount: number;\r\n    hasActionVerb: boolean;\r\n    hasSpecificContentType: boolean;\r\n    hasGenericContentType: boolean;\r\n    hasPlatform: boolean;\r\n    hasTopic: boolean;\r\n    isNoise: boolean;\r\n    isMetaIntent: boolean;\r\n  }\r\n\r\n  const computeSignals = (normalized: string): IntentSignals => {\r\n    const wordCount = normalized.split(/\\s+/).filter(Boolean).length;\r\n\r\n    const hasActionVerb = ACTION_VERBS.test(normalized);\r\n    const hasSpecificContentType = SPECIFIC_CONTENT_TYPES.test(normalized);\r\n    const hasGenericContentType = GENERIC_CONTENT_TYPES.test(normalized) && !hasSpecificContentType;\r\n    const hasPlatform = PLATFORMS.test(normalized);\r\n    const hasTopic = TOPIC_INDICATORS.test(normalized) || BUSINESS_TERMS.test(normalized);\r\n    const isNoise = NOISE_PATTERNS.some((p) => p.test(normalized));\r\n    const isMetaIntent = META_INTENT_PATTERNS.some((p) => p.test(normalized));\r\n\r\n    return {\r\n      normalized,\r\n      wordCount,\r\n      hasActionVerb,\r\n      hasSpecificContentType,\r\n      hasGenericContentType,\r\n      hasPlatform,\r\n      hasTopic,\r\n      isNoise,\r\n      isMetaIntent,\r\n    };\r\n  };\r\n\r\n  const detectStateFromSignals = (signals: IntentSignals): InputState => {\r\n    const {\r\n      normalized,\r\n      wordCount,\r\n      hasActionVerb,\r\n      hasSpecificContentType,\r\n      hasGenericContentType,\r\n      hasPlatform,\r\n      hasTopic,\r\n      isNoise,\r\n      isMetaIntent,\r\n    } = signals;\r\n\r\n    if (normalized.length === 0) return 'empty';\r\n    if (isNoise) return 'noise';\r\n\r\n    if (isMetaIntent && !hasSpecificContentType && !hasPlatform && !hasTopic) {\r\n      return 'intent_weak';\r\n    }\r\n\r\n    if (wordCount === 1) {\r\n      if (hasSpecificContentType) return 'intent_clear';\r\n      if (hasPlatform) return 'short';\r\n      return 'short';\r\n    }\r\n\r\n    if (hasActionVerb && hasSpecificContentType) return 'intent_clear';\r\n    if (hasActionVerb && hasGenericContentType && (hasPlatform || hasTopic)) return 'intent_clear';\r\n    if (hasPlatform && (hasSpecificContentType || hasGenericContentType)) return 'intent_clear';\r\n    if ((hasSpecificContentType || hasGenericContentType) && hasTopic) return 'intent_clear';\r\n    if (hasPlatform && hasTopic) return 'intent_clear';\r\n    if (wordCount >= 4 && (hasActionVerb || hasPlatform || hasTopic)) return 'intent_clear';\r\n\r\n    if (wordCount >= 2) {\r\n      if (hasSpecificContentType || hasPlatform || hasTopic) return 'intent_clear';\r\n    }\r\n\r\n    return 'short';\r\n  };\r\n\r\n  /**\r\n   * getIntentModel:\r\n   * - Hints are derived from signal state\r\n   * - Submit gating is now CALM: any non-empty input can send (like ChatGPT).\r\n   *   AI can ask follow-up instead of UI blocking.\r\n   *\r\n   * STEP 4.5: Progressive Hint Silence\r\n   * - After first AI result, reduce hint verbosity\r\n   * - When intent is clear or user is typing, minimize guidance\r\n   * - System speaks once, then steps back\r\n   */\r\n  const getIntentModel = (rawInput: string, loading: boolean, hasAIResult: boolean) => {\r\n    const normalized = normalizeInput(rawInput);\r\n    const signals = computeSignals(normalized);\r\n    const inputState = detectStateFromSignals(signals);\r\n\r\n    const canSubmit = !loading && normalized.length > 0;\r\n    const isTyping = normalized.length > 0;\r\n\r\n    // STEP 4.5: Progressive silence - reduce hints after first result or when typing\r\n    let hint: string;\r\n    if (loading) {\r\n      hint = 'AI Ä‘ang xá»­ lÃ½â€¦';\r\n    } else if (hasAIResult) {\r\n      // STEP 4.5: After AI result, stay silent unless empty\r\n      hint = isTyping ? '' : '';\r\n    } else if (inputState === 'intent_clear' || isTyping) {\r\n      // STEP 4.5: When intent is clear or user is typing, stay quiet\r\n      hint = '';\r\n    } else {\r\n      // First-time users only - provide minimal guidance\r\n      switch (inputState) {\r\n        case 'empty':\r\n          hint = 'MÃ´ táº£ Ã½ tÆ°á»Ÿng cá»§a báº¡n.';\r\n          break;\r\n        case 'noise':\r\n        case 'short':\r\n        case 'intent_weak':\r\n          // STEP 4.5: Reduce secondary hints - let user proceed\r\n          hint = '';\r\n          break;\r\n        default:\r\n          hint = '';\r\n      }\r\n    }\r\n\r\n    return { normalized, signals, inputState, canSubmit, hint };\r\n  };\r\n\r\n  const hasResult = messages.some((m) => m.role === 'assistant');\r\n  const { canSubmit, hint, inputState: _inputState } = getIntentModel(chatInput, aiLoading, hasResult);\r\n\r\n  useEffect(() => {\r\n    editorRef.current?.focus();\r\n  }, []);\r\n\r\n  // Auto-resize textarea\r\n  const MIN_HEIGHT = 80;\r\n  const MAX_HEIGHT = 200;\r\n\r\n  const handleTextareaResize = () => {\r\n    const textarea = editorRef.current;\r\n    if (!textarea) return;\r\n\r\n    textarea.style.height = 'auto';\r\n    const newHeight = Math.min(Math.max(textarea.scrollHeight, MIN_HEIGHT), MAX_HEIGHT);\r\n    textarea.style.height = `${newHeight}px`;\r\n    textarea.style.overflowY = textarea.scrollHeight > MAX_HEIGHT ? 'auto' : 'hidden';\r\n  };\r\n\r\n  useEffect(() => {\r\n    handleTextareaResize();\r\n  }, [chatInput]);\r\n\r\n  useEffect(() => {\r\n    handleTextareaResize();\r\n  }, []);\r\n\r\n  // ============================================\r\n  // SCROLL DETECTION & AUTO-SCROLL LOGIC\r\n  // ============================================\r\n\r\n  const checkIfNearBottom = useCallback(() => {\r\n    const container = messagesContainerRef.current;\r\n    if (!container) return true;\r\n\r\n    const { scrollTop, scrollHeight, clientHeight } = container;\r\n    const distanceFromBottom = scrollHeight - (scrollTop + clientHeight);\r\n    return distanceFromBottom <= SCROLL_THRESHOLD;\r\n  }, []);\r\n\r\n  const scrollToBottom = useCallback((behavior: ScrollBehavior = 'smooth') => {\r\n    const container = messagesContainerRef.current;\r\n    if (container) {\r\n      container.scrollTo({\r\n        top: container.scrollHeight,\r\n        behavior,\r\n      });\r\n    }\r\n    setIsNearBottom(true);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const container = messagesContainerRef.current;\r\n    if (!container) return;\r\n\r\n    let scrollTimeout: ReturnType<typeof setTimeout>;\r\n\r\n    const handleScroll = () => {\r\n      isUserScrollingRef.current = true;\r\n\r\n      clearTimeout(scrollTimeout);\r\n      scrollTimeout = setTimeout(() => {\r\n        const nearBottom = checkIfNearBottom();\r\n        setIsNearBottom(nearBottom);\r\n        isUserScrollingRef.current = false;\r\n      }, 100);\r\n    };\r\n\r\n    container.addEventListener('scroll', handleScroll, { passive: true });\r\n    return () => {\r\n      container.removeEventListener('scroll', handleScroll);\r\n      clearTimeout(scrollTimeout);\r\n    };\r\n  }, [checkIfNearBottom]);\r\n\r\n  useEffect(() => {\r\n    const messageCountChanged = messages.length !== prevMessagesLengthRef.current;\r\n    const isNewMessage = messages.length > prevMessagesLengthRef.current;\r\n\r\n    if (messageCountChanged) {\r\n      prevMessagesLengthRef.current = messages.length;\r\n\r\n      if (isNewMessage && (isNearBottom || messages.length === 1)) {\r\n        requestAnimationFrame(() => {\r\n          const container = messagesContainerRef.current;\r\n          if (container) {\r\n            container.scrollTop = container.scrollHeight;\r\n          }\r\n        });\r\n      }\r\n    }\r\n  }, [messages, isNearBottom]);\r\n\r\n  useEffect(() => {\r\n    if (aiLoading && isNearBottom) {\r\n      requestAnimationFrame(() => {\r\n        const container = messagesContainerRef.current;\r\n        if (container) {\r\n          container.scrollTop = container.scrollHeight;\r\n        }\r\n      });\r\n    }\r\n  }, [aiLoading, isNearBottom]);\r\n\r\n  // ============================================\r\n  // STEP 6.5: Generate hash for confirmation context\r\n  // ============================================\r\n  const generateConfirmationHash = useCallback(\r\n    (inputText: string, editedId: string | null, sourceId: string | null): string => {\r\n      return `${inputText.trim().substring(0, 50)}|${editedId || 'none'}|${sourceId || 'none'}`;\r\n    },\r\n    []\r\n  );\r\n\r\n  // ============================================\r\n  // STEP 6.5 + STEP 7: Resolve Intent Choice\r\n  // ============================================\r\n  const resolveIntentChoice = useCallback(\r\n    (choice: IntentChoice) => {\r\n      if (!pendingIntentChoice) return;\r\n\r\n      const { inputText, editedMessageId: pendingEditedId, uiSourceMessageId } = pendingIntentChoice;\r\n\r\n      // Save choice for \"don't ask twice\" behavior (session-level)\r\n      setLastIntentChoice(choice);\r\n      setLastConfirmationHash(generateConfirmationHash(inputText, pendingEditedId, uiSourceMessageId));\r\n\r\n      // âœ… STEP 7 + STEP 14: Record choice for learning loop (persistent)\r\n      // Respects governance: only record if learning is allowed for this user/role\r\n      const hasLastValid = messages.some(m => m.role === 'assistant');\r\n      const normalizedInstruction = inputText.toLowerCase().normalize('NFC').trim();\r\n      const patternHash = computePatternHash({\r\n        normalizedInstruction,\r\n        hasActiveSource: !!uiSourceMessageId,\r\n        hasLastValidAssistant: hasLastValid,\r\n        uiSourceMessageId,\r\n      });\r\n\r\n      // Only record choice if governance allows learning (or governance is inactive)\r\n      if (!isGovernanceActive() || isLearningAllowed()) {\r\n        recordChoice(patternHash, choice);\r\n      } else if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP14] Learning blocked by governance');\r\n      }\r\n\r\n      // âœ… STEP 9 + STEP 11: Get debug context for outcome and continuity tracking\r\n      const debugContext = pendingDebugContextRef.current;\r\n\r\n      // âœ… STEP 11: Update continuity state with user's choice\r\n      const newContinuity = updateContinuityState(continuityState, {\r\n        intentType: choice === 'CREATE_NEW' ? 'CREATE' : choice === 'EDIT_IN_PLACE' ? 'EDIT_IN_PLACE' : 'TRANSFORM',\r\n        patternHash,\r\n        choice,\r\n        routeHint: debugContext?.confidenceResult.routeHint,\r\n      });\r\n      setContinuityState(newContinuity);\r\n\r\n      // âœ… STEP 12 + STEP 14: Record preference signals from user choice\r\n      // Respects governance: only record if learning is allowed\r\n      if (!isGovernanceActive() || isLearningAllowed()) {\r\n        const prefContext: PreferenceContext = {\r\n          routeHint: debugContext?.confidenceResult.routeHint,\r\n          hasActiveSource: !!uiSourceMessageId,\r\n          inputLength: inputText.length,\r\n          stabilityBand: debugContext?.stability?.band,\r\n        };\r\n        const choiceSignals = detectChoiceSignals(choice, prefContext);\r\n        for (const signal of choiceSignals) {\r\n          recordPreference(signal);\r\n        }\r\n        // Also detect signals from the instruction itself\r\n        const instructionSignals = detectInstructionSignals(inputText);\r\n        for (const signal of instructionSignals) {\r\n          recordPreference(signal);\r\n        }\r\n      }\r\n\r\n      // âœ… STEP 9: Create outcome record for tracking\r\n      createIntentOutcome(\r\n        choiceToRoute(choice),\r\n        patternHash,\r\n        debugContext?.confidenceResult.intentConfidence\r\n      );\r\n\r\n      // Clear pending state before action\r\n      setPendingIntentChoice(null);\r\n\r\n      switch (choice) {\r\n        case 'EDIT_IN_PLACE': {\r\n          // ============================================\r\n          // STEP 6.6: EDIT_IN_PLACE - Local Apply Pathway\r\n          // ============================================\r\n          // NO LLM call - apply deterministic local transforms\r\n          const sourceId = pendingEditedId || uiSourceMessageId;\r\n          if (!sourceId) {\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.warn('[StudioEditor:STEP6.6] EDIT_IN_PLACE but no source');\r\n            }\r\n            // Fallback to TRANSFORM if no source\r\n            handleSend();\r\n            break;\r\n          }\r\n\r\n          // Find source message content\r\n          const sourceMessage = messages.find(m => m.id === sourceId);\r\n          if (!sourceMessage || sourceMessage.role !== 'assistant') {\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.warn('[StudioEditor:STEP6.6] Source message not found or not assistant');\r\n            }\r\n            handleSend();\r\n            break;\r\n          }\r\n\r\n          // Try local apply\r\n          const result = localApply(sourceMessage.content, inputText);\r\n\r\n          if (result.ok && result.nextContent) {\r\n            // Success! Apply locally without LLM\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.log('[StudioEditor:STEP6.6] Local apply success:', {\r\n                messageId: sourceId,\r\n                appliedOps: result.appliedOps,\r\n              });\r\n            }\r\n\r\n            // Store previous content for undo\r\n            const previousContent = sourceMessage.content;\r\n\r\n            // Update message content in-place\r\n            updateMessageContent(sourceId, result.nextContent);\r\n\r\n            // Clear input\r\n            setChatInput('');\r\n\r\n            // Show undo toast (5 second window)\r\n            // âœ… STEP 7: Include patternHash for negative signal tracking\r\n            setLocalEditToast({\r\n              show: true,\r\n              message: result.reason,\r\n              messageId: sourceId,\r\n              previousContent,\r\n              expiresAt: Date.now() + 5000,\r\n              patternHash, // From STEP 7 learning loop\r\n            });\r\n\r\n            // âœ… STEP 9: Start accept timer for silent acceptance detection\r\n            lastOutputAtRef.current = Date.now();\r\n            lastActiveSourceRef.current = sourceId;\r\n            startAcceptTimer();\r\n          } else {\r\n            // Local apply failed - fallback to LLM transform\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.log('[StudioEditor:STEP6.6] Local apply failed, falling back to LLM:', result.reason);\r\n            }\r\n            if (setActiveSource) {\r\n              setActiveSource(sourceId);\r\n            }\r\n            handleSend();\r\n          }\r\n          break;\r\n        }\r\n\r\n        case 'TRANSFORM_NEW_VERSION':\r\n          // TRANSFORM_NEW_VERSION: Ensure correct source is bound\r\n          // Priority: editedMessageId > uiSourceMessageId\r\n          const sourceToUse = pendingEditedId || uiSourceMessageId;\r\n          if (sourceToUse && setActiveSource) {\r\n            setActiveSource(sourceToUse);\r\n          }\r\n          if (process.env.NODE_ENV === 'development') {\r\n            console.log('[StudioEditor:STEP6.5] TRANSFORM_NEW_VERSION, source:', sourceToUse);\r\n          }\r\n          handleSend();\r\n          break;\r\n\r\n        case 'CREATE_NEW':\r\n          // CREATE_NEW: Clear any active source and send\r\n          if (setActiveSource) {\r\n            setActiveSource(null);\r\n          }\r\n          if (process.env.NODE_ENV === 'development') {\r\n            console.log('[StudioEditor:STEP6.5] CREATE_NEW, clearing source');\r\n          }\r\n          handleSend();\r\n          break;\r\n      }\r\n    },\r\n    [pendingIntentChoice, handleSend, setActiveSource, generateConfirmationHash, messages, updateMessageContent, setChatInput, createIntentOutcome, startAcceptTimer, continuityState]\r\n  );\r\n\r\n  // ============================================\r\n  // STEP 6.5: Cancel Confirmation\r\n  // ============================================\r\n  const cancelIntentConfirmation = useCallback(() => {\r\n    setPendingIntentChoice(null);\r\n  }, []);\r\n\r\n  // ============================================\r\n  // STEP 14A: Handle Create Warning Response\r\n  // ============================================\r\n  const handleCreateWarningResponse = useCallback((confirmation: CreateConfirmation) => {\r\n    handleCreateConfirmation(confirmation);\r\n    setShowCreateWarning(false);\r\n\r\n    if (confirmation === 'CREATE_NEW' && pendingCreateIntent) {\r\n      // User explicitly wants new draft - enter create mode and send\r\n      enterCreateMode();\r\n      refreshEditorialMode();\r\n      if (setActiveSource) {\r\n        setActiveSource(null);\r\n      }\r\n      handleSend();\r\n    } else if (confirmation === 'CONTINUE_EDITING') {\r\n      // User wants to continue editing - re-attempt with EDIT_IN_PLACE forced\r\n      // The override is already applied, just proceed\r\n      handleSend();\r\n    }\r\n\r\n    setPendingCreateIntent(null);\r\n  }, [pendingCreateIntent, handleSend, setActiveSource, refreshEditorialMode]);\r\n\r\n  // ============================================\r\n  // STEP 27: Handle Rewrite Confirmation Response\r\n  // ============================================\r\n  const handleRewriteConfirmation = useCallback(() => {\r\n    const currentDraftId = getActiveDraftId();\r\n    if (!currentDraftId) {\r\n      // Edge case: draft disappeared while dialog was shown\r\n      setShowRewriteConfirmation(false);\r\n      pendingRewriteInputRef.current = null;\r\n      return;\r\n    }\r\n\r\n    // Mark as confirmed for this draft (UI state only)\r\n    setRewriteConfirmedForDraftId(currentDraftId);\r\n    setShowRewriteConfirmation(false);\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP27] Rewrite confirmed for draft', currentDraftId);\r\n    }\r\n\r\n    // Proceed with original send\r\n    pendingRewriteInputRef.current = null;\r\n    handleSend();\r\n  }, [handleSend]);\r\n\r\n  const handleRewriteCreateNew = useCallback(() => {\r\n    // User wants to create new instead - switch to CREATE mode\r\n    setShowRewriteConfirmation(false);\r\n    pendingRewriteInputRef.current = null;\r\n    setRewriteConfirmedForDraftId(null);\r\n\r\n    // Enter create mode and clear source\r\n    enterCreateMode();\r\n    refreshEditorialMode();\r\n    if (setActiveSource) {\r\n      setActiveSource(null);\r\n    }\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP27] User chose CREATE instead of REWRITE');\r\n    }\r\n\r\n    // User needs to re-send with different intent\r\n    // Don't auto-send - let them adjust their prompt if needed\r\n  }, [setActiveSource, refreshEditorialMode]);\r\n\r\n  const handleRewriteCancel = useCallback(() => {\r\n    setShowRewriteConfirmation(false);\r\n    pendingRewriteInputRef.current = null;\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP27] Rewrite confirmation cancelled');\r\n    }\r\n  }, []);\r\n\r\n  // ============================================\r\n  // STEP 19: Handle Scope Pick Response\r\n  // ============================================\r\n  const handleScopePickResponse = useCallback((pickedTarget: 'HOOK' | 'BODY' | 'CTA' | 'TONE' | 'FULL') => {\r\n    if (!pendingScopeGate) return;\r\n\r\n    const { inputText } = pendingScopeGate;\r\n    const lang = (language as 'vi' | 'en') || 'vi';\r\n\r\n    // Extract locked sections from activeCanon (STEP 15)\r\n    const canonLockedSections: ('HOOK' | 'BODY' | 'CTA')[] = [];\r\n    if (activeCanon?.hook.locked) canonLockedSections.push('HOOK');\r\n    if (activeCanon?.cta.locked) canonLockedSections.push('CTA');\r\n\r\n    // Build contract with user-picked target\r\n    const contract = buildEditScopeContract({\r\n      instructionText: inputText,\r\n      lang,\r\n      activeCanonLocks: canonLockedSections,\r\n      hasActiveCanon: !!activeCanon,\r\n      userPickedTarget: pickedTarget,\r\n    });\r\n\r\n    // Store for badge display\r\n    setActiveScopeContract(contract);\r\n    // Store in ref for passing through handleSend\r\n    selectedScopeContractRef.current = contract;\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP19] User picked scope:', {\r\n        target: contract.target,\r\n        lockedSections: contract.lockedSections,\r\n        source: contract.source,\r\n      });\r\n    }\r\n\r\n    // Clear pending gate\r\n    setPendingScopeGate(null);\r\n\r\n    // Now proceed with send\r\n    handleSend();\r\n  }, [pendingScopeGate, language, activeCanon, handleSend]);\r\n\r\n  // ============================================\r\n  // STEP 19: Cancel Scope Pick\r\n  // ============================================\r\n  const cancelScopePick = useCallback(() => {\r\n    setPendingScopeGate(null);\r\n  }, []);\r\n\r\n  // ============================================\r\n  // STEP 6.5 + STEP 7 + STEP 8 + STEP 9 + STEP 14 + STEP 14A: Attempt Send with Confirmation, Learning, Debug, Outcome, Governance & Editorial Authority\r\n  // ============================================\r\n  // eslint-disable-next-line react-hooks/preserve-manual-memoization -- Complex callback with intentional partial deps\r\n  const attemptSend = useCallback(() => {\r\n    if (!canSubmit) return;\r\n\r\n    // âœ… STEP 14A: Check if edit is locked (waiting for LLM response)\r\n    if (isEditLocked()) {\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP14A] Edit locked, ignoring send');\r\n      }\r\n      return;\r\n    }\r\n\r\n    // âœ… STEP 14: Get governance context and check execution permission\r\n    const governanceContext = getGovernanceContext();\r\n    if (isGovernanceActive() && !isExecutionAllowed()) {\r\n      // VIEWER role cannot execute - show message and return\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP14] Execution blocked by governance:', {\r\n          role: governanceContext?.role,\r\n          userId: governanceContext?.userId,\r\n        });\r\n      }\r\n      // TODO: Could show a toast message here\r\n      return;\r\n    }\r\n\r\n    // âœ… STEP 9: Check for RESEND_IMMEDIATELY (within 10s of last output, same source)\r\n    const timeSinceOutput = Date.now() - lastOutputAtRef.current;\r\n    if (timeSinceOutput < 10000 && lastOutputAtRef.current > 0) {\r\n      // User resent quickly - record as potential negative signal\r\n      cancelAcceptTimer();\r\n      recordOutcomeSignal('RESEND_IMMEDIATELY', {\r\n        withinMs: timeSinceOutput,\r\n        sameSource: activeSourceId === lastActiveSourceRef.current,\r\n      });\r\n    }\r\n\r\n    const inputText = chatInput.trim();\r\n    const currentSourceId = activeSourceId;\r\n    const hasLastValid = messages.some(m => m.role === 'assistant');\r\n\r\n    // ============================================\r\n    // STEP 22: REWRITE_UPGRADE Context Guard (UI pre-flight)\r\n    // ============================================\r\n    // Detect task type EARLY to check if REWRITE_UPGRADE is attempted without context.\r\n    // This provides immediate user feedback without waiting for server response.\r\n    const taskDetectionCtx: TaskDetectionContext = {\r\n      hasActiveDraft: hasActiveDraft(),\r\n      hasPreviousMessages: hasLastValid,\r\n      lang: (language as 'vi' | 'en') || 'vi',\r\n    };\r\n    const taskDetection = detectTaskType(inputText, taskDetectionCtx);\r\n\r\n    // ============================================\r\n    // STEP 29: Kill-Switch Gate\r\n    // ============================================\r\n    // When kill-switch is active, route REWRITE_UPGRADE to CREATE.\r\n    // Detection still runs for telemetry, but flow is redirected.\r\n    const rewriteEnabled = isRewriteUpgradeEnabled();\r\n    if (taskDetection.taskType === 'REWRITE_UPGRADE' && !rewriteEnabled) {\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP29] Kill-switch active, routing to CREATE', {\r\n          detectedTaskType: taskDetection.taskType,\r\n          killSwitchActive: true,\r\n        });\r\n      }\r\n      // Fall through to CREATE path - no special REWRITE_UPGRADE handling\r\n      // The rest of attemptSend will treat this as a normal CREATE\r\n    }\r\n\r\n    if (taskDetection.taskType === 'REWRITE_UPGRADE' && rewriteEnabled) {\r\n      const hasContext = taskDetectionCtx.hasActiveDraft || taskDetectionCtx.hasPreviousMessages;\r\n      if (!hasContext) {\r\n        // BLOCK: Show error message to user, do NOT call LLM\r\n        const errorMessage = REWRITE_NO_CONTEXT_ERROR[taskDetectionCtx.lang];\r\n\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.warn('[StudioEditor:STEP22] BLOCKED: REWRITE_UPGRADE without context', {\r\n            inputText: inputText.substring(0, 50),\r\n            taskType: taskDetection.taskType,\r\n            hasActiveDraft: taskDetectionCtx.hasActiveDraft,\r\n            hasPreviousMessages: taskDetectionCtx.hasPreviousMessages,\r\n          });\r\n        }\r\n\r\n        // Display error using existing aiError mechanism (rendered in UI)\r\n        setAiError(errorMessage);\r\n\r\n        return; // DO NOT proceed to handleSend - no LLM call\r\n      }\r\n\r\n      // ============================================\r\n      // STEP 27: Rewrite Intent Confirmation Gate\r\n      // ============================================\r\n      // Show confirmation dialog ONCE per draft before first REWRITE_UPGRADE\r\n      const currentDraftId = getActiveDraftId();\r\n      if (taskDetectionCtx.hasActiveDraft && currentDraftId) {\r\n        // Check if user has already confirmed for this draft\r\n        if (rewriteConfirmedForDraftId !== currentDraftId) {\r\n          // Need confirmation - store input and show dialog\r\n          pendingRewriteInputRef.current = inputText;\r\n          setShowRewriteConfirmation(true);\r\n\r\n          if (process.env.NODE_ENV === 'development') {\r\n            console.log('[StudioEditor:STEP27] Showing rewrite confirmation', {\r\n              draftId: currentDraftId,\r\n              inputPreview: inputText.substring(0, 50),\r\n            });\r\n          }\r\n\r\n          return; // DO NOT proceed - wait for user confirmation\r\n        }\r\n        // Already confirmed for this draft - proceed normally\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.log('[StudioEditor:STEP27] Rewrite already confirmed for draft', currentDraftId);\r\n        }\r\n      }\r\n    }\r\n\r\n    // ============================================\r\n    // STEP 7: Compute confidence for observability\r\n    // ============================================\r\n    const explicitNewCreate = isExplicitNewCreate(inputText);\r\n    const explicitTransformRef = isExplicitTransformReference(inputText);\r\n    const ambiguousTransform = isAmbiguousInstruction(inputText);\r\n\r\n    const confidenceInput: ConfidenceInput = {\r\n      inputText,\r\n      hasActiveSource: !!currentSourceId,\r\n      hasLastValidAssistant: hasLastValid,\r\n      isExplicitNewCreate: explicitNewCreate,\r\n      isExplicitTransformRef: explicitTransformRef,\r\n      isAmbiguousTransform: ambiguousTransform,\r\n      inputLength: inputText.length,\r\n    };\r\n\r\n    const confidenceResult = computeRouteConfidence(confidenceInput);\r\n\r\n    // ============================================\r\n    // STEP 7: Compute pattern hash for learning\r\n    // ============================================\r\n    const normalizedInstruction = inputText.toLowerCase().normalize('NFC').trim();\r\n    const patternHash = computePatternHash({\r\n      normalizedInstruction,\r\n      hasActiveSource: !!currentSourceId,\r\n      hasLastValidAssistant: hasLastValid,\r\n      uiSourceMessageId: currentSourceId,\r\n    });\r\n\r\n    // ============================================\r\n    // STEP 8: Helper to log and set debug decision\r\n    // ============================================\r\n    const logDebugDecision = (path: DecisionPath, choice?: IntentChoice, autoApply?: IntentChoice) => {\r\n      if (!isIntentDebugEnabled()) return;\r\n\r\n      const learned = getLearnedChoice(patternHash);\r\n      const decision = createDebugDecision({\r\n        patternHash,\r\n        confidenceInput,\r\n        confidenceResult,\r\n        decisionPath: path,\r\n        autoApplyChoice: autoApply || null,\r\n        learnedCount: learned?.count,\r\n        confirmationShown: path === 'CONFIRMATION_SHOWN' || path === 'USER_CONFIRMED',\r\n        uiSourceMessageId: currentSourceId,\r\n        finalChoice: choice,\r\n      });\r\n\r\n      setLastDebugDecision(decision);\r\n      logIntentDecision(decision);\r\n    };\r\n\r\n    // ============================================\r\n    // STEP 14A: Editorial Authority Override (CRITICAL)\r\n    // When a draft is active, FORCE route to EDIT_IN_PLACE\r\n    // ============================================\r\n    const detectedIntent: 'CREATE' | 'TRANSFORM' | 'EDIT_IN_PLACE' =\r\n      explicitNewCreate ? 'CREATE' :\r\n      confidenceResult.routeHint === 'CREATE' ? 'CREATE' : 'TRANSFORM';\r\n\r\n    const editorialOverride = checkIntentOverride(detectedIntent);\r\n\r\n    if (editorialOverride.blocked && editorialOverride.showCreateWarning) {\r\n      // Draft is active - show warning before allowing CREATE/TRANSFORM\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP14A] Editorial override - showing create warning:', {\r\n          attempted: editorialOverride.originalIntent,\r\n          enforced: editorialOverride.finalIntent,\r\n          reason: editorialOverride.reason,\r\n        });\r\n      }\r\n\r\n      // Store the pending intent for when user confirms\r\n      setPendingCreateIntent({\r\n        originalIntent: detectedIntent,\r\n        inputText,\r\n      });\r\n      setShowCreateWarning(true);\r\n      return;\r\n    }\r\n\r\n    if (editorialOverride.overridden) {\r\n      // Editorial authority overrode the intent - use EDIT_IN_PLACE\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP14A] Intent overridden to EDIT_IN_PLACE:', {\r\n          original: editorialOverride.originalIntent,\r\n          reason: editorialOverride.reason,\r\n        });\r\n      }\r\n\r\n      // Force EDIT_IN_PLACE path - lock for edit and proceed\r\n      lockForEdit();\r\n      refreshEditorialMode();\r\n\r\n      const lang = (language as 'vi' | 'en') || 'vi';\r\n\r\n      // ============================================\r\n      // STEP 20: Edit Intent Normalization (BEFORE STEP 19)\r\n      // Translates natural VN/EN edit language â†’ canonical edit intent\r\n      // This helps understand \"thÃªm thÃ´ng tin\" as EDIT_IN_PLACE + BODY\r\n      // ============================================\r\n      const normalizedIntent = normalizeEditIntent(inputText, {\r\n        hasActiveDraft: hasActiveDraft(),\r\n        canonLockState: activeCanon ? {\r\n          lockedSections: [\r\n            ...(activeCanon.hook.locked ? ['HOOK' as const] : []),\r\n            ...(activeCanon.cta.locked ? ['CTA' as const] : []),\r\n          ],\r\n          hasActiveCanon: true,\r\n        } : undefined,\r\n        lang,\r\n      });\r\n\r\n      if (process.env.NODE_ENV === 'development' && normalizedIntent) {\r\n        console.log('[StudioEditor:STEP20] Edit intent normalized:', {\r\n          target: normalizedIntent.target,\r\n          confidence: normalizedIntent.confidence,\r\n          reason: normalizedIntent.reason,\r\n          matchedPatterns: normalizedIntent.matchedPatterns,\r\n        });\r\n      }\r\n\r\n      // ============================================\r\n      // STEP 19: Edit Scope Gating (CRITICAL)\r\n      // BEFORE sending, check if scope is ambiguous.\r\n      // If so, gate execution until user picks scope.\r\n      // STEP 20 normalization helps reduce false ambiguity.\r\n      // ============================================\r\n\r\n      // ============================================\r\n      // STEP 21: Edit Patch Execution Layer\r\n      // When EDIT intent + target are HIGH confidence â†’ NEVER block execution.\r\n      // Skip scope gating for ANY specific target (not just BODY).\r\n      // ============================================\r\n      const skipScopeGating = !!normalizedIntent &&\r\n        normalizedIntent.confidence === 'HIGH' &&\r\n        normalizedIntent.target !== 'FULL';\r\n\r\n      const scopeGate = skipScopeGating\r\n        ? { requiresUserPick: false, suggested: undefined }\r\n        : shouldGateForScopePick(inputText, !!activeCanon, lang);\r\n\r\n      if (scopeGate.requiresUserPick) {\r\n        // Scope is ambiguous - gate execution\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.log('[StudioEditor:STEP19] Scope gating - requires user pick:', {\r\n            suggested: scopeGate.suggested,\r\n            inputText: inputText.substring(0, 50),\r\n          });\r\n        }\r\n\r\n        // Store the pending scope gate\r\n        setPendingScopeGate({\r\n          gate: scopeGate,\r\n          inputText,\r\n        });\r\n\r\n        // DO NOT call handleSend - return and wait for user pick\r\n        return;\r\n      }\r\n\r\n      // Scope is clear - build contract and proceed\r\n      // Extract locked sections from activeCanon (STEP 15)\r\n      const canonLockedSections: ('HOOK' | 'BODY' | 'CTA')[] = [];\r\n      if (activeCanon?.hook.locked) canonLockedSections.push('HOOK');\r\n      if (activeCanon?.cta.locked) canonLockedSections.push('CTA');\r\n\r\n      // Use STEP 20 normalized target if available with HIGH confidence,\r\n      // otherwise let STEP 19 buildEditScopeContract detect it\r\n      const userPickedTarget = normalizedIntent?.confidence === 'HIGH'\r\n        ? normalizedIntent.target\r\n        : undefined;\r\n\r\n      const contract = buildEditScopeContract({\r\n        instructionText: inputText,\r\n        lang,\r\n        activeCanonLocks: canonLockedSections,\r\n        hasActiveCanon: !!activeCanon,\r\n        userPickedTarget, // Use STEP 20 result if HIGH confidence\r\n      });\r\n\r\n      // Store for badge display\r\n      setActiveScopeContract(contract);\r\n      // Store in ref for passing through handleSend\r\n      selectedScopeContractRef.current = contract;\r\n\r\n      // ============================================\r\n      // STEP 21: Build edit patch metadata\r\n      // This enables partial edits (BODY-only, CTA-only, etc.)\r\n      // without requiring full Hook/Body/CTA structure.\r\n      // ============================================\r\n      const editPatchMeta = normalizedIntent ? buildEditPatchMeta(normalizedIntent) : null;\r\n      const skipStructureValidation = shouldSkipStructureValidation(normalizedIntent);\r\n      const partialOutputAllowed = allowsPartialOutput(normalizedIntent);\r\n\r\n      // âœ… STEP 21: Set edit patch meta in context before handleSend\r\n      setEditPatchMeta(editPatchMeta);\r\n\r\n      // ============================================\r\n      // STEP 22: Build output contract from patch meta\r\n      // When we have a patch target, enforce PATCH_ONLY output format.\r\n      // This instructs LLM to return [PATCH] blocks only, not full rewrites.\r\n      // ============================================\r\n      const outputContract = buildOutputContractFromMeta(editPatchMeta);\r\n      setOutputContract(outputContract);\r\n\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[StudioEditor:STEP19] Scope contract built:', {\r\n          target: contract.target,\r\n          lockedSections: contract.lockedSections,\r\n          source: contract.source,\r\n          confidence: contract.confidence,\r\n        });\r\n        console.log('[StudioEditor:STEP21] Edit patch config:', {\r\n          patchMeta: editPatchMeta ? getEditPatchDebugSummary(editPatchMeta) : 'none',\r\n          skipStructureValidation,\r\n          partialOutputAllowed,\r\n        });\r\n        console.log('[StudioEditor:STEP22] Output contract:', {\r\n          contract: getOutputContractDebugSummary(outputContract),\r\n        });\r\n      }\r\n\r\n      // Log debug decision for editorial override\r\n      logDebugDecision('EXPLICIT_TRANSFORM_REF', 'EDIT_IN_PLACE'); // Reuse path for now\r\n      createIntentOutcome('TRANSFORM', patternHash, confidenceResult.intentConfidence); // EDIT_IN_PLACE uses TRANSFORM route\r\n\r\n      // Ensure source is set to the active draft\r\n      const activeDraft = getActiveDraftId();\r\n      if (activeDraft && setActiveSource) {\r\n        setActiveSource(activeDraft);\r\n      }\r\n\r\n      handleSend();\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // Check for escape hatches first (high confidence paths)\r\n    // ============================================\r\n    if (explicitNewCreate) {\r\n      // Explicit CREATE: clear source and send directly\r\n      logDebugDecision('EXPLICIT_NEW_CREATE', 'CREATE_NEW');\r\n      // âœ… STEP 9: Create outcome for explicit create\r\n      createIntentOutcome('CREATE', patternHash, confidenceResult.intentConfidence);\r\n      if (setActiveSource) {\r\n        setActiveSource(null);\r\n      }\r\n      handleSend();\r\n      return;\r\n    }\r\n\r\n    if (explicitTransformRef) {\r\n      // Explicit TRANSFORM reference: send directly with current binding\r\n      logDebugDecision('EXPLICIT_TRANSFORM_REF', 'TRANSFORM_NEW_VERSION');\r\n      // âœ… STEP 9: Create outcome for explicit transform\r\n      createIntentOutcome('TRANSFORM', patternHash, confidenceResult.intentConfidence);\r\n      handleSend();\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // Check if we should confirm\r\n    // ============================================\r\n    const needsConfirmation = shouldConfirmIntent({\r\n      isEditing,\r\n      editedMessageId,\r\n      uiSourceMessageId: currentSourceId,\r\n      inputText,\r\n    });\r\n\r\n    if (!needsConfirmation) {\r\n      // No confirmation needed, send directly\r\n      const defaultChoice = confidenceResult.routeHint === 'CREATE' ? 'CREATE_NEW' : 'TRANSFORM_NEW_VERSION';\r\n      logDebugDecision('DEFAULT_NO_CONFIRM', defaultChoice);\r\n      // âœ… STEP 9: Create outcome for default path\r\n      createIntentOutcome(\r\n        confidenceResult.routeHint === 'CREATE' ? 'CREATE' : 'TRANSFORM',\r\n        patternHash,\r\n        confidenceResult.intentConfidence\r\n      );\r\n      handleSend();\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // STEP 7 + STEP 13 + STEP 14: Check learned choices (learning loop)\r\n    // Respects user control AND governance: only auto-apply if both allow\r\n    // ============================================\r\n    const canAutoApply = isAutoApplyEnabled() && (!isGovernanceActive() || isAutoApplyAllowedByGovernance());\r\n    const autoApplyChoice = canAutoApply ? getAutoApplyChoice(patternHash) : null;\r\n    if (autoApplyChoice) {\r\n      // Log debug decision for auto-apply\r\n      logDebugDecision('LEARNED_CHOICE', autoApplyChoice, autoApplyChoice);\r\n      // âœ… STEP 9: Create outcome for auto-applied choice\r\n      createIntentOutcome(choiceToRoute(autoApplyChoice), patternHash, confidenceResult.intentConfidence);\r\n\r\n      // Apply the learned choice directly (same as resolveIntentChoice but without UI)\r\n      switch (autoApplyChoice) {\r\n        case 'EDIT_IN_PLACE':\r\n        case 'TRANSFORM_NEW_VERSION':\r\n          handleSend();\r\n          break;\r\n        case 'CREATE_NEW':\r\n          if (setActiveSource) {\r\n            setActiveSource(null);\r\n          }\r\n          handleSend();\r\n          break;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // Check \"don't ask twice\" - session-level cache (existing behavior)\r\n    // ============================================\r\n    const currentHash = generateConfirmationHash(inputText, editedMessageId, currentSourceId);\r\n    if (lastConfirmationHash === currentHash && lastIntentChoice) {\r\n      // Log debug decision for cached choice\r\n      logDebugDecision('SESSION_CACHE', lastIntentChoice);\r\n      // âœ… STEP 9: Create outcome for cached choice\r\n      createIntentOutcome(choiceToRoute(lastIntentChoice), patternHash, confidenceResult.intentConfidence);\r\n\r\n      // Apply the cached choice directly\r\n      switch (lastIntentChoice) {\r\n        case 'EDIT_IN_PLACE':\r\n        case 'TRANSFORM_NEW_VERSION':\r\n          handleSend();\r\n          break;\r\n        case 'CREATE_NEW':\r\n          if (setActiveSource) {\r\n            setActiveSource(null);\r\n          }\r\n          handleSend();\r\n          break;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // STEP 10: Compute stability and check confirmation gating\r\n    // ============================================\r\n    const stability = computeStability(patternHash);\r\n    const confirmGating = getConfirmationGating(stability);\r\n\r\n    // ============================================\r\n    // STEP 11: Helper to update continuity state after a decision\r\n    // ============================================\r\n    const updateContinuity = (choice: IntentChoice) => {\r\n      const newContinuity = updateContinuityState(continuityState, {\r\n        intentType: choice === 'CREATE_NEW' ? 'CREATE' : choice === 'EDIT_IN_PLACE' ? 'EDIT_IN_PLACE' : 'TRANSFORM',\r\n        patternHash,\r\n        choice,\r\n        routeHint: confidenceResult.routeHint,\r\n      });\r\n      setContinuityState(newContinuity);\r\n    };\r\n\r\n    if (confirmGating === 'SKIP') {\r\n      // HIGH stability + auto-apply eligible: skip confirmation\r\n      const defaultChoice = confidenceResult.routeHint === 'CREATE' ? 'CREATE_NEW' : 'TRANSFORM_NEW_VERSION';\r\n      logDebugDecision('HIGH_CONFIDENCE_AUTO', defaultChoice);\r\n      // âœ… STEP 9: Create outcome for stability-skipped confirmation\r\n      createIntentOutcome(\r\n        confidenceResult.routeHint === 'CREATE' ? 'CREATE' : 'TRANSFORM',\r\n        patternHash,\r\n        confidenceResult.intentConfidence\r\n      );\r\n      // âœ… STEP 11: Update continuity state\r\n      updateContinuity(defaultChoice);\r\n      handleSend();\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // STEP 11: Check continuity-based confirmation skip\r\n    // ============================================\r\n    const continuitySkip = shouldSkipConfirmationByContext({\r\n      continuity: continuityState,\r\n      stabilityBand: stability.band,\r\n      routeHint: confidenceResult.routeHint,\r\n      autoApplyEligible: stability.autoApplyEligible,\r\n    });\r\n\r\n    if (continuitySkip === 'SKIP') {\r\n      // Continuity suggests we can skip (e.g., REFINE_FLOW + matching hint)\r\n      const defaultChoice = confidenceResult.routeHint === 'CREATE' ? 'CREATE_NEW' : 'TRANSFORM_NEW_VERSION';\r\n      logDebugDecision('HIGH_CONFIDENCE_AUTO', defaultChoice);\r\n      createIntentOutcome(\r\n        confidenceResult.routeHint === 'CREATE' ? 'CREATE' : 'TRANSFORM',\r\n        patternHash,\r\n        confidenceResult.intentConfidence\r\n      );\r\n      updateContinuity(defaultChoice);\r\n      handleSend();\r\n      return;\r\n    }\r\n\r\n    // ============================================\r\n    // STEP 12 + STEP 13 + STEP 14: Compute preference bias for debug display and ordering\r\n    // Respects user control AND governance: only compute if both allow\r\n    // ============================================\r\n    const canUsePreferenceBias = arePreferencesEnabled() && (!isGovernanceActive() || isPreferenceBiasAllowed());\r\n    const preferenceBias = canUsePreferenceBias\r\n      ? getPreferenceBias({\r\n          routeHint: confidenceResult.routeHint,\r\n          hasActiveSource: !!currentSourceId,\r\n          inputLength: inputText.length,\r\n          stabilityBand: stability.band,\r\n        })\r\n      : { activePreferences: [], defaultChoiceBias: undefined, defaultChoiceStrength: 0, optionOrderBias: [], debugSummary: isGovernanceActive() ? 'Preferences disabled by governance' : 'Preferences disabled' };\r\n\r\n    // âœ… STEP 14: Compute governance decision for confirmation flow\r\n    const governanceDecision = governanceContext\r\n      ? shouldForceConfirmation(\r\n          governanceContext,\r\n          {\r\n            patternHash,\r\n            routeHint: confidenceResult.routeHint,\r\n            confidence: confidenceResult.intentConfidence,\r\n            autoApplySuggested: !!autoApplyChoice,\r\n          },\r\n          continuityState,\r\n          stability.band\r\n        )\r\n      : null;\r\n\r\n    // ============================================\r\n    // STEP 8 + STEP 14: Store pending debug context for confirmation resolution\r\n    // ============================================\r\n    const debugContext: DebugContextType = {\r\n      patternHash,\r\n      confidenceInput,\r\n      confidenceResult,\r\n      uiSourceMessageId: currentSourceId,\r\n      // âœ… STEP 10: Include stability metrics for debug display\r\n      stability,\r\n      // âœ… STEP 11: Include continuity state for debug display\r\n      continuity: continuityState,\r\n      // âœ… STEP 12: Include preference bias for debug display\r\n      preferenceBias,\r\n      // âœ… STEP 14: Include governance decision for debug display\r\n      governanceDecision: governanceDecision ?? undefined,\r\n    };\r\n    pendingDebugContextRef.current = debugContext;\r\n    setDebugContextForRender(debugContext);\r\n\r\n    // Log that confirmation is being shown\r\n    logDebugDecision('CONFIRMATION_SHOWN');\r\n\r\n    // ============================================\r\n    // Show confirmation UI\r\n    // ============================================\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[StudioEditor:STEP6.5] Showing intent confirmation:', {\r\n        inputText: inputText.substring(0, 50),\r\n        editedMessageId,\r\n        uiSourceMessageId: currentSourceId,\r\n        patternHash,\r\n        intentConfidence: confidenceResult.intentConfidence.toFixed(2),\r\n        stabilityBand: stability.band,\r\n        confirmGating,\r\n      });\r\n    }\r\n\r\n    setPendingIntentChoice({\r\n      inputText,\r\n      editedMessageId,\r\n      uiSourceMessageId: currentSourceId,\r\n    });\r\n  }, [\r\n    canSubmit,\r\n    chatInput,\r\n    activeSourceId,\r\n    messages,\r\n    isEditing,\r\n    editedMessageId,\r\n    handleSend,\r\n    setActiveSource,\r\n    lastIntentChoice,\r\n    lastConfirmationHash,\r\n    generateConfirmationHash,\r\n    createIntentOutcome,\r\n    cancelAcceptTimer,\r\n    recordOutcomeSignal,\r\n    // âœ… STEP 11: Include continuity state for flow detection\r\n    continuityState,\r\n  ]);\r\n\r\n  // Handle submit\r\n  const handleSubmit = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!canSubmit) return;\r\n    attemptSend();\r\n  };\r\n\r\n  const handleKeyDown = (e: React.KeyboardEvent) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      if (canSubmit) {\r\n        attemptSend();\r\n      }\r\n    }\r\n    // ESC to cancel confirmation\r\n    if (e.key === 'Escape' && pendingIntentChoice) {\r\n      e.preventDefault();\r\n      cancelIntentConfirmation();\r\n    }\r\n  };\r\n\r\n  const handleCopy = async (content: string) => {\r\n    try {\r\n      await navigator.clipboard.writeText(content);\r\n    } catch (error) {\r\n      console.error('Failed to copy:', error);\r\n    }\r\n  };\r\n\r\n  const onTransformAction = useCallback(\r\n    (action: ActionType, messageId: string) => {\r\n      if (handleTransformAction) {\r\n        handleTransformAction(action, messageId);\r\n      }\r\n    },\r\n    [handleTransformAction]\r\n  );\r\n\r\n  const activeSourceContent = activeSourceId ? messages.find((m) => m.id === activeSourceId)?.content || '' : '';\r\n\r\n  const handleChangeSource = useCallback(() => {\r\n    setIsSourcePickerMode(true);\r\n    messagesContainerRef.current?.scrollTo({ top: 0, behavior: 'smooth' });\r\n  }, []);\r\n\r\n  const handleSelectSource = useCallback(\r\n    (messageId: string) => {\r\n      if (isSourcePickerMode && setActiveSource) {\r\n        setActiveSource(messageId);\r\n        setIsSourcePickerMode(false);\r\n      }\r\n    },\r\n    [isSourcePickerMode, setActiveSource]\r\n  );\r\n\r\n  // Entry state\r\n  const isEntryState = messages.length === 0;\r\n\r\n  // Check if actions should be disabled (loading states)\r\n  const isActionDisabled = aiLoading || !!transformLoading;\r\n\r\n  // ============================================\r\n  // STEP 6.5 + STEP 8: Intent Confirmation Panel with Debug\r\n  // ============================================\r\n  const renderIntentConfirmation = () => {\r\n    if (!pendingIntentChoice) return null;\r\n\r\n    // Get pending debug context for explainability (use state, not ref, during render)\r\n    const debugContext = debugContextForRender;\r\n\r\n    // âœ… STEP 10 + STEP 13: Get trust microcopy for display\r\n    const hasActivePrefs = arePreferencesEnabled() && (debugContext?.preferenceBias?.activePreferences?.length ?? 0) > 0;\r\n\r\n    return (\r\n      <div className=\"mx-auto w-full max-w-4xl px-4 sm:px-6 mb-2 animate-fade-in\">\r\n        <div className=\"bg-amber-50 dark:bg-amber-950/40 border border-amber-200 dark:border-amber-800/60 rounded-xl p-4\">\r\n          <div className=\"flex items-center justify-between mb-3\">\r\n            <p className=\"text-sm font-medium text-amber-800 dark:text-amber-200\">\r\n              Báº¡n muá»‘n Ã¡p dá»¥ng yÃªu cáº§u nÃ y cho Ä‘Ã¢u?\r\n            </p>\r\n            {/* âœ… STEP 13: Trust microcopy (production-safe) */}\r\n            <TrustMicrocopy\r\n              stabilityMetrics={debugContext?.stability}\r\n              hasActivePreferences={hasActivePrefs}\r\n              language=\"vi\"\r\n            />\r\n          </div>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {/* Option 1: Edit in place (only show if editing) */}\r\n            {isEditing && editedMessageId && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => resolveIntentChoice('EDIT_IN_PLACE')}\r\n                disabled={isActionDisabled}\r\n                className=\"flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-card border border-border text-foreground hover:bg-secondary transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                <span>âœï¸</span>\r\n                <span>Sá»­a trá»±c tiáº¿p ná»™i dung Ä‘ang má»Ÿ</span>\r\n              </button>\r\n            )}\r\n\r\n            {/* Option 2: Transform (create new version) */}\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => resolveIntentChoice('TRANSFORM_NEW_VERSION')}\r\n              disabled={isActionDisabled}\r\n              className=\"flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-card border border-border text-foreground hover:bg-secondary transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              <span>ðŸ”</span>\r\n              <span>Táº¡o phiÃªn báº£n má»›i tá»« ná»™i dung nÃ y</span>\r\n            </button>\r\n\r\n            {/* Option 3: Create new */}\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => resolveIntentChoice('CREATE_NEW')}\r\n              disabled={isActionDisabled}\r\n              className=\"flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg bg-card border border-border text-muted-foreground hover:bg-secondary hover:text-foreground transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              <span>ðŸ†•</span>\r\n              <span>Viáº¿t ná»™i dung má»›i</span>\r\n            </button>\r\n          </div>\r\n\r\n          {/* Cancel link */}\r\n          <button\r\n            type=\"button\"\r\n            onClick={cancelIntentConfirmation}\r\n            className=\"mt-3 text-xs text-amber-600 dark:text-amber-400 hover:text-amber-800 dark:hover:text-amber-200 transition-colors\"\r\n          >\r\n            Há»§y\r\n          </button>\r\n\r\n          {/* STEP 8: Debug explainability (DEV only) */}\r\n          {debugContext && (\r\n            <IntentConfirmExplain\r\n              confidence={debugContext.confidenceResult.intentConfidence}\r\n              routeHint={debugContext.confidenceResult.routeHint}\r\n              reason={debugContext.confidenceResult.reason}\r\n              hasActiveSource={debugContext.confidenceInput.hasActiveSource}\r\n              hasLastValidAssistant={debugContext.confidenceInput.hasLastValidAssistant}\r\n              patternHash={debugContext.patternHash}\r\n              stability={debugContext.stability}\r\n              continuity={debugContext.continuity}\r\n            />\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // ============================================\r\n  // STEP 14A: Editorial Authority Create Warning Modal\r\n  // ============================================\r\n  const renderCreateWarning = () => {\r\n    if (!showCreateWarning) return null;\r\n\r\n    const copy = getCreateWarningCopy('vi');\r\n\r\n    return (\r\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 animate-fade-in\">\r\n        <div className=\"bg-card rounded-xl shadow-xl max-w-md w-full mx-4 p-6 border border-border\">\r\n          <div className=\"flex items-start gap-3 mb-4\">\r\n            <span className=\"text-2xl\">âœï¸</span>\r\n            <div>\r\n              <h3 className=\"text-lg font-semibold text-foreground\">\r\n                {copy.title}\r\n              </h3>\r\n              <p className=\"text-sm text-muted-foreground mt-1\">\r\n                {copy.message}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex flex-col gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => handleCreateWarningResponse('CONTINUE_EDITING')}\r\n              className=\"flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium rounded-lg bg-primary text-primary-foreground hover:opacity-90 transition-all\"\r\n            >\r\n              <span>âœï¸</span>\r\n              <span>{copy.continueEditing}</span>\r\n            </button>\r\n\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => handleCreateWarningResponse('CREATE_NEW')}\r\n              className=\"flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium rounded-lg bg-secondary text-secondary-foreground hover:bg-secondary/80 transition-colors\"\r\n            >\r\n              <span>ðŸ†•</span>\r\n              <span>{copy.createNew}</span>\r\n            </button>\r\n\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => {\r\n                handleCreateWarningResponse('CANCEL');\r\n              }}\r\n              className=\"px-4 py-2 text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors\"\r\n            >\r\n              {copy.cancel}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // ============================================\r\n  // STEP 14A: Editorial Badge (shows when editing draft)\r\n  // ============================================\r\n  const _renderEditorialBadge = () => {\r\n    if (editorialMode !== 'DRAFT_ACTIVE' && editorialMode !== 'EDIT_LOCKED') {\r\n      return null;\r\n    }\r\n\r\n    const copy = getEditorialBadgeCopy('vi');\r\n    const debugState = getEditorialDebugState();\r\n    const isLocked = editorialMode === 'EDIT_LOCKED';\r\n\r\n    return (\r\n      <div className=\"flex items-center gap-2 px-3 py-1.5 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-lg\">\r\n        <span className={`text-sm ${isLocked ? 'animate-pulse' : ''}`}>\r\n          {isLocked ? 'â³' : 'ðŸ”’'}\r\n        </span>\r\n        <span className=\"text-xs font-medium text-emerald-700 dark:text-emerald-300\">\r\n          {isLocked ? 'Äang xá»­ lÃ½...' : copy.editing}\r\n        </span>\r\n        {debugState.editCount > 0 && !isLocked && (\r\n          <span className=\"text-xs text-emerald-600 dark:text-emerald-400\">\r\n            ({copy.editCount(debugState.editCount)})\r\n          </span>\r\n        )}\r\n        {/* DEV-only: Show draft ID */}\r\n        {process.env.NODE_ENV === 'development' && debugState.activeDraftId && (\r\n          <span className=\"text-[10px] text-emerald-500 dark:text-emerald-500 font-mono\">\r\n            #{debugState.activeDraftId.slice(0, 6)}\r\n          </span>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // ============================================\r\n  // STEP 14A: Explicit Create New Button\r\n  // ============================================\r\n  const _handleExplicitCreateNew = useCallback(() => {\r\n    // Explicitly enter create mode\r\n    enterCreateMode();\r\n    refreshEditorialMode();\r\n    if (setActiveSource) {\r\n      setActiveSource(null);\r\n    }\r\n    // Focus the input\r\n    editorRef.current?.focus();\r\n  }, [setActiveSource, refreshEditorialMode]);\r\n\r\n  const renderComposer = () => (\r\n    <div\r\n      className=\"flex-shrink-0 border-t border-border/70 bg-card\"\r\n      style={{ paddingBottom: 'max(12px, env(safe-area-inset-bottom))' }}\r\n    >\r\n      {/* STEP 6.5: Intent Confirmation Panel */}\r\n      {renderIntentConfirmation()}\r\n\r\n      <div className=\"mx-auto w-full max-w-4xl px-4 sm:px-6 py-3\">\r\n        <div\r\n          className={`bg-card border border-border/60 shadow-sm rounded-lg ${\r\n            isEntryState\r\n              ? ''\r\n              : ''\r\n          } focus-within:ring-1 focus-within:ring-ring/15`}\r\n        >\r\n          <form onSubmit={handleSubmit}>\r\n            <textarea\r\n              ref={editorRef}\r\n              value={chatInput}\r\n              onChange={(e) => setChatInput(e.target.value)}\r\n              onKeyDown={handleKeyDown}\r\n              placeholder={'MÃ´ táº£ Ã½ tÆ°á»Ÿng cá»§a báº¡nâ€¦'}\r\n              className=\"w-full px-4 py-3 text-[13px] leading-relaxed text-foreground placeholder:text-muted-foreground bg-transparent border-0 resize-none outline-none ring-0\"\r\n              style={{ minHeight: `${MIN_HEIGHT}px`, maxHeight: `${MAX_HEIGHT}px` }}\r\n            />\r\n            <div className=\"border-t border-border/70\">\r\n              <div className=\"px-4 py-2 flex items-center justify-between gap-2\">\r\n                <div className=\"flex-1 min-w-0 flex items-center gap-2\">\r\n                  {/* STEP 19: Edit Scope Badge (compact, near input) */}\r\n                  {activeScopeContract && hasActiveDraft() && (\r\n                    <EditScopeBadge\r\n                      contract={activeScopeContract}\r\n                      compact\r\n                      className=\"flex-shrink-0\"\r\n                    />\r\n                  )}\r\n                  <p\r\n                    className={`flex-1 min-w-0 text-[11px] text-muted-foreground truncate transition-opacity ${\r\n                      aiLoading ? 'opacity-90' : chatInput.trim() ? 'opacity-70' : 'opacity-100'\r\n                    }`}\r\n                  >\r\n                    {hint}\r\n                  </p>\r\n                </div>\r\n                <div className=\"flex items-center gap-1.5 flex-shrink-0\">\r\n                  {messages.length > 0 && (\r\n                    <>\r\n                      {/* FEATURE B: Session management buttons */}\r\n                      <div className=\"relative\">\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => setShowSnapshotsDropdown(!showSnapshotsDropdown)}\r\n                          className=\"px-2 py-1 text-[11px] text-muted-foreground hover:text-foreground transition-colors\"\r\n                          title=\"PhiÃªn lÃ m viá»‡c\"\r\n                        >\r\n                          <Icon name=\"bookmark\" size={12} />\r\n                        </button>\r\n                        {showSnapshotsDropdown && (\r\n                          <div\r\n                            className=\"absolute right-0 top-full mt-1 w-56 bg-card border border-border rounded-lg shadow-md z-50\"\r\n                            style={{ animation: 'fadeIn var(--motion-base) var(--ease-out-premium)' }}\r\n                          >\r\n                            <div className=\"p-2 border-b border-border\">\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() => {\r\n                                  saveSessionSnapshot();\r\n                                  setShowSnapshotsDropdown(false);\r\n                                }}\r\n                                className=\"w-full flex items-center gap-2 px-2 py-1.5 text-xs text-foreground hover:bg-secondary rounded transition-colors\"\r\n                              >\r\n                                <Icon name=\"plus\" size={12} />\r\n                                <span>LÆ°u snapshot</span>\r\n                              </button>\r\n                            </div>\r\n                            <div className=\"max-h-40 overflow-y-auto\">\r\n                              {getRecentSnapshots().length === 0 ? (\r\n                                <div className=\"px-3 py-2 text-[11px] text-muted-foreground\">\r\n                                  ChÆ°a cÃ³ snapshot nÃ o\r\n                                </div>\r\n                              ) : (\r\n                                getRecentSnapshots().map((snapshot) => (\r\n                                  <button\r\n                                    key={snapshot.id}\r\n                                    type=\"button\"\r\n                                    onClick={() => {\r\n                                      restoreSnapshot(snapshot.id);\r\n                                      setShowSnapshotsDropdown(false);\r\n                                    }}\r\n                                    className=\"w-full flex flex-col items-start px-3 py-2 text-left hover:bg-secondary transition-colors\"\r\n                                  >\r\n                                    <span className=\"text-xs text-foreground truncate w-full\">\r\n                                      {snapshot.name}\r\n                                    </span>\r\n                                    <span className=\"text-[10px] text-muted-foreground\">\r\n                                      {new Date(snapshot.createdAt).toLocaleDateString('vi-VN')}\r\n                                    </span>\r\n                                  </button>\r\n                                ))\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={clearMessages}\r\n                        className=\"px-2 py-1 text-[11px] text-muted-foreground hover:text-foreground transition-colors\"\r\n                      >\r\n                        XÃ³a\r\n                      </button>\r\n                    </>\r\n                  )}\r\n                  <button\r\n                    type=\"submit\"\r\n                    disabled={!canSubmit}\r\n                    className={`min-w-[52px] px-3 py-1.5 text-[12px] font-medium rounded-md transition-colors ${\r\n                      canSubmit\r\n                        ? 'bg-foreground text-primary-foreground hover:bg-foreground/90'\r\n                        : 'bg-secondary/70 text-muted-foreground cursor-not-allowed'\r\n                    }`}\r\n                  >\r\n                    {aiLoading ? 'â€¦' : 'Gá»­i'}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"relative flex flex-col h-full min-h-0\">\r\n      <div ref={messagesContainerRef} className=\"flex-1 min-h-0 overflow-y-auto\">\r\n        {messages.length === 0 ? (\r\n          <div className=\"px-4 sm:px-6 py-3\">\r\n            <div className=\"mx-auto w-full max-w-4xl\">{promptGrid}</div>\r\n            {aiError && (\r\n              <div className={`${ERROR_BOX.container} mt-4 max-w-4xl mx-auto`}>\r\n                <p className={ERROR_BOX.text}>{aiError}</p>\r\n                {chatInput.trim() && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={retryLastAction}\r\n                    disabled={aiLoading}\r\n                    className=\"mt-3 inline-flex items-center gap-2 px-3.5 py-2 text-[12px] font-medium text-zinc-600 dark:text-zinc-300 bg-zinc-100 dark:bg-zinc-800/60 hover:bg-zinc-200 dark:hover:bg-zinc-700/60 rounded-lg transition-colors disabled:opacity-50\"\r\n                  >\r\n                    <Icon name=\"refresh\" size={12} />\r\n                    <span>Thá»­ láº¡i</span>\r\n                  </button>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <div className=\"mx-auto w-full max-w-4xl space-y-4 px-4 sm:px-6 py-4\">\r\n            {messages.map((message) => {\r\n              const isApproved = approvedMessageId === message.id;\r\n              const isPrimary = primaryMessageId === message.id;\r\n              const isHovered = hoveredMessageId === message.id;\r\n\r\n              return (\r\n                <div\r\n                  key={message.id}\r\n                  className=\"animate-fade-in\"\r\n                  onMouseEnter={() => setHoveredMessageId(message.id)}\r\n                  onMouseLeave={() => setHoveredMessageId(null)}\r\n                >\r\n                  {message.role === 'user' ? (\r\n                    <div className=\"flex justify-end\">\r\n                      <div\r\n                        className={`max-w-[70%] px-4 py-3 rounded-lg bg-secondary/60 ${\r\n                          message.meta?.status === 'pending' ? 'opacity-80' : ''\r\n                        } ${message.meta?.status === 'error' ? 'border border-destructive/30' : ''}`}\r\n                      >\r\n                        <div className=\"flex items-center justify-end gap-2 mb-1\">\r\n                          {/* STEP 3: Calmer pending state */}\r\n                          {message.meta?.status === 'pending' && (\r\n                            <span className=\"flex items-center gap-1.5 text-[10px] text-zinc-500 dark:text-zinc-400\">\r\n                              <span className=\"w-1.5 h-1.5 bg-zinc-400 dark:bg-zinc-500 rounded-full animate-pulse\" />\r\n                              Äang xá»­ lÃ½â€¦\r\n                            </span>\r\n                          )}\r\n                          {message.meta?.status === 'error' && (\r\n                            <span className=\"text-[10px] text-destructive\">Lá»—i</span>\r\n                          )}\r\n                          <span className=\"text-[10px] tracking-wide uppercase text-muted-foreground\">\r\n                            {t('studio.workspace.you')}\r\n                          </span>\r\n                        </div>\r\n\r\n                        <div className=\"text-[13px] text-foreground/90 leading-relaxed whitespace-pre-wrap\">\r\n                          {getDisplayedUserMessageText(message)}\r\n                        </div>\r\n\r\n                        {isIntentSummaryEnabled() && message.meta?.intentSnapshot && (\r\n                          <div className=\"mt-2\">\r\n                            <IntentSummaryBadge snapshot={message.meta.intentSnapshot} state=\"completed\" />\r\n                          </div>\r\n                        )}\r\n\r\n                        {isIntentDebugAvailable() && (\r\n                          <IntentDebugPanel snapshot={message.meta?.intentSnapshot} messageId={message.id} />\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <div\r\n                      className=\"flex justify-start\"\r\n                      onClick={() => isSourcePickerMode && handleSelectSource(message.id)}\r\n                    >\r\n                      <div\r\n                        className={`max-w-[85%] bg-card border border-border/60 shadow-sm rounded-xl ${\r\n                          isApproved ? '' : ''\r\n                        } ${isSourcePickerMode ? 'cursor-pointer ring-1 ring-ring/20 hover:ring-ring/40' : ''} ${\r\n                          activeSourceId === message.id ? 'ring-1 ring-ring/40' : ''\r\n                        }`}\r\n                      >\r\n                        <div className=\"flex items-center justify-between px-3 sm:px-4 py-2.5 sm:py-3 border-b border-border/70\">\r\n                          {/* Left: AI label + badges - always inline, no wrap */}\r\n                          <div className=\"flex items-center gap-1.5 sm:gap-2 flex-nowrap min-w-0\">\r\n                            <span className=\"text-[10px] tracking-wide uppercase text-muted-foreground flex-shrink-0\">\r\n                              AI\r\n                            </span>\r\n                            {message.meta?.templateName && (\r\n                              <>\r\n                                <span className=\"text-muted-foreground/50 hidden sm:inline\">Â·</span>\r\n                                <span className=\"text-[10px] sm:text-[11px] text-muted-foreground truncate max-w-[80px] sm:max-w-none\">\r\n                                  {message.meta.templateName}\r\n                                </span>\r\n                              </>\r\n                            )}\r\n                            {isApproved && (\r\n                              <span className=\"px-1.5 sm:px-2 py-0.5 text-[9px] sm:text-[10px] font-medium tracking-wide uppercase rounded-full bg-secondary text-muted-foreground flex-shrink-0 whitespace-nowrap\">\r\n                                âœ“ ÄÃ£ duyá»‡t\r\n                              </span>\r\n                            )}\r\n                            {isPrimary && (\r\n                              <span className=\"px-1.5 sm:px-2 py-0.5 text-[9px] sm:text-[10px] font-medium tracking-wide uppercase rounded-full bg-foreground text-primary-foreground flex-shrink-0 whitespace-nowrap\">\r\n                                Báº£n chÃ­nh\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n\r\n                          <div\r\n                            className={`flex items-center gap-2 transition-opacity duration-150 ${\r\n                              isHovered ? 'opacity-100' : 'opacity-0'\r\n                            }`}\r\n                          >\r\n                            <MessageActionBar\r\n                              messageId={message.id}\r\n                              onAction={onTransformAction}\r\n                              isLoading={transformLoading === message.id}\r\n                            />\r\n                            <div className=\"w-px h-4 bg-border\" />\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleCopy(message.content)}\r\n                              className=\"p-1.5 rounded-lg text-muted-foreground hover:text-foreground hover:bg-secondary transition-colors duration-150\"\r\n                              title=\"Sao chÃ©p\"\r\n                            >\r\n                              <Icon name=\"copy\" size={14} />\r\n                            </button>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => setApprovedMessage(message.id)}\r\n                              className={`p-1.5 rounded-[8px] transition-colors duration-150 ${\r\n                                isApproved\r\n                                  ? 'text-zinc-500 dark:text-zinc-400'\r\n                                  : 'text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800'\r\n                              }`}\r\n                              title={isApproved ? 'ÄÃ£ duyá»‡t' : 'Duyá»‡t ná»™i dung'}\r\n                              disabled={isApproved}\r\n                            >\r\n                              <Icon name=\"check\" size={14} />\r\n                            </button>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => setPrimaryMessage(message.id)}\r\n                              className={`p-1.5 rounded-[8px] transition-colors duration-150 ${\r\n                                isPrimary\r\n                                  ? 'bg-foreground text-primary-foreground'\r\n                                  : 'text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800'\r\n                              }`}\r\n                              title={isPrimary ? 'Báº£n chÃ­nh' : 'Äáº·t lÃ m báº£n chÃ­nh'}\r\n                            >\r\n                              <Icon name=\"bookmark\" size={14} />\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <article className=\"px-4 sm:px-5 py-4 sm:py-5\">\r\n                          <div className=\"max-w-[68ch]\">\r\n                            <div\r\n                              className=\"text-[15px] leading-7 text-zinc-800 dark:text-zinc-200 whitespace-pre-wrap\"\r\n                              style={{ wordSpacing: '0.02em', textRendering: 'optimizeLegibility' }}\r\n                            >\r\n                              {message.content}\r\n                            </div>\r\n                          </div>\r\n                        </article>\r\n\r\n                        {(() => {\r\n                          const effectiveQL = getEffectiveQualityLock(message);\r\n                          return effectiveQL ? (\r\n                            <QualityLockPanel\r\n                              decision={effectiveQL.decision}\r\n                              hardFails={effectiveQL.hardFails || []}\r\n                              softFails={effectiveQL.softFails || []}\r\n                              testMode={effectiveQL.testMode}\r\n                              intent={message.meta?.templateId}\r\n                              autoFixAttempts={effectiveQL.autoFixAttempts || 0}\r\n                              onAutoFix={() => autoFixMessage(message.id)}\r\n                              autoFixLoading={autoFixLoading === message.id}\r\n                              previousDecision={effectiveQL.previousDecision}\r\n                              messageId={message.id}\r\n                            />\r\n                          ) : null;\r\n                        })()}\r\n\r\n                        {message.meta?.diffApply && (\r\n                          <DiffApplyPanel\r\n                            message={message}\r\n                            onApply={(mode) => applyTransformResult(message.id, mode)}\r\n                            onUndo={() => undoApplyTransformResult(message.id)}\r\n                          />\r\n                        )}\r\n\r\n                        {/* STEP 4 + 4.5: Transition micro-copy - only show once, then fade */}\r\n                        {/* STEP 4.5: Hide if user is typing or has interacted */}\r\n                        {(() => {\r\n                          const assistantMessages = messages.filter(m => m.role === 'assistant');\r\n                          const isLatestAssistant = assistantMessages.length > 0 &&\r\n                            assistantMessages[assistantMessages.length - 1].id === message.id;\r\n                          const hasDiffPending = message.meta?.diffApply && message.meta?.diffApply?.applyState === 'idle';\r\n                          const isUserTyping = chatInput.trim().length > 0;\r\n                          // STEP 4.5: Only show on first result, hide if typing or multiple results\r\n                          const isFirstResult = assistantMessages.length === 1;\r\n\r\n                          if (isLatestAssistant && !aiLoading && !hasDiffPending && isFirstResult && !isUserTyping) {\r\n                            return (\r\n                              <div className=\"px-4 sm:px-5 pb-3 pt-0.5\">\r\n                                <p className=\"text-[11px] text-zinc-400 dark:text-zinc-500\">\r\n                                  Ná»™i dung sáºµn sÃ ng.\r\n                                </p>\r\n                              </div>\r\n                            );\r\n                          }\r\n                          return null;\r\n                        })()}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n\r\n            {/* STEP 3: AI thinking state - calm, intentional presence */}\r\n            {aiLoading && (\r\n              <div className=\"py-5 animate-fade-in\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"flex gap-1\">\r\n                    <div\r\n                      className=\"w-1.5 h-1.5 bg-zinc-300 dark:bg-zinc-600 rounded-full animate-pulse\"\r\n                      style={{ animationDelay: '0ms' }}\r\n                    />\r\n                    <div\r\n                      className=\"w-1.5 h-1.5 bg-zinc-300 dark:bg-zinc-600 rounded-full animate-pulse\"\r\n                      style={{ animationDelay: '200ms' }}\r\n                    />\r\n                    <div\r\n                      className=\"w-1.5 h-1.5 bg-zinc-300 dark:bg-zinc-600 rounded-full animate-pulse\"\r\n                      style={{ animationDelay: '400ms' }}\r\n                    />\r\n                  </div>\r\n                  <span className=\"text-[12px] text-zinc-500 dark:text-zinc-400\">\r\n                    Äang chuáº©n bá»‹ ná»™i dung phÃ¹ há»£pâ€¦\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            <div ref={messagesEndRef} />\r\n\r\n            {aiError && (\r\n              <div className={ERROR_BOX.container}>\r\n                <p className={ERROR_BOX.text}>{aiError}</p>\r\n                {chatInput.trim() && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={retryLastAction}\r\n                    disabled={aiLoading}\r\n                    className=\"mt-3 inline-flex items-center gap-2 px-3.5 py-2 text-[12px] font-medium text-zinc-600 dark:text-zinc-300 bg-zinc-100 dark:bg-zinc-800/60 hover:bg-zinc-200 dark:hover:bg-zinc-700/60 rounded-lg transition-colors disabled:opacity-50\"\r\n                  >\r\n                    <Icon name=\"refresh\" size={12} />\r\n                    <span>Thá»­ láº¡i</span>\r\n                  </button>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {activeSourceId && activeSourceContent && (\r\n        <div className=\"flex-shrink-0 px-4 sm:px-6 pt-2\">\r\n          <div className=\"mx-auto w-full max-w-4xl\">\r\n            <SourceIndicator\r\n              sourcePreview={activeSourceContent}\r\n              onClear={() => {\r\n                setActiveSource?.(null);\r\n                setIsSourcePickerMode(false);\r\n              }}\r\n              onChangeSource={handleChangeSource}\r\n            />\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {isSourcePickerMode && (\r\n        <div className=\"flex-shrink-0 px-4 sm:px-6 py-2 bg-amber-50 dark:bg-amber-950/30 border-t border-amber-200 dark:border-amber-800/50\">\r\n          <div className=\"mx-auto w-full max-w-4xl flex items-center justify-between\">\r\n            <span className=\"text-sm text-amber-700 dark:text-amber-300\">Nháº¥n vÃ o tin nháº¯n Ä‘á»ƒ chá»n lÃ m nguá»“n chá»‰nh sá»­a</span>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setIsSourcePickerMode(false)}\r\n              className=\"text-xs text-amber-600 dark:text-amber-400 hover:text-amber-800 dark:hover:text-amber-200\"\r\n            >\r\n              Há»§y\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {renderComposer()}\r\n\r\n      {/* Passive status indicator - styled as system hint, not action */}\r\n      {messages.length > 0 && !isNearBottom && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => scrollToBottom('smooth')}\r\n          title=\"Nháº¥n Ä‘á»ƒ cuá»™n xuá»‘ng ná»™i dung má»›i nháº¥t\"\r\n          className=\"absolute z-40 bottom-36 right-6 flex items-center gap-1.5 px-2.5 py-1.5 bg-secondary/60 border border-dashed border-muted-foreground/30 rounded-full shadow-sm hover:bg-secondary hover:border-muted-foreground/50 transition-colors duration-150 animate-fade-in\"\r\n          aria-label=\"Cuá»™n xuá»‘ng tin nháº¯n má»›i nháº¥t\"\r\n        >\r\n          <Icon name=\"chevronDown\" size={14} className=\"text-muted-foreground\" />\r\n          <span className=\"text-xs font-medium text-muted-foreground\">Tin má»›i nháº¥t</span>\r\n        </button>\r\n      )}\r\n\r\n      {autoFixPreview && (\r\n        <DiffPreviewModal\r\n          isOpen={!!autoFixPreview}\r\n          onClose={cancelAutoFix}\r\n          originalContent={autoFixPreview.originalContent}\r\n          refinedContent={autoFixPreview.refinedContent}\r\n          similarity={autoFixPreview.similarity}\r\n          attempts={autoFixPreview.attempts}\r\n          usedFallback={autoFixPreview.usedFallback}\r\n          onApply={applyAutoFix}\r\n          onKeepOriginal={cancelAutoFix}\r\n        />\r\n      )}\r\n\r\n      {/* STEP 6: AutoFix Toast - neutral, no micro-confirmation (silence = trust) */}\r\n      {autoFixToast?.show && (\r\n        <div className=\"fixed bottom-6 left-1/2 -translate-x-1/2 z-50 animate-fade-in\">\r\n          <div className=\"flex items-center gap-3 px-4 py-3 rounded-xl shadow-sm border bg-card border-zinc-200/80 dark:border-zinc-700/60\">\r\n            <Icon\r\n              name={autoFixToast.type === 'success' ? 'check' : 'info'}\r\n              size={16}\r\n              className=\"text-zinc-400 dark:text-zinc-500\"\r\n            />\r\n            <span className=\"text-sm text-zinc-600 dark:text-zinc-300\">\r\n              {autoFixToast.message}\r\n            </span>\r\n            {autoFixToast.canUndo && (\r\n              <button\r\n                onClick={undoAutoFix}\r\n                className=\"px-2 py-1 text-xs text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800/50 rounded-md transition-colors\"\r\n              >\r\n                HoÃ n tÃ¡c\r\n              </button>\r\n            )}\r\n            <button\r\n              onClick={dismissAutoFixToast}\r\n              className=\"p-1 rounded-md text-zinc-300 dark:text-zinc-600 hover:text-zinc-500 dark:hover:text-zinc-400 transition-colors\"\r\n            >\r\n              <Icon name=\"close\" size={14} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* STEP 6: Local Edit Toast - no micro-confirmation (undo availability = trust) */}\r\n      {localEditToast?.show && (\r\n        <div className=\"fixed bottom-6 left-1/2 -translate-x-1/2 z-50 animate-fade-in\">\r\n          <div className=\"flex items-center gap-3 px-4 py-3 rounded-xl shadow-sm border bg-card border-zinc-200/80 dark:border-zinc-700/60\">\r\n            <Icon name=\"check\" size={16} className=\"text-zinc-400 dark:text-zinc-500\" />\r\n            <span className=\"text-sm text-zinc-600 dark:text-zinc-300\">\r\n              {localEditToast.message}\r\n            </span>\r\n            <button\r\n              onClick={undoLocalEdit}\r\n              className=\"px-2 py-1 text-xs text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800/50 rounded-md transition-colors\"\r\n            >\r\n              HoÃ n tÃ¡c\r\n            </button>\r\n            <button\r\n              onClick={() => setLocalEditToast(null)}\r\n              className=\"p-1 rounded-md text-zinc-300 dark:text-zinc-600 hover:text-zinc-500 dark:hover:text-zinc-400 transition-colors\"\r\n            >\r\n              <Icon name=\"close\" size={14} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* STEP 8 + STEP 14: Intent Debug Badge (DEV only, requires ?debugIntent=1) */}\r\n      <IntentDebugBadge\r\n        decision={lastDebugDecision}\r\n        continuity={continuityState}\r\n        preferenceBias={debugContextForRender?.preferenceBias}\r\n        governanceDecision={debugContextForRender?.governanceDecision}\r\n        onDismiss={() => setLastDebugDecision(null)}\r\n      />\r\n\r\n      {/* STEP 14A: Editorial Authority Create Warning Modal */}\r\n      {renderCreateWarning()}\r\n\r\n      {/* STEP 27: Rewrite Intent Confirmation Dialog */}\r\n      {showRewriteConfirmation && (\r\n        <RewriteConfirmationDialog\r\n          language={(language as 'vi' | 'en') || 'vi'}\r\n          onConfirmRewrite={handleRewriteConfirmation}\r\n          onCreateNew={handleRewriteCreateNew}\r\n          onCancel={handleRewriteCancel}\r\n        />\r\n      )}\r\n\r\n      {/* STEP 14A: Editorial Badge - HIDDEN (UI cleanup, logic preserved) */}\r\n      {/* Badge and \"Táº¡o bÃ i má»›i\" button removed from display per UI simplification */}\r\n\r\n      {/* STEP 16: Edit Guard Modal */}\r\n      {pendingEditGuard && (\r\n        <EditGuardModal\r\n          requestedOp={pendingEditGuard.requestedOp}\r\n          guardResult={pendingEditGuard.guardResult}\r\n          originalText={pendingEditGuard.originalText}\r\n          newText={pendingEditGuard.newText}\r\n          onAccept={() => {\r\n            // User accepts despite violation - apply the changes\r\n            applyTransformResult(pendingEditGuard.messageId, pendingEditGuard.applyMode);\r\n            setPendingEditGuard(null);\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.log('[StudioEditor:STEP16] Edit Guard - user accepted violation');\r\n            }\r\n          }}\r\n          onReject={() => {\r\n            // User rejects - do not apply, dismiss modal\r\n            setPendingEditGuard(null);\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.log('[StudioEditor:STEP16] Edit Guard - user rejected');\r\n            }\r\n          }}\r\n          onCancel={() => {\r\n            // User cancelled - dismiss modal\r\n            setPendingEditGuard(null);\r\n          }}\r\n          language=\"vi\"\r\n        />\r\n      )}\r\n\r\n      {/* STEP 17: Intent Canon Guard Modal */}\r\n      {pendingIntentCanonGuard && activeIntentCanon && (\r\n        <IntentCanonGuardModal\r\n          canon={activeIntentCanon}\r\n          diff={pendingIntentCanonGuard.diff}\r\n          decision={pendingIntentCanonGuard.decision}\r\n          onKeepIntent={() => {\r\n            // User keeps original intent - do not apply AI output\r\n            setPendingIntentCanonGuard(null);\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.log('[StudioEditor:STEP17] Intent Canon Guard - user kept original');\r\n            }\r\n          }}\r\n          onAcceptDrift={() => {\r\n            // User accepts drift - apply AI output AND update intent canon\r\n            applyTransformResult(pendingIntentCanonGuard.messageId, pendingIntentCanonGuard.applyMode);\r\n            updateIntentCanonAfterDrift(pendingIntentCanonGuard.newText);\r\n            setPendingIntentCanonGuard(null);\r\n            if (process.env.NODE_ENV === 'development') {\r\n              console.log('[StudioEditor:STEP17] Intent Canon Guard - user accepted drift');\r\n            }\r\n          }}\r\n          onCancel={() => {\r\n            // User cancelled - dismiss modal, do not apply\r\n            setPendingIntentCanonGuard(null);\r\n          }}\r\n          language=\"vi\"\r\n        />\r\n      )}\r\n\r\n      {/* STEP 19: Edit Scope Pick Modal */}\r\n      <EditScopePickModal\r\n        open={!!pendingScopeGate}\r\n        gate={pendingScopeGate?.gate ?? null}\r\n        instructionPreview={pendingScopeGate?.inputText?.substring(0, 100)}\r\n        onPick={handleScopePickResponse}\r\n        onCancel={cancelScopePick}\r\n      />\r\n\r\n      <style jsx>{`\r\n        .animate-fade-in {\r\n          animation: fadeIn 0.3s ease-out;\r\n        }\r\n        @keyframes fadeIn {\r\n          from {\r\n            opacity: 0;\r\n            transform: translateY(8px);\r\n          }\r\n          to {\r\n            opacity: 1;\r\n            transform: translateY(0);\r\n          }\r\n        }\r\n      `}</style>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\components\\posts\\ImageUploader.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":88,"column":11,"nodeType":"JSXOpeningElement","endLine":92,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { supabase } from '@/lib/supabase';\r\n\r\ninterface ImageUploaderProps {\r\n  currentImageUrl?: string;\r\n  onImageUploaded: (url: string) => void;\r\n}\r\n\r\nexport default function ImageUploader({\r\n  currentImageUrl,\r\n  onImageUploaded,\r\n}: ImageUploaderProps) {\r\n  const [uploading, setUploading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [preview, setPreview] = useState<string | null>(currentImageUrl || null);\r\n\r\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    // Validate file type\r\n    if (!file.type.startsWith('image/')) {\r\n      setError('Please select an image file');\r\n      return;\r\n    }\r\n\r\n    // Validate file size (max 5MB)\r\n    if (file.size > 5 * 1024 * 1024) {\r\n      setError('Image size must be less than 5MB');\r\n      return;\r\n    }\r\n\r\n    setError(null);\r\n    setUploading(true);\r\n\r\n    try {\r\n      // Create a unique file name\r\n      const fileExt = file.name.split('.').pop();\r\n      const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\r\n      const filePath = `${fileName}`;\r\n\r\n      // Upload to Supabase Storage\r\n      const { error: uploadError } = await supabase.storage\r\n        .from('post-images')\r\n        .upload(filePath, file, {\r\n          cacheControl: '3600',\r\n          upsert: false,\r\n        });\r\n\r\n      if (uploadError) {\r\n        throw uploadError;\r\n      }\r\n\r\n      // Get public URL\r\n      const { data } = supabase.storage\r\n        .from('post-images')\r\n        .getPublicUrl(filePath);\r\n\r\n      if (data?.publicUrl) {\r\n        setPreview(data.publicUrl);\r\n        onImageUploaded(data.publicUrl);\r\n      } else {\r\n        throw new Error('Failed to get public URL');\r\n      }\r\n    } catch (err: unknown) {\r\n      console.error('Upload error:', err);\r\n      setError(err instanceof Error ? err.message : 'Failed to upload image');\r\n    } finally {\r\n      setUploading(false);\r\n    }\r\n  };\r\n\r\n  const handleRemove = () => {\r\n    setPreview(null);\r\n    onImageUploaded('');\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <label className=\"block text-sm font-medium text-gray-700\">\r\n        Cover Image\r\n      </label>\r\n\r\n      {preview ? (\r\n        <div className=\"relative\">\r\n          <img\r\n            src={preview}\r\n            alt=\"Cover preview\"\r\n            className=\"w-full h-48 object-cover rounded-lg border border-gray-300\"\r\n          />\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleRemove}\r\n            className=\"absolute top-2 right-2 px-3 py-1 bg-red-600 text-white text-sm font-medium rounded hover:bg-red-700 transition-colors\"\r\n          >\r\n            Remove\r\n          </button>\r\n        </div>\r\n      ) : (\r\n        <div className=\"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors\">\r\n          <input\r\n            type=\"file\"\r\n            accept=\"image/*\"\r\n            onChange={handleFileChange}\r\n            disabled={uploading}\r\n            className=\"hidden\"\r\n            id=\"image-upload\"\r\n          />\r\n          <label\r\n            htmlFor=\"image-upload\"\r\n            className=\"cursor-pointer flex flex-col items-center\"\r\n          >\r\n            <svg\r\n              className=\"w-12 h-12 text-gray-400 mb-3\"\r\n              fill=\"none\"\r\n              stroke=\"currentColor\"\r\n              viewBox=\"0 0 24 24\"\r\n            >\r\n              <path\r\n                strokeLinecap=\"round\"\r\n                strokeLinejoin=\"round\"\r\n                strokeWidth={2}\r\n                d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"\r\n              />\r\n            </svg>\r\n            <span className=\"text-sm text-gray-600\">\r\n              {uploading ? 'Uploading...' : 'Click to upload an image'}\r\n            </span>\r\n            <span className=\"text-xs text-gray-400 mt-1\">\r\n              PNG, JPG, GIF up to 5MB\r\n            </span>\r\n          </label>\r\n        </div>\r\n      )}\r\n\r\n      {error && (\r\n        <p className=\"text-sm text-red-600\">\r\n          {error}\r\n        </p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\components\\posts\\PostForm.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'formData.content', 'formData.title', and 'mode'. Either include them or remove the dependency array.","line":181,"column":6,"nodeType":"ArrayExpression","endLine":181,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [formData.content, formData.title, mode]","fix":{"range":[6053,6055],"text":"[formData.content, formData.title, mode]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'activePreviewPlatform'. Either include it or remove the dependency array.","line":204,"column":6,"nodeType":"ArrayExpression","endLine":204,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [activePreviewPlatform, formData.platforms]","fix":{"range":[6882,6902],"text":"[activePreviewPlatform, formData.platforms]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'formData.cover_image_url' and 'mediaImages.length'. Either include them or remove the dependency array. You can also replace multiple useState variables with useReducer if 'setMediaImages' needs the current value of 'formData.cover_image_url'.","line":211,"column":6,"nodeType":"ArrayExpression","endLine":211,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [formData.cover_image_url, mediaImages.length]","fix":{"range":[7109,7111],"text":"[formData.cover_image_url, mediaImages.length]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'formData.cover_image_url'. Either include it or remove the dependency array.","line":219,"column":6,"nodeType":"ArrayExpression","endLine":219,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [formData.cover_image_url, mediaImages]","fix":{"range":[7388,7401],"text":"[formData.cover_image_url, mediaImages]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":276,"column":15,"nodeType":"JSXOpeningElement","endLine":280,"endColumn":17},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":287,"column":19,"nodeType":"JSXOpeningElement","endLine":292,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":301,"column":17,"nodeType":"JSXOpeningElement","endLine":305,"endColumn":19},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":310,"column":21,"nodeType":"JSXOpeningElement","endLine":314,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":317,"column":21,"nodeType":"JSXOpeningElement","endLine":321,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":367,"column":11,"nodeType":"JSXOpeningElement","endLine":371,"endColumn":13},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":425,"column":17,"nodeType":"JSXOpeningElement","endLine":429,"endColumn":19},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":461,"column":15,"nodeType":"JSXOpeningElement","endLine":465,"endColumn":17},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":535,"column":11,"nodeType":"JSXOpeningElement","endLine":539,"endColumn":13},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":572,"column":11,"nodeType":"JSXOpeningElement","endLine":576,"endColumn":13},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":582,"column":19,"nodeType":"JSXOpeningElement","endLine":586,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":825,"column":21,"nodeType":"JSXOpeningElement","endLine":829,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport _ImageUploader from './ImageUploader';\nimport { PLATFORMS, getPlatformDisplayName } from '@/lib/platforms';\nimport type { PostFormData, PostStatus, Platform } from '@/lib/types';\nimport { useTranslation } from '@/lib/i18n';\n\ninterface PostFormProps {\n  mode: 'create' | 'edit';\n  initialData?: Partial<PostFormData>;\n  postId?: string;\n}\n\nexport default function PostForm({ mode, initialData, postId }: PostFormProps) {\n  const router = useRouter();\n  const { t } = useTranslation();\n  const [submitting, setSubmitting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [saveSuccess, setSaveSuccess] = useState(false);\n  const [showPreview, setShowPreview] = useState(true);\n  const [activePreviewPlatform, setActivePreviewPlatform] = useState<Platform | 'generic'>('generic');\n\n  // TODO: Phase 17 â€“ extend backend to support multiple media URLs (media_urls: string[])\n  // Currently using local state for UI preview only, backend still uses single cover_image_url\n  const [mediaImages, setMediaImages] = useState<string[]>([]);\n\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  // Autosave: Generate unique key for localStorage based on mode and postId\n  const autosaveKey = mode === 'create' ? 'post-draft-new' : `post-draft-${postId}`;\n\n  const [formData, setFormData] = useState<PostFormData>(() => {\n    // Restore from localStorage if creating new post and draft exists\n    if (mode === 'create' && typeof window !== 'undefined') {\n      const savedDraft = localStorage.getItem(autosaveKey);\n      if (savedDraft) {\n        try {\n          return JSON.parse(savedDraft);\n        } catch {\n          // If parsing fails, use default values\n        }\n      }\n    }\n    return {\n      title: initialData?.title || '',\n      content: initialData?.content || '',\n      status: initialData?.status || 'draft',\n      scheduled_time: initialData?.scheduled_time || '',\n      cover_image_url: initialData?.cover_image_url || '',\n      platforms: initialData?.platforms || [],\n    };\n  });\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n    setSubmitting(true);\n\n    try {\n      const url = mode === 'create'\n        ? '/api/posts'\n        : `/api/posts/${postId}`;\n\n      const method = mode === 'create' ? 'POST' : 'PATCH';\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          title: formData.title,\n          content: formData.content,\n          status: formData.status,\n          scheduled_time: formData.scheduled_time || null,\n          cover_image_url: formData.cover_image_url || null,\n          platforms: formData.platforms.length > 0 ? formData.platforms : null,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || t('postForm.error.failedToSave'));\n      }\n\n      const data = await response.json();\n\n      // Clear autosaved draft on successful submit\n      if (typeof window !== 'undefined') {\n        localStorage.removeItem(autosaveKey);\n      }\n\n      // Show success flash\n      setSaveSuccess(true);\n      setTimeout(() => setSaveSuccess(false), 2000);\n\n      // Navigate after brief delay to show success state\n      setTimeout(() => {\n        if (mode === 'create') {\n          router.push(`/posts/${data.post.id}`);\n        } else {\n          router.push(`/posts/${postId}`);\n        }\n      }, 500);\n    } catch (err: unknown) {\n      console.error('Form submission error:', err);\n      const errorMessage = err instanceof Error ? err.message : t('postForm.error.failedToSave');\n      setError(errorMessage);\n      setSubmitting(false);\n    }\n  };\n\n  const handlePlatformToggle = (platform: Platform) => {\n    setFormData((prev) => ({\n      ...prev,\n      platforms: prev.platforms.includes(platform)\n        ? prev.platforms.filter((p) => p !== platform)\n        : [...prev.platforms, platform],\n    }));\n  };\n\n  // Autosave: Debounced save to localStorage (1.5s delay)\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (typeof window !== 'undefined') {\n        localStorage.setItem(autosaveKey, JSON.stringify(formData));\n      }\n    }, 1500);\n\n    return () => clearTimeout(timer);\n  }, [formData, autosaveKey]);\n\n  // Prefill from Studio approved draft (Phase 10)\n  useEffect(() => {\n    // Only run once on mount for create mode\n    if (mode !== 'create' || typeof window === 'undefined') return;\n\n    // Only prefill if form is currently empty\n    if (formData.title.trim() || formData.content.trim()) return;\n\n    try {\n      const studioDraft = localStorage.getItem('studio_approved_draft_v1');\n      if (!studioDraft) return;\n\n      const parsed = JSON.parse(studioDraft);\n      if (!parsed.content) return;\n\n      // Derive title from content\n      const rawContent = parsed.content.trim();\n      let derivedTitle = 'Báº£n nhÃ¡p tá»« Studio'; // Fallback\n\n      if (rawContent) {\n        const firstLineMatch = rawContent.split('\\n')[0];\n        if (firstLineMatch && firstLineMatch.trim()) {\n          // Use first line, truncated to 80 chars\n          derivedTitle = firstLineMatch.trim().substring(0, 80);\n        } else {\n          // No clear line break, use first 80 chars\n          derivedTitle = rawContent.substring(0, 80);\n        }\n      }\n\n      // Prefill form\n      setFormData((prev) => ({\n        ...prev,\n        title: derivedTitle,\n        content: rawContent,\n      }));\n\n      // Clear the draft from localStorage\n      localStorage.removeItem('studio_approved_draft_v1');\n\n      console.log('âœ… Prefilled post from Studio approved content');\n    } catch (error) {\n      console.error('âŒ Failed to load Studio draft:', error);\n      // Clear invalid draft\n      if (typeof window !== 'undefined') {\n        localStorage.removeItem('studio_approved_draft_v1');\n      }\n    }\n  }, []); // Run only once on mount\n\n  // Textarea auto-resize\n  useEffect(() => {\n    const textarea = textareaRef.current;\n    if (textarea) {\n      textarea.style.height = 'auto';\n      textarea.style.height = `${textarea.scrollHeight}px`;\n    }\n  }, [formData.content]);\n\n  // Update active preview platform based on selected platforms\n  useEffect(() => {\n    if (formData.platforms.length === 0) {\n      setActivePreviewPlatform('generic');\n    } else if (formData.platforms.length === 1) {\n      setActivePreviewPlatform(formData.platforms[0]);\n    } else {\n      // Multiple platforms: keep current if still valid, otherwise use first\n      if (activePreviewPlatform === 'generic' || !formData.platforms.includes(activePreviewPlatform as Platform)) {\n        setActivePreviewPlatform(formData.platforms[0]);\n      }\n    }\n  }, [formData.platforms]);\n\n  // Initialize mediaImages from cover_image_url on mount\n  useEffect(() => {\n    if (formData.cover_image_url && mediaImages.length === 0) {\n      setMediaImages([formData.cover_image_url]);\n    }\n  }, []);\n\n  // Sync cover_image_url with first media image\n  useEffect(() => {\n    const firstImage = mediaImages.length > 0 ? mediaImages[0] : '';\n    if (firstImage !== formData.cover_image_url) {\n      setFormData((prev) => ({ ...prev, cover_image_url: firstImage }));\n    }\n  }, [mediaImages]);\n\n  // Handlers for multi-image management\n  const handleAddMedia = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files) return;\n\n    // Convert FileList to array and create object URLs for preview\n    const newImages = Array.from(files).map((file) => URL.createObjectURL(file));\n    setMediaImages((prev) => [...prev, ...newImages]);\n\n    // Reset input\n    e.target.value = '';\n  };\n\n  const handleRemoveMedia = (index: number) => {\n    setMediaImages((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  // Platform-specific preview renderers\n  const renderFacebookPreview = () => {\n    const imageCount = mediaImages.length;\n\n    return (\n      <div className=\"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden\">\n        {/* Facebook Header */}\n        <div className=\"flex items-center gap-3 p-3 border-b border-gray-200 dark:border-gray-700\">\n          <div className=\"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold\">\n            U\n          </div>\n          <div>\n            <div className=\"text-sm font-semibold text-gray-900 dark:text-gray-100\">{t('postForm.preview.userName')}</div>\n            <div className=\"text-xs text-gray-500 dark:text-gray-400\">{t('postForm.preview.justNow')} Â· {t('postForm.preview.world')}</div>\n          </div>\n        </div>\n\n        {/* Post Content with \"See more\" truncation */}\n        {formData.content && (\n          <div className=\"px-3 pt-3 pb-2\">\n            <p className=\"text-sm text-gray-900 dark:text-gray-100 leading-relaxed\">\n              {formData.content.length > 200 ? (\n                <>\n                  {formData.content.substring(0, 200)}...{' '}\n                  <button className=\"text-gray-600 dark:text-gray-400 hover:underline font-medium\">{t('postForm.preview.seeMore')}</button>\n                </>\n              ) : (\n                formData.content\n              )}\n            </p>\n          </div>\n        )}\n\n        {/* Media Grid */}\n        {imageCount > 0 && (\n          <div className=\"bg-gray-100 dark:bg-gray-800\">\n            {imageCount === 1 && (\n              // Single image: full width\n              <img\n                src={mediaImages[0]}\n                alt=\"Facebook preview\"\n                className=\"w-full object-cover max-h-96\"\n              />\n            )}\n\n            {imageCount === 2 && (\n              // Two images: side by side\n              <div className=\"grid grid-cols-2 gap-0.5\">\n                {mediaImages.slice(0, 2).map((img, i) => (\n                  <img\n                    key={i}\n                    src={img}\n                    alt={`Facebook preview ${i + 1}`}\n                    className=\"w-full h-64 object-cover\"\n                  />\n                ))}\n              </div>\n            )}\n\n            {imageCount >= 3 && (\n              // Three or more: mosaic layout\n              <div className=\"grid grid-cols-2 gap-0.5\">\n                {/* First image takes full left column */}\n                <img\n                  src={mediaImages[0]}\n                  alt=\"Facebook preview 1\"\n                  className=\"w-full h-full min-h-[256px] object-cover\"\n                />\n\n                {/* Right column: 2 images stacked */}\n                <div className=\"grid grid-rows-2 gap-0.5\">\n                  <div className=\"relative\">\n                    <img\n                      src={mediaImages[1]}\n                      alt=\"Facebook preview 2\"\n                      className=\"w-full h-full min-h-[128px] object-cover\"\n                    />\n                  </div>\n                  <div className=\"relative\">\n                    <img\n                      src={mediaImages[2]}\n                      alt=\"Facebook preview 3\"\n                      className=\"w-full h-full min-h-[128px] object-cover\"\n                    />\n                    {/* +N overlay if more than 3 images */}\n                    {imageCount > 3 && (\n                      <div className=\"absolute inset-0 bg-black/70 flex items-center justify-center\">\n                        <span className=\"text-white text-3xl font-bold\">+{imageCount - 3}</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Engagement bar */}\n        <div className=\"border-t border-gray-200 dark:border-gray-700 p-2 flex items-center justify-around text-xs text-gray-600 dark:text-gray-400\">\n          <button className=\"flex items-center gap-1 hover:bg-gray-100 dark:hover:bg-gray-800 px-3 py-1.5 rounded transition-colors\">\n            <span>ðŸ‘</span> {t('postForm.preview.like')}\n          </button>\n          <button className=\"flex items-center gap-1 hover:bg-gray-100 dark:hover:bg-gray-800 px-3 py-1.5 rounded transition-colors\">\n            <span>ðŸ’¬</span> {t('postForm.preview.comment')}\n          </button>\n          <button className=\"flex items-center gap-1 hover:bg-gray-100 dark:hover:bg-gray-800 px-3 py-1.5 rounded transition-colors\">\n            <span>â†—ï¸</span> {t('postForm.preview.share')}\n          </button>\n        </div>\n      </div>\n    );\n  };\n\n  const renderInstagramPreview = () => (\n    <div className=\"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden max-w-sm mx-auto\">\n      {/* Instagram Header */}\n      <div className=\"flex items-center justify-between p-3\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"w-8 h-8 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center text-white text-xs font-semibold\">\n            U\n          </div>\n          <div className=\"text-sm font-semibold text-gray-900 dark:text-gray-100\">{t('postForm.preview.username')}</div>\n        </div>\n        <button className=\"text-gray-900 dark:text-gray-100\">â‹¯</button>\n      </div>\n\n      {/* Main Media Image (square, first image only) */}\n      {mediaImages.length > 0 && (\n        <div className=\"relative\">\n          <img\n            src={mediaImages[0]}\n            alt=\"Instagram preview\"\n            className=\"w-full aspect-square object-cover\"\n          />\n          {/* Carousel indicator for multiple images */}\n          {mediaImages.length > 1 && (\n            <>\n              {/* Image counter badge */}\n              <div className=\"absolute top-3 right-3 px-2 py-1 bg-black/60 text-white text-xs rounded-full font-medium\">\n                1/{mediaImages.length}\n              </div>\n              {/* Carousel dots */}\n              <div className=\"absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-1.5\">\n                {mediaImages.slice(0, 5).map((_, index) => (\n                  <div\n                    key={index}\n                    className={`w-1.5 h-1.5 rounded-full ${\n                      index === 0 ? 'bg-white' : 'bg-white/50'\n                    }`}\n                  />\n                ))}\n                {mediaImages.length > 5 && (\n                  <div className=\"w-1.5 h-1.5 rounded-full bg-white/30\" />\n                )}\n              </div>\n            </>\n          )}\n        </div>\n      )}\n\n      {/* Action buttons */}\n      <div className=\"flex items-center justify-between p-3 border-b border-gray-100 dark:border-gray-800\">\n        <div className=\"flex items-center gap-4 text-lg\">\n          <button>â¤ï¸</button>\n          <button>ðŸ’¬</button>\n          <button>ðŸ“¤</button>\n        </div>\n        <button>ðŸ”–</button>\n      </div>\n\n      {/* Caption */}\n      {formData.content && (\n        <div className=\"px-3 pt-2 pb-2\">\n          <p className=\"text-sm text-gray-900 dark:text-gray-100\">\n            <span className=\"font-semibold\">{t('postForm.preview.username')}</span>{' '}\n            {formData.content.substring(0, 100)}\n            {formData.content.length > 100 && <span className=\"text-gray-500 dark:text-gray-400\">... {t('postForm.preview.more')}</span>}\n          </p>\n        </div>\n      )}\n\n      {/* Thumbnail strip for additional images with custom scrollbar */}\n      {mediaImages.length > 1 && (\n        <div className=\"px-3 pb-3\">\n          <div className=\"flex items-center gap-2 overflow-x-auto thumbnail-scroll\">\n            {mediaImages.slice(1).map((imageUrl, index) => (\n              <div key={index} className=\"flex-shrink-0\">\n                <img\n                  src={imageUrl}\n                  alt={`Thumbnail ${index + 2}`}\n                  className=\"w-14 h-14 rounded-md object-cover border border-gray-200 dark:border-gray-700\"\n                />\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n\n  const renderTwitterPreview = () => (\n    <div className=\"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden\">\n      {/* Twitter/X Header */}\n      <div className=\"flex items-start gap-3 p-3\">\n        <div className=\"w-10 h-10 bg-gray-700 dark:bg-gray-600 rounded-full flex items-center justify-center text-white text-xs font-semibold\">\n          U\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-1.5\">\n            <span className=\"text-sm font-bold text-gray-900 dark:text-gray-100\">{t('postForm.preview.userName')}</span>\n            <span className=\"text-sm text-gray-500 dark:text-gray-400\">@{t('postForm.preview.username')} Â· 1m</span>\n          </div>\n\n          {/* Tweet Content */}\n          {formData.content && (\n            <p className=\"text-sm text-gray-900 dark:text-gray-100 mt-1 leading-relaxed\">\n              {formData.content}\n            </p>\n          )}\n\n          {/* Media (landscape aspect ratio) */}\n          {mediaImages.length > 0 && (\n            <div className=\"mt-3 rounded-2xl overflow-hidden border border-gray-200 dark:border-gray-700\">\n              <img\n                src={mediaImages[0]}\n                alt=\"Twitter preview\"\n                className=\"w-full aspect-[16/9] object-cover\"\n              />\n            </div>\n          )}\n\n          {/* Engagement row */}\n          <div className=\"flex items-center justify-between mt-3 text-gray-500 dark:text-gray-400 text-xs\">\n            <button className=\"flex items-center gap-1 hover:text-blue-500 transition-colors\">\n              <span>ðŸ’¬</span> <span>{t('postForm.preview.reply')}</span>\n            </button>\n            <button className=\"flex items-center gap-1 hover:text-green-500 transition-colors\">\n              <span>ðŸ”</span> <span>{t('postForm.preview.repost')}</span>\n            </button>\n            <button className=\"flex items-center gap-1 hover:text-red-500 transition-colors\">\n              <span>â¤ï¸</span> <span>{t('postForm.preview.like')}</span>\n            </button>\n            <button className=\"flex items-center gap-1 hover:text-blue-500 transition-colors\">\n              <span>ðŸ“Š</span> <span>{t('postForm.preview.view')}</span>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n\n  // Helper function to get localized status label\n  const getStatusLabel = (status: PostStatus) => {\n    switch (status) {\n      case 'draft':\n        return t('status.draft');\n      case 'scheduled':\n        return t('status.scheduled');\n      case 'published':\n        return t('status.published');\n      case 'failed':\n        return t('status.failed');\n      default:\n        return status;\n    }\n  };\n\n  const renderLinkedInPreview = () => (\n    <div className=\"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden\">\n      {/* LinkedIn Header */}\n      <div className=\"flex items-start gap-3 p-4\">\n        <div className=\"w-12 h-12 bg-blue-700 rounded-full flex items-center justify-center text-white font-semibold\">\n          U\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"text-sm font-semibold text-gray-900 dark:text-gray-100\">{t('postForm.preview.userName')}</div>\n          <div className=\"text-xs text-gray-500 dark:text-gray-400\">{t('postForm.preview.professionalTitle')}</div>\n          <div className=\"text-xs text-gray-500 dark:text-gray-400\">1h Â· ðŸŒ</div>\n        </div>\n        <button className=\"text-gray-500 hover:text-gray-700 dark:hover:text-gray-300\">â‹¯</button>\n      </div>\n\n      {/* Post Content */}\n      {formData.content && (\n        <div className=\"px-4 pb-3\">\n          <p className=\"text-sm text-gray-900 dark:text-gray-100 leading-relaxed\">\n            {formData.content.substring(0, 150)}\n            {formData.content.length > 150 && (\n              <button className=\"text-blue-700 dark:text-blue-500 hover:underline ml-1\">{t('postForm.preview.seeMoreLinkedIn')}</button>\n            )}\n          </p>\n        </div>\n      )}\n\n      {/* Media (wide landscape) */}\n      {mediaImages.length > 0 && (\n        <div className=\"px-0\">\n          <img\n            src={mediaImages[0]}\n            alt=\"LinkedIn preview\"\n            className=\"w-full aspect-[2/1] object-cover\"\n          />\n        </div>\n      )}\n\n      {/* Engagement bar */}\n      <div className=\"border-t border-gray-200 dark:border-gray-700 px-4 py-2 flex items-center justify-between text-xs text-gray-600 dark:text-gray-400\">\n        <button className=\"flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-800 px-3 py-1.5 rounded transition-colors\">\n          <span>ðŸ‘</span> <span>{t('postForm.preview.like')}</span>\n        </button>\n        <button className=\"flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-800 px-3 py-1.5 rounded transition-colors\">\n          <span>ðŸ’¬</span> <span>{t('postForm.preview.comment')}</span>\n        </button>\n        <button className=\"flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-800 px-3 py-1.5 rounded transition-colors\">\n          <span>â†—ï¸</span> <span>{t('postForm.preview.share')}</span>\n        </button>\n      </div>\n    </div>\n  );\n\n  const renderGenericPreview = () => (\n    <div className=\"space-y-3\">\n      {/* Title Preview */}\n      {formData.title && (\n        <div>\n          <h4 className=\"text-lg font-bold text-gray-900 dark:text-gray-100\">\n            {formData.title}\n          </h4>\n        </div>\n      )}\n\n      {/* Main Media Image (first image only) */}\n      {mediaImages.length > 0 && (\n        <div>\n          <img\n            src={mediaImages[0]}\n            alt=\"Preview\"\n            className=\"w-full rounded-lg object-cover max-h-48\"\n          />\n          {/* Thumbnail strip for additional images */}\n          {mediaImages.length > 1 && (\n            <div className=\"mt-2 flex items-center gap-2 overflow-x-auto thumbnail-scroll\">\n              {mediaImages.slice(1).map((imageUrl, index) => (\n                <div key={index} className=\"flex-shrink-0\">\n                  <img\n                    src={imageUrl}\n                    alt={`Thumbnail ${index + 2}`}\n                    className=\"w-16 h-16 rounded object-cover border border-gray-200 dark:border-gray-700\"\n                  />\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Content Preview */}\n      {formData.content && (\n        <div className=\"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-3\">\n          <p className=\"text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap leading-relaxed\">\n            {formData.content}\n          </p>\n        </div>\n      )}\n\n      {/* Platforms Preview */}\n      {formData.platforms.length > 0 && (\n        <div>\n          <p className=\"text-xs font-medium text-gray-700 dark:text-gray-300 mb-2\">{t('postForm.preview.targetPlatforms')}</p>\n          <div className=\"flex flex-wrap gap-1.5\">\n            {formData.platforms.map((platform) => (\n              <span\n                key={platform}\n                className=\"px-2 py-1 bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-400 text-[10px] font-medium rounded\"\n              >\n                {getPlatformDisplayName(platform)}\n              </span>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Metadata */}\n      <div className=\"pt-3 border-t border-gray-200 dark:border-gray-700 text-[10px] text-gray-500 dark:text-gray-400 space-y-1\">\n        <div>{t('postForm.preview.status')} <span className=\"font-medium\">{getStatusLabel(formData.status)}</span></div>\n        {formData.scheduled_time && (\n          <div>{t('postForm.preview.scheduled')} <span className=\"font-medium\">{new Date(formData.scheduled_time).toLocaleString()}</span></div>\n        )}\n        <div>{t('postForm.preview.characters')} <span className=\"font-medium\">{formData.content.length}</span></div>\n      </div>\n    </div>\n  );\n\n  return (\n    <form onSubmit={handleSubmit} className=\"relative\">\n      {/* Component-scoped scrollbar styles */}\n      <style jsx>{`\n        /* Custom scrollbar for preview panel and thumbnail strips */\n        :global(.preview-scroll)::-webkit-scrollbar,\n        :global(.thumbnail-scroll)::-webkit-scrollbar {\n          width: 6px;\n          height: 6px;\n        }\n\n        :global(.preview-scroll)::-webkit-scrollbar-track,\n        :global(.thumbnail-scroll)::-webkit-scrollbar-track {\n          background: transparent;\n        }\n\n        :global(.preview-scroll)::-webkit-scrollbar-thumb,\n        :global(.thumbnail-scroll)::-webkit-scrollbar-thumb {\n          background-color: rgb(156 163 175);\n          border-radius: 3px;\n        }\n\n        :global(.preview-scroll)::-webkit-scrollbar-thumb:hover,\n        :global(.thumbnail-scroll)::-webkit-scrollbar-thumb:hover {\n          background-color: rgb(107 114 128);\n        }\n\n        /* Dark mode scrollbar */\n        :global(.dark .preview-scroll)::-webkit-scrollbar-thumb,\n        :global(.dark .thumbnail-scroll)::-webkit-scrollbar-thumb {\n          background-color: rgb(75 85 99);\n        }\n\n        :global(.dark .preview-scroll)::-webkit-scrollbar-thumb:hover,\n        :global(.dark .thumbnail-scroll)::-webkit-scrollbar-thumb:hover {\n          background-color: rgb(107 114 128);\n        }\n\n        /* Firefox scrollbar support */\n        :global(.preview-scroll),\n        :global(.thumbnail-scroll) {\n          scrollbar-width: thin;\n          scrollbar-color: rgb(156 163 175) transparent;\n        }\n\n        :global(.dark .preview-scroll),\n        :global(.dark .thumbnail-scroll) {\n          scrollbar-color: rgb(75 85 99) transparent;\n        }\n      `}</style>\n\n      {/* Toolbar - Compact on mobile, comfortable on desktop */}\n      <div className=\"bg-card border-b border-border px-3 sm:px-6 py-2 sm:py-3 -mx-6 sm:-mx-8 -mt-6 sm:-mt-8 mb-4 sm:mb-5\">\n        <div className=\"flex items-center justify-between gap-2\">\n          {/* Left: Title + metadata */}\n          <div className=\"flex items-center gap-2 sm:gap-3 min-w-0\">\n            <h3 className=\"text-xs sm:text-sm font-medium text-foreground truncate\">\n              {mode === 'create' ? t('postForm.toolbar.newPost') : t('postForm.toolbar.editPost')}\n            </h3>\n            <div className=\"hidden sm:block h-4 w-px bg-border\"></div>\n            <div className=\"flex items-center gap-1.5 sm:gap-2 text-[10px] sm:text-xs text-muted-foreground\">\n              <span>{formData.content.length.toLocaleString()} {t('postForm.toolbar.charactersCount')}</span>\n              {mode === 'create' && (\n                <>\n                  <span className=\"hidden sm:inline\">Â·</span>\n                  <span className=\"hidden sm:inline\">{t('postForm.toolbar.autoSaved')}</span>\n                </>\n              )}\n            </div>\n          </div>\n          {/* Right: Actions - Primary CTA hidden on mobile (moved to bottom) */}\n          <div className=\"flex items-center gap-1.5 sm:gap-2 flex-shrink-0\">\n            <button\n              type=\"button\"\n              onClick={() => setShowPreview(!showPreview)}\n              className=\"px-2 sm:px-3 py-1.5 text-xs sm:text-sm text-muted-foreground hover:text-foreground bg-secondary hover:bg-secondary/80 rounded-lg transition-colors\"\n            >\n              <span className=\"sm:hidden\">{showPreview ? 'áº¨n' : 'Xem'}</span>\n              <span className=\"hidden sm:inline\">{showPreview ? t('postForm.toolbar.hidePreview') : t('postForm.toolbar.showPreview')}</span>\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => router.back()}\n              className=\"px-2 sm:px-3 py-1.5 text-xs sm:text-sm text-muted-foreground hover:text-foreground border border-border hover:bg-secondary rounded-lg transition-colors\"\n              disabled={submitting}\n            >\n              {t('postForm.toolbar.cancel')}\n            </button>\n            {/* Desktop only: Primary CTA in header */}\n            <button\n              type=\"submit\"\n              disabled={submitting}\n              className={`hidden sm:inline-flex px-4 py-1.5 text-sm font-medium rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed ${\n                saveSuccess\n                  ? 'bg-primary text-primary-foreground'\n                  : submitting\n                  ? 'bg-primary/80 text-primary-foreground'\n                  : 'bg-primary text-primary-foreground hover:opacity-90'\n              }`}\n            >\n              {saveSuccess ? t('postForm.toolbar.saved') : submitting ? t('postForm.toolbar.saving') : mode === 'create' ? t('postForm.toolbar.createPost') : t('postForm.toolbar.saveChanges')}\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Error Message */}\n      {error && (\n        <div className=\"p-3 bg-destructive/10 border border-destructive/20 rounded-lg text-sm text-destructive mb-4\">\n          {error}\n        </div>\n      )}\n\n      {/* Main Content: Editor + Preview/Settings Split */}\n      <div className=\"grid gap-5 lg:grid-cols-[1.6fr,1fr]\">\n        {/* Left Column: Content Editor */}\n        <div className=\"space-y-4\">\n          <div>\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">\n              {t('postForm.sections.content')}\n            </h3>\n          </div>\n\n          {/* Title */}\n          <div>\n            <label className=\"block text-xs font-medium text-muted-foreground mb-2\">\n              {t('postEditor.titleLabel')}\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.title}\n              onChange={(e) =>\n                setFormData((prev) => ({ ...prev, title: e.target.value }))\n              }\n              className=\"w-full px-4 py-3 border border-border bg-card text-sm text-foreground rounded-lg focus:ring-2 focus:ring-ring/20 focus:border-border transition-all dark:bg-secondary\"\n              placeholder={t('postEditor.titlePlaceholder')}\n            />\n          </div>\n\n          {/* Content */}\n          <div>\n            <label className=\"block text-xs font-medium text-muted-foreground mb-2\">\n              {t('postEditor.contentLabel')}\n            </label>\n            <textarea\n              ref={textareaRef}\n              required\n              value={formData.content}\n              onChange={(e) =>\n                setFormData((prev) => ({ ...prev, content: e.target.value }))\n              }\n              rows={10}\n              className=\"w-full px-4 py-3 border border-border bg-card text-sm text-foreground rounded-lg focus:ring-2 focus:ring-ring/20 focus:border-border resize-none overflow-y-auto leading-relaxed transition-all dark:bg-secondary\"\n              placeholder={t('postEditor.contentPlaceholder')}\n              style={{ minHeight: '160px', maxHeight: '260px' }}\n            />\n          </div>\n\n          {/* Multi-Media Upload */}\n          <div>\n            <label className=\"block text-xs font-medium text-muted-foreground mb-2\">\n              {t('postForm.sections.media')}\n            </label>\n\n            {/* Add Media Button */}\n            <div className=\"relative\">\n              <input\n                type=\"file\"\n                accept=\"image/*\"\n                multiple\n                onChange={handleAddMedia}\n                className=\"hidden\"\n                id=\"media-upload\"\n              />\n              <label\n                htmlFor=\"media-upload\"\n                className=\"inline-flex items-center gap-2 px-4 py-2.5 bg-card border border-border text-muted-foreground rounded-lg hover:bg-secondary hover:text-foreground transition-colors cursor-pointer\"\n              >\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                </svg>\n                <span className=\"text-sm font-medium\">{t('postForm.sections.addMedia')}</span>\n              </label>\n            </div>\n\n            {/* Thumbnail Row */}\n            {mediaImages.length > 0 && (\n              <div className=\"mt-3 flex flex-wrap gap-2\">\n                {mediaImages.map((imageUrl, index) => (\n                  <div\n                    key={index}\n                    className=\"relative group w-20 h-20 rounded-lg overflow-hidden border border-border\"\n                  >\n                    <img\n                      src={imageUrl}\n                      alt={`Media ${index + 1}`}\n                      className=\"w-full h-full object-cover\"\n                    />\n                    {/* Remove Button */}\n                    <button\n                      type=\"button\"\n                      onClick={() => handleRemoveMedia(index)}\n                      className=\"absolute top-1 right-1 w-5 h-5 bg-destructive hover:bg-destructive/90 text-destructive-foreground rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\"\n                      aria-label={t('accessibility.removeImage')}\n                    >\n                      <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                      </svg>\n                    </button>\n                    {/* First image badge */}\n                    {index === 0 && (\n                      <div className=\"absolute bottom-1 left-1 px-1.5 py-0.5 bg-primary text-primary-foreground text-[10px] font-medium rounded\">\n                        {t('postForm.sections.cover')}\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {/* Helper text */}\n            <p className=\"mt-2 text-xs text-muted-foreground\">\n              {t('postForm.sections.multiImageHelp')}\n            </p>\n          </div>\n\n          {/* Target Platforms Section */}\n          <div className=\"space-y-3\">\n            <div>\n              <h3 className=\"text-sm font-medium text-foreground mb-1\">\n                {t('postForm.sections.targetPlatforms')}\n              </h3>\n              <p className=\"text-xs text-muted-foreground\">\n                {t('postForm.sections.targetPlatformsDescription')}\n              </p>\n            </div>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {PLATFORMS.map((platform) => (\n                <label\n                  key={platform}\n                  className={`flex items-center gap-2 p-2.5 border rounded-lg cursor-pointer transition-colors ${\n                    formData.platforms.includes(platform)\n                      ? 'border-foreground/60 bg-secondary/70'\n                      : 'border-border hover:border-border hover:bg-secondary/40'\n                  }`}\n                >\n                  <input\n                    type=\"checkbox\"\n                    checked={formData.platforms.includes(platform)}\n                    onChange={() => handlePlatformToggle(platform)}\n                    className=\"w-3.5 h-3.5 text-foreground rounded border-border focus:ring-1 focus:ring-ring/15\"\n                  />\n                  <span className=\"text-sm font-medium text-foreground\">\n                    {getPlatformDisplayName(platform)}\n                  </span>\n                </label>\n              ))}\n            </div>\n          </div>\n\n          {/* Publishing Settings Section */}\n          <div className=\"space-y-3 pt-4 border-t border-border\">\n            <div>\n              <h3 className=\"text-sm font-medium text-foreground mb-0.5\">\n                {t('postForm.sections.publishingSettings')}\n              </h3>\n              <p className=\"text-xs text-muted-foreground\">\n                {t('postForm.sections.publishingSettingsDescription')}\n              </p>\n            </div>\n            <div className=\"space-y-3\">\n              <div>\n                <label className=\"block text-xs font-medium text-muted-foreground mb-1.5\">\n                  {t('postEditor.statusLabel')}\n                </label>\n                <select\n                  value={formData.status}\n                  onChange={(e) =>\n                    setFormData((prev) => ({\n                      ...prev,\n                      status: e.target.value as PostStatus,\n                    }))\n                  }\n                  className=\"w-full px-3.5 py-2.5 border border-border bg-card text-sm text-foreground rounded-lg focus:ring-1 focus:ring-ring/15 focus:border-border transition-all dark:bg-secondary\"\n                >\n                  <option value=\"draft\">{t('status.draft')}</option>\n                  <option value=\"scheduled\">{t('status.scheduled')}</option>\n                  <option value=\"published\">{t('status.published')}</option>\n                  <option value=\"failed\">{t('status.failed')}</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-xs font-medium text-muted-foreground mb-1.5\">\n                  {t('postEditor.scheduledTimeLabel')}\n                  {formData.status === 'scheduled' && (\n                    <span className=\"text-destructive ml-1\">*</span>\n                  )}\n                </label>\n                <input\n                  type=\"datetime-local\"\n                  value={formData.scheduled_time}\n                  onChange={(e) =>\n                    setFormData((prev) => ({\n                      ...prev,\n                      scheduled_time: e.target.value,\n                    }))\n                  }\n                  className=\"w-full px-3.5 py-2.5 border border-border bg-card text-sm text-foreground rounded-lg focus:ring-1 focus:ring-ring/15 focus:border-border transition-all dark:bg-secondary\"\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Right Column: Live Preview Only */}\n        <div className=\"lg:sticky lg:top-20 lg:self-start lg:max-h-[calc(100vh-100px)] lg:overflow-y-auto preview-scroll\">\n          {/* Live Preview Panel */}\n          {showPreview && (\n            <div className=\"bg-secondary/50 border border-border rounded-lg overflow-hidden\">\n              {/* Preview Header */}\n              <div className=\"flex items-center justify-between border-b border-border px-3.5 py-2.5\">\n                <h3 className=\"text-sm font-medium text-foreground\">{t('postForm.sections.livePreview')}</h3>\n                <span className=\"text-xs px-1.5 py-0.5 bg-card text-muted-foreground rounded font-medium border border-border\">\n                  {t('postForm.sections.realTime')}\n                </span>\n              </div>\n\n              {/* Platform Tabs (show only if multiple platforms selected) */}\n              {formData.platforms.length > 1 && (\n                <div className=\"flex items-center gap-1 px-3.5 py-2 bg-card border-b border-border\">\n                  {formData.platforms.map((platform) => (\n                    <button\n                      key={platform}\n                      type=\"button\"\n                      onClick={() => setActivePreviewPlatform(platform)}\n                      className={`px-2.5 py-1 text-xs font-medium rounded-md transition-colors ${\n                        activePreviewPlatform === platform\n                          ? 'bg-primary text-primary-foreground'\n                          : 'bg-secondary text-muted-foreground hover:bg-secondary hover:text-foreground'\n                      }`}\n                    >\n                      {getPlatformDisplayName(platform)}\n                    </button>\n                  ))}\n                </div>\n              )}\n\n              {/* Preview Content */}\n              <div className=\"p-3.5\">\n                {(activePreviewPlatform as string) === 'facebook' && renderFacebookPreview()}\n                {(activePreviewPlatform as string) === 'instagram' && renderInstagramPreview()}\n                {(activePreviewPlatform as string) === 'twitter' && renderTwitterPreview()}\n                {(activePreviewPlatform as string) === 'linkedin' && renderLinkedInPreview()}\n                {(activePreviewPlatform === 'generic' ||\n                  ((activePreviewPlatform as string) !== 'facebook' &&\n                   (activePreviewPlatform as string) !== 'instagram' &&\n                   (activePreviewPlatform as string) !== 'twitter' &&\n                   (activePreviewPlatform as string) !== 'linkedin')) &&\n                  renderGenericPreview()}\n              </div>\n            </div>\n          )}\n        </div>\n\n      </div>\n\n      {/* Mobile: Sticky bottom CTA */}\n      <div className=\"sm:hidden fixed bottom-0 left-0 right-0 z-40 bg-card border-t border-border px-4 py-3 safe-area-pb\">\n        <button\n          type=\"submit\"\n          disabled={submitting}\n          className={`w-full px-4 py-2.5 text-sm font-medium rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed ${\n            saveSuccess\n              ? 'bg-primary text-primary-foreground'\n              : submitting\n              ? 'bg-primary/80 text-primary-foreground'\n              : 'bg-primary text-primary-foreground hover:opacity-90'\n          }`}\n        >\n          {saveSuccess ? t('postForm.toolbar.saved') : submitting ? t('postForm.toolbar.saving') : mode === 'create' ? t('postForm.toolbar.createPost') : t('postForm.toolbar.saveChanges')}\n        </button>\n      </div>\n      {/* Spacer for mobile sticky bottom CTA */}\n      <div className=\"sm:hidden h-16\" />\n    </form>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\lib\\studio\\intentSnapshot.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3867,3870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3867,3870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":442,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":442,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13747,13750],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13747,13750],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// ============================================\r\n// Tests for Intent Snapshot\r\n// ============================================\r\n// STEP 3: Verify snapshot creation, immutability,\r\n// and chain preservation across transforms.\r\n//\r\n// CRITICAL: These tests verify OBSERVABILITY ONLY.\r\n// No execution logic should be tested here.\r\n// ============================================\r\n\r\nimport { describe, it, expect } from 'vitest';\r\nimport { createIntentSnapshot, type IntentSnapshot, type ChatMessage } from '../../types/studio';\r\nimport {\r\n  createTransformSnapshot,\r\n  createCreateSnapshot,\r\n  getMessageSnapshot,\r\n  hasIntentSnapshot,\r\n  validateSnapshot,\r\n  formatSnapshotForDebug,\r\n} from './intentSnapshot';\r\n\r\n// ============================================\r\n// SNAPSHOT CREATION TESTS\r\n// ============================================\r\n\r\ndescribe('createIntentSnapshot', () => {\r\n  it('should create a valid snapshot with all required fields', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      detectedMode: 'DIRECTED_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 2,\r\n    });\r\n\r\n    expect(snapshot.userTypedText).toBe('viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n');\r\n    expect(snapshot.detectedMode).toBe('DIRECTED_TRANSFORM');\r\n    expect(snapshot.detectedActions).toEqual(['REWRITE']);\r\n    expect(snapshot.sourceMessageId).toBe('msg-123');\r\n    expect(snapshot.turnIndex).toBe(2);\r\n    expect(snapshot.snapshotId).toMatch(/^snapshot-\\d+-/);\r\n    expect(snapshot.createdAt).toBeGreaterThan(0);\r\n    expect(snapshot.originSnapshotId).toBeNull();\r\n  });\r\n\r\n  it('should preserve originSnapshotId when provided', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'rÃºt gá»n cÃ²n 50 tá»«',\r\n      detectedMode: 'DIRECTED_TRANSFORM',\r\n      detectedActions: ['SHORTEN'],\r\n      sourceMessageId: 'msg-456',\r\n      turnIndex: 3,\r\n      originSnapshotId: 'snapshot-original-123',\r\n    });\r\n\r\n    expect(snapshot.originSnapshotId).toBe('snapshot-original-123');\r\n  });\r\n\r\n  it('should generate unique snapshotIds', () => {\r\n    const snapshot1 = createIntentSnapshot({\r\n      userTypedText: 'test1',\r\n      detectedMode: 'CREATE',\r\n      detectedActions: [],\r\n      sourceMessageId: null,\r\n      turnIndex: 0,\r\n    });\r\n\r\n    const snapshot2 = createIntentSnapshot({\r\n      userTypedText: 'test2',\r\n      detectedMode: 'CREATE',\r\n      detectedActions: [],\r\n      sourceMessageId: null,\r\n      turnIndex: 1,\r\n    });\r\n\r\n    expect(snapshot1.snapshotId).not.toBe(snapshot2.snapshotId);\r\n  });\r\n});\r\n\r\n// ============================================\r\n// SNAPSHOT IMMUTABILITY TESTS\r\n// ============================================\r\n\r\ndescribe('Snapshot Immutability', () => {\r\n  it('should be frozen (immutable)', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i',\r\n      detectedMode: 'PURE_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n    });\r\n\r\n    expect(Object.isFrozen(snapshot)).toBe(true);\r\n  });\r\n\r\n  it('should have frozen detectedActions array', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i',\r\n      detectedMode: 'PURE_TRANSFORM',\r\n      detectedActions: ['REWRITE', 'OPTIMIZE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n    });\r\n\r\n    expect(Object.isFrozen(snapshot.detectedActions)).toBe(true);\r\n  });\r\n\r\n  it('should not allow mutation of userTypedText', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'original text',\r\n      detectedMode: 'CREATE',\r\n      detectedActions: [],\r\n      sourceMessageId: null,\r\n      turnIndex: 0,\r\n    });\r\n\r\n    // Attempt to mutate should fail silently or throw in strict mode\r\n    expect(() => {\r\n      (snapshot as any).userTypedText = 'mutated text';\r\n    }).toThrow();\r\n  });\r\n});\r\n\r\n// ============================================\r\n// HELPER FUNCTION TESTS\r\n// ============================================\r\n\r\ndescribe('createTransformSnapshot', () => {\r\n  it('should create a TRANSFORM snapshot with correct mode', () => {\r\n    const snapshot = createTransformSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      transformMode: 'DIRECTED_TRANSFORM',\r\n      actionType: 'REWRITE',\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 2,\r\n    });\r\n\r\n    expect(snapshot.detectedMode).toBe('DIRECTED_TRANSFORM');\r\n    expect(snapshot.detectedActions).toContain('REWRITE');\r\n    expect(snapshot.sourceMessageId).toBe('msg-123');\r\n  });\r\n\r\n  it('should preserve origin chain when previousSnapshot provided', () => {\r\n    const originalSnapshot = createIntentSnapshot({\r\n      userTypedText: 'original',\r\n      detectedMode: 'CREATE',\r\n      detectedActions: ['CREATE_CONTENT'],\r\n      sourceMessageId: null,\r\n      turnIndex: 0,\r\n    });\r\n\r\n    const chainedSnapshot = createTransformSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i',\r\n      transformMode: 'PURE_TRANSFORM',\r\n      actionType: 'REWRITE',\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n      previousSnapshot: originalSnapshot,\r\n    });\r\n\r\n    expect(chainedSnapshot.originSnapshotId).toBe(originalSnapshot.snapshotId);\r\n  });\r\n\r\n  it('should use originSnapshotId from previousSnapshot if available', () => {\r\n    // First transform in chain\r\n    const firstSnapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i',\r\n      detectedMode: 'PURE_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n      originSnapshotId: 'snapshot-origin-abc',\r\n    });\r\n\r\n    // Second transform in chain\r\n    const secondSnapshot = createTransformSnapshot({\r\n      userTypedText: 'rÃºt gá»n',\r\n      transformMode: 'PURE_TRANSFORM',\r\n      actionType: 'SHORTEN',\r\n      sourceMessageId: 'msg-456',\r\n      turnIndex: 2,\r\n      previousSnapshot: firstSnapshot,\r\n    });\r\n\r\n    // Should preserve the ORIGINAL origin, not the first snapshot's ID\r\n    expect(secondSnapshot.originSnapshotId).toBe('snapshot-origin-abc');\r\n  });\r\n});\r\n\r\ndescribe('createCreateSnapshot', () => {\r\n  it('should create a CREATE snapshot', () => {\r\n    const snapshot = createCreateSnapshot({\r\n      userTypedText: 'Viáº¿t bÃ i vá» MIK Ocean City',\r\n      turnIndex: 0,\r\n    });\r\n\r\n    expect(snapshot.detectedMode).toBe('CREATE');\r\n    expect(snapshot.detectedActions).toContain('CREATE_CONTENT');\r\n    expect(snapshot.sourceMessageId).toBeNull();\r\n    expect(snapshot.originSnapshotId).toBeNull();\r\n  });\r\n});\r\n\r\n// ============================================\r\n// MESSAGE SNAPSHOT EXTRACTION TESTS\r\n// ============================================\r\n\r\ndescribe('getMessageSnapshot', () => {\r\n  it('should return snapshot from message meta', () => {\r\n    const testSnapshot = createIntentSnapshot({\r\n      userTypedText: 'test',\r\n      detectedMode: 'CREATE',\r\n      detectedActions: [],\r\n      sourceMessageId: null,\r\n      turnIndex: 0,\r\n    });\r\n\r\n    const message: ChatMessage = {\r\n      id: 'msg-1',\r\n      role: 'user',\r\n      content: 'test',\r\n      timestamp: new Date(),\r\n      meta: {\r\n        intentSnapshot: testSnapshot,\r\n      },\r\n    };\r\n\r\n    expect(getMessageSnapshot(message)).toBe(testSnapshot);\r\n  });\r\n\r\n  it('should return null if no snapshot', () => {\r\n    const message: ChatMessage = {\r\n      id: 'msg-1',\r\n      role: 'user',\r\n      content: 'test',\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    expect(getMessageSnapshot(message)).toBeNull();\r\n  });\r\n});\r\n\r\ndescribe('hasIntentSnapshot', () => {\r\n  it('should return true if message has snapshot', () => {\r\n    const message: ChatMessage = {\r\n      id: 'msg-1',\r\n      role: 'user',\r\n      content: 'test',\r\n      timestamp: new Date(),\r\n      meta: {\r\n        intentSnapshot: createIntentSnapshot({\r\n          userTypedText: 'test',\r\n          detectedMode: 'CREATE',\r\n          detectedActions: [],\r\n          sourceMessageId: null,\r\n          turnIndex: 0,\r\n        }),\r\n      },\r\n    };\r\n\r\n    expect(hasIntentSnapshot(message)).toBe(true);\r\n  });\r\n\r\n  it('should return false if no snapshot', () => {\r\n    const message: ChatMessage = {\r\n      id: 'msg-1',\r\n      role: 'user',\r\n      content: 'test',\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    expect(hasIntentSnapshot(message)).toBe(false);\r\n  });\r\n});\r\n\r\n// ============================================\r\n// CHAIN PRESERVATION TESTS (MULTI-TRANSFORM)\r\n// ============================================\r\n\r\ndescribe('Snapshot Chain Preservation', () => {\r\n  it('should maintain same origin across 3+ transforms', () => {\r\n    // CREATE: Original content\r\n    const createSnapshot = createCreateSnapshot({\r\n      userTypedText: 'Viáº¿t bÃ i vá» MIK',\r\n      turnIndex: 0,\r\n    });\r\n\r\n    // TRANSFORM 1\r\n    const transform1 = createTransformSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      transformMode: 'DIRECTED_TRANSFORM',\r\n      actionType: 'REWRITE',\r\n      sourceMessageId: 'msg-1',\r\n      turnIndex: 1,\r\n      previousSnapshot: createSnapshot,\r\n    });\r\n\r\n    // TRANSFORM 2\r\n    const transform2 = createTransformSnapshot({\r\n      userTypedText: 'rÃºt gá»n cÃ²n 100 tá»«',\r\n      transformMode: 'DIRECTED_TRANSFORM',\r\n      actionType: 'SHORTEN',\r\n      sourceMessageId: 'msg-2',\r\n      turnIndex: 2,\r\n      previousSnapshot: transform1,\r\n    });\r\n\r\n    // TRANSFORM 3\r\n    const transform3 = createTransformSnapshot({\r\n      userTypedText: 'thÃªm CTA',\r\n      transformMode: 'DIRECTED_TRANSFORM',\r\n      actionType: 'EXPAND',\r\n      sourceMessageId: 'msg-3',\r\n      turnIndex: 3,\r\n      previousSnapshot: transform2,\r\n    });\r\n\r\n    // All should point to the CREATE snapshot as origin\r\n    expect(transform1.originSnapshotId).toBe(createSnapshot.snapshotId);\r\n    expect(transform2.originSnapshotId).toBe(createSnapshot.snapshotId);\r\n    expect(transform3.originSnapshotId).toBe(createSnapshot.snapshotId);\r\n  });\r\n\r\n  it('should preserve userTypedText exactly through chain', () => {\r\n    const instructions = [\r\n      'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      'rÃºt gá»n cÃ²n 100 tá»«',\r\n      'thÃªm CTA kÃªu gá»i liÃªn há»‡',\r\n    ];\r\n\r\n    const snapshots: IntentSnapshot[] = [];\r\n\r\n    // Create chain\r\n    let previousSnapshot: IntentSnapshot | undefined;\r\n    instructions.forEach((text, i) => {\r\n      const snapshot = createTransformSnapshot({\r\n        userTypedText: text,\r\n        transformMode: 'DIRECTED_TRANSFORM',\r\n        actionType: 'REWRITE',\r\n        sourceMessageId: `msg-${i}`,\r\n        turnIndex: i + 1,\r\n        previousSnapshot,\r\n      });\r\n      snapshots.push(snapshot);\r\n      previousSnapshot = snapshot;\r\n    });\r\n\r\n    // Verify each snapshot preserves exact userTypedText\r\n    instructions.forEach((text, i) => {\r\n      expect(snapshots[i].userTypedText).toBe(text);\r\n    });\r\n  });\r\n});\r\n\r\n// ============================================\r\n// VALIDATION TESTS\r\n// ============================================\r\n\r\ndescribe('validateSnapshot', () => {\r\n  it('should return valid for correct snapshot', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i',\r\n      detectedMode: 'PURE_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n    });\r\n\r\n    const result = validateSnapshot(snapshot);\r\n    expect(result.valid).toBe(true);\r\n    expect(result.warnings).toHaveLength(0);\r\n  });\r\n\r\n  it('should warn for empty userTypedText', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: '',\r\n      detectedMode: 'PURE_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n    });\r\n\r\n    const result = validateSnapshot(snapshot);\r\n    expect(result.valid).toBe(false);\r\n    expect(result.warnings).toContain('userTypedText is empty');\r\n  });\r\n\r\n  it('should warn for transform without sourceMessageId', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i',\r\n      detectedMode: 'PURE_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: null,\r\n      turnIndex: 1,\r\n    });\r\n\r\n    const result = validateSnapshot(snapshot);\r\n    expect(result.valid).toBe(false);\r\n    expect(result.warnings).toContain('sourceMessageId missing for transform');\r\n  });\r\n\r\n  it('should warn for CREATE with sourceMessageId', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t bÃ i má»›i',\r\n      detectedMode: 'CREATE',\r\n      detectedActions: ['CREATE_CONTENT'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 0,\r\n    });\r\n\r\n    const result = validateSnapshot(snapshot);\r\n    expect(result.valid).toBe(false);\r\n    expect(result.warnings).toContain('sourceMessageId should be null for CREATE');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// NO EXECUTION LOGIC TESTS\r\n// ============================================\r\n\r\ndescribe('Snapshot does NOT affect execution', () => {\r\n  it('snapshot data should be purely observational', () => {\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      detectedMode: 'DIRECTED_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n    });\r\n\r\n    // Snapshot should have no methods that could affect state\r\n    expect(typeof snapshot.userTypedText).toBe('string');\r\n    expect(typeof snapshot.detectedMode).toBe('string');\r\n    expect(Array.isArray(snapshot.detectedActions)).toBe(true);\r\n    expect(typeof snapshot.snapshotId).toBe('string');\r\n    expect(typeof snapshot.createdAt).toBe('number');\r\n\r\n    // No functions on the snapshot\r\n    const keys = Object.keys(snapshot);\r\n    keys.forEach(key => {\r\n      expect(typeof (snapshot as any)[key]).not.toBe('function');\r\n    });\r\n  });\r\n});\r\n\r\n// ============================================\r\n// DEBUG FORMATTING TESTS\r\n// ============================================\r\n\r\ndescribe('formatSnapshotForDebug', () => {\r\n  it('should return null for null snapshot', () => {\r\n    expect(formatSnapshotForDebug(null)).toBeNull();\r\n  });\r\n\r\n  // Note: In production, formatSnapshotForDebug returns null\r\n  // This test verifies DEV behavior\r\n  it('should format snapshot for display in DEV', () => {\r\n    // This test only runs in dev mode\r\n    if (process.env.NODE_ENV !== 'development') {\r\n      return;\r\n    }\r\n\r\n    const snapshot = createIntentSnapshot({\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      detectedMode: 'DIRECTED_TRANSFORM',\r\n      detectedActions: ['REWRITE'],\r\n      sourceMessageId: 'msg-123',\r\n      turnIndex: 1,\r\n    });\r\n\r\n    const formatted = formatSnapshotForDebug(snapshot);\r\n    expect(formatted).not.toBeNull();\r\n    expect(formatted).toHaveProperty('mode');\r\n    expect(formatted).toHaveProperty('actions');\r\n    expect(formatted).toHaveProperty('turn');\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\lib\\studio\\messageDisplay.test.ts","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":179,"column":7,"severity":1,"nodeType":null,"fix":{"range":[6765,6827],"text":" "}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":182,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6924,6927],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6924,6927],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":189,"column":7,"severity":1,"nodeType":null,"fix":{"range":[7175,7237],"text":" "}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":192,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7323,7326],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7323,7326],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":2,"source":"// ============================================\r\n// Tests for Message Display Utilities\r\n// ============================================\r\n// CONCEPTUAL INVARIANT: displayedUserMessage === userTypedText\r\n//\r\n// USER MESSAGE â‰  ACTION\r\n// - userTypedText: ALWAYS what the user expressed (typed OR clicked)\r\n// - actionLabel: Internal only (for badges/chips, NEVER for message display)\r\n// ============================================\r\n\r\nimport { describe, it, expect } from 'vitest';\r\nimport {\r\n  getDisplayedUserMessageText,\r\n  getUserMessageDisplayMode,\r\n  isTransformMessage,\r\n  getTransformActionLabel,\r\n} from './messageDisplay';\r\nimport type { ChatMessage } from '@/types/studio';\r\n\r\n// Helper to create test messages\r\nfunction createUserMessage(\r\n  content: string,\r\n  meta?: ChatMessage['meta']\r\n): ChatMessage {\r\n  return {\r\n    id: `user-${Date.now()}`,\r\n    role: 'user',\r\n    content,\r\n    timestamp: new Date(),\r\n    meta,\r\n  };\r\n}\r\n\r\nfunction createAssistantMessage(content: string): ChatMessage {\r\n  return {\r\n    id: `assistant-${Date.now()}`,\r\n    role: 'assistant',\r\n    content,\r\n    timestamp: new Date(),\r\n  };\r\n}\r\n\r\n// ============================================\r\n// CORE INVARIANT TESTS\r\n// ============================================\r\n// These tests verify the fundamental invariant:\r\n// displayedUserMessage === userTypedText\r\n// ============================================\r\n\r\ndescribe('INVARIANT: displayedUserMessage === userTypedText', () => {\r\n  describe('userTypedText is the ONLY source of truth', () => {\r\n    it('should return userTypedText when present', () => {\r\n      const msg = createUserMessage('internal content', {\r\n        userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n        actionLabel: 'Viáº¿t láº¡i', // Should be IGNORED\r\n        transformMode: 'PURE_TRANSFORM', // Should be IGNORED\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe('viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n');\r\n    });\r\n\r\n    it('should NEVER display actionLabel even if userTypedText matches', () => {\r\n      // Even if userTypedText equals actionLabel, we use userTypedText\r\n      const msg = createUserMessage('Viáº¿t láº¡i', {\r\n        userTypedText: 'Viáº¿t láº¡i',\r\n        actionLabel: 'Viáº¿t láº¡i',\r\n        transformMode: 'PURE_TRANSFORM',\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe('Viáº¿t láº¡i');\r\n    });\r\n\r\n    it('should preserve full instruction regardless of transformMode', () => {\r\n      // PURE_TRANSFORM should NOT truncate userTypedText\r\n      const msg = createUserMessage('internal', {\r\n        userTypedText: 'rÃºt gá»n cÃ²n 50 tá»«, giá»¯ nguyÃªn CTA',\r\n        actionLabel: 'RÃºt gá»n',\r\n        transformMode: 'PURE_TRANSFORM', // Even with PURE mode\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe('rÃºt gá»n cÃ²n 50 tá»«, giá»¯ nguyÃªn CTA');\r\n    });\r\n  });\r\n\r\n  describe('Button click scenario (user clicked action button)', () => {\r\n    it('should display what user expressed via button', () => {\r\n      // When user clicks \"Viáº¿t láº¡i\" button, userTypedText = \"Viáº¿t láº¡i\"\r\n      const msg = createUserMessage('Viáº¿t láº¡i', {\r\n        userTypedText: 'Viáº¿t láº¡i', // What they expressed\r\n        actionLabel: 'Viáº¿t láº¡i', // Internal\r\n        transformMode: 'PURE_TRANSFORM',\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe('Viáº¿t láº¡i');\r\n    });\r\n\r\n    it('should display \"RÃºt gá»n\" when user clicked shorten button', () => {\r\n      const msg = createUserMessage('RÃºt gá»n', {\r\n        userTypedText: 'RÃºt gá»n',\r\n        actionLabel: 'RÃºt gá»n',\r\n        transformMode: 'PURE_TRANSFORM',\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe('RÃºt gá»n');\r\n    });\r\n  });\r\n\r\n  describe('Typed instruction scenario', () => {\r\n    it('should preserve full typed instruction', () => {\r\n      const instruction = 'viáº¿t láº¡i theo phong cÃ¡ch Gen Z, thÃªm emoji, giá»¯ nguyÃªn thÃ´ng tin chÃ­nh';\r\n      const msg = createUserMessage('internal', {\r\n        userTypedText: instruction,\r\n        actionLabel: 'Viáº¿t láº¡i',\r\n        transformMode: 'DIRECTED_TRANSFORM',\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe(instruction);\r\n    });\r\n\r\n    it('should preserve multi-intent instruction verbatim', () => {\r\n      const instruction = 'viáº¿t láº¡i + Ä‘á»•i giá»ng + thÃªm hotline 0878123456 + rÃºt gá»n';\r\n      const msg = createUserMessage('internal', {\r\n        userTypedText: instruction,\r\n        actionLabel: 'Viáº¿t láº¡i', // Only captures primary action\r\n        transformMode: 'DIRECTED_TRANSFORM',\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe(instruction);\r\n    });\r\n\r\n    it('should never truncate to action label', () => {\r\n      const msg = createUserMessage('internal', {\r\n        userTypedText: 'viáº¿t láº¡i bÃ i nÃ y dÃ i hÆ¡n, giá»ng chuyÃªn nghiá»‡p',\r\n        actionLabel: 'Viáº¿t láº¡i',\r\n        sourceMessageId: 'msg-123',\r\n      });\r\n      const displayed = getDisplayedUserMessageText(msg);\r\n      expect(displayed).toBe('viáº¿t láº¡i bÃ i nÃ y dÃ i hÆ¡n, giá»ng chuyÃªn nghiá»‡p');\r\n      expect(displayed).not.toBe('Viáº¿t láº¡i'); // NEVER just the action\r\n    });\r\n  });\r\n});\r\n\r\n// ============================================\r\n// CREATE MODE TESTS\r\n// ============================================\r\n\r\ndescribe('CREATE mode (no transform)', () => {\r\n  it('should return content for simple messages without meta', () => {\r\n    const msg = createUserMessage('Viáº¿t bÃ i vá» du lá»‹ch ÄÃ  Náºµng');\r\n    expect(getDisplayedUserMessageText(msg)).toBe('Viáº¿t bÃ i vá» du lá»‹ch ÄÃ  Náºµng');\r\n  });\r\n\r\n  it('should return userTypedText when present in CREATE mode', () => {\r\n    const msg = createUserMessage('internal', {\r\n      userTypedText: 'Viáº¿t bÃ i vá» MIK Ocean City',\r\n      templateId: 'social_caption_v1',\r\n    });\r\n    expect(getDisplayedUserMessageText(msg)).toBe('Viáº¿t bÃ i vá» MIK Ocean City');\r\n  });\r\n\r\n  it('should fall back to content for legacy messages', () => {\r\n    const msg = createUserMessage('Legacy content without userTypedText', {\r\n      templateId: 'social_caption_v1',\r\n      requestId: 'req-123',\r\n    });\r\n    expect(getDisplayedUserMessageText(msg)).toBe('Legacy content without userTypedText');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// LEGACY COMPATIBILITY TESTS\r\n// ============================================\r\n\r\ndescribe('Legacy compatibility (deprecated userInstruction field)', () => {\r\n  it('should read from legacy userInstruction if userTypedText missing', () => {\r\n    // Old messages may have userInstruction instead of userTypedText\r\n    const msg = createUserMessage('internal', {\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      userInstruction: 'legacy instruction text',\r\n      sourceMessageId: 'msg-123',\r\n    } as any);\r\n    expect(getDisplayedUserMessageText(msg)).toBe('legacy instruction text');\r\n  });\r\n\r\n  it('should prefer userTypedText over userInstruction', () => {\r\n    const msg = createUserMessage('internal', {\r\n      userTypedText: 'new field',\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      userInstruction: 'legacy field',\r\n      sourceMessageId: 'msg-123',\r\n    } as any);\r\n    expect(getDisplayedUserMessageText(msg)).toBe('new field');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// ASSISTANT MESSAGE TESTS\r\n// ============================================\r\n\r\ndescribe('Assistant messages', () => {\r\n  it('should return content for assistant messages', () => {\r\n    const msg = createAssistantMessage('AI-generated content here');\r\n    expect(getDisplayedUserMessageText(msg)).toBe('AI-generated content here');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// DISPLAY MODE TESTS (for styling only)\r\n// ============================================\r\n\r\ndescribe('getUserMessageDisplayMode (styling only)', () => {\r\n  it('should return CREATE for messages without source', () => {\r\n    const msg = createUserMessage('Create something', {\r\n      userTypedText: 'Create something',\r\n    });\r\n    expect(getUserMessageDisplayMode(msg)).toBe('CREATE');\r\n  });\r\n\r\n  it('should return DIRECTED_TRANSFORM when mode is set', () => {\r\n    const msg = createUserMessage('instruction', {\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn',\r\n      transformMode: 'DIRECTED_TRANSFORM',\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n    expect(getUserMessageDisplayMode(msg)).toBe('DIRECTED_TRANSFORM');\r\n  });\r\n\r\n  it('should return PURE_TRANSFORM for button clicks', () => {\r\n    const msg = createUserMessage('Viáº¿t láº¡i', {\r\n      userTypedText: 'Viáº¿t láº¡i',\r\n      transformMode: 'PURE_TRANSFORM',\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n    expect(getUserMessageDisplayMode(msg)).toBe('PURE_TRANSFORM');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// UTILITY FUNCTION TESTS\r\n// ============================================\r\n\r\ndescribe('isTransformMessage', () => {\r\n  it('should return true for user messages with sourceMessageId', () => {\r\n    const msg = createUserMessage('Transform', {\r\n      userTypedText: 'Viáº¿t láº¡i',\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n    expect(isTransformMessage(msg)).toBe(true);\r\n  });\r\n\r\n  it('should return false for CREATE messages', () => {\r\n    const msg = createUserMessage('Create content', {\r\n      userTypedText: 'Create content',\r\n    });\r\n    expect(isTransformMessage(msg)).toBe(false);\r\n  });\r\n\r\n  it('should return false for assistant messages', () => {\r\n    const msg = createAssistantMessage('AI response');\r\n    expect(isTransformMessage(msg)).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe('getTransformActionLabel', () => {\r\n  it('should return actionLabel for transform messages', () => {\r\n    const msg = createUserMessage('instruction', {\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn',\r\n      actionLabel: 'Viáº¿t láº¡i',\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n    expect(getTransformActionLabel(msg)).toBe('Viáº¿t láº¡i');\r\n  });\r\n\r\n  it('should return null for non-transform messages', () => {\r\n    const msg = createUserMessage('Create content', {\r\n      userTypedText: 'Create content',\r\n    });\r\n    expect(getTransformActionLabel(msg)).toBe(null);\r\n  });\r\n});\r\n\r\n// ============================================\r\n// REGRESSION TESTS\r\n// ============================================\r\n// These tests prevent the previous bugs from recurring\r\n\r\ndescribe('Regression: User instruction truncation bug', () => {\r\n  it('should preserve \"viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n\" not just \"Viáº¿t láº¡i\"', () => {\r\n    const msg = createUserMessage('internal', {\r\n      userTypedText: 'viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n',\r\n      actionLabel: 'Viáº¿t láº¡i',\r\n      transformMode: 'PURE_TRANSFORM', // Bug: classifier returned PURE\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n    expect(getDisplayedUserMessageText(msg)).toBe('viáº¿t láº¡i giá»ng tá»± nhiÃªn hÆ¡n');\r\n    expect(getDisplayedUserMessageText(msg)).not.toBe('Viáº¿t láº¡i');\r\n  });\r\n\r\n  it('should preserve instruction on 3rd, 4th, 5th transform', () => {\r\n    // The original bug manifested on prompt #3 and beyond\r\n    const instructions = [\r\n      'má»Ÿ rá»™ng pháº§n giá»›i thiá»‡u thÃªm chi tiáº¿t',\r\n      'rÃºt gá»n pháº§n cuá»‘i cÃ²n 2 cÃ¢u',\r\n      'thÃªm CTA kÃªu gá»i liÃªn há»‡',\r\n    ];\r\n\r\n    instructions.forEach((instruction, i) => {\r\n      const msg = createUserMessage('internal', {\r\n        userTypedText: instruction,\r\n        actionLabel: ['Má»Ÿ rá»™ng', 'RÃºt gá»n', 'Viáº¿t láº¡i'][i],\r\n        transformMode: 'PURE_TRANSFORM',\r\n        sourceMessageId: `msg-transform-${i + 1}`,\r\n      });\r\n      expect(getDisplayedUserMessageText(msg)).toBe(instruction);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('Regression: actionLabel should NEVER be displayed as user content', () => {\r\n  it('should not use actionLabel even when userTypedText is missing (legacy)', () => {\r\n    // For legacy messages without userTypedText, fall back to content NOT actionLabel\r\n    const msg = createUserMessage('Legacy content', {\r\n      actionLabel: 'Viáº¿t láº¡i',\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n    // Should NOT return 'Viáº¿t láº¡i' - actionLabel is internal only\r\n    expect(getDisplayedUserMessageText(msg)).toBe('Legacy content');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// CONCEPTUAL TESTS\r\n// ============================================\r\n// These tests enforce the architectural principle:\r\n// USER MESSAGE â‰  ACTION\r\n\r\ndescribe('Conceptual: USER MESSAGE â‰  ACTION', () => {\r\n  it('user message represents what user said, not system classification', () => {\r\n    // User typed: \"viáº¿t láº¡i bÃ i nÃ y cho chuyÃªn nghiá»‡p hÆ¡n\"\r\n    // System classified as: REWRITE action\r\n    // Display should show: what user SAID, not what system classified\r\n    const msg = createUserMessage('internal', {\r\n      userTypedText: 'viáº¿t láº¡i bÃ i nÃ y cho chuyÃªn nghiá»‡p hÆ¡n',\r\n      actionLabel: 'Viáº¿t láº¡i', // System classification\r\n      actionType: 'REWRITE', // System classification\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n\r\n    const displayed = getDisplayedUserMessageText(msg);\r\n\r\n    // Must show USER'S words\r\n    expect(displayed).toBe('viáº¿t láº¡i bÃ i nÃ y cho chuyÃªn nghiá»‡p hÆ¡n');\r\n    // Must NOT show system classification\r\n    expect(displayed).not.toBe('Viáº¿t láº¡i');\r\n    expect(displayed).not.toBe('REWRITE');\r\n  });\r\n\r\n  it('actionLabel is for UI badges only, not message content', () => {\r\n    const msg = createUserMessage('internal', {\r\n      userTypedText: 'rÃºt gá»n cÃ²n 100 tá»«',\r\n      actionLabel: 'RÃºt gá»n',\r\n      sourceMessageId: 'msg-123',\r\n    });\r\n\r\n    // Message display: user's words\r\n    expect(getDisplayedUserMessageText(msg)).toBe('rÃºt gá»n cÃ²n 100 tá»«');\r\n\r\n    // Action label: available for badges/chips (via separate function)\r\n    expect(getTransformActionLabel(msg)).toBe('RÃºt gá»n');\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\Content Machine\\lib\\studio\\studioContext.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'pendingEditPatchMeta' and 'pendingOutputContract'. Either include them or remove the dependency array.","line":2061,"column":6,"nodeType":"ArrayExpression","endLine":2061,"endColumn":80,"suggestions":[{"desc":"Update the dependencies array to be: [messages, getLastValidAssistantMessage, selectedTemplateId, selectedTone?.systemReinforcement, pendingEditPatchMeta, pendingOutputContract]","fix":{"range":[79915,79989],"text":"[messages, getLastValidAssistantMessage, selectedTemplateId, selectedTone?.systemReinforcement, pendingEditPatchMeta, pendingOutputContract]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'executeCreateWithToken' and 'executeTransformWithToken'. Either include them or remove the dependency array.","line":2536,"column":6,"nodeType":"ArrayExpression","endLine":2544,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [lastIntentType, getLastValidAssistantMessage, activeSourceId, lastTransformSourceId, messages, executeTransformWithToken, selectedTemplateId, executeCreateWithToken]","fix":{"range":[99785,100001],"text":"[lastIntentType, getLastValidAssistantMessage, activeSourceId, lastTransformSourceId, messages, executeTransformWithToken, selectedTemplateId, executeCreateWithToken]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'pendingEditPatchMeta' and 'pendingOutputContract'. Either include them or remove the dependency array.","line":3165,"column":6,"nodeType":"ArrayExpression","endLine":3165,"endColumn":80,"suggestions":[{"desc":"Update the dependencies array to be: [messages, getLastValidAssistantMessage, selectedTemplateId, selectedTone?.systemReinforcement, pendingEditPatchMeta, pendingOutputContract]","fix":{"range":[126289,126363],"text":"[messages, getLastValidAssistantMessage, selectedTemplateId, selectedTone?.systemReinforcement, pendingEditPatchMeta, pendingOutputContract]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n// ============================================\r\n// Studio Context Provider\r\n// ============================================\r\n// STATE SEPARATION RULES (MANDATORY):\r\n//\r\n// 1. Ká»ŠCH Báº¢N STATE (Strategic Layer):\r\n//    - Variable: selectedTemplateId\r\n//    - Handler: handleTemplateSelect\r\n//    - Scope: Session-specific (ephemeral, no persistence)\r\n//    - Persistence: NONE - user must explicitly select each session\r\n//    - MUST NOT be modified by: Prompt Kit actions, content edits, message deletion\r\n//\r\n// 2. PROMPT KIT STATE (Tactical Layer):\r\n//    - Tracked in: chatInput modifications only\r\n//    - Scope: Ephemeral to current action\r\n//    - MUST NOT affect: selectedTemplateId, tone, use case\r\n//\r\n// 3. CONTENT STATE (Output Layer):\r\n//    - Variables: messages, chatInput, approvedMessageId\r\n//    - Affected by: Ká»‹ch báº£n (via AI behavior), Prompt Kit (via text insertion)\r\n//\r\n// ============================================\r\n\r\nimport React, { createContext, useContext, useState, useEffect, useCallback, useRef } from 'react';\r\nimport { useSearchParams } from 'next/navigation';\r\nimport type { UseCase, StudioContextType, PromptTemplate, ChatMessage, QualityLockMeta, AutoFixPreviewData, AutoFixToast, StudioToast, StudioSessionSnapshot, StudioSessionMeta } from '@/types/studio';\r\nimport { TEMPLATE_CATEGORIES } from './promptTemplates';\r\nimport { buildStudioAIRequest } from './aiClient';\r\nimport type { StudioAIRequest } from './aiTypes';\r\nimport { BRAND_TONES, type BrandTone } from './tones';\r\nimport { STUDIO_USE_CASES } from './useCases';\r\nimport { type WorkflowStep } from './workflow';\r\n// NEW: Import Content Machine Engine template system\r\nimport { getTemplateById as getNewTemplateById } from './templateLoader';\r\n// NEW: Import prompt localization helper\r\nimport { getLocalizedPrompt } from './promptLocalization';\r\nimport { useTranslation } from '@/lib/i18n';\r\n// AI Library: Persistent storage for saved thinking sessions\r\nimport { saveToAILibrary, loadAILibrary, type AILibraryEntry } from './aiLibrary';\r\n// âœ… PHASE 4: Import manifest resolver + system prompt builder\r\nimport { resolveTemplateManifest } from './templates/resolveManifest';\r\nimport { buildSystemPrompt } from './templates/buildSystemPrompt';\r\n// âœ… Quality Lock: Import evaluation engine\r\nimport { runQualityLock } from '@/lib/quality/runQualityLock';\r\nimport { isValidIntentId } from '@/lib/quality/intentQualityRules';\r\n// âœ… Quality Feedback: Import user-facing feedback transformer\r\nimport { transformToFeedback } from '@/lib/quality/qualityFeedback';\r\nimport type { IntentId } from '@/lib/quality/intentQualityRules';\r\n// âœ… Analytics: Import privacy-safe tracker\r\nimport {\r\n  trackQLEvaluationRequested,\r\n  trackQLEvaluationCompleted,\r\n  trackAutoFixRequested,\r\n  trackAutoFixAttemptCompleted,\r\n  trackAutoFixCandidateShown,\r\n  trackAutoFixApplied,\r\n  trackAutoFixDismissed,\r\n  trackAutoFixUndoUsed,\r\n  trackAutoFixPostApplyReEvaluated,\r\n} from '@/lib/analytics/track';\r\nimport { DraftState, AssistMode } from '@/types/analytics';\r\n// âœ… Orchestrator: Import transform orchestrator\r\nimport type { ActionType, TransformMode } from '@/types/orchestrator';\r\nimport { shouldValidate, getActionLabel, isRefusal, applyFallbackTransform, classifyAction, detectTransformMode, detectNewCreate, detectTopicDrift, extractOutputContract, validateOutputContract, buildEnforcementInstruction, buildContractInstruction } from '@/lib/orchestrator';\r\nimport { getMessageContent } from '@/lib/orchestrator/sourceResolver';\r\nimport { extractLockedContext } from '@/lib/orchestrator/lockedContextExtractor';\r\nimport { injectConstraints, buildSourceReference } from '@/lib/orchestrator/constraintInjector';\r\nimport type { TransformOutputContract, ContractValidationResult } from '@/types/orchestrator';\r\n// âœ… INVARIANT-SAFE: Import execution gate and LLM executor\r\nimport {\r\n  generateEventId,\r\n  createAuthorizationToken,\r\n  type UserActionType,\r\n} from '@/lib/orchestrator/executionGate';\r\nimport {\r\n  executeLLM,\r\n  type LLMRequest,\r\n} from '@/lib/orchestrator/llmExecutor';\r\nimport { safeHash } from '@/lib/studio/safeHash';\r\n// âœ… Diff & Apply: Import section extraction and apply helpers\r\nimport { extractSections, applySection, type ApplyMode } from '@/lib/studio/applySections';\r\n// âœ… STEP 3: Intent Snapshot (observability layer)\r\nimport {\r\n  createTransformSnapshot,\r\n  createCreateSnapshot,\r\n  getMessageSnapshot,\r\n  validateSnapshot,\r\n} from '@/lib/studio/intentSnapshot';\r\n// âœ… STEP 5: Execution Contract Enforcement\r\nimport {\r\n  resolveExecutionSource,\r\n  validateExecutionContract,\r\n  warnIfExecutionSourceDrifts,\r\n  warnIfModeMismatch,\r\n  getOriginForChain,\r\n} from '@/lib/studio/executionContract';\r\n// âœ… STEP 21: Edit Patch Executor\r\nimport { type EditPatchMeta } from '@/lib/studio/editPatchExecutor';\r\n// âœ… STEP 5 (UX): Soft Preference Memory - Output Length Bias & Workflow Pattern\r\nimport { recordLongerRequest, recordShorterRequest, recordSessionAction } from '@/lib/studio/preferenceMemory';\r\n// âœ… STEP 22: Rewrite Anchors for structural output guard\r\nimport {\r\n  injectAnchors,\r\n  validateAnchors,\r\n  stripAnchors,\r\n  shouldApplyAnchors,\r\n  type AnchoredContent,\r\n} from '@/lib/studio/rewriteAnchors';\r\n// âœ… STEP 22: Rewrite Diff Guard for conservative rewrite limits\r\nimport {\r\n  validateRewriteDiff,\r\n  getDiffGuardErrorMessage,\r\n} from '@/lib/studio/rewriteDiffGuard';\r\nimport { detectTaskType, type TaskDetectionContext } from '@/lib/studio/answerEngine';\r\n// âœ… STEP 23: User-facing error messages\r\nimport { getUserFacingAiError } from '@/lib/studio/errorMessages';\r\n\r\n// âœ… PHASE 2: Simple requestId generator (no external dependencies)\r\nfunction generateRequestId(): string {\r\n  return `req-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n// ============================================\r\n// AUTOMATIC TEMPLATE RESOLUTION\r\n// ============================================\r\n// Maps detected intent signals to appropriate template\r\n// Enables chat-first UX without requiring manual template selection\r\n//\r\n// Priority:\r\n// 1. User-selected template (explicit choice)\r\n// 2. Inferred from input signals (platform + content type)\r\n// 3. Fallback to general-purpose template\r\n\r\n// Template mapping by detected category\r\nconst TEMPLATE_INFERENCE_MAP: Record<string, string> = {\r\n  // Social media captions\r\n  'caption': 'social_caption_v1',\r\n  'instagram': 'social_caption_v1',\r\n  'facebook_post': 'social_caption_v1',\r\n  'tiktok': 'reel_caption_v1',\r\n  'reel': 'reel_caption_v1',\r\n  'reels': 'reel_caption_v1',\r\n\r\n  // Long-form content\r\n  'blog': 'seo_blog_v1',\r\n  'seo': 'seo_blog_v1',\r\n  'article': 'seo_blog_v1',\r\n\r\n  // Video content\r\n  'video': 'video_script_v1',\r\n  'script': 'video_script_v1',\r\n  'youtube': 'video_script_v1',\r\n\r\n  // E-commerce\r\n  'product': 'product_description_v1',\r\n  'ecommerce': 'product_description_v1',\r\n  'shop': 'product_description_v1',\r\n\r\n  // Marketing\r\n  'email': 'email_marketing_v1',\r\n  'newsletter': 'email_marketing_v1',\r\n  'landing': 'landing_page_v1',\r\n  'ads': 'social_caption_v1', // Use caption as fallback until ad_copy_v1 is ready\r\n  'quáº£ng cÃ¡o': 'social_caption_v1',\r\n};\r\n\r\n// Default template when no specific match (general-purpose)\r\nconst DEFAULT_TEMPLATE_ID = 'social_caption_v1';\r\n\r\n/**\r\n * Infer template ID from user input text\r\n * Uses keyword detection, not exhaustive phrase matching\r\n */\r\nfunction inferTemplateFromInput(input: string): string {\r\n  const normalized = input.toLowerCase().normalize('NFC');\r\n\r\n  // Priority 1: Check for specific content types\r\n  if (/\\b(reel|reels|tiktok|tik tok|shorts)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['reel'];\r\n  }\r\n  if (/\\b(caption|bÃ i Ä‘Äƒng)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['caption'];\r\n  }\r\n  if (/\\b(blog|bÃ i viáº¿t dÃ i|seo)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['blog'];\r\n  }\r\n  if (/\\b(video|ká»‹ch báº£n|kich ban|script|youtube)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['video'];\r\n  }\r\n  if (/\\b(sáº£n pháº©m|san pham|product|mÃ´ táº£ sp|mo ta sp|description)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['product'];\r\n  }\r\n  if (/\\b(email|thÆ°|newsletter|báº£n tin)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['email'];\r\n  }\r\n  if (/\\b(landing|trang Ä‘Ã­ch|landing page)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['landing'];\r\n  }\r\n\r\n  // Priority 2: Check for platform hints\r\n  if (/\\b(instagram|ig|insta)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['instagram'];\r\n  }\r\n  if (/\\b(facebook|fb|fanpage)\\b/i.test(normalized)) {\r\n    return TEMPLATE_INFERENCE_MAP['facebook_post'];\r\n  }\r\n\r\n  // Priority 3: Default to social caption (most versatile)\r\n  return DEFAULT_TEMPLATE_ID;\r\n}\r\n\r\n/**\r\n * Resolve effective template ID for sending\r\n * @param userSelectedTemplateId - Template manually selected by user (if any)\r\n * @param userInput - Current chat input text\r\n * @returns Template ID to use for this request\r\n */\r\nfunction resolveEffectiveTemplateId(\r\n  userSelectedTemplateId: string | null,\r\n  userInput: string\r\n): string {\r\n  // Priority 1: User explicitly selected a template\r\n  if (userSelectedTemplateId) {\r\n    return userSelectedTemplateId;\r\n  }\r\n\r\n  // Priority 2: Infer from input\r\n  return inferTemplateFromInput(userInput);\r\n}\r\n\r\n// âœ… Auto Fix Trust Metric (silent, console-only)\r\n// Logs whether user kept the suggestion after undo window closes\r\nfunction logAutoFixMetric(data: { kept: boolean; messageId: string; intent?: string }) {\r\n  console.log('[AutoFix:Metric]', JSON.stringify(data));\r\n}\r\n\r\n// âœ… System-driven workflow step derivation\r\n// Workflow is NEVER manually set - always derived from editor state\r\nfunction deriveWorkflowStep(state: {\r\n  messages: ChatMessage[];\r\n  approvedMessageId: string | null;\r\n}): WorkflowStep {\r\n  const { messages, approvedMessageId } = state;\r\n\r\n  const hasAIGeneration = messages.some(m => m.role === 'assistant');\r\n  const isApproved = approvedMessageId !== null;\r\n\r\n  // Find the latest assistant message with quality data\r\n  const latestAssistantWithQL = [...messages].reverse().find(\r\n    m => m.role === 'assistant' && m.meta?.qualityLock\r\n  );\r\n  const qualityFeedback = latestAssistantWithQL?.meta?.qualityLock?.feedback;\r\n  const qualityDecision = latestAssistantWithQL?.meta?.qualityLock?.decision;\r\n\r\n  // Has issues/suggestions = FAIL or WARNING status, or legacy FAIL/DRAFT decision\r\n  const hasIssuesOrSuggestions = qualityFeedback\r\n    ? (qualityFeedback.status === 'FAIL' || qualityFeedback.status === 'WARNING')\r\n    : (qualityDecision === 'FAIL' || qualityDecision === 'DRAFT');\r\n\r\n  // Priority 1: Approved OR has issues/suggestions â†’ 'review'\r\n  if (isApproved || (hasIssuesOrSuggestions && hasAIGeneration)) {\r\n    return 'review';\r\n  }\r\n\r\n  // Priority 2: AI has generated output with no issues â†’ 'draft'\r\n  if (hasAIGeneration) {\r\n    return 'draft';\r\n  }\r\n\r\n  // Priority 3: Default â†’ 'brief'\r\n  return 'brief';\r\n}\r\n\r\nconst StudioContext = createContext<StudioContextType | undefined>(undefined);\r\n\r\nexport const useStudio = () => {\r\n  const context = useContext(StudioContext);\r\n  if (!context) {\r\n    throw new Error('useStudio must be used within StudioProvider');\r\n  }\r\n  return context;\r\n};\r\n\r\nexport const StudioProvider: React.FC<{ children: React.ReactNode }> = ({\r\n  children,\r\n}) => {\r\n  // i18n hook for prompt localization\r\n  const { language } = useTranslation();\r\n\r\n  const [selectedUseCase, setSelectedUseCase] = useState<UseCase | null>(null);\r\n  // workflowStep is now DERIVED, not manually set - see deriveWorkflowStep() below\r\n  const [showWelcomeAnimation, setShowWelcomeAnimation] = useState(true);\r\n  const [chatInput, setChatInput] = useState('');\r\n  const [celebrationTrigger, setCelebrationTrigger] = useState(0);\r\n\r\n  // Tone Engine State with localStorage persistence\r\n  const [selectedTone, setSelectedTone] = useState<BrandTone | null>(() => {\r\n    if (typeof window === 'undefined') return null;\r\n    try {\r\n      const saved = localStorage.getItem('studio_selected_tone');\r\n      if (saved) {\r\n        const parsed = JSON.parse(saved);\r\n        return parsed as BrandTone;\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load saved tone:', error);\r\n    }\r\n    return null;\r\n  });\r\n\r\n  // Template Browser State (OLD system - for prompt templates)\r\n  const [isTemplateBrowserOpen, setTemplateBrowserOpen] = useState(false);\r\n  const [templateSearch, setTemplateSearch] = useState('');\r\n  const [selectedTemplateCategoryId, setSelectedTemplateCategoryId] = useState(\r\n    TEMPLATE_CATEGORIES[0]?.id || 'seo'\r\n  );\r\n\r\n  // NEW: Content Machine Engine Template State (NO PERSISTENCE)\r\n  // TERMINOLOGY: This manages ðŸŽ¬ Ká»ŠCH Báº¢N (Script) selection\r\n  // selectedTemplateId = ID of the active Ká»‹ch báº£n (complete content-generation structure)\r\n  // Note: Variable name kept as \"selectedTemplateId\" for backward compatibility\r\n  // but conceptually represents the active Script/Ká»‹ch báº£n\r\n  //\r\n  // UX RULE: User must EXPLICITLY select a script. No auto-selection, no persistence.\r\n  // Default state is NULL - user sees empty state until they actively choose.\r\n  const [selectedTemplateId, setSelectedTemplateIdState] = useState<string | null>(() => {\r\n    // âœ… FIXED: No auto-selection on SSR or client\r\n    if (typeof window === 'undefined') return null;\r\n\r\n    // âœ… REMOVED: localStorage persistence\r\n    // Script selection is session-specific and ephemeral\r\n    // User must explicitly choose script for each session\r\n\r\n    return null; // âœ… Default: no script selected\r\n  });\r\n\r\n  // Message History State with localStorage persistence\r\n  const [messages, setMessages] = useState<ChatMessage[]>(() => {\r\n    if (typeof window === 'undefined') return [];\r\n    try {\r\n      const saved = localStorage.getItem('studio_chat_messages_v1');\r\n      if (saved) {\r\n        const parsed = JSON.parse(saved);\r\n        // Check schema version for forward compatibility\r\n        if (parsed.schemaVersion === 1 && Array.isArray(parsed.messages)) {\r\n          // Rehydrate Date objects from ISO strings\r\n          return parsed.messages.map((msg: Record<string, unknown>) => ({\r\n            ...msg,\r\n            timestamp: new Date(msg.timestamp),\r\n          }));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load saved messages:', error);\r\n    }\r\n    return [];\r\n  });\r\n\r\n  // Approved Message State with localStorage persistence\r\n  const [approvedMessageId, setApprovedMessageIdState] = useState<string | null>(() => {\r\n    if (typeof window === 'undefined') return null;\r\n    try {\r\n      const saved = localStorage.getItem('studio_chat_messages_v1');\r\n      if (saved) {\r\n        const parsed = JSON.parse(saved);\r\n        if (parsed.schemaVersion === 1 && parsed.approvedMessageId) {\r\n          return parsed.approvedMessageId;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load approved message:', error);\r\n    }\r\n    return null;\r\n  });\r\n\r\n  // AI Result State\r\n  const [aiLoading, setAiLoading] = useState(false);\r\n  const [aiError, setAiError] = useState<string | null>(null);\r\n\r\n  // âœ… Quality Lock Auto Fix State\r\n  const [autoFixLoading, setAutoFixLoading] = useState<string | null>(null);\r\n\r\n  // âœ… Auto Fix Preview Modal State (Diff Preview UX)\r\n  const [autoFixPreview, setAutoFixPreview] = useState<AutoFixPreviewData | null>(null);\r\n  const [autoFixPreviewShownAt, setAutoFixPreviewShownAt] = useState<number | null>(null);\r\n\r\n  // âœ… Auto Fix Toast State (with undo support)\r\n  const [autoFixToast, setAutoFixToast] = useState<AutoFixToast | null>(null);\r\n  const [autoFixAppliedAt, setAutoFixAppliedAt] = useState<number | null>(null);\r\n\r\n  // âœ… PHASE 3: Template gate feedback state\r\n  const [_templateGateToast, _setTemplateGateToast] = useState<{\r\n    show: boolean;\r\n    message: string;\r\n  } | null>(null);\r\n\r\n  // âœ… Orchestrator: Active source and transform state\r\n  const [activeSourceId, setActiveSourceId] = useState<string | null>(null);\r\n  const [transformLoading, setTransformLoading] = useState<string | null>(null);\r\n\r\n  // âœ… STEP 21: Edit Patch Meta - set by StudioEditor before handleSend\r\n  // Enables partial edits (BODY-only, CTA-only, etc.) without full structure\r\n  const [pendingEditPatchMeta, setPendingEditPatchMeta] = useState<EditPatchMeta | null>(null);\r\n\r\n  // âœ… STEP 22: Output Contract - set by StudioEditor before handleSend\r\n  // Enforces PATCH_ONLY output format with [PATCH] blocks\r\n  const [pendingOutputContract, setPendingOutputContract] = useState<import('@/types/studio').OutputContract | null>(null);\r\n\r\n  // âœ… Transform Intent Memory: Remembers last intent type to handle uncertain classifications\r\n  // When user is in a refinement loop, defaults to TRANSFORM even if classifier is uncertain\r\n  // Explicit NEW-CREATE signals (\"viáº¿t bÃ i má»›i\", \"chá»§ Ä‘á» khÃ¡c\") override memory\r\n  const [lastIntentType, setLastIntentType] = useState<'CREATE' | 'TRANSFORM' | null>(() => {\r\n    if (typeof window === 'undefined') return null;\r\n    try {\r\n      const saved = localStorage.getItem('studio_intent_memory_v1');\r\n      if (saved) {\r\n        const parsed = JSON.parse(saved);\r\n        return parsed.lastIntentType || null;\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load intent memory:', error);\r\n    }\r\n    return null;\r\n  });\r\n\r\n  const [lastTransformSourceId, setLastTransformSourceId] = useState<string | null>(() => {\r\n    if (typeof window === 'undefined') return null;\r\n    try {\r\n      const saved = localStorage.getItem('studio_intent_memory_v1');\r\n      if (saved) {\r\n        const parsed = JSON.parse(saved);\r\n        return parsed.lastTransformSourceId || null;\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load intent memory:', error);\r\n    }\r\n    return null;\r\n  });\r\n\r\n  // ============================================\r\n  // FEATURE A: Primary Selection State\r\n  // ============================================\r\n  // Primary = the \"best\" output the user wants to commit to Posts\r\n  // Separate from approvedMessageId (which is for workflow approval)\r\n\r\n  const [primaryMessageId, setPrimaryMessageIdState] = useState<string | null>(() => {\r\n    if (typeof window === 'undefined') return null;\r\n    try {\r\n      const saved = localStorage.getItem('studio_primary_message_v1');\r\n      if (saved) {\r\n        return JSON.parse(saved).primaryMessageId || null;\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load primary message:', error);\r\n    }\r\n    return null;\r\n  });\r\n\r\n  const [commitLoading, setCommitLoading] = useState(false);\r\n  const [saveSessionLoading, setSaveSessionLoading] = useState(false);\r\n\r\n  // ============================================\r\n  // FEATURE B: Studio Session Persistence\r\n  // ============================================\r\n\r\n  // Generate session ID on first load\r\n  const [sessionId] = useState<string>(() => {\r\n    if (typeof window === 'undefined') return `session-${Date.now()}`;\r\n    try {\r\n      const saved = localStorage.getItem('studio_session_id_v1');\r\n      if (saved) {\r\n        return saved;\r\n      }\r\n      const newId = `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\r\n      localStorage.setItem('studio_session_id_v1', newId);\r\n      return newId;\r\n    } catch {\r\n      return `session-${Date.now()}`;\r\n    }\r\n  });\r\n\r\n  // Toast notifications\r\n  const [studioToast, setStudioToast] = useState<StudioToast | null>(null);\r\n\r\n  // Session snapshots (stored in localStorage)\r\n  const [snapshots, setSnapshots] = useState<StudioSessionSnapshot[]>(() => {\r\n    if (typeof window === 'undefined') return [];\r\n    try {\r\n      const saved = localStorage.getItem('studio_snapshots_v1');\r\n      if (saved) {\r\n        const parsed = JSON.parse(saved);\r\n        if (Array.isArray(parsed)) {\r\n          // Rehydrate dates and limit to 5 most recent\r\n          return parsed.slice(0, 5).map((s: StudioSessionSnapshot) => ({\r\n            ...s,\r\n            messages: s.messages.map((m: ChatMessage) => ({\r\n              ...m,\r\n              timestamp: new Date(m.timestamp),\r\n            })),\r\n          }));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load snapshots:', error);\r\n    }\r\n    return [];\r\n  });\r\n\r\n  // ============================================\r\n  // AI Library: Persistent saved sessions (survives Studio reset)\r\n  // ============================================\r\n  const [aiLibraryEntries, setAiLibraryEntries] = useState<AILibraryEntry[]>(() => {\r\n    return loadAILibrary();\r\n  });\r\n\r\n  // Track if we've already restored from URL to prevent duplicate restores\r\n  const hasRestoredFromUrl = useRef(false);\r\n\r\n  // Handle ?restore= query parameter from AI Library sidebar clicks\r\n  const searchParams = useSearchParams();\r\n  useEffect(() => {\r\n    const restoreId = searchParams.get('restore');\r\n    if (restoreId && !hasRestoredFromUrl.current) {\r\n      hasRestoredFromUrl.current = true;\r\n\r\n      // Find the entry in AI Library\r\n      const entry = aiLibraryEntries.find(e => e.id === restoreId);\r\n      if (entry) {\r\n        // Restore all state from library entry\r\n        setMessages(entry.messages.map(m => ({\r\n          ...m,\r\n          timestamp: new Date(m.timestamp),\r\n        })));\r\n        setPrimaryMessageIdState(entry.primaryMessageId);\r\n        setChatInput(entry.meta.promptInput || '');\r\n\r\n        // Restore tone if available\r\n        if (entry.meta.toneId) {\r\n          const tone = BRAND_TONES.find((t: BrandTone) => t.id === entry.meta.toneId);\r\n          if (tone) setSelectedTone(tone);\r\n        }\r\n\r\n        // Restore template if available\r\n        if (entry.meta.templateId) {\r\n          setSelectedTemplateIdState(entry.meta.templateId);\r\n        }\r\n\r\n        // STEP 6: Neutral restore - implies continuity\r\n        setStudioToast({\r\n          id: `restore-${Date.now()}`,\r\n          type: 'success',\r\n          message: 'ÄÃ£ khÃ´i phá»¥c. Tiáº¿p tá»¥c tá»« Ä‘Ã¢y.',\r\n          duration: 2500,\r\n        });\r\n\r\n        // Clear the URL param without navigation\r\n        if (typeof window !== 'undefined') {\r\n          const url = new URL(window.location.href);\r\n          url.searchParams.delete('restore');\r\n          window.history.replaceState({}, '', url.toString());\r\n        }\r\n      }\r\n    }\r\n  }, [searchParams, aiLibraryEntries]);\r\n\r\n  // Auto-hide welcome animation after 3 seconds\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      setShowWelcomeAnimation(false);\r\n    }, 3000);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, []);\r\n\r\n  // Edge case: Clear approvedMessageId if the message no longer exists\r\n  useEffect(() => {\r\n    if (approvedMessageId && !messages.find(m => m.id === approvedMessageId)) {\r\n      setApprovedMessageIdState(null);\r\n    }\r\n  }, [messages, approvedMessageId]);\r\n\r\n  // Persist messages and approved message to localStorage whenever they change\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    try {\r\n      const payload = {\r\n        schemaVersion: 1,\r\n        messages: messages,\r\n        approvedMessageId: approvedMessageId,\r\n      };\r\n      localStorage.setItem('studio_chat_messages_v1', JSON.stringify(payload));\r\n    } catch (error) {\r\n      console.error('Failed to save messages:', error);\r\n    }\r\n  }, [messages, approvedMessageId]);\r\n\r\n  // âœ… Persist intent memory to localStorage whenever it changes\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    try {\r\n      const payload = {\r\n        lastIntentType,\r\n        lastTransformSourceId,\r\n      };\r\n      localStorage.setItem('studio_intent_memory_v1', JSON.stringify(payload));\r\n    } catch (error) {\r\n      console.error('Failed to save intent memory:', error);\r\n    }\r\n  }, [lastIntentType, lastTransformSourceId]);\r\n\r\n  // ============================================\r\n  // FEATURE A: Primary Selection Persistence\r\n  // ============================================\r\n\r\n  // Persist primary message ID\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    try {\r\n      localStorage.setItem('studio_primary_message_v1', JSON.stringify({\r\n        primaryMessageId,\r\n      }));\r\n    } catch (error) {\r\n      console.error('Failed to save primary message:', error);\r\n    }\r\n  }, [primaryMessageId]);\r\n\r\n  // Clear primary if message no longer exists\r\n  useEffect(() => {\r\n    if (primaryMessageId && !messages.find(m => m.id === primaryMessageId)) {\r\n      setPrimaryMessageIdState(null);\r\n    }\r\n  }, [messages, primaryMessageId]);\r\n\r\n  // ============================================\r\n  // FEATURE B: Session Autosave\r\n  // ============================================\r\n\r\n  // Autosave session on key state changes (debounced)\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    if (messages.length === 0) return; // Don't save empty sessions\r\n\r\n    const timer = setTimeout(() => {\r\n      try {\r\n        const sessionData = {\r\n          sessionId,\r\n          messages,\r\n          primaryMessageId,\r\n          chatInput,\r\n          toneId: selectedTone?.id,\r\n          templateId: selectedTemplateId,\r\n          updatedAt: Date.now(),\r\n        };\r\n        localStorage.setItem('studio_autosave_v1', JSON.stringify(sessionData));\r\n      } catch (error) {\r\n        console.error('Failed to autosave session:', error);\r\n      }\r\n    }, 1000); // Debounce 1 second\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [messages, primaryMessageId, chatInput, selectedTone?.id, selectedTemplateId, sessionId]);\r\n\r\n  // Persist snapshots to localStorage\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    try {\r\n      localStorage.setItem('studio_snapshots_v1', JSON.stringify(snapshots));\r\n    } catch (error) {\r\n      console.error('Failed to save snapshots:', error);\r\n    }\r\n  }, [snapshots]);\r\n\r\n  // ============================================\r\n  // FEATURE A: Primary Selection Handlers\r\n  // ============================================\r\n\r\n  const setPrimaryMessage = useCallback((messageId: string) => {\r\n    // Only allow setting assistant messages as primary\r\n    const msg = messages.find(m => m.id === messageId);\r\n    if (msg && msg.role === 'assistant') {\r\n      setPrimaryMessageIdState(messageId);\r\n    }\r\n  }, [messages]);\r\n\r\n  const clearPrimaryMessage = useCallback(() => {\r\n    setPrimaryMessageIdState(null);\r\n  }, []);\r\n\r\n  // Create post draft from primary message\r\n  const createPostFromPrimary = useCallback(async (): Promise<{ success: boolean; postId?: string; error?: string }> => {\r\n    if (!primaryMessageId) {\r\n      return { success: false, error: 'ChÆ°a chá»n báº£n chÃ­nh' };\r\n    }\r\n\r\n    const primaryMsg = messages.find(m => m.id === primaryMessageId);\r\n    if (!primaryMsg || primaryMsg.role !== 'assistant') {\r\n      return { success: false, error: 'Báº£n chÃ­nh khÃ´ng há»£p lá»‡' };\r\n    }\r\n\r\n    setCommitLoading(true);\r\n\r\n    try {\r\n      const response = await fetch('/api/posts', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          title: primaryMsg.content.substring(0, 60).replace(/\\n+/g, ' ').trim() + (primaryMsg.content.length > 60 ? '...' : ''),\r\n          content: primaryMsg.content,\r\n          status: 'draft',\r\n          // Include metadata for traceability\r\n          meta: {\r\n            source: 'studio',\r\n            sessionId,\r\n            toneId: selectedTone?.id,\r\n            templateId: selectedTemplateId,\r\n            createdFromMessageId: primaryMessageId,\r\n          },\r\n        }),\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (!response.ok || !result.success) {\r\n        throw new Error(result.error || 'Failed to create draft');\r\n      }\r\n\r\n      // STEP 6: Neutral completion tone - no celebration\r\n      setStudioToast({\r\n        id: `toast-${Date.now()}`,\r\n        type: 'success',\r\n        message: 'BÃ i viáº¿t Ä‘Ã£ cÃ³ trong danh sÃ¡ch.',\r\n        action: {\r\n          label: 'Xem',\r\n          href: '/posts',\r\n        },\r\n        duration: 4000,\r\n      });\r\n\r\n      return { success: true, postId: result.post?.id };\r\n    } catch (error) {\r\n      const errorMsg = error instanceof Error ? error.message : 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';\r\n      // STEP 6: Softer error language - implies continuity\r\n      setStudioToast({\r\n        id: `toast-${Date.now()}`,\r\n        type: 'error',\r\n        message: 'ChÆ°a táº¡o Ä‘Æ°á»£c. Báº¡n cÃ³ thá»ƒ thá»­ láº¡i.',\r\n        duration: 4000,\r\n      });\r\n      return { success: false, error: errorMsg };\r\n    } finally {\r\n      setCommitLoading(false);\r\n    }\r\n  }, [primaryMessageId, messages, sessionId, selectedTone?.id, selectedTemplateId]);\r\n\r\n  // ============================================\r\n  // FEATURE B: Session Management Handlers\r\n  // ============================================\r\n\r\n  const showStudioToast = useCallback((toast: Omit<StudioToast, 'id'>) => {\r\n    const id = `toast-${Date.now()}`;\r\n    setStudioToast({ ...toast, id });\r\n\r\n    // Auto-dismiss after duration\r\n    if (toast.duration) {\r\n      setTimeout(() => {\r\n        setStudioToast(prev => prev?.id === id ? null : prev);\r\n      }, toast.duration);\r\n    }\r\n  }, []);\r\n\r\n  const dismissStudioToast = useCallback(() => {\r\n    setStudioToast(null);\r\n  }, []);\r\n\r\n  const saveSessionSnapshot = useCallback(async (name?: string) => {\r\n    const snapshotName = name || `Session â€“ ${new Date().toLocaleDateString('vi-VN')}`;\r\n    const snapshot: StudioSessionSnapshot = {\r\n      id: `snapshot-${Date.now()}`,\r\n      name: snapshotName,\r\n      createdAt: Date.now(),\r\n      messages: messages,\r\n      primaryMessageId,\r\n      meta: {\r\n        sessionId,\r\n        createdAt: Date.now(),\r\n        updatedAt: Date.now(),\r\n        promptInput: chatInput,\r\n        toneId: selectedTone?.id,\r\n        templateId: selectedTemplateId || undefined,\r\n      },\r\n    };\r\n\r\n    setSnapshots(prev => {\r\n      // Keep only 5 most recent, add new one at front\r\n      const updated = [snapshot, ...prev.slice(0, 4)];\r\n      return updated;\r\n    });\r\n\r\n    // STEP 6: Neutral confirmation - no celebration\r\n    showStudioToast({\r\n      type: 'success',\r\n      message: 'ÄÃ£ lÆ°u.',\r\n      duration: 2500,\r\n    });\r\n  }, [messages, primaryMessageId, chatInput, selectedTone?.id, selectedTemplateId, sessionId, showStudioToast]);\r\n\r\n  // Explicit user-initiated save (for psychological safety)\r\n  // Shows friendly toast, does NOT create a Post or change Primary\r\n  // ALSO saves to AI Library for persistence across Studio reset/refresh\r\n  const saveSession = useCallback(async () => {\r\n    if (saveSessionLoading) return;\r\n\r\n    // Check if session is empty (no messages and no input)\r\n    const hasContent = messages.length > 0 || chatInput.trim().length > 0;\r\n    if (!hasContent) {\r\n      showStudioToast({\r\n        type: 'info',\r\n        message: 'ChÆ°a cÃ³ ná»™i dung Ä‘á»ƒ lÆ°u',\r\n        duration: 2500,\r\n      });\r\n      return;\r\n    }\r\n\r\n    setSaveSessionLoading(true);\r\n    try {\r\n      // Save as a snapshot with user-friendly name\r\n      const snapshotName = `PhiÃªn lÃ m viá»‡c â€“ ${new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}`;\r\n      const snapshot: StudioSessionSnapshot = {\r\n        id: `session-save-${Date.now()}`,\r\n        name: snapshotName,\r\n        createdAt: Date.now(),\r\n        messages: messages,\r\n        primaryMessageId,\r\n        meta: {\r\n          sessionId,\r\n          createdAt: Date.now(),\r\n          updatedAt: Date.now(),\r\n          promptInput: chatInput,\r\n          toneId: selectedTone?.id,\r\n          templateId: selectedTemplateId || undefined,\r\n        },\r\n      };\r\n\r\n      setSnapshots(prev => {\r\n        // Keep only 5 most recent, add new one at front\r\n        const updated = [snapshot, ...prev.slice(0, 4)];\r\n        return updated;\r\n      });\r\n\r\n      // ============================================\r\n      // AI Library: Persist to localStorage for cross-session access\r\n      // ============================================\r\n      const libraryMeta: StudioSessionMeta = {\r\n        sessionId,\r\n        createdAt: Date.now(),\r\n        updatedAt: Date.now(),\r\n        promptInput: chatInput,\r\n        toneId: selectedTone?.id,\r\n        templateId: selectedTemplateId || undefined,\r\n      };\r\n\r\n      saveToAILibrary({\r\n        sessionId,\r\n        messages,\r\n        primaryMessageId,\r\n        meta: libraryMeta,\r\n      });\r\n\r\n      // Refresh AI Library state\r\n      setAiLibraryEntries(loadAILibrary());\r\n\r\n      // STEP 6: Neutral confirmation - implies continuity\r\n      showStudioToast({\r\n        type: 'success',\r\n        message: 'ÄÃ£ lÆ°u. Báº¡n cÃ³ thá»ƒ quay láº¡i sau.',\r\n        duration: 3000,\r\n      });\r\n    } catch (error) {\r\n      console.error('[Studio] Error saving session:', error);\r\n      // STEP 6: Softer error - implies safety\r\n      showStudioToast({\r\n        type: 'error',\r\n        message: 'ChÆ°a lÆ°u Ä‘Æ°á»£c. Ná»™i dung váº«n cÃ²n á»Ÿ Ä‘Ã¢y.',\r\n        duration: 3000,\r\n      });\r\n    } finally {\r\n      setSaveSessionLoading(false);\r\n    }\r\n  }, [messages, chatInput, primaryMessageId, sessionId, selectedTone?.id, selectedTemplateId, saveSessionLoading, showStudioToast]);\r\n\r\n  const getRecentSnapshots = useCallback((): StudioSessionSnapshot[] => {\r\n    return snapshots;\r\n  }, [snapshots]);\r\n\r\n  const restoreSnapshot = useCallback((snapshotId: string) => {\r\n    const snapshot = snapshots.find(s => s.id === snapshotId);\r\n    if (!snapshot) {\r\n      showStudioToast({\r\n        type: 'error',\r\n        message: 'KhÃ´ng tÃ¬m tháº¥y báº£n lÆ°u.',\r\n        duration: 2500,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Restore all state from snapshot\r\n    setMessages(snapshot.messages.map(m => ({\r\n      ...m,\r\n      timestamp: new Date(m.timestamp),\r\n    })));\r\n    setPrimaryMessageIdState(snapshot.primaryMessageId);\r\n    setChatInput(snapshot.meta.promptInput || '');\r\n\r\n    // STEP 6: Neutral restore - no celebration\r\n    showStudioToast({\r\n      type: 'success',\r\n      message: 'ÄÃ£ khÃ´i phá»¥c.',\r\n      duration: 2500,\r\n    });\r\n  }, [snapshots, showStudioToast]);\r\n\r\n  // ============================================\r\n  // AI Library: Restore session from library entry\r\n  // ============================================\r\n  const restoreFromAILibrary = useCallback((entryId: string) => {\r\n    const entry = aiLibraryEntries.find(e => e.id === entryId);\r\n    if (!entry) {\r\n      showStudioToast({\r\n        type: 'error',\r\n        message: 'KhÃ´ng tÃ¬m tháº¥y báº£n lÆ°u.',\r\n        duration: 2500,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Restore all state from library entry\r\n    setMessages(entry.messages.map(m => ({\r\n      ...m,\r\n      timestamp: new Date(m.timestamp),\r\n    })));\r\n    setPrimaryMessageIdState(entry.primaryMessageId);\r\n    setChatInput(entry.meta.promptInput || '');\r\n\r\n    // Restore tone if available\r\n    if (entry.meta.toneId) {\r\n      const tone = BRAND_TONES.find((t: BrandTone) => t.id === entry.meta.toneId);\r\n      if (tone) setSelectedTone(tone);\r\n    }\r\n\r\n    // Restore template if available\r\n    if (entry.meta.templateId) {\r\n      setSelectedTemplateIdState(entry.meta.templateId);\r\n    }\r\n\r\n    // STEP 6: Neutral restore - implies continuity\r\n    showStudioToast({\r\n      type: 'success',\r\n      message: 'ÄÃ£ khÃ´i phá»¥c. Tiáº¿p tá»¥c tá»« Ä‘Ã¢y.',\r\n      duration: 2500,\r\n    });\r\n  }, [aiLibraryEntries, showStudioToast]);\r\n\r\n  // Handle use case selection\r\n  const handleUseCaseSelect = (useCase: UseCase) => {\r\n    setSelectedUseCase(useCase);\r\n\r\n    // Only auto-fill if use case has a prompt (legacy behavior)\r\n    // If it only has a placeholder, just set the context without filling input\r\n    if (useCase.prompt) {\r\n      setTimeout(() => {\r\n        setChatInput(useCase.prompt!); // Safe because we checked for prompt above\r\n      }, 150);\r\n    }\r\n  };\r\n\r\n  // Handle tone selection with persistence\r\n  const handleToneSelect = (tone: BrandTone) => {\r\n    setSelectedTone(tone);\r\n    // Persist to localStorage\r\n    try {\r\n      localStorage.setItem('studio_selected_tone', JSON.stringify(tone));\r\n    } catch (error) {\r\n      console.error('Failed to save tone:', error);\r\n    }\r\n  };\r\n\r\n  // NEW: Handle Content Machine Engine template selection (NO PERSISTENCE)\r\n  // TERMINOLOGY: This selects a ðŸŽ¬ Ká»ŠCH Báº¢N (Script), NOT a prompt or template in the old sense\r\n  // A Ká»‹ch báº£n defines: objective, flow, constraints, mode (A/B/C), platform compatibility\r\n  const handleTemplateSelect = (templateId: string | null) => {\r\n    setSelectedTemplateIdState(templateId);\r\n    // âœ… NO PERSISTENCE: Script selection is ephemeral per session\r\n    // User must explicitly choose script each time they use Studio\r\n  };\r\n\r\n  // Trigger celebration effect\r\n  const triggerCelebration = () => {\r\n    setCelebrationTrigger((prev) => prev + 1);\r\n  };\r\n\r\n  // ============================================\r\n  // OLD sendToAI REMOVED - Now uses dispatchExecution â†’ executeCreateWithToken\r\n  // All AI execution MUST go through dispatchExecution (gate-first architecture)\r\n  // ============================================\r\n\r\n  // Clear message history\r\n  const clearMessages = () => {\r\n    setMessages([]);\r\n    setAiError(null);\r\n    setApprovedMessageIdState(null); // Also clear approved message\r\n    // âœ… Clear intent memory when clearing messages\r\n    setLastIntentType(null);\r\n    setLastTransformSourceId(null);\r\n    // Clear from localStorage\r\n    try {\r\n      if (typeof window !== 'undefined') {\r\n        localStorage.removeItem('studio_chat_messages_v1');\r\n        localStorage.removeItem('studio_intent_memory_v1');\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to clear messages from storage:', error);\r\n    }\r\n  };\r\n\r\n  // Set approved message (only allow assistant messages)\r\n  const setApprovedMessage = (messageId: string) => {\r\n    const message = messages.find(m => m.id === messageId);\r\n    if (message && message.role === 'assistant') {\r\n      setApprovedMessageIdState(messageId);\r\n    }\r\n  };\r\n\r\n  // Clear approved message\r\n  const clearApprovedMessage = () => {\r\n    setApprovedMessageIdState(null);\r\n  };\r\n\r\n  // âœ… Quality Lock Auto Fix\r\n  // Calls /api/quality/auto-fix to refine content based on failed rules (both HARD and SOFT)\r\n  // Opens Diff Preview Modal instead of immediately applying\r\n  const autoFixMessage = async (messageId: string) => {\r\n    const message = messages.find(m => m.id === messageId);\r\n    if (!message || message.role !== 'assistant') {\r\n      console.warn('[Auto-Fix] Invalid message:', messageId);\r\n      return;\r\n    }\r\n\r\n    const qualityLock = message.meta?.qualityLock;\r\n    // Auto Fix is available for DRAFT (soft fails only) or FAIL (has hard fails)\r\n    // Not available for PASS (nothing to fix)\r\n    const hasFailsToFix =\r\n      (qualityLock?.softFails?.length ?? 0) > 0 ||\r\n      (qualityLock?.hardFails?.length ?? 0) > 0;\r\n\r\n    if (!qualityLock || qualityLock.decision === 'PASS' || !hasFailsToFix) {\r\n      console.warn('[Auto-Fix] Message not eligible for auto-fix:', messageId, {\r\n        decision: qualityLock?.decision,\r\n        softFails: qualityLock?.softFails?.length ?? 0,\r\n        hardFails: qualityLock?.hardFails?.length ?? 0,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Determine intent: prefer meta.intent (resolved at generation time), fallback to templateId\r\n    const candidateIntent = message.meta?.intent || message.meta?.templateId;\r\n    if (!isValidIntentId(candidateIntent)) {\r\n      console.warn('[Auto-Fix] No valid intent found for auto-fix');\r\n      return;\r\n    }\r\n\r\n    const intent = candidateIntent;\r\n    setAutoFixLoading(messageId);\r\n    const requestStartTime = Date.now();\r\n\r\n    // âœ… Track Auto Fix requested\r\n    trackAutoFixRequested({\r\n      draft_id: messageId,\r\n      message_id: messageId,\r\n      intent_id: intent,\r\n      ui_surface: 'studio',\r\n      editor_state: DraftState.D0_ACTIVE,\r\n      assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n      previous_decision: qualityLock.decision,\r\n      target_rule_ids: [\r\n        ...(qualityLock.hardFails || []).map(r => r.id),\r\n        ...(qualityLock.softFails || []).map(r => r.id),\r\n      ],\r\n    });\r\n\r\n    try {\r\n      const response = await fetch('/api/quality/auto-fix', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          intent,\r\n          output: message.content,\r\n          softFails: qualityLock.softFails || [],\r\n          hardFails: qualityLock.hardFails || [],\r\n          meta: {\r\n            templateId: message.meta?.templateId,\r\n            language: 'vi', // Default to Vietnamese\r\n          },\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok || !data.refinedOutput) {\r\n        throw new Error(data.error || 'Auto-fix failed');\r\n      }\r\n\r\n      const requestDuration = Date.now() - requestStartTime;\r\n\r\n      console.log('[Auto-Fix] API response:', {\r\n        similarity: data.similarity?.score,\r\n        attempts: data.attempts,\r\n        usedFallback: data.usedFallback,\r\n      });\r\n\r\n      // âœ… Track Auto Fix attempt completed\r\n      trackAutoFixAttemptCompleted({\r\n        draft_id: messageId,\r\n        message_id: messageId,\r\n        intent_id: intent,\r\n        ui_surface: 'studio',\r\n        editor_state: DraftState.D0_ACTIVE,\r\n        assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n        attempt_number: data.attempts || 1,\r\n        similarity_score: data.similarity?.score || 1,\r\n        used_fallback: data.usedFallback || false,\r\n        duration_ms: requestDuration,\r\n      });\r\n\r\n      // âœ… Open Diff Preview Modal instead of immediately applying\r\n      setAutoFixPreview({\r\n        messageId,\r\n        originalContent: message.content,\r\n        refinedContent: data.refinedOutput,\r\n        similarity: data.similarity,\r\n        attempts: data.attempts,\r\n        usedFallback: data.usedFallback,\r\n      });\r\n\r\n      // âœ… Track Auto Fix candidate shown\r\n      trackAutoFixCandidateShown({\r\n        draft_id: messageId,\r\n        message_id: messageId,\r\n        intent_id: intent,\r\n        ui_surface: 'studio',\r\n        editor_state: DraftState.D0_ACTIVE,\r\n        assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n        similarity_score: data.similarity?.score || 1,\r\n        used_fallback: data.usedFallback || false,\r\n      });\r\n\r\n      // Track when preview was shown for review duration calculation\r\n      setAutoFixPreviewShownAt(Date.now());\r\n\r\n    } catch (error: unknown) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Auto-fix failed';\r\n      console.error('[Auto-Fix] Failed:', errorMessage);\r\n      setAiError(`Auto-fix failed: ${errorMessage}`);\r\n    } finally {\r\n      setAutoFixLoading(null);\r\n    }\r\n  };\r\n\r\n  // âœ… Apply Auto Fix from Preview Modal\r\n  const applyAutoFix = useCallback(() => {\r\n    if (!autoFixPreview) return;\r\n\r\n    const { messageId, originalContent, refinedContent } = autoFixPreview;\r\n    const message = messages.find(m => m.id === messageId);\r\n    if (!message) return;\r\n\r\n    const qualityLock = message.meta?.qualityLock;\r\n    const intent = message.meta?.intent || message.meta?.templateId;\r\n\r\n    if (!isValidIntentId(intent)) {\r\n      console.warn('[Auto-Fix Apply] No valid intent found');\r\n      return;\r\n    }\r\n\r\n    // Re-run Quality Lock on refined output\r\n    const reEvalResult = runQualityLock({\r\n      intent,\r\n      output: refinedContent,\r\n      meta: {\r\n        templateId: message.meta?.templateId,\r\n        language: 'vi',\r\n        testMode: message.meta?.testMode,\r\n      },\r\n    });\r\n\r\n    // Map re-evaluation result to decision\r\n    const newDecision = reEvalResult.hardFails.length > 0\r\n      ? 'FAIL' as const\r\n      : reEvalResult.softFails.length > 0\r\n      ? 'DRAFT' as const\r\n      : 'PASS' as const;\r\n\r\n    const newAttempts = (qualityLock?.autoFixAttempts || 0) + 1;\r\n\r\n    console.log(`[Auto-Fix Apply] Re-evaluation: ${newDecision}`, {\r\n      attempts: newAttempts,\r\n      hardFails: reEvalResult.hardFails.length,\r\n      softFails: reEvalResult.softFails.length,\r\n    });\r\n\r\n    // âœ… Track Auto Fix post-apply re-evaluation\r\n    trackAutoFixPostApplyReEvaluated({\r\n      draft_id: messageId,\r\n      message_id: messageId,\r\n      intent_id: intent,\r\n      ui_surface: 'studio',\r\n      editor_state: DraftState.D0_ACTIVE,\r\n      assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n      new_decision: newDecision,\r\n    });\r\n\r\n    // âœ… Track Auto Fix applied\r\n    const reviewDuration = autoFixPreviewShownAt ? Date.now() - autoFixPreviewShownAt : 0;\r\n    trackAutoFixApplied({\r\n      draft_id: messageId,\r\n      message_id: messageId,\r\n      intent_id: intent,\r\n      ui_surface: 'studio',\r\n      editor_state: DraftState.D0_ACTIVE,\r\n      assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n      review_duration_ms: reviewDuration,\r\n      similarity_score: autoFixPreview.similarity?.score || 1,\r\n      was_fallback: autoFixPreview.usedFallback || false,\r\n    });\r\n    setAutoFixPreviewShownAt(null);\r\n\r\n    // Update message with refined content and new quality lock result\r\n    // Store previousDecision for outcome visibility UX\r\n    const previousDecision = qualityLock?.decision;\r\n\r\n    setMessages(prev => prev.map(m => {\r\n      if (m.id === messageId) {\r\n        return {\r\n          ...m,\r\n          content: refinedContent,\r\n          meta: {\r\n            ...m.meta,\r\n            qualityLock: {\r\n              decision: newDecision,\r\n              softFails: reEvalResult.softFails,\r\n              hardFails: reEvalResult.hardFails,\r\n              autoFixAttempts: newAttempts,\r\n              previousDecision, // For outcome visibility indicator\r\n            },\r\n          },\r\n        };\r\n      }\r\n      return m;\r\n    }));\r\n\r\n    // Close preview modal\r\n    setAutoFixPreview(null);\r\n\r\n    // Track when fix was applied for undo timing\r\n    setAutoFixAppliedAt(Date.now());\r\n\r\n    // Show toast with undo option\r\n    setAutoFixToast({\r\n      show: true,\r\n      message: 'ÄÃ£ thay báº±ng báº£n Ä‘iá»u chá»‰nh.',\r\n      type: 'success',\r\n      canUndo: true,\r\n      undoData: {\r\n        messageId,\r\n        originalContent,\r\n      },\r\n    });\r\n\r\n    // Auto-dismiss toast after 5 seconds\r\n    // Log trust metric when undo window closes without undo\r\n    setTimeout(() => {\r\n      setAutoFixToast(prev => {\r\n        // If toast still exists for this message, user did NOT undo â†’ kept: true\r\n        if (prev?.undoData?.messageId === messageId) {\r\n          logAutoFixMetric({ kept: true, messageId, intent });\r\n          return null;\r\n        }\r\n        return prev;\r\n      });\r\n    }, 5000);\r\n\r\n    console.log('[Auto-Fix Apply] Successfully applied refinement:', messageId);\r\n  }, [autoFixPreview, messages, autoFixPreviewShownAt]);\r\n\r\n  // âœ… Cancel Auto Fix (keep original)\r\n  const cancelAutoFix = useCallback(() => {\r\n    // âœ… Track Auto Fix dismissed\r\n    if (autoFixPreview) {\r\n      const reviewDuration = autoFixPreviewShownAt ? Date.now() - autoFixPreviewShownAt : 0;\r\n      const message = messages.find(m => m.id === autoFixPreview.messageId);\r\n      const intent = message?.meta?.intent || message?.meta?.templateId;\r\n      trackAutoFixDismissed({\r\n        draft_id: autoFixPreview.messageId,\r\n        message_id: autoFixPreview.messageId,\r\n        intent_id: intent,\r\n        ui_surface: 'studio',\r\n        editor_state: DraftState.D0_ACTIVE,\r\n        assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n        review_duration_ms: reviewDuration,\r\n        similarity_score: autoFixPreview.similarity?.score || 1,\r\n        was_fallback: autoFixPreview.usedFallback || false,\r\n      });\r\n    }\r\n    setAutoFixPreviewShownAt(null);\r\n\r\n    setAutoFixPreview(null);\r\n    setAutoFixToast({\r\n      show: true,\r\n      message: 'Giá»¯ nguyÃªn báº£n gá»‘c.',\r\n      type: 'info',\r\n    });\r\n\r\n    // Auto-dismiss toast after 3 seconds\r\n    setTimeout(() => {\r\n      setAutoFixToast(null);\r\n    }, 3000);\r\n  }, [autoFixPreview, autoFixPreviewShownAt, messages]);\r\n\r\n  // âœ… Undo Auto Fix\r\n  const undoAutoFix = useCallback(() => {\r\n    if (!autoFixToast?.undoData) return;\r\n\r\n    const { messageId, originalContent } = autoFixToast.undoData;\r\n    const message = messages.find(m => m.id === messageId);\r\n    if (!message) return;\r\n\r\n    const intent = message.meta?.intent || message.meta?.templateId;\r\n\r\n    // âœ… Track Auto Fix undo used\r\n    const timeSinceApply = autoFixAppliedAt ? Date.now() - autoFixAppliedAt : 0;\r\n    trackAutoFixUndoUsed({\r\n      draft_id: messageId,\r\n      message_id: messageId,\r\n      intent_id: intent,\r\n      ui_surface: 'studio',\r\n      editor_state: DraftState.D0_ACTIVE,\r\n      assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n      time_since_apply_ms: timeSinceApply,\r\n    });\r\n    setAutoFixAppliedAt(null);\r\n\r\n    // Log trust metric: user rejected the suggestion\r\n    logAutoFixMetric({ kept: false, messageId, intent });\r\n\r\n    if (!isValidIntentId(intent)) {\r\n      console.warn('[Auto-Fix Undo] No valid intent found');\r\n      return;\r\n    }\r\n\r\n    // Re-run Quality Lock on original content to restore original state\r\n    const reEvalResult = runQualityLock({\r\n      intent,\r\n      output: originalContent,\r\n      meta: {\r\n        templateId: message.meta?.templateId,\r\n        language: 'vi',\r\n        testMode: message.meta?.testMode,\r\n      },\r\n    });\r\n\r\n    const newDecision = reEvalResult.hardFails.length > 0\r\n      ? 'FAIL' as const\r\n      : reEvalResult.softFails.length > 0\r\n      ? 'DRAFT' as const\r\n      : 'PASS' as const;\r\n\r\n    // Decrement attempts (but never below 0)\r\n    const currentAttempts = message.meta?.qualityLock?.autoFixAttempts || 0;\r\n    const newAttempts = Math.max(0, currentAttempts - 1);\r\n\r\n    // Restore original content\r\n    setMessages(prev => prev.map(m => {\r\n      if (m.id === messageId) {\r\n        return {\r\n          ...m,\r\n          content: originalContent,\r\n          meta: {\r\n            ...m.meta,\r\n            qualityLock: {\r\n              decision: newDecision,\r\n              softFails: reEvalResult.softFails,\r\n              hardFails: reEvalResult.hardFails,\r\n              autoFixAttempts: newAttempts,\r\n            },\r\n          },\r\n        };\r\n      }\r\n      return m;\r\n    }));\r\n\r\n    // Dismiss toast\r\n    setAutoFixToast(null);\r\n\r\n    console.log('[Auto-Fix Undo] Restored original content:', messageId);\r\n  }, [autoFixToast, messages, autoFixAppliedAt]);\r\n\r\n  // âœ… Dismiss Auto Fix Toast\r\n  const dismissAutoFixToast = useCallback(() => {\r\n    setAutoFixToast(null);\r\n  }, []);\r\n\r\n  // âœ… Orchestrator: Set active source for transforms\r\n  const setActiveSource = useCallback((sourceId: string | null) => {\r\n    setActiveSourceId(sourceId);\r\n  }, []);\r\n\r\n  // âœ… Orchestrator: Get last assistant message (for default source selection)\r\n  const _getLastAssistantMessage = useCallback((): ChatMessage | null => {\r\n    const assistantMessages = messages.filter(m => m.role === 'assistant');\r\n    return assistantMessages.length > 0 ? assistantMessages[assistantMessages.length - 1] : null;\r\n  }, [messages]);\r\n\r\n  // âœ… Orchestrator: Get last VALID assistant message (non-empty, non-fallback refusal)\r\n  // Used for transform source selection - skips empty or refusal messages\r\n  const getLastValidAssistantMessage = useCallback((): ChatMessage | null => {\r\n    const assistantMessages = messages.filter(m => m.role === 'assistant');\r\n\r\n    // Search from newest to oldest\r\n    for (let i = assistantMessages.length - 1; i >= 0; i--) {\r\n      const msg = assistantMessages[i];\r\n      const content = msg.content?.trim() || '';\r\n\r\n      // Skip empty messages\r\n      if (!content) continue;\r\n\r\n      // Skip refusal messages\r\n      if (isRefusal(content)) continue;\r\n\r\n      // Skip very short messages (likely errors or system messages)\r\n      if (content.length < 20) continue;\r\n\r\n      return msg;\r\n    }\r\n\r\n    return null;\r\n  }, [messages]);\r\n\r\n  // âœ… Orchestrator: Handle transform action from MessageActionBar\r\n  // Includes refusal detection, retry logic, and fallback transforms\r\n  // transformMode: PURE_TRANSFORM (verb only) vs DIRECTED_TRANSFORM (verb + directives)\r\n  // userInstruction: Original user text (for DIRECTED_TRANSFORM prompt building)\r\n  // userActionType: Type of user action (for invariant gate)\r\n  // eventId: Unique event ID (for duplicate prevention)\r\n  const handleTransformAction = useCallback(async (\r\n    action: ActionType,\r\n    sourceMessageId?: string,\r\n    transformMode: TransformMode = 'PURE_TRANSFORM',\r\n    userInstruction?: string,\r\n    userActionType: UserActionType = 'send',\r\n    eventId?: string\r\n  ) => {\r\n    // âœ… INVARIANT-SAFE: Generate event ID if not provided\r\n    const actionEventId = eventId || generateEventId();\r\n    const actionTimestamp = Date.now();\r\n\r\n    // âœ… INVARIANT-SAFE: Create authorization token through gate\r\n    const authToken = createAuthorizationToken({\r\n      userActionType,\r\n      eventId: actionEventId,\r\n      actionTimestamp,\r\n      hasValidInput: true, // Transform always has source content as input\r\n      sourceMessageId,\r\n      actionType: action,\r\n      callerLocation: 'handleTransformAction',\r\n    });\r\n\r\n    if (!authToken) {\r\n      console.error('[Transform] Execution blocked by gate - no valid authorization');\r\n      setAiError('KhÃ´ng thá»ƒ thá»±c hiá»‡n yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i.');\r\n      throw new Error('Execution blocked by gate');\r\n    }\r\n    // Auto-select last VALID assistant message if no source specified\r\n    let effectiveSourceId = sourceMessageId;\r\n    if (!effectiveSourceId) {\r\n      const lastValid = getLastValidAssistantMessage();\r\n      if (!lastValid) {\r\n        console.warn('[Transform] No valid source available - no assistant messages');\r\n        setAiError('KhÃ´ng cÃ³ ná»™i dung Ä‘á»ƒ chá»‰nh sá»­a. HÃ£y táº¡o ná»™i dung trÆ°á»›c.');\r\n        // âœ… B6: Throw to trigger draft restoration in caller\r\n        throw new Error('No valid source available');\r\n      }\r\n      effectiveSourceId = lastValid.id;\r\n      console.log('[Transform] Auto-selected last valid assistant message as source:', effectiveSourceId);\r\n    }\r\n\r\n    // Get source message content\r\n    const sourceContent = getMessageContent(effectiveSourceId, messages);\r\n    if (!sourceContent || !sourceContent.trim()) {\r\n      console.warn('[Transform] Source content is empty:', effectiveSourceId);\r\n      setAiError('Ná»™i dung nguá»“n trá»‘ng. Vui lÃ²ng chá»n má»™t tin nháº¯n khÃ¡c.');\r\n      // âœ… B6: Throw to trigger draft restoration in caller\r\n      throw new Error('Source content is empty');\r\n    }\r\n\r\n    // Set active source for UI indicator\r\n    setActiveSourceId(effectiveSourceId);\r\n    setTransformLoading(effectiveSourceId);\r\n\r\n    // âœ… STEP 5 (UX): Record length preference for soft memory\r\n    // Track when user explicitly requests length changes\r\n    if (action === 'EXPAND') {\r\n      recordLongerRequest();\r\n    } else if (action === 'SHORTEN') {\r\n      recordShorterRequest();\r\n    }\r\n\r\n    try {\r\n      // Get action label for user message\r\n      const actionLabel = getActionLabel(action);\r\n\r\n      // âœ… MODE-AWARE INSTRUCTION BUILDING\r\n      // PURE_TRANSFORM: Generic instruction based on action type\r\n      // DIRECTED_TRANSFORM: Use user's original instruction with directives preserved\r\n      let instruction: string;\r\n\r\n      if (transformMode === 'DIRECTED_TRANSFORM' && userInstruction) {\r\n        // User provided specific directives - use their exact instruction\r\n        // Example: \"viáº¿t láº¡i chuyÃªn nghiá»‡p hÆ¡n, dÃ nh cho GenZ\" â†’ keep full instruction\r\n        instruction = userInstruction;\r\n        console.log('[Transform] DIRECTED mode - using user instruction:', userInstruction.substring(0, 50));\r\n      } else {\r\n        // Pure transform - build generic instruction from action type\r\n        instruction = `${actionLabel} ná»™i dung nÃ y.`;\r\n        console.log('[Transform] PURE mode - using generic instruction:', instruction);\r\n      }\r\n\r\n      // Resolve template system prompt if available\r\n      const sourceMessage = messages.find(m => m.id === effectiveSourceId);\r\n      const templateId = sourceMessage?.meta?.templateId || selectedTemplateId;\r\n      let templateSystemPrompt: string | undefined;\r\n\r\n      if (templateId) {\r\n        try {\r\n          const manifest = resolveTemplateManifest(templateId);\r\n          if (manifest) {\r\n            templateSystemPrompt = buildSystemPrompt(manifest, {\r\n              toneReinforcement: selectedTone?.systemReinforcement,\r\n            });\r\n          }\r\n        } catch {\r\n          // Use default prompt if manifest not found\r\n        }\r\n      }\r\n\r\n      // Extract locked context from source\r\n      const lockedContext = extractLockedContext(sourceContent, effectiveSourceId);\r\n\r\n      // Determine lock mode based on whether validation is needed\r\n      const useValidation = shouldValidate(action);\r\n\r\n      // âœ… IMMUTABLE OUTPUT CONTRACT: Extract quantitative requirements from user instruction\r\n      const outputContract: TransformOutputContract = userInstruction\r\n        ? extractOutputContract(userInstruction, sourceContent)\r\n        : { requiredMinWords: null, requiredMaxWords: null, requiredStructure: [], requiredTone: null, derivedFrom: '', isStrict: false };\r\n\r\n      if (outputContract.isStrict) {\r\n        console.log('[Transform] Output contract extracted:', {\r\n          minWords: outputContract.requiredMinWords,\r\n          maxWords: outputContract.requiredMaxWords,\r\n          tone: outputContract.requiredTone,\r\n        });\r\n      }\r\n\r\n      // âœ… MODE-AWARE SYSTEM PROMPT\r\n      // PURE_TRANSFORM: Strong topic lock constraints\r\n      // DIRECTED_TRANSFORM: Lighter constraints, trust user's directive\r\n      const basePrompt = templateSystemPrompt || 'Báº¡n lÃ  trá»£ lÃ½ viáº¿t ná»™i dung chuyÃªn nghiá»‡p. HÃ£y hoÃ n thÃ nh yÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng.';\r\n\r\n      let constrainedPrompt: string;\r\n      if (transformMode === 'DIRECTED_TRANSFORM') {\r\n        // Lighter constraints for directed transforms\r\n        // User explicitly asked for changes, so allow more flexibility\r\n        constrainedPrompt = useValidation\r\n          ? injectConstraints(basePrompt, lockedContext, 'RELAXED') // Relaxed constraints\r\n          : basePrompt;\r\n      } else {\r\n        // Strong constraints for pure transforms\r\n        constrainedPrompt = useValidation\r\n          ? injectConstraints(basePrompt, lockedContext, 'NORMAL')\r\n          : basePrompt;\r\n      }\r\n\r\n      // âœ… Add contract instruction to system prompt if strict requirements exist\r\n      const contractInstruction = buildContractInstruction(outputContract);\r\n      if (contractInstruction) {\r\n        constrainedPrompt = constrainedPrompt + '\\n\\n' + contractInstruction;\r\n      }\r\n\r\n      // ============================================\r\n      // STEP 22: Detect REWRITE_UPGRADE for anchor injection\r\n      // ============================================\r\n      const taskDetectionCtx: TaskDetectionContext = {\r\n        hasActiveDraft: messages.some(m => m.role === 'assistant' && m.content.length > 100),\r\n        hasPreviousMessages: messages.length > 0,\r\n        lang: 'vi',\r\n      };\r\n      const taskDetection = detectTaskType(userInstruction || instruction, taskDetectionCtx);\r\n      const isRewriteUpgrade = taskDetection.taskType === 'REWRITE_UPGRADE';\r\n\r\n      // âœ… STEP 22: Inject anchors for REWRITE_UPGRADE mode\r\n      let anchorMeta: AnchoredContent | null = null;\r\n      let effectiveSourceReference: string;\r\n\r\n      if (isRewriteUpgrade && shouldApplyAnchors(sourceContent)) {\r\n        // Use anchored source reference for REWRITE_UPGRADE\r\n        anchorMeta = injectAnchors(sourceContent);\r\n        effectiveSourceReference = `\\n\\n---\\n**SOURCE CONTENT TO REWRITE (with paragraph anchors):**\\n\\`\\`\\`\\n${anchorMeta.anchoredText}\\n\\`\\`\\`\\n\\n**ANCHOR COUNT:** ${anchorMeta.paragraphCount} paragraphs (${anchorMeta.anchorIds.join(', ')})\\n---\\n`;\r\n        console.log('[Transform] REWRITE_UPGRADE with anchors:', {\r\n          paragraphCount: anchorMeta.paragraphCount,\r\n          anchors: anchorMeta.anchorIds,\r\n        });\r\n      } else {\r\n        // Standard source reference for other modes\r\n        effectiveSourceReference = buildSourceReference(sourceContent);\r\n      }\r\n\r\n      // Retry logic: NORMAL â†’ STRICT (with contract enforcement)\r\n      // Max 2 attempts for strict contracts\r\n      const maxAttempts = outputContract.isStrict ? 2 : 3;\r\n      let attemptCount = 0;\r\n      let success = false;\r\n      let lastContractValidation: ContractValidationResult | null = null;\r\n      let lastExecutionError: string | null = null; // Track last error for surfacing\r\n      let lastReasonCode: string | null = null; // Track reasonCode for user-facing messages\r\n      let lastAnchorError: string | null = null; // Track anchor validation errors\r\n      let lastDiffGuardError: string | null = null; // Track diff guard errors\r\n\r\n      while (attemptCount < maxAttempts && !success) {\r\n        attemptCount++;\r\n        const isRetry = attemptCount > 1;\r\n\r\n        // Build instruction with enforcement if retry\r\n        let modeInstruction = instruction;\r\n\r\n        if (isRetry && lastContractValidation && !lastContractValidation.passed) {\r\n          // âœ… Add enforcement instruction for retry\r\n          const enforcement = buildEnforcementInstruction(lastContractValidation.violations);\r\n          modeInstruction = enforcement + '\\n\\n' + instruction;\r\n          console.log('[Transform] Retry with enforcement:', lastContractValidation.violations.map(v => v.type));\r\n        } else if (isRetry) {\r\n          // Generic retry instruction (refusal or API error)\r\n          modeInstruction += '\\n\\nâš ï¸ QUAN TRá»ŒNG: Pháº£i giá»¯ nguyÃªn táº¥t cáº£ sá»‘ liá»‡u, tÃªn riÃªng, vÃ  thÃ´ng tin quan trá»ng.';\r\n        }\r\n\r\n        try {\r\n          // âœ… INVARIANT-SAFE: Build LLM request\r\n          // âœ… CRITICAL: Include full conversation history for context\r\n          const transformMessages: LLMRequest['messages'] = [\r\n            { role: 'system', content: constrainedPrompt },\r\n          ];\r\n\r\n          // Add all previous messages for context\r\n          for (const msg of messages) {\r\n            if (msg.role === 'user' || msg.role === 'assistant') {\r\n              transformMessages.push({\r\n                role: msg.role,\r\n                content: msg.content,\r\n              });\r\n            }\r\n          }\r\n\r\n          // Add current transform instruction as final user message\r\n          // âœ… STEP 22: Use effectiveSourceReference (anchored for REWRITE_UPGRADE)\r\n          transformMessages.push({\r\n            role: 'user',\r\n            content: modeInstruction + effectiveSourceReference,\r\n          });\r\n\r\n          // Compute final userPrompt for binding validation\r\n          const finalUserPrompt = modeInstruction + effectiveSourceReference;\r\n          // âœ… CRITICAL FIX: Trim to match executor normalization (llmExecutor.ts:281)\r\n          const trimmedUserPrompt = finalUserPrompt.trim();\r\n\r\n          const transformRequest: LLMRequest = {\r\n            messages: transformMessages,\r\n            userPrompt: trimmedUserPrompt, // Explicit userPrompt (trimmed for consistency)\r\n            meta: {\r\n              templateId,\r\n              mode: 'execute',\r\n              // âœ… STEP 18: Use uiFinalPromptHash for enriched transform prompts (TRIMMED)\r\n              uiFinalPromptHash: safeHash(trimmedUserPrompt),\r\n              uiFinalPromptLength: trimmedUserPrompt.length,\r\n            },\r\n            // âœ… STEP 21: Inject edit patch metadata if set\r\n            // This enables partial edits without requiring full structure\r\n            editPatch: pendingEditPatchMeta || undefined,\r\n            // âœ… STEP 22: Inject output contract if set\r\n            // This enforces [PATCH] block format for patch-only edits\r\n            outputContract: pendingOutputContract || undefined,\r\n            // âœ… STEP 22: Answer Engine context\r\n            // Enables QA vs EDIT_PATCH vs CREATE mode detection\r\n            answerEngineContext: {\r\n              hasActiveDraft: messages.some(m => m.role === 'assistant' && m.content.length > 100),\r\n              hasPreviousMessages: messages.length > 0,\r\n              lang: 'vi',\r\n            },\r\n          };\r\n\r\n          // âœ… INVARIANT-SAFE: Execute through authorized LLM executor\r\n          const executionResult = await executeLLM(authToken, transformRequest);\r\n\r\n          if (!executionResult.success || !executionResult.response) {\r\n            // Capture error for surfacing\r\n            lastExecutionError = executionResult.error || 'Unknown execution error';\r\n            lastReasonCode = executionResult.debugInfo?.reasonCode || null;\r\n            console.error('[Transform] API error on attempt', attemptCount, ':', {\r\n              error: executionResult.error,\r\n              reasonCode: executionResult.debugInfo?.reasonCode,\r\n              eventId: executionResult.debugInfo?.eventId,\r\n            });\r\n            continue; // Try next attempt\r\n          }\r\n\r\n          const output = executionResult.response.content;\r\n\r\n          // Check for refusal\r\n          if (isRefusal(output)) {\r\n            console.log(`[Transform] Refusal detected on attempt ${attemptCount}, retrying...`);\r\n            continue; // Try next attempt\r\n          }\r\n\r\n          // âœ… IMMUTABLE CONTRACT VALIDATION\r\n          if (outputContract.isStrict) {\r\n            const contractValidation = validateOutputContract(output, outputContract);\r\n            lastContractValidation = contractValidation;\r\n\r\n            if (!contractValidation.passed) {\r\n              console.log(`[Transform] Contract validation FAILED on attempt ${attemptCount}:`, {\r\n                wordCount: contractValidation.wordCount,\r\n                violations: contractValidation.violations,\r\n              });\r\n              continue; // Try next attempt with enforcement\r\n            }\r\n\r\n            console.log(`[Transform] Contract validation PASSED:`, {\r\n              wordCount: contractValidation.wordCount,\r\n              required: { min: outputContract.requiredMinWords, max: outputContract.requiredMaxWords },\r\n            });\r\n          }\r\n\r\n          // âœ… STEP 22: ANCHOR VALIDATION for REWRITE_UPGRADE\r\n          // Reject output if anchor structure is violated\r\n          if (anchorMeta) {\r\n            const anchorValidation = validateAnchors(output, anchorMeta.anchorIds);\r\n\r\n            if (!anchorValidation.valid) {\r\n              lastAnchorError = anchorValidation.error || 'Anchor structure violation';\r\n              console.log(`[Transform] Anchor validation FAILED on attempt ${attemptCount}:`, {\r\n                expected: anchorValidation.expected,\r\n                found: anchorValidation.found,\r\n                missing: anchorValidation.missing,\r\n                extra: anchorValidation.extra,\r\n                orderPreserved: anchorValidation.orderPreserved,\r\n                error: anchorValidation.error,\r\n              });\r\n              continue; // Try next attempt - NO silent fallback\r\n            }\r\n\r\n            console.log(`[Transform] Anchor validation PASSED:`, {\r\n              anchorCount: anchorMeta.paragraphCount,\r\n              orderPreserved: anchorValidation.orderPreserved,\r\n            });\r\n\r\n            // âœ… STEP 22: DIFF GUARD for conservative rewrite limits\r\n            // Applied AFTER anchor validation, ONLY for REWRITE_UPGRADE\r\n            const diffResult = validateRewriteDiff(anchorMeta.anchoredText, output);\r\n\r\n            if (!diffResult.ok) {\r\n              lastDiffGuardError = getDiffGuardErrorMessage(diffResult, 'vi');\r\n              console.log(`[Transform] Diff guard FAILED on attempt ${attemptCount}:`, {\r\n                reason: diffResult.reason,\r\n                details: diffResult.details,\r\n                paragraphAnalysis: diffResult.paragraphAnalysis.map(p => ({\r\n                  anchor: p.anchorId,\r\n                  passed: p.passed,\r\n                  failReason: p.failReason,\r\n                })),\r\n              });\r\n              continue; // Try next attempt - NO silent fallback\r\n            }\r\n\r\n            console.log(`[Transform] Diff guard PASSED:`, {\r\n              paragraphCount: diffResult.paragraphAnalysis.length,\r\n              allPassed: diffResult.paragraphAnalysis.every(p => p.passed),\r\n            });\r\n          }\r\n\r\n          // Success!\r\n          success = true;\r\n\r\n          // âœ… STEP 22: Strip anchors from output for display\r\n          // Anchors are for validation only, not for user-facing content\r\n          const cleanOutput = anchorMeta ? stripAnchors(output) : output;\r\n\r\n          // Generate requestId for this transform\r\n          const requestId = generateRequestId();\r\n\r\n          // âœ… B4: Compute transform chain tracking\r\n          // If source has originMessageId, use it; otherwise, source IS the origin\r\n          const originMessageId = sourceMessage?.meta?.originMessageId || effectiveSourceId;\r\n          // If source has transformDepth, increment; otherwise this is depth 1\r\n          const transformDepth = (sourceMessage?.meta?.transformDepth || 0) + 1;\r\n\r\n          // ============================================\r\n          // CONCEPTUAL INVARIANT: userTypedText === displayed text\r\n          // ============================================\r\n          // USER MESSAGE â‰  ACTION\r\n          // - If user typed instruction â†’ userTypedText = instruction\r\n          // - If user clicked button â†’ userTypedText = actionLabel (what they chose)\r\n          // Both are valid \"user expressions\" - one via keyboard, one via button.\r\n          const userTypedText = userInstruction?.trim() || actionLabel;\r\n\r\n          const userMsg: ChatMessage = {\r\n            id: `user-${Date.now()}`,\r\n            role: 'user',\r\n            content: userTypedText, // Content = what user expressed\r\n            timestamp: new Date(),\r\n            meta: {\r\n              requestId,\r\n              templateId: templateId ?? undefined,\r\n              actionType: action,\r\n              sourceMessageId: effectiveSourceId,\r\n              // âœ… MANDATORY: userTypedText is ALWAYS populated\r\n              userTypedText, // This is THE source of truth for display\r\n              // Internal fields (NOT for display):\r\n              transformMode,\r\n              actionLabel,\r\n            },\r\n          };\r\n\r\n          // âœ… Diff & Apply: Extract sections for apply functionality\r\n          // Use cleanOutput (anchors stripped) for display and diff\r\n          const beforeSectionsRaw = extractSections(sourceContent);\r\n          const afterSectionsRaw = extractSections(cleanOutput);\r\n\r\n          // Add AI response with chain tracking and diff/apply metadata\r\n          const assistantMsg: ChatMessage = {\r\n            id: `assistant-${Date.now()}`,\r\n            role: 'assistant',\r\n            content: cleanOutput, // âœ… STEP 22: Use anchor-stripped output\r\n            timestamp: new Date(),\r\n            meta: {\r\n              requestId,\r\n              templateId: templateId ?? undefined,\r\n              actionType: action,\r\n              sourceMessageId: effectiveSourceId,\r\n              lockedContext: useValidation ? lockedContext : undefined,\r\n              originMessageId,      // âœ… B4: Track chain origin\r\n              transformDepth,       // âœ… B4: Track depth in chain\r\n              // âœ… Diff & Apply: Store before/after for section-level apply\r\n              diffApply: {\r\n                applyTargetMessageId: effectiveSourceId,\r\n                beforeText: sourceContent,\r\n                afterText: cleanOutput, // âœ… STEP 22: Use anchor-stripped output\r\n                beforeSections: {\r\n                  hook: beforeSectionsRaw.hook ?? undefined,\r\n                  body: beforeSectionsRaw.body ?? undefined,\r\n                  cta: beforeSectionsRaw.cta ?? undefined,\r\n                  hashtags: beforeSectionsRaw.hashtags ?? undefined,\r\n                },\r\n                afterSections: {\r\n                  hook: afterSectionsRaw.hook ?? undefined,\r\n                  body: afterSectionsRaw.body ?? undefined,\r\n                  cta: afterSectionsRaw.cta ?? undefined,\r\n                  hashtags: afterSectionsRaw.hashtags ?? undefined,\r\n                },\r\n                applyState: 'idle',\r\n              },\r\n            },\r\n          };\r\n\r\n          setMessages(prev => [...prev, userMsg, assistantMsg]);\r\n\r\n          console.log('[Transform] Success:', {\r\n            action,\r\n            sourceMessageId: effectiveSourceId,\r\n            outputLength: cleanOutput.length,\r\n            attemptCount,\r\n            contractPassed: lastContractValidation?.passed ?? 'N/A',\r\n            anchorsStripped: anchorMeta ? true : false,\r\n          });\r\n\r\n          break; // Exit retry loop\r\n\r\n        } catch (error) {\r\n          console.error(`[Transform] API error on attempt ${attemptCount}:`, error);\r\n          // Continue to next attempt\r\n        }\r\n      }\r\n\r\n      // All retries failed\r\n      if (!success) {\r\n        // âœ… STRICT CONTRACT FAILURE: Do NOT fallback, show system error\r\n        if (outputContract.isStrict && lastContractValidation && !lastContractValidation.passed) {\r\n          const violation = lastContractValidation.violations[0];\r\n          const errorMsg = violation\r\n            ? `KhÃ´ng thá»ƒ táº¡o ná»™i dung Ä‘Ãºng yÃªu cáº§u (${violation.expected}, thá»±c táº¿: ${violation.actual}). Vui lÃ²ng thá»­ láº¡i.`\r\n            : 'KhÃ´ng thá»ƒ táº¡o ná»™i dung Ä‘Ãºng yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i.';\r\n          setAiError(errorMsg);\r\n          console.log('[Transform] Contract validation failed after all retries - NO FALLBACK');\r\n          throw new Error('Contract validation failed');\r\n        }\r\n\r\n        // âœ… STEP 22: ANCHOR VALIDATION FAILURE: Do NOT fallback, show system error\r\n        if (lastAnchorError) {\r\n          const errorMsg = `KhÃ´ng thá»ƒ viáº¿t láº¡i ná»™i dung Ä‘Ãºng cáº¥u trÃºc (${lastAnchorError}). Vui lÃ²ng thá»­ láº¡i.`;\r\n          setAiError(errorMsg);\r\n          console.log('[Transform] Anchor validation failed after all retries - NO FALLBACK');\r\n          throw new Error('Anchor validation failed');\r\n        }\r\n\r\n        // âœ… STEP 22: DIFF GUARD FAILURE: Do NOT fallback, show system error\r\n        if (lastDiffGuardError) {\r\n          const errorMsg = `KhÃ´ng thá»ƒ viáº¿t láº¡i ná»™i dung (${lastDiffGuardError}). Vui lÃ²ng thá»­ láº¡i.`;\r\n          setAiError(errorMsg);\r\n          console.log('[Transform] Diff guard failed after all retries - NO FALLBACK');\r\n          throw new Error('Diff guard failed');\r\n        }\r\n\r\n        console.log('[Transform] All retries failed, using fallback transform');\r\n\r\n        // Special case: TRANSLATE cannot be done without AI - show system warning\r\n        if (action === 'TRANSLATE') {\r\n          const errorMsg = getUserFacingAiError({\r\n            lang: 'vi',\r\n            reasonCode: lastReasonCode,\r\n            fallback: `KhÃ´ng thá»ƒ dá»‹ch tá»± Ä‘á»™ng. Vui lÃ²ng thá»­ láº¡i sau hoáº·c dá»‹ch thá»§ cÃ´ng.`,\r\n          });\r\n          setAiError(errorMsg);\r\n          console.log('[Transform] TRANSLATE failed - showing system warning instead of fallback');\r\n          // âœ… B6: Throw to trigger draft restoration\r\n          throw new Error(lastExecutionError || 'Translation requires AI');\r\n        }\r\n\r\n        // Special case: DIRECTED_TRANSFORM cannot be done with rule-based fallback\r\n        // User's directives require AI understanding\r\n        if (transformMode === 'DIRECTED_TRANSFORM') {\r\n          const errorMsg = getUserFacingAiError({\r\n            lang: 'vi',\r\n            reasonCode: lastReasonCode,\r\n            fallback: `KhÃ´ng thá»ƒ Ã¡p dá»¥ng chá»‰ dáº«n cá»§a báº¡n. Vui lÃ²ng thá»­ láº¡i hoáº·c Ä‘Æ¡n giáº£n hÃ³a yÃªu cáº§u.`,\r\n          });\r\n          setAiError(errorMsg);\r\n          console.log('[Transform] DIRECTED_TRANSFORM failed - directives require AI');\r\n          // âœ… B6: Throw to trigger draft restoration\r\n          throw new Error(lastExecutionError || 'Directed transform requires AI');\r\n        }\r\n\r\n        const fallbackOutput = applyFallbackTransform(action, sourceContent);\r\n\r\n        // Safety check: ensure fallback is not a refusal either\r\n        if (isRefusal(fallbackOutput)) {\r\n          setAiError(`${actionLabel} tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.`);\r\n          console.log('[Transform] Fallback also produced refusal - showing error');\r\n          // âœ… B6: Throw to trigger draft restoration\r\n          throw new Error('Fallback produced refusal');\r\n        }\r\n\r\n        // Generate requestId for fallback\r\n        const requestId = generateRequestId();\r\n\r\n        // âœ… B4: Compute transform chain tracking for fallback\r\n        const originMessageId = sourceMessage?.meta?.originMessageId || effectiveSourceId;\r\n        const transformDepth = (sourceMessage?.meta?.transformDepth || 0) + 1;\r\n\r\n        // ============================================\r\n        // CONCEPTUAL INVARIANT: userTypedText === displayed text\r\n        // ============================================\r\n        // This fallback path only runs for PURE_TRANSFORM (button clicks)\r\n        // User clicked a button â†’ userTypedText = actionLabel (what they chose)\r\n        const userTypedText = userInstruction?.trim() || actionLabel;\r\n\r\n        const userMsg: ChatMessage = {\r\n          id: `user-${Date.now()}`,\r\n          role: 'user',\r\n          content: userTypedText, // Content = what user expressed\r\n          timestamp: new Date(),\r\n          meta: {\r\n            requestId,\r\n            templateId: templateId ?? undefined,\r\n            actionType: action,\r\n            sourceMessageId: effectiveSourceId,\r\n            // âœ… MANDATORY: userTypedText is ALWAYS populated\r\n            userTypedText, // This is THE source of truth for display\r\n            // Internal fields (NOT for display):\r\n            transformMode: 'PURE_TRANSFORM',\r\n            actionLabel,\r\n          },\r\n        };\r\n\r\n        // âœ… Diff & Apply: Extract sections for fallback apply functionality\r\n        const beforeSectionsFallback = extractSections(sourceContent);\r\n        const afterSectionsFallback = extractSections(fallbackOutput);\r\n\r\n        // Add fallback response with chain tracking and diff/apply metadata\r\n        const assistantMsg: ChatMessage = {\r\n          id: `assistant-${Date.now()}`,\r\n          role: 'assistant',\r\n          content: fallbackOutput,\r\n          timestamp: new Date(),\r\n          meta: {\r\n            requestId,\r\n            templateId: templateId ?? undefined,\r\n            actionType: action,\r\n            sourceMessageId: effectiveSourceId,\r\n            isFallback: true, // Mark as fallback for potential UI indicator\r\n            originMessageId,      // âœ… B4: Track chain origin\r\n            transformDepth,       // âœ… B4: Track depth in chain\r\n            // âœ… Diff & Apply: Store before/after for section-level apply\r\n            diffApply: {\r\n              applyTargetMessageId: effectiveSourceId,\r\n              beforeText: sourceContent,\r\n              afterText: fallbackOutput,\r\n              beforeSections: {\r\n                hook: beforeSectionsFallback.hook ?? undefined,\r\n                body: beforeSectionsFallback.body ?? undefined,\r\n                cta: beforeSectionsFallback.cta ?? undefined,\r\n                hashtags: beforeSectionsFallback.hashtags ?? undefined,\r\n              },\r\n              afterSections: {\r\n                hook: afterSectionsFallback.hook ?? undefined,\r\n                body: afterSectionsFallback.body ?? undefined,\r\n                cta: afterSectionsFallback.cta ?? undefined,\r\n                hashtags: afterSectionsFallback.hashtags ?? undefined,\r\n              },\r\n              applyState: 'idle',\r\n            },\r\n          },\r\n        };\r\n\r\n        setMessages(prev => [...prev, userMsg, assistantMsg]);\r\n\r\n        console.log('[Transform] Used fallback transform:', {\r\n          action,\r\n          sourceMessageId: effectiveSourceId,\r\n          outputLength: fallbackOutput.length,\r\n        });\r\n      }\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Transform failed';\r\n      console.error('[Transform] Failed:', errorMessage);\r\n      setAiError(`${getActionLabel(action)} tháº¥t báº¡i: ${errorMessage}`);\r\n      // âœ… B6: Re-throw so caller can restore draft\r\n      throw error;\r\n    } finally {\r\n      setTransformLoading(null);\r\n      // Keep source selected for potential follow-up transforms\r\n    }\r\n  }, [messages, selectedTemplateId, selectedTone, getLastValidAssistantMessage]);\r\n\r\n  // ============================================\r\n  // INVARIANT-SAFE EXECUTION DISPATCHER\r\n  // ============================================\r\n  // This is the ONLY function that can trigger AI logic.\r\n  // ExecutionGate is checked FIRST, before ANY intent detection,\r\n  // routing, state mutation, or execution.\r\n  //\r\n  // HARD INVARIANT: If gate blocks, NOTHING happens.\r\n  // ============================================\r\n\r\n  /**\r\n   * dispatchExecution - Single entry point to ALL AI logic\r\n   *\r\n   * INVARIANTS ENFORCED:\r\n   * 1. Gate check happens FIRST (before any intent detection)\r\n   * 2. If gate blocks â†’ immediate return, zero side effects\r\n   * 3. Intent detection only runs AFTER gate approval\r\n   * 4. State mutations only happen AFTER successful execution\r\n   */\r\n  const dispatchExecution = useCallback(async (params: {\r\n    userActionType: UserActionType;\r\n    inputText: string;\r\n    eventId: string;\r\n    timestamp: number;\r\n    uiSourceMessageId?: string | null;  // âœ… STEP 6: UI BINDING - user clicked message + typed follow-up\r\n    // âœ… STEP 18: Request binding metadata for single source of truth\r\n    uiInputHash?: string;\r\n    uiInputLength?: number;\r\n    uiSendAt?: number;\r\n  }) => {\r\n    const { userActionType, inputText, eventId, timestamp, uiSourceMessageId, uiInputHash, uiInputLength, uiSendAt } = params;\r\n\r\n    // ============================================\r\n    // GATE CHECK - MUST BE FIRST\r\n    // ============================================\r\n    // NO intent detection, NO state mutation, NO routing before this point\r\n    const authToken = createAuthorizationToken({\r\n      userActionType,\r\n      eventId,\r\n      actionTimestamp: timestamp,\r\n      hasValidInput: !!inputText.trim(),\r\n      callerLocation: 'dispatchExecution',\r\n    });\r\n\r\n    if (!authToken) {\r\n      // GATE BLOCKED - Return immediately, do NOTHING\r\n      console.warn('[dispatchExecution] BLOCKED by ExecutionGate - no execution');\r\n      return { success: false, reason: 'GATE_BLOCKED' };\r\n    }\r\n\r\n    // ============================================\r\n    // GATE PASSED - Now we can do intent detection and routing\r\n    // ============================================\r\n    console.log('[dispatchExecution] GATE PASSED - proceeding with execution', { eventId });\r\n\r\n    // Save input for error recovery\r\n    const savedInput = inputText;\r\n\r\n    try {\r\n      // âœ… STEP 1: Check for explicit NEW-CREATE signals (after gate!)\r\n      const isExplicitNewCreate = detectNewCreate(inputText);\r\n\r\n      if (isExplicitNewCreate) {\r\n        console.log('[dispatchExecution] Explicit NEW-CREATE signal detected');\r\n      }\r\n\r\n      // âœ… STEP 2: Classify user intent (after gate!)\r\n      const classification = classifyAction(inputText);\r\n\r\n      console.log('[dispatchExecution] Action classification:', {\r\n        type: classification.type,\r\n        category: classification.category,\r\n        confidence: classification.confidence,\r\n        signals: classification.signals,\r\n        lastIntentType,\r\n        isExplicitNewCreate,\r\n      });\r\n\r\n      // âœ… STEP 3: Determine routing\r\n      const STRONG_TRANSFORM_VERBS = [\r\n        /^(viáº¿t\\s+láº¡i|rewrite)/i,\r\n        /^(rÃºt\\s*gá»n|shorten|ngáº¯n\\s+láº¡i)/i,\r\n        /^(tá»‘i\\s*Æ°u|optimize|cáº£i\\s*thiá»‡n)/i,\r\n        /^(Ä‘á»•i\\s*giá»ng|change\\s*tone)/i,\r\n        /^(má»Ÿ\\s*rá»™ng|expand)/i,\r\n        /^(dá»‹ch|translate)/i,\r\n        /^(Ä‘á»•i\\s*format|convert)/i,\r\n      ];\r\n\r\n      const hasStrongVerb = STRONG_TRANSFORM_VERBS.some(p => p.test(inputText.trim()));\r\n      const hasValidSource = getLastValidAssistantMessage() !== null;\r\n      const isClassifierConfident = classification.confidence >= 0.7;\r\n      const isClassifierUncertain = classification.confidence < 0.7 && classification.confidence >= 0.45;\r\n\r\n      // ============================================\r\n      // âœ… STEP 5: EXECUTION CONTRACT ENFORCEMENT\r\n      // ============================================\r\n      // Use resolveExecutionSource for strict priority-based resolution.\r\n      // This ensures intent â†’ execution consistency.\r\n      //\r\n      // PRIORITY ORDER (highest to lowest):\r\n      // 1. IntentSnapshot.sourceMessageId (if exists) - BINDING\r\n      // 2. activeSourceId (UI-selected source) - user explicitly chose\r\n      // 3. lastTransformSourceId (intent memory) - chain lock\r\n      // 4. getLastValidAssistantMessage() - fallback\r\n      // ============================================\r\n\r\n      // ============================================\r\n      // âœ… STEP 6: UI BINDING takes HIGHEST priority\r\n      // ============================================\r\n      // Resolve source using execution contract (before we have intent snapshot)\r\n      // We'll validate contract AFTER creating the snapshot\r\n      const preliminarySourceResult = resolveExecutionSource({\r\n        intentSnapshot: null, // Will validate after snapshot creation\r\n        uiSourceMessageId,    // âœ… STEP 6: UI BINDING (highest priority)\r\n        activeSourceId,\r\n        lastTransformSourceId: lastIntentType === 'TRANSFORM' ? lastTransformSourceId : null,\r\n        messages,\r\n        getLastValidAssistantMessage,\r\n      });\r\n\r\n      // âœ… STEP 6: Log UI binding resolution\r\n      if (uiSourceMessageId && preliminarySourceResult.resolution === 'UI_BINDING') {\r\n        console.log('[dispatchExecution] UI BINDING active:', {\r\n          uiSourceMessageId,\r\n          resolvedSourceId: preliminarySourceResult.sourceId,\r\n        });\r\n      }\r\n\r\n      let forcedSourceId = preliminarySourceResult.sourceId;\r\n\r\n      console.log('[dispatchExecution] Source resolution:', {\r\n        sourceId: forcedSourceId,\r\n        resolution: preliminarySourceResult.resolution,\r\n        matchesIntent: preliminarySourceResult.matchesIntent,\r\n      });\r\n\r\n      // âœ… GAP B: TOPIC DRIFT AUTO BREAK\r\n      let isTopicDrift = false;\r\n      if (lastIntentType === 'TRANSFORM' && forcedSourceId && !isExplicitNewCreate) {\r\n        const sourceContent = getMessageContent(forcedSourceId, messages);\r\n        if (sourceContent) {\r\n          isTopicDrift = detectTopicDrift(inputText, sourceContent);\r\n          if (isTopicDrift) {\r\n            console.log('[dispatchExecution] GAP B: Topic drift detected');\r\n            forcedSourceId = null;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Determine routing\r\n      let shouldRouteToTransform = false;\r\n\r\n      if (isExplicitNewCreate || isTopicDrift) {\r\n        shouldRouteToTransform = false;\r\n      } else if (classification.category === 'transform' && isClassifierConfident && hasValidSource) {\r\n        shouldRouteToTransform = true;\r\n      } else if (hasStrongVerb && classification.confidence >= 0.45 && hasValidSource) {\r\n        shouldRouteToTransform = true;\r\n      } else if (isClassifierUncertain && lastIntentType === 'TRANSFORM' && hasValidSource) {\r\n        console.log('[dispatchExecution] Using intent memory: defaulting to TRANSFORM');\r\n        shouldRouteToTransform = true;\r\n      }\r\n\r\n      // ============================================\r\n      // EXECUTE (after gate approval)\r\n      // ============================================\r\n\r\n      if (shouldRouteToTransform) {\r\n        // TRANSFORM PATH\r\n        const transformMode = classification.transformMode || detectTransformMode(inputText);\r\n        const actionLabel = getActionLabel(classification.type as ActionType);\r\n\r\n        console.log('[dispatchExecution] Executing TRANSFORM:', {\r\n          type: classification.type,\r\n          transformMode,\r\n          forcedSourceId,\r\n        });\r\n\r\n        // âœ… STEP 5: Use execution contract for source resolution\r\n        // This ensures consistent source resolution across the pipeline\r\n        let effectiveSourceForMemory = forcedSourceId;\r\n        if (!effectiveSourceForMemory) {\r\n          const lastValid = getLastValidAssistantMessage();\r\n          effectiveSourceForMemory = lastValid?.id || null;\r\n        }\r\n\r\n        // âœ… STEP 5: Use getOriginForChain for consistent origin tracking\r\n        // This replaces manual origin lookup with contract-enforced resolution\r\n        const originToTrack = getOriginForChain(effectiveSourceForMemory, messages);\r\n\r\n        if (originToTrack !== effectiveSourceForMemory) {\r\n          console.log('[dispatchExecution] Using origin from chain:', originToTrack);\r\n        }\r\n\r\n        // ============================================\r\n        // âœ… OPTIMISTIC RENDERING: Show user message IMMEDIATELY\r\n        // ============================================\r\n        const optimisticUserMsgId = `user-${Date.now()}`;\r\n        const requestId = generateRequestId();\r\n\r\n        // ============================================\r\n        // CONCEPTUAL INVARIANT: userTypedText === displayed text\r\n        // ============================================\r\n        // USER MESSAGE â‰  ACTION\r\n        // - userTypedText: ALWAYS what the user expressed (MANDATORY)\r\n        // - actionLabel: Internal only (for routing, badges, NOT display)\r\n        //\r\n        // What user expressed:\r\n        // - If they typed \"viáº¿t láº¡i giá»ng tá»± nhiÃªn\" â†’ that's their userTypedText\r\n        // - If they typed just \"viáº¿t láº¡i\" â†’ that's their userTypedText\r\n        // - The inputText IS what the user typed. Period.\r\n        // ============================================\r\n        const userTypedText = inputText.trim();\r\n\r\n        // ============================================\r\n        // âœ… STEP 3: Create Intent Snapshot (OBSERVABILITY ONLY)\r\n        // ============================================\r\n        // Snapshot is READ-ONLY and NEVER affects execution.\r\n        // Used for debugging and regression detection.\r\n        const turnIndex = messages.filter(m => m.role === 'user').length;\r\n        const sourceMsg = effectiveSourceForMemory\r\n          ? messages.find(m => m.id === effectiveSourceForMemory)\r\n          : null;\r\n        const previousSnapshot = sourceMsg ? getMessageSnapshot(sourceMsg) : null;\r\n\r\n        const intentSnapshot = createTransformSnapshot({\r\n          userTypedText,\r\n          transformMode,\r\n          actionType: classification.type,\r\n          sourceMessageId: effectiveSourceForMemory || '',\r\n          turnIndex,\r\n          previousSnapshot: previousSnapshot ?? undefined,\r\n        });\r\n\r\n        // DEV-ONLY: Validate snapshot and execution contract\r\n        if (process.env.NODE_ENV === 'development') {\r\n          const snapshotValidation = validateSnapshot(intentSnapshot);\r\n          console.log('[dispatchExecution] Intent Snapshot (TRANSFORM):', {\r\n            snapshotId: intentSnapshot.snapshotId,\r\n            mode: intentSnapshot.detectedMode,\r\n            actions: intentSnapshot.detectedActions,\r\n            valid: snapshotValidation.valid,\r\n          });\r\n\r\n          // âœ… STEP 5: Validate execution contract\r\n          const contractValidation = validateExecutionContract(intentSnapshot, {\r\n            sourceId: effectiveSourceForMemory,\r\n            resolution: preliminarySourceResult.resolution,\r\n            matchesIntent: intentSnapshot.sourceMessageId === effectiveSourceForMemory,\r\n          });\r\n\r\n          if (!contractValidation.valid) {\r\n            console.warn('[dispatchExecution] Execution contract violations:', {\r\n              violations: contractValidation.violations,\r\n              snapshotSource: intentSnapshot.sourceMessageId,\r\n              effectiveSource: effectiveSourceForMemory,\r\n            });\r\n          }\r\n\r\n          // âœ… STEP 5: Check for source drift\r\n          warnIfExecutionSourceDrifts(intentSnapshot, effectiveSourceForMemory, 'dispatchExecution:TRANSFORM');\r\n          warnIfModeMismatch(intentSnapshot, true, 'dispatchExecution:TRANSFORM');\r\n        }\r\n\r\n        console.log('[dispatchExecution] User message (TRANSFORM):', {\r\n          userTypedText: userTypedText.substring(0, 50),\r\n          actionLabel, // Internal only\r\n          transformMode, // Internal routing only\r\n        });\r\n\r\n        const optimisticUserMsg: ChatMessage = {\r\n          id: optimisticUserMsgId,\r\n          role: 'user',\r\n          content: userTypedText, // Content = what user typed\r\n          timestamp: new Date(),\r\n          meta: {\r\n            requestId,\r\n            status: 'pending', // Will be updated to 'done' when assistant responds\r\n            // âœ… MANDATORY: userTypedText is ALWAYS populated\r\n            userTypedText, // This is THE source of truth for display\r\n            // Internal fields (NOT for display):\r\n            transformMode,\r\n            actionLabel,\r\n            sourceMessageId: effectiveSourceForMemory || undefined,\r\n            actionType: classification.type as ActionType,\r\n            // âœ… STEP 3: Attach intent snapshot (OBSERVABILITY ONLY)\r\n            intentSnapshot,\r\n          },\r\n        };\r\n\r\n        // Append user message IMMEDIATELY (before LLM call)\r\n        setMessages(prev => [...prev, optimisticUserMsg]);\r\n\r\n        // Clear input IMMEDIATELY for responsive UX\r\n        setChatInput('');\r\n\r\n        try {\r\n          // Execute transform (gate already passed, token already obtained)\r\n          // Pass the optimistic user message ID so it doesn't create a duplicate\r\n          // userTypedText is ALWAYS passed - it's what the user expressed\r\n          await executeTransformWithToken(\r\n            authToken,\r\n            classification.type as ActionType,\r\n            forcedSourceId || undefined,\r\n            transformMode,\r\n            userTypedText, // ALWAYS pass user's full text\r\n            optimisticUserMsgId, // âœ… Pass existing user message ID\r\n            requestId, // âœ… Pass request ID for linking\r\n            // âœ… STEP 18: Pass request binding metadata\r\n            { uiInputHash, uiInputLength, uiSendAt, eventId }\r\n          );\r\n\r\n          // âœ… Update user message status to 'done' on success\r\n          setMessages(prev => prev.map(m =>\r\n            m.id === optimisticUserMsgId\r\n              ? { ...m, meta: { ...m.meta, status: 'done' as const } }\r\n              : m\r\n          ));\r\n\r\n        } catch (error) {\r\n          // âœ… Update user message status to 'error' on failure\r\n          setMessages(prev => prev.map(m =>\r\n            m.id === optimisticUserMsgId\r\n              ? { ...m, meta: { ...m.meta, status: 'error' as const } }\r\n              : m\r\n          ));\r\n          throw error; // Re-throw to be caught by outer catch\r\n        }\r\n\r\n        // âœ… CRITICAL FIX: Update intent memory to track ORIGIN, not the new result\r\n        // This prevents subsequent transforms from using wrong context\r\n        setLastIntentType('TRANSFORM');\r\n        setLastTransformSourceId(originToTrack);\r\n\r\n        console.log('[dispatchExecution] Intent memory updated:', {\r\n          lastIntentType: 'TRANSFORM',\r\n          lastTransformSourceId: originToTrack,\r\n          wasChainedFromOrigin: originToTrack !== effectiveSourceForMemory,\r\n        });\r\n\r\n        // Reset topic drift state if needed\r\n        if (isExplicitNewCreate || isTopicDrift) {\r\n          setLastIntentType('CREATE');\r\n          setLastTransformSourceId(null);\r\n        }\r\n\r\n        return { success: true };\r\n\r\n      } else {\r\n        // CREATE PATH\r\n        const effectiveTemplateId = resolveEffectiveTemplateId(selectedTemplateId, inputText);\r\n\r\n        console.log('[dispatchExecution] Executing CREATE:', {\r\n          templateId: effectiveTemplateId,\r\n        });\r\n\r\n        // ============================================\r\n        // âœ… OPTIMISTIC RENDERING: Show user message IMMEDIATELY\r\n        // ============================================\r\n        const optimisticUserMsgId = `user-${Date.now()}`;\r\n        const requestId = generateRequestId();\r\n\r\n        // ============================================\r\n        // CONCEPTUAL INVARIANT: userTypedText === displayed text\r\n        // ============================================\r\n        const userTypedText = inputText.trim();\r\n\r\n        // ============================================\r\n        // âœ… STEP 3: Create Intent Snapshot (OBSERVABILITY ONLY)\r\n        // ============================================\r\n        // Snapshot is READ-ONLY and NEVER affects execution.\r\n        // Used for debugging and regression detection.\r\n        const turnIndex = messages.filter(m => m.role === 'user').length;\r\n\r\n        const intentSnapshot = createCreateSnapshot({\r\n          userTypedText,\r\n          turnIndex,\r\n        });\r\n\r\n        // DEV-ONLY: Validate snapshot and execution contract\r\n        if (process.env.NODE_ENV === 'development') {\r\n          const snapshotValidation = validateSnapshot(intentSnapshot);\r\n          console.log('[dispatchExecution] Intent Snapshot (CREATE):', {\r\n            snapshotId: intentSnapshot.snapshotId,\r\n            mode: intentSnapshot.detectedMode,\r\n            valid: snapshotValidation.valid,\r\n          });\r\n\r\n          // âœ… STEP 5: Validate execution contract for CREATE\r\n          const contractValidation = validateExecutionContract(intentSnapshot, {\r\n            sourceId: null, // CREATE has no source\r\n            resolution: 'NONE',\r\n            matchesIntent: true,\r\n          });\r\n\r\n          if (!contractValidation.valid) {\r\n            console.warn('[dispatchExecution] Execution contract violations (CREATE):', {\r\n              violations: contractValidation.violations,\r\n            });\r\n          }\r\n\r\n          // âœ… STEP 5: Check for mode mismatch\r\n          warnIfModeMismatch(intentSnapshot, false, 'dispatchExecution:CREATE');\r\n        }\r\n\r\n        const optimisticUserMsg: ChatMessage = {\r\n          id: optimisticUserMsgId,\r\n          role: 'user',\r\n          content: userTypedText, // Content = what user typed\r\n          timestamp: new Date(),\r\n          meta: {\r\n            requestId,\r\n            status: 'pending',\r\n            templateId: effectiveTemplateId,\r\n            // âœ… MANDATORY: userTypedText is ALWAYS populated\r\n            userTypedText, // This is THE source of truth for display\r\n            // âœ… STEP 3: Attach intent snapshot (OBSERVABILITY ONLY)\r\n            intentSnapshot,\r\n          },\r\n        };\r\n\r\n        // Append user message IMMEDIATELY (before LLM call)\r\n        setMessages(prev => [...prev, optimisticUserMsg]);\r\n\r\n        // Clear input IMMEDIATELY for responsive UX\r\n        setChatInput('');\r\n\r\n        // Trigger celebration\r\n        triggerCelebration();\r\n\r\n        try {\r\n          // Execute create (gate already passed, token already obtained)\r\n          // Pass the optimistic user message ID so it doesn't create a duplicate\r\n          await executeCreateWithToken(\r\n            authToken,\r\n            effectiveTemplateId,\r\n            inputText,\r\n            optimisticUserMsgId, // âœ… Pass existing user message ID\r\n            requestId, // âœ… Pass request ID for linking\r\n            // âœ… STEP 18: Pass request binding metadata\r\n            { uiInputHash, uiInputLength, uiSendAt, eventId }\r\n          );\r\n\r\n          // âœ… Update user message status to 'done' on success\r\n          setMessages(prev => prev.map(m =>\r\n            m.id === optimisticUserMsgId\r\n              ? { ...m, meta: { ...m.meta, status: 'done' as const } }\r\n              : m\r\n          ));\r\n\r\n        } catch (error) {\r\n          // âœ… Update user message status to 'error' on failure\r\n          setMessages(prev => prev.map(m =>\r\n            m.id === optimisticUserMsgId\r\n              ? { ...m, meta: { ...m.meta, status: 'error' as const } }\r\n              : m\r\n          ));\r\n          throw error;\r\n        }\r\n\r\n        // Update intent memory AFTER successful execution\r\n        setLastIntentType('CREATE');\r\n        setLastTransformSourceId(null);\r\n\r\n        return { success: true };\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('[dispatchExecution] Execution failed:', error);\r\n      setChatInput(savedInput); // Restore input on error\r\n      return { success: false, reason: 'EXECUTION_ERROR', error };\r\n    }\r\n  }, [\r\n    messages,\r\n    selectedTemplateId,\r\n    selectedTone,\r\n    lastIntentType,\r\n    lastTransformSourceId,\r\n    activeSourceId, // âœ… Added: UI-selected source takes priority\r\n    getLastValidAssistantMessage,\r\n  ]);\r\n\r\n  /**\r\n   * Execute CREATE action with pre-authorized token\r\n   * Called ONLY by dispatchExecution after gate approval\r\n   *\r\n   * @param authToken - Authorization token from gate\r\n   * @param effectiveTemplateId - Resolved template ID\r\n   * @param userInput - The EXACT user input text (passed explicitly, NOT from closure)\r\n   * @param existingUserMsgId - Optional: ID of already-appended optimistic user message (skip creation if provided)\r\n   * @param existingRequestId - Optional: Request ID from optimistic message (for linking)\r\n   * @param bindingMeta - STEP 18: Request binding metadata for single source of truth\r\n   */\r\n  const executeCreateWithToken = useCallback(async (\r\n    authToken: ReturnType<typeof createAuthorizationToken>,\r\n    effectiveTemplateId: string,\r\n    userInput: string,\r\n    existingUserMsgId?: string,\r\n    existingRequestId?: string,\r\n    bindingMeta?: { uiInputHash?: string; uiInputLength?: number; uiSendAt?: number; eventId?: string }\r\n  ) => {\r\n    if (!authToken) throw new Error('No auth token');\r\n\r\n    // Derive workflowStep inline (since it's computed from messages/approvedMessageId)\r\n    const currentWorkflowStep = deriveWorkflowStep({ messages, approvedMessageId });\r\n\r\n    // Use existing request ID if provided (from optimistic message), else generate new\r\n    const requestId = existingRequestId || generateRequestId();\r\n    // CRITICAL: Use the passed userInput, NOT chatInput from closure!\r\n    // This fixes the bug where chatInput could be stale/empty due to closure capture.\r\n    const userMessageContent = userInput;\r\n\r\n    // Snapshot template metadata\r\n    let templateSnapshot: { templateName?: string; templateVersion?: string } = {};\r\n    if (effectiveTemplateId) {\r\n      try {\r\n        const loadedTemplate = getNewTemplateById(effectiveTemplateId);\r\n        templateSnapshot = {\r\n          templateName: loadedTemplate.template.name,\r\n          templateVersion: loadedTemplate.template.ui?.engineVersion || 'unknown',\r\n        };\r\n      } catch (error) {\r\n        console.warn('Failed to snapshot template metadata:', error);\r\n      }\r\n    }\r\n\r\n    // âœ… OPTIMISTIC RENDERING: Skip user message creation if already appended\r\n    if (!existingUserMsgId) {\r\n      // Legacy path: Create user message here (for direct calls without optimistic rendering)\r\n      // NOTE: This path should rarely run since dispatchExecution always creates optimistic messages\r\n      console.warn('[executeCreateWithToken] Legacy path triggered - no existingUserMsgId');\r\n      const userMessage: ChatMessage = {\r\n        id: `user-${Date.now()}`,\r\n        role: 'user',\r\n        content: userMessageContent,\r\n        timestamp: new Date(),\r\n        meta: {\r\n          toneId: selectedTone?.id,\r\n          templateId: effectiveTemplateId ?? undefined,\r\n          useCaseId: selectedUseCase?.id,\r\n          workflowStep: currentWorkflowStep,\r\n          requestId,\r\n          // âœ… MANDATORY: userTypedText for display (STEP 2 hardening)\r\n          userTypedText: userMessageContent,\r\n        },\r\n      };\r\n\r\n      setMessages((prev) => [...prev, userMessage]);\r\n      setChatInput('');\r\n    }\r\n    // User message already appended by dispatchExecution, just set loading state\r\n    setAiError(null);\r\n    setAiLoading(true);\r\n\r\n    try {\r\n      // Build system prompt\r\n      let manifestSystemPrompt: string | undefined;\r\n      if (effectiveTemplateId) {\r\n        try {\r\n          const manifest = resolveTemplateManifest(effectiveTemplateId);\r\n          if (manifest) {\r\n            manifestSystemPrompt = buildSystemPrompt(manifest, {\r\n              toneReinforcement: selectedTone?.systemReinforcement,\r\n              workflowGuidance: currentWorkflowStep ? `Current workflow step: ${currentWorkflowStep}` : undefined,\r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.error('[executeCreateWithToken] Error resolving manifest:', error);\r\n        }\r\n      }\r\n\r\n      // Build request\r\n      const aiRequest: StudioAIRequest = buildStudioAIRequest({\r\n        userPrompt: userMessageContent,\r\n        templateSystemMessage: manifestSystemPrompt,\r\n        toneReinforcement: manifestSystemPrompt ? undefined : selectedTone?.systemReinforcement,\r\n        meta: {\r\n          useCaseId: selectedUseCase?.id,\r\n          templateId: effectiveTemplateId ?? undefined,\r\n          toneId: selectedTone?.id,\r\n          workflowStep: currentWorkflowStep,\r\n          mode: 'execute',\r\n        },\r\n      });\r\n\r\n      // Execute through LLM executor\r\n      // âœ… STEP 18: Include userPrompt explicitly + binding metadata\r\n      // âœ… CRITICAL: Include full conversation history for context\r\n      // Build messages array with: system + all previous user/assistant messages + current user prompt\r\n      const llmMessages: LLMRequest['messages'] = [\r\n        { role: 'system', content: aiRequest.systemMessage },\r\n      ];\r\n\r\n      // Add all previous messages (excluding the current user message we're about to send)\r\n      for (const msg of messages) {\r\n        // Skip system messages (we already added our own)\r\n        // Include all user and assistant messages for conversation history\r\n        if (msg.role === 'user' || msg.role === 'assistant') {\r\n          llmMessages.push({\r\n            role: msg.role,\r\n            content: msg.content,\r\n          });\r\n        }\r\n      }\r\n\r\n      // Add current user prompt as the final message\r\n      llmMessages.push({\r\n        role: 'user',\r\n        content: aiRequest.userPrompt,\r\n      });\r\n\r\n      const llmRequest: LLMRequest = {\r\n        messages: llmMessages,\r\n        userPrompt: aiRequest.userPrompt, // âœ… STEP 18: Explicit userPrompt (source of truth)\r\n        meta: {\r\n          ...(aiRequest.meta as Record<string, unknown>),\r\n          // âœ… STEP 18: Request binding for validation\r\n          ...(bindingMeta?.uiInputHash && {\r\n            eventId: bindingMeta.eventId,\r\n            uiInputHash: bindingMeta.uiInputHash,\r\n            uiInputLength: bindingMeta.uiInputLength,\r\n            uiSendAt: bindingMeta.uiSendAt,\r\n          }),\r\n        },\r\n      };\r\n\r\n      const executionResult = await executeLLM(authToken, llmRequest);\r\n\r\n      if (!executionResult.success || !executionResult.response) {\r\n        throw new Error(executionResult.error || 'Failed to generate AI response');\r\n      }\r\n\r\n      const aiResponse = executionResult.response;\r\n\r\n      // Quality Lock evaluation\r\n      let qualityLockMeta: QualityLockMeta | undefined;\r\n      let resolvedIntent: string | undefined;\r\n      const testMode = /TEST SETTINGS/i.test(userMessageContent) || /TEST_MODE/i.test(userMessageContent);\r\n\r\n      if (isValidIntentId(effectiveTemplateId)) {\r\n        resolvedIntent = effectiveTemplateId;\r\n        const messageId = `assistant-${Date.now()}`;\r\n\r\n        trackQLEvaluationRequested({\r\n          draft_id: messageId,\r\n          message_id: messageId,\r\n          intent_id: resolvedIntent,\r\n          ui_surface: 'studio',\r\n          editor_state: DraftState.D0_ACTIVE,\r\n          assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n          test_mode: testMode,\r\n        });\r\n\r\n        const evalStartTime = Date.now();\r\n        try {\r\n          const qualityResult = runQualityLock({\r\n            intent: effectiveTemplateId as IntentId,\r\n            output: aiResponse.content,\r\n            meta: { templateId: effectiveTemplateId, language: 'vi', testMode },\r\n          });\r\n\r\n          const decision = qualityResult.hardFails.length > 0\r\n            ? 'FAIL' as const\r\n            : qualityResult.softFails.length > 0\r\n            ? 'DRAFT' as const\r\n            : 'PASS' as const;\r\n\r\n          const feedback = transformToFeedback(qualityResult);\r\n\r\n          qualityLockMeta = {\r\n            decision,\r\n            softFails: qualityResult.softFails,\r\n            hardFails: qualityResult.hardFails,\r\n            autoFixAttempts: 0,\r\n            feedback: {\r\n              status: feedback.status,\r\n              score: feedback.score,\r\n              band: feedback.band,\r\n              summary: feedback.summary,\r\n              canApprove: feedback.canApprove,\r\n              issues: feedback.issues,\r\n            },\r\n          };\r\n\r\n          trackQLEvaluationCompleted({\r\n            draft_id: messageId,\r\n            message_id: messageId,\r\n            intent_id: resolvedIntent,\r\n            ui_surface: 'studio',\r\n            editor_state: DraftState.D0_ACTIVE,\r\n            assist_mode: AssistMode.A0_ASSIST_NORMAL,\r\n            test_mode: testMode,\r\n            decision,\r\n            hard_fail_count: qualityResult.hardFails.length,\r\n            soft_fail_count: qualityResult.softFails.length,\r\n            content_length: aiResponse.content.length,\r\n            failed_rule_ids: [\r\n              ...qualityResult.hardFails.map(r => r.id),\r\n              ...qualityResult.softFails.map(r => r.id),\r\n            ],\r\n            duration_ms: Date.now() - evalStartTime,\r\n          });\r\n        } catch (error) {\r\n          console.warn('[executeCreateWithToken] Quality Lock evaluation failed:', error);\r\n        }\r\n      }\r\n\r\n      // Add assistant message\r\n      const assistantMessage: ChatMessage = {\r\n        id: `assistant-${Date.now()}`,\r\n        role: 'assistant',\r\n        content: aiResponse.content,\r\n        timestamp: new Date(),\r\n        meta: {\r\n          toneId: selectedTone?.id,\r\n          templateId: effectiveTemplateId ?? undefined,\r\n          useCaseId: selectedUseCase?.id,\r\n          workflowStep: currentWorkflowStep,\r\n          requestId,\r\n          templateName: templateSnapshot.templateName,\r\n          templateVersion: templateSnapshot.templateVersion,\r\n          intent: resolvedIntent,\r\n          testMode: testMode || undefined,\r\n          qualityLock: qualityLockMeta,\r\n        },\r\n      };\r\n\r\n      setMessages((prev) => [...prev, assistantMessage]);\r\n      setAiLoading(false);\r\n\r\n      // âœ… STEP 5 (UX): Record 'generate' action for workflow pattern inference\r\n      recordSessionAction('generate');\r\n\r\n    } catch (error: unknown) {\r\n      console.error('[executeCreateWithToken] Failed:', error);\r\n      setAiError(error instanceof Error ? error.message : 'An unexpected error occurred');\r\n      setAiLoading(false);\r\n      throw error;\r\n    }\r\n  }, [selectedTone, selectedUseCase, messages, approvedMessageId]); // Note: chatInput removed - now passed as parameter\r\n\r\n  /**\r\n   * Execute TRANSFORM action with pre-authorized token\r\n   * Called ONLY by dispatchExecution after gate approval\r\n   *\r\n   * @param existingUserMsgId - Optional: ID of already-appended optimistic user message (skip creation if provided)\r\n   * @param existingRequestId - Optional: Request ID from optimistic message (for linking)\r\n   * @param bindingMeta - STEP 18: Request binding metadata for single source of truth\r\n   */\r\n  const executeTransformWithToken = useCallback(async (\r\n    authToken: ReturnType<typeof createAuthorizationToken>,\r\n    action: ActionType,\r\n    sourceMessageId: string | undefined,\r\n    transformMode: TransformMode,\r\n    userInstruction: string | undefined,\r\n    existingUserMsgId?: string,\r\n    existingRequestId?: string,\r\n    bindingMeta?: { uiInputHash?: string; uiInputLength?: number; uiSendAt?: number; eventId?: string }\r\n  ) => {\r\n    if (!authToken) throw new Error('No auth token');\r\n\r\n    // Auto-select source if not provided\r\n    let effectiveSourceId = sourceMessageId;\r\n    if (!effectiveSourceId) {\r\n      const lastValid = getLastValidAssistantMessage();\r\n      if (!lastValid) {\r\n        setAiError('KhÃ´ng cÃ³ ná»™i dung Ä‘á»ƒ chá»‰nh sá»­a. HÃ£y táº¡o ná»™i dung trÆ°á»›c.');\r\n        throw new Error('No valid source available');\r\n      }\r\n      effectiveSourceId = lastValid.id;\r\n    }\r\n\r\n    const sourceContent = getMessageContent(effectiveSourceId, messages);\r\n    if (!sourceContent?.trim()) {\r\n      setAiError('Ná»™i dung nguá»“n trá»‘ng. Vui lÃ²ng chá»n má»™t tin nháº¯n khÃ¡c.');\r\n      throw new Error('Source content is empty');\r\n    }\r\n\r\n    // âœ… SAFETY CHECK: Compute content hash for tracing\r\n    // This helps debug context-binding issues\r\n    const sourceContentHash = sourceContent.substring(0, 50).replace(/\\s+/g, ' ');\r\n    console.log('[executeTransformWithToken] Source binding check:', {\r\n      effectiveSourceId,\r\n      sourceContentHash,\r\n      contentLength: sourceContent.length,\r\n    });\r\n\r\n    // âœ… SAFETY ASSERTION: Verify source message exists and matches\r\n    const sourceMessage = messages.find(m => m.id === effectiveSourceId);\r\n    if (!sourceMessage) {\r\n      console.error('[executeTransformWithToken] CRITICAL: Source message not found:', effectiveSourceId);\r\n      setAiError('Lá»—i há»‡ thá»‘ng: KhÃ´ng tÃ¬m tháº¥y tin nháº¯n nguá»“n.');\r\n      throw new Error('Transform source mismatch: message not found');\r\n    }\r\n\r\n    if (sourceMessage.content !== sourceContent) {\r\n      console.error('[executeTransformWithToken] CRITICAL: Content mismatch detected:', {\r\n        messageContent: sourceMessage.content?.substring(0, 50),\r\n        resolvedContent: sourceContent.substring(0, 50),\r\n      });\r\n      // Don't abort - this could be due to apply/diff changes, just warn\r\n      console.warn('[executeTransformWithToken] Content may have been modified');\r\n    }\r\n\r\n    setActiveSourceId(effectiveSourceId);\r\n    setTransformLoading(effectiveSourceId);\r\n\r\n    try {\r\n      const actionLabel = getActionLabel(action);\r\n      const instruction = transformMode === 'DIRECTED_TRANSFORM' && userInstruction\r\n        ? userInstruction\r\n        : `${actionLabel} ná»™i dung nÃ y.`;\r\n\r\n      // Resolve template\r\n      const sourceMessage = messages.find(m => m.id === effectiveSourceId);\r\n      const templateId = sourceMessage?.meta?.templateId || selectedTemplateId;\r\n      let templateSystemPrompt: string | undefined;\r\n\r\n      if (templateId) {\r\n        try {\r\n          const manifest = resolveTemplateManifest(templateId);\r\n          if (manifest) {\r\n            templateSystemPrompt = buildSystemPrompt(manifest, {\r\n              toneReinforcement: selectedTone?.systemReinforcement,\r\n            });\r\n          }\r\n        } catch { /* Use default */ }\r\n      }\r\n\r\n      // Extract locked context\r\n      const lockedContext = extractLockedContext(sourceContent, effectiveSourceId);\r\n      const useValidation = shouldValidate(action);\r\n\r\n      // Output contract\r\n      const outputContract: TransformOutputContract = userInstruction\r\n        ? extractOutputContract(userInstruction, sourceContent)\r\n        : { requiredMinWords: null, requiredMaxWords: null, requiredStructure: [], requiredTone: null, derivedFrom: '', isStrict: false };\r\n\r\n      // Build constrained prompt\r\n      const basePrompt = templateSystemPrompt || 'Báº¡n lÃ  trá»£ lÃ½ viáº¿t ná»™i dung chuyÃªn nghiá»‡p. HÃ£y hoÃ n thÃ nh yÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng.';\r\n      let constrainedPrompt = transformMode === 'DIRECTED_TRANSFORM'\r\n        ? (useValidation ? injectConstraints(basePrompt, lockedContext, 'RELAXED') : basePrompt)\r\n        : (useValidation ? injectConstraints(basePrompt, lockedContext, 'NORMAL') : basePrompt);\r\n\r\n      const contractInstruction = buildContractInstruction(outputContract);\r\n      if (contractInstruction) {\r\n        constrainedPrompt += '\\n\\n' + contractInstruction;\r\n      }\r\n\r\n      // Retry logic\r\n      const maxAttempts = outputContract.isStrict ? 2 : 3;\r\n      let attemptCount = 0;\r\n      let success = false;\r\n      let lastContractValidation: ContractValidationResult | null = null;\r\n      let lastExecutionError: string | null = null; // Track last error for surfacing\r\n      let lastReasonCode: string | null = null; // Track reasonCode for user-facing messages\r\n\r\n      while (attemptCount < maxAttempts && !success) {\r\n        attemptCount++;\r\n        const isRetry = attemptCount > 1;\r\n\r\n        let modeInstruction = instruction;\r\n        if (isRetry && lastContractValidation && !lastContractValidation.passed) {\r\n          const enforcement = buildEnforcementInstruction(lastContractValidation.violations);\r\n          modeInstruction = enforcement + '\\n\\n' + instruction;\r\n        } else if (isRetry) {\r\n          modeInstruction += '\\n\\nâš ï¸ QUAN TRá»ŒNG: Pháº£i giá»¯ nguyÃªn táº¥t cáº£ sá»‘ liá»‡u, tÃªn riÃªng, vÃ  thÃ´ng tin quan trá»ng.';\r\n        }\r\n\r\n        try {\r\n          // âœ… STEP 18: Build transform request with binding metadata\r\n          // âœ… CRITICAL: Include full conversation history for context\r\n          // Compute finalUserPrompt = instruction + sourceReference (exact string sent to LLM)\r\n          const finalUserPrompt = modeInstruction + buildSourceReference(sourceContent);\r\n\r\n          const transformMessages: LLMRequest['messages'] = [\r\n            { role: 'system', content: constrainedPrompt },\r\n          ];\r\n\r\n          // Add all previous messages for context\r\n          for (const msg of messages) {\r\n            if (msg.role === 'user' || msg.role === 'assistant') {\r\n              transformMessages.push({\r\n                role: msg.role,\r\n                content: msg.content,\r\n              });\r\n            }\r\n          }\r\n\r\n          // Add current transform instruction as final user message\r\n          transformMessages.push({\r\n            role: 'user',\r\n            content: finalUserPrompt,\r\n          });\r\n\r\n          // âœ… CRITICAL FIX: Trim userPrompt to match executor normalization\r\n          // The executor trims userPrompt before validation (llmExecutor.ts:281)\r\n          // Hash and length MUST be computed from the SAME trimmed string\r\n          const trimmedUserPrompt = finalUserPrompt.trim();\r\n\r\n          const transformRequest: LLMRequest = {\r\n            messages: transformMessages,\r\n            userPrompt: trimmedUserPrompt, // âœ… STEP 18: Explicit userPrompt (trimmed for consistency)\r\n            meta: {\r\n              templateId,\r\n              mode: 'execute',\r\n              // âœ… STEP 18: uiFinalPromptHash computed from TRIMMED prompt\r\n              // Guarantees hash/length/meta match the actual validated userPrompt\r\n              eventId: bindingMeta?.eventId,\r\n              uiFinalPromptHash: safeHash(trimmedUserPrompt),\r\n              uiFinalPromptLength: trimmedUserPrompt.length,\r\n              uiSendAt: bindingMeta?.uiSendAt,\r\n            },\r\n            // âœ… STEP 21: Inject edit patch metadata if set\r\n            editPatch: pendingEditPatchMeta || undefined,\r\n            // âœ… STEP 22: Inject output contract if set\r\n            outputContract: pendingOutputContract || undefined,\r\n            // âœ… STEP 22: Answer Engine context\r\n            // Enables QA vs EDIT_PATCH vs CREATE mode detection\r\n            answerEngineContext: {\r\n              hasActiveDraft: messages.some(m => m.role === 'assistant' && m.content.length > 100),\r\n              hasPreviousMessages: messages.length > 0,\r\n              lang: 'vi',\r\n            },\r\n          };\r\n\r\n          const executionResult = await executeLLM(authToken, transformRequest);\r\n\r\n          if (!executionResult.success || !executionResult.response) {\r\n            // Capture error for surfacing\r\n            lastExecutionError = executionResult.error || 'Unknown execution error';\r\n            lastReasonCode = executionResult.debugInfo?.reasonCode || null;\r\n            console.error('[executeTransformWithToken] LLM execution failed:', {\r\n              attempt: attemptCount,\r\n              error: executionResult.error,\r\n              reasonCode: executionResult.debugInfo?.reasonCode,\r\n              eventId: executionResult.debugInfo?.eventId,\r\n            });\r\n            continue;\r\n          }\r\n\r\n          const output = executionResult.response.content;\r\n\r\n          if (isRefusal(output)) {\r\n            continue;\r\n          }\r\n\r\n          // Contract validation\r\n          if (outputContract.isStrict) {\r\n            const contractValidation = validateOutputContract(output, outputContract);\r\n            lastContractValidation = contractValidation;\r\n            if (!contractValidation.passed) {\r\n              continue;\r\n            }\r\n          }\r\n\r\n          // Success!\r\n          success = true;\r\n          // Use existing request ID if provided (from optimistic message), else generate new\r\n          const requestId = existingRequestId || generateRequestId();\r\n          const originMessageId = sourceMessage?.meta?.originMessageId || effectiveSourceId;\r\n          const transformDepth = (sourceMessage?.meta?.transformDepth || 0) + 1;\r\n\r\n          // âœ… Diff & Apply: Extract sections for apply functionality\r\n          const beforeSectionsExec = extractSections(sourceContent);\r\n          const afterSectionsExec = extractSections(output);\r\n\r\n          const assistantMsg: ChatMessage = {\r\n            id: `assistant-${Date.now()}`,\r\n            role: 'assistant',\r\n            content: output,\r\n            timestamp: new Date(),\r\n            meta: {\r\n              requestId,\r\n              templateId: templateId ?? undefined,\r\n              actionType: action,\r\n              // âœ… CRITICAL: Explicit source binding for tracing\r\n              sourceMessageId: effectiveSourceId,\r\n              sourceContentHash, // For debugging context-binding issues\r\n              lockedContext: useValidation ? lockedContext : undefined,\r\n              originMessageId,\r\n              transformDepth,\r\n              // âœ… Diff & Apply: Store before/after for section-level apply\r\n              diffApply: {\r\n                applyTargetMessageId: effectiveSourceId,\r\n                beforeText: sourceContent,\r\n                afterText: output,\r\n                beforeSections: {\r\n                  hook: beforeSectionsExec.hook ?? undefined,\r\n                  body: beforeSectionsExec.body ?? undefined,\r\n                  cta: beforeSectionsExec.cta ?? undefined,\r\n                  hashtags: beforeSectionsExec.hashtags ?? undefined,\r\n                },\r\n                afterSections: {\r\n                  hook: afterSectionsExec.hook ?? undefined,\r\n                  body: afterSectionsExec.body ?? undefined,\r\n                  cta: afterSectionsExec.cta ?? undefined,\r\n                  hashtags: afterSectionsExec.hashtags ?? undefined,\r\n                },\r\n                applyState: 'idle',\r\n              },\r\n            },\r\n          };\r\n\r\n          // âœ… OPTIMISTIC RENDERING: Only append assistant message\r\n          // User message was already appended by dispatchExecution\r\n          setMessages(prev => [...prev, assistantMsg]);\r\n\r\n          // âœ… STEP 5 (UX): Record 'generate' action for workflow pattern inference\r\n          recordSessionAction('generate');\r\n          break;\r\n\r\n        } catch (error) {\r\n          console.error(`[executeTransformWithToken] Attempt ${attemptCount} failed:`, error);\r\n        }\r\n      }\r\n\r\n      // Handle failure\r\n      if (!success) {\r\n        if (outputContract.isStrict && lastContractValidation && !lastContractValidation.passed) {\r\n          const violation = lastContractValidation.violations[0];\r\n          const errorMsg = violation\r\n            ? `KhÃ´ng thá»ƒ táº¡o ná»™i dung Ä‘Ãºng yÃªu cáº§u (${violation.expected}, thá»±c táº¿: ${violation.actual}).`\r\n            : 'KhÃ´ng thá»ƒ táº¡o ná»™i dung Ä‘Ãºng yÃªu cáº§u.';\r\n          setAiError(errorMsg);\r\n          throw new Error('Contract validation failed');\r\n        }\r\n\r\n        if (action === 'TRANSLATE' || transformMode === 'DIRECTED_TRANSFORM') {\r\n          // Surface user-facing error based on reasonCode\r\n          const errorMsg = getUserFacingAiError({\r\n            lang: 'vi',\r\n            reasonCode: lastReasonCode,\r\n            fallback: 'KhÃ´ng thá»ƒ thá»±c hiá»‡n yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i.',\r\n          });\r\n          setAiError(errorMsg);\r\n          throw new Error(lastExecutionError || 'Transform requires AI');\r\n        }\r\n\r\n        // Fallback - only runs for PURE_TRANSFORM (DIRECTED_TRANSFORM throws at line 1896)\r\n        const fallbackOutput = applyFallbackTransform(action, sourceContent);\r\n        if (!isRefusal(fallbackOutput)) {\r\n          // Use existing request ID if provided (from optimistic message), else generate new\r\n          const requestId = existingRequestId || generateRequestId();\r\n          const originMessageId = sourceMessage?.meta?.originMessageId || effectiveSourceId;\r\n          const transformDepth = (sourceMessage?.meta?.transformDepth || 0) + 1;\r\n\r\n          // âœ… Diff & Apply: Extract sections for fallback apply functionality\r\n          const beforeSecExecFb = extractSections(sourceContent);\r\n          const afterSecExecFb = extractSections(fallbackOutput);\r\n\r\n          const assistantMsg: ChatMessage = {\r\n            id: `assistant-${Date.now()}`,\r\n            role: 'assistant',\r\n            content: fallbackOutput,\r\n            timestamp: new Date(),\r\n            meta: {\r\n              requestId,\r\n              templateId: templateId ?? undefined,\r\n              actionType: action,\r\n              sourceMessageId: effectiveSourceId,\r\n              isFallback: true,\r\n              originMessageId,\r\n              transformDepth,\r\n              // âœ… Diff & Apply: Store before/after for section-level apply\r\n              diffApply: {\r\n                applyTargetMessageId: effectiveSourceId,\r\n                beforeText: sourceContent,\r\n                afterText: fallbackOutput,\r\n                beforeSections: {\r\n                  hook: beforeSecExecFb.hook ?? undefined,\r\n                  body: beforeSecExecFb.body ?? undefined,\r\n                  cta: beforeSecExecFb.cta ?? undefined,\r\n                  hashtags: beforeSecExecFb.hashtags ?? undefined,\r\n                },\r\n                afterSections: {\r\n                  hook: afterSecExecFb.hook ?? undefined,\r\n                  body: afterSecExecFb.body ?? undefined,\r\n                  cta: afterSecExecFb.cta ?? undefined,\r\n                  hashtags: afterSecExecFb.hashtags ?? undefined,\r\n                },\r\n                applyState: 'idle',\r\n              },\r\n            },\r\n          };\r\n\r\n          // âœ… OPTIMISTIC RENDERING: Only append assistant message\r\n          // User message was already appended by dispatchExecution\r\n          setMessages(prev => [...prev, assistantMsg]);\r\n\r\n          // âœ… STEP 5 (UX): Record 'generate' action for workflow pattern inference\r\n          recordSessionAction('generate');\r\n        } else {\r\n          setAiError(`${actionLabel} tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.`);\r\n          throw new Error('Fallback produced refusal');\r\n        }\r\n      }\r\n\r\n    } finally {\r\n      setTransformLoading(null);\r\n    }\r\n  }, [messages, selectedTemplateId, selectedTone, getLastValidAssistantMessage]);\r\n\r\n  // ============================================\r\n  // handleSend - THIN DISPATCHER ONLY\r\n  // ============================================\r\n  // This function ONLY creates the execution event and dispatches.\r\n  // NO intent detection, NO routing, NO state mutation here.\r\n  // ============================================\r\n  const handleSend = async () => {\r\n    if (!chatInput.trim()) return;\r\n\r\n    // âœ… STEP 18: Capture the EXACT input text at SEND time\r\n    // This is the SINGLE SOURCE OF TRUTH for what the user intended to send\r\n    const finalUserPrompt = chatInput.trim();\r\n\r\n    // Create execution event\r\n    const eventId = generateEventId();\r\n    const timestamp = Date.now();\r\n\r\n    // âœ… STEP 18: Create request binding for single source of truth\r\n    // This hash validates that userPrompt wasn't modified between UI and API\r\n    const uiInputHash = safeHash(finalUserPrompt);\r\n    const uiInputLength = finalUserPrompt.length;\r\n\r\n    // âœ… STEP 6: Capture UI binding at SEND time\r\n    // If user has selected a message (activeSourceId), that becomes the BINDING source\r\n    // This is the user's explicit intent: \"transform THIS message with my instruction\"\r\n    const uiBindingSource = activeSourceId;\r\n\r\n    console.log('[handleSend] Dispatching execution event:', {\r\n      eventId,\r\n      timestamp,\r\n      uiSourceMessageId: uiBindingSource, // âœ… STEP 6: Log UI binding\r\n      uiInputHash, // âœ… STEP 18: Log input hash\r\n      uiInputLength, // âœ… STEP 18: Log input length\r\n    });\r\n\r\n    // Dispatch to execution pipeline (gate check happens INSIDE)\r\n    await dispatchExecution({\r\n      userActionType: 'send',\r\n      inputText: finalUserPrompt, // âœ… STEP 18: Use captured text (not chatInput)\r\n      eventId,\r\n      timestamp,\r\n      uiSourceMessageId: uiBindingSource, // âœ… STEP 6: Pass UI BINDING\r\n      // âœ… STEP 18: Request binding metadata\r\n      uiInputHash,\r\n      uiInputLength,\r\n      uiSendAt: timestamp,\r\n    });\r\n  };\r\n\r\n  // ============================================\r\n  // Retry Last Action - Error Recovery\r\n  // ============================================\r\n  // Re-executes handleSend with current state.\r\n  // INVARIANTS:\r\n  // - Does NOT reset editor content\r\n  // - Does NOT create new drafts\r\n  // - Does NOT affect Primary logic\r\n  // - Uses existing execution path (handleSend)\r\n  // - Only clears error state before retry\r\n  // ============================================\r\n  const retryLastAction = () => {\r\n    // Clear error before retry attempt\r\n    setAiError(null);\r\n    // Re-execute with same input (restored on error)\r\n    handleSend();\r\n  };\r\n\r\n  // Reset studio to initial state\r\n  const resetStudio = () => {\r\n    setSelectedUseCase(null);\r\n    setChatInput('');\r\n    setSelectedTemplateIdState(null);\r\n    setMessages([]);\r\n    setAiError(null);\r\n    // âœ… Clear intent memory on reset\r\n    setLastIntentType(null);\r\n    setLastTransformSourceId(null);\r\n    // Clear messages from localStorage\r\n    try {\r\n      if (typeof window !== 'undefined') {\r\n        localStorage.removeItem('studio_chat_messages_v1');\r\n        localStorage.removeItem('studio_intent_memory_v1');\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to clear messages from storage:', error);\r\n    }\r\n  };\r\n\r\n  // Open template browser\r\n  const openTemplateBrowser = () => {\r\n    setTemplateBrowserOpen(true);\r\n  };\r\n\r\n  // Apply a template (OLD system - for prompt templates)\r\n  const applyTemplate = (template: PromptTemplate) => {\r\n    // Note: This is for the OLD template browser system\r\n    // Use localized prompt based on current UI language\r\n    const localizedPrompt = getLocalizedPrompt(template, language);\r\n    setChatInput(localizedPrompt);\r\n    setTemplateBrowserOpen(false);\r\n  };\r\n\r\n  // âœ… Derive workflow step from current state (system-driven, no manual control)\r\n  const workflowStep = deriveWorkflowStep({ messages, approvedMessageId });\r\n\r\n  // ============================================\r\n  // Diff & Apply: Apply transform results to source content\r\n  // ============================================\r\n  // Client-side only - NO LLM calls, NO database writes\r\n  // Updates message content and tracks apply state\r\n  // ============================================\r\n\r\n  /**\r\n   * Apply transform result to the source message content\r\n   * @param messageId - The assistant message ID containing the transform result\r\n   * @param mode - Which section(s) to apply: 'all' | 'hook' | 'body' | 'cta' | 'hashtags'\r\n   */\r\n  const applyTransformResult = useCallback((messageId: string, mode: ApplyMode) => {\r\n    setMessages((prevMessages) => {\r\n      // Find the transform result message\r\n      const transformMsg = prevMessages.find((m) => m.id === messageId);\r\n      if (!transformMsg || transformMsg.role !== 'assistant' || !transformMsg.meta?.diffApply) {\r\n        console.warn('[applyTransformResult] Invalid message or missing diffApply:', messageId);\r\n        return prevMessages;\r\n      }\r\n\r\n      const { diffApply } = transformMsg.meta;\r\n      const targetId = diffApply.applyTargetMessageId;\r\n\r\n      // Find the target message to update\r\n      const targetMsgIndex = prevMessages.findIndex((m) => m.id === targetId);\r\n      if (targetMsgIndex === -1) {\r\n        console.warn('[applyTransformResult] Target message not found:', targetId);\r\n        return prevMessages;\r\n      }\r\n\r\n      // Apply the section(s)\r\n      const result = applySection(diffApply.beforeText, diffApply.afterText, mode);\r\n      if (!result.success) {\r\n        console.warn('[applyTransformResult] Apply failed:', result.errors);\r\n        return prevMessages;\r\n      }\r\n\r\n      // Update both messages atomically\r\n      const newMessages = [...prevMessages];\r\n\r\n      // Update target message content\r\n      const targetMsg = newMessages[targetMsgIndex];\r\n      newMessages[targetMsgIndex] = {\r\n        ...targetMsg,\r\n        content: result.content,\r\n      };\r\n\r\n      // Update transform message diffApply state\r\n      const transformMsgIndex = newMessages.findIndex((m) => m.id === messageId);\r\n      newMessages[transformMsgIndex] = {\r\n        ...newMessages[transformMsgIndex],\r\n        meta: {\r\n          ...newMessages[transformMsgIndex].meta,\r\n          diffApply: {\r\n            ...diffApply,\r\n            applyState: 'applied',\r\n            appliedAt: Date.now(),\r\n            appliedMode: mode,\r\n          },\r\n        },\r\n      };\r\n\r\n      return newMessages;\r\n    });\r\n  }, []);\r\n\r\n  /**\r\n   * Undo a previously applied transform result\r\n   * Restores the source message to its original content (beforeText)\r\n   * @param messageId - The assistant message ID containing the transform result\r\n   */\r\n  const undoApplyTransformResult = useCallback((messageId: string) => {\r\n    setMessages((prevMessages) => {\r\n      // Find the transform result message\r\n      const transformMsg = prevMessages.find((m) => m.id === messageId);\r\n      if (!transformMsg || transformMsg.role !== 'assistant' || !transformMsg.meta?.diffApply) {\r\n        console.warn('[undoApplyTransformResult] Invalid message or missing diffApply:', messageId);\r\n        return prevMessages;\r\n      }\r\n\r\n      const { diffApply } = transformMsg.meta;\r\n      if (diffApply.applyState !== 'applied') {\r\n        console.warn('[undoApplyTransformResult] Nothing to undo - not in applied state');\r\n        return prevMessages;\r\n      }\r\n\r\n      const targetId = diffApply.applyTargetMessageId;\r\n\r\n      // Find the target message to restore\r\n      const targetMsgIndex = prevMessages.findIndex((m) => m.id === targetId);\r\n      if (targetMsgIndex === -1) {\r\n        console.warn('[undoApplyTransformResult] Target message not found:', targetId);\r\n        return prevMessages;\r\n      }\r\n\r\n      // Update both messages atomically\r\n      const newMessages = [...prevMessages];\r\n\r\n      // Restore target message content to original\r\n      const targetMsg = newMessages[targetMsgIndex];\r\n      newMessages[targetMsgIndex] = {\r\n        ...targetMsg,\r\n        content: diffApply.beforeText,\r\n      };\r\n\r\n      // Update transform message diffApply state to reverted\r\n      const transformMsgIndex = newMessages.findIndex((m) => m.id === messageId);\r\n      newMessages[transformMsgIndex] = {\r\n        ...newMessages[transformMsgIndex],\r\n        meta: {\r\n          ...newMessages[transformMsgIndex].meta,\r\n          diffApply: {\r\n            ...diffApply,\r\n            applyState: 'reverted',\r\n            appliedAt: undefined,\r\n            appliedMode: undefined,\r\n          },\r\n        },\r\n      };\r\n\r\n      return newMessages;\r\n    });\r\n  }, []);\r\n\r\n  // ============================================\r\n  // STEP 6.6: Update Message Content In-Place\r\n  // ============================================\r\n  // NO LLM call - direct local content update\r\n  // Used by EDIT_IN_PLACE pathway for deterministic transforms\r\n  const updateMessageContent = useCallback((messageId: string, newContent: string) => {\r\n    if (!messageId || !newContent) {\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.warn('[updateMessageContent] Missing messageId or newContent');\r\n      }\r\n      return;\r\n    }\r\n\r\n    setMessages((prevMessages) => {\r\n      const messageIndex = prevMessages.findIndex((m) => m.id === messageId);\r\n      if (messageIndex === -1) {\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.warn('[updateMessageContent] Message not found:', messageId);\r\n        }\r\n        return prevMessages;\r\n      }\r\n\r\n      const message = prevMessages[messageIndex];\r\n\r\n      // Only allow updating assistant messages\r\n      if (message.role !== 'assistant') {\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.warn('[updateMessageContent] Cannot update non-assistant message');\r\n        }\r\n        return prevMessages;\r\n      }\r\n\r\n      // Store previous content for undo\r\n      const previousContent = message.content;\r\n\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log('[updateMessageContent] Updating message:', {\r\n          messageId,\r\n          previousLength: previousContent.length,\r\n          newLength: newContent.length,\r\n        });\r\n      }\r\n\r\n      const newMessages = [...prevMessages];\r\n      newMessages[messageIndex] = {\r\n        ...message,\r\n        content: newContent,\r\n        meta: {\r\n          ...message.meta,\r\n          // Track local edit for undo\r\n          localEdit: {\r\n            previousContent,\r\n            appliedAt: Date.now(),\r\n          },\r\n        },\r\n      };\r\n\r\n      return newMessages;\r\n    });\r\n  }, []);\r\n\r\n  const value: StudioContextType = {\r\n    useCases: STUDIO_USE_CASES,\r\n    selectedUseCase,\r\n    setSelectedUseCase,\r\n    workflowStep, // Now derived, not manually set\r\n    // setWorkflowStep removed - workflow is system-driven\r\n    showWelcomeAnimation,\r\n    celebrationTrigger,\r\n    triggerCelebration,\r\n    chatInput,\r\n    setChatInput,\r\n    messages,\r\n    clearMessages,\r\n    approvedMessageId,\r\n    setApprovedMessage,\r\n    clearApprovedMessage,\r\n    isTemplateBrowserOpen,\r\n    setTemplateBrowserOpen,\r\n    selectedTemplateId,\r\n    handleTemplateSelect, // NEW: Handler for Content Machine Engine templates\r\n    templateSearch,\r\n    setTemplateSearch,\r\n    selectedTemplateCategoryId,\r\n    setSelectedTemplateCategoryId,\r\n    selectedTone,\r\n    handleToneSelect,\r\n    aiLoading,\r\n    aiError,\r\n    setAiError, // âœ… STEP 22: Expose for REWRITE_UPGRADE context guard error display\r\n    retryLastAction, // âœ… Error recovery: re-execute with same input/state\r\n    templateGateToast, // âœ… PHASE 3: Template gate feedback\r\n    handleUseCaseSelect,\r\n    handleSend,\r\n    resetStudio,\r\n    openTemplateBrowser,\r\n    applyTemplate,\r\n    // sendToAI REMOVED - All execution goes through handleSend â†’ dispatchExecution\r\n    // âœ… Quality Lock Auto Fix\r\n    autoFixMessage,\r\n    autoFixLoading,\r\n\r\n    // âœ… Auto Fix Preview Modal (Diff Preview UX)\r\n    autoFixPreview,\r\n    applyAutoFix,\r\n    cancelAutoFix,\r\n\r\n    // âœ… Auto Fix Toast (with undo support)\r\n    autoFixToast,\r\n    undoAutoFix,\r\n    dismissAutoFixToast,\r\n\r\n    // âœ… Orchestrator: Transform actions\r\n    activeSourceId,\r\n    setActiveSource,\r\n    handleTransformAction,\r\n    transformLoading,\r\n\r\n    // âœ… Diff & Apply: Apply transform results to source content\r\n    applyTransformResult,\r\n    undoApplyTransformResult,\r\n\r\n    // âœ… STEP 6.6: Local Edit (NO LLM call)\r\n    updateMessageContent,\r\n\r\n    // âœ… STEP 21: Edit Patch Meta setter\r\n    setEditPatchMeta: setPendingEditPatchMeta,\r\n\r\n    // âœ… STEP 22: Output Contract setter\r\n    setOutputContract: setPendingOutputContract,\r\n\r\n    // ============================================\r\n    // FEATURE A: Primary Selection + Commit to Posts\r\n    // ============================================\r\n    primaryMessageId,\r\n    setPrimaryMessage,\r\n    clearPrimaryMessage,\r\n    createPostFromPrimary,\r\n    commitLoading,\r\n\r\n    // ============================================\r\n    // FEATURE B: Studio Session Persistence\r\n    // ============================================\r\n    sessionId,\r\n    studioToast,\r\n    dismissStudioToast,\r\n    showStudioToast,\r\n    saveSessionSnapshot,\r\n    saveSession,\r\n    saveSessionLoading,\r\n    getRecentSnapshots,\r\n    restoreSnapshot,\r\n\r\n    // ============================================\r\n    // AI Library: Persistent saved sessions\r\n    // ============================================\r\n    aiLibraryEntries,\r\n    restoreFromAILibrary,\r\n  };\r\n\r\n  return (\r\n    <StudioContext.Provider value={value}>{children}</StudioContext.Provider>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]}]